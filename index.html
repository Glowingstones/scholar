<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ (æœ€ç»ˆå®Œç¾ç¨³å®šç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* =================================================================
           1. ç³»ç»Ÿçº§ CSS å˜é‡ä¸é‡ç½®
           ================================================================= */
        :root {
            /* ç•Œé¢é…è‰² - è¿˜åŸä¸ºæ‚¨å¯èƒ½ä¹ æƒ¯çš„æ¸…çˆ½é£æ ¼ */
            --primary-color: #2563eb;       /* ç§‘æŠ€è“ */
            --primary-hover: #1d4ed8;
            --bg-body: #f3f4f6;             /* æµ…ç°åº•è‰² */
            --bg-sidebar: #111827;          /* æ·±è‰²ä¾§è¾¹æ  (ä¸“ä¸šæ„Ÿ) */
            --text-sidebar: #e5e7eb;
            --bg-white: #ffffff;
            
            /* è¾¹æ¡†ä¸åˆ†å‰² */
            --border-color: #e5e7eb;
            --radius-md: 6px;
            --radius-lg: 12px;

            /* åŠŸèƒ½è‰² */
            --color-paper: #3b82f6;
            --color-patent: #f59e0b;
            --color-project: #10b981;
            --color-award: #ef4444;
            --color-book: #8b5cf6;
            --color-member: #06b6d4;

            /* é˜´å½±ä¸å±‚çº§ */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --z-modal: 9999;
            --z-toast: 10000;
        }

        /* åŸºç¡€é‡ç½® */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body {
            font-family: "Microsoft YaHei", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-body);
            color: #1f2937;
            height: 100vh;
            overflow: hidden; /* ç¦ç”¨ Body æ»šåŠ¨ï¼Œä½¿ç”¨å†…éƒ¨ Flex æ»šåŠ¨ */
            display: flex;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* =================================================================
           2. ä¾§è¾¹æ  (Sidebar) - ç¨³å›ºå¸ƒå±€
           ================================================================= */
        .sidebar {
            width: 260px;
            background-color: var(--bg-sidebar);
            color: var(--text-sidebar);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.3s;
        }

        .logo-area {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
            letter-spacing: 1px;
        }
        .logo-icon { margin-right: 10px; font-size: 1.4rem; }

        .nav-scroller {
            flex: 1;
            overflow-y: auto;
            padding: 20px 10px;
        }

        .nav-group-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            margin: 15px 0 5px 12px;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            color: #d1d5db;
        }
        .nav-item:hover { background-color: rgba(255,255,255,0.1); color: #fff; }
        .nav-item.active { background-color: var(--primary-color); color: #fff; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
        
        .nav-icon { width: 24px; text-align: center; margin-right: 10px; }
        .nav-badge {
            margin-left: auto;
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        /* ä¾§è¾¹æ åº•éƒ¨åŠŸèƒ½åŒº */
        .sidebar-bottom {
            padding: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
        }

        /* å¼ºåŠ›æŒ‰é’®ç»„ - è§£å†³â€œç‚¹ä¸åŠ¨â€é—®é¢˜ */
        .action-btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .sidebar-action-btn {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: transparent;
            color: #fff;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .sidebar-action-btn:hover { background: rgba(255,255,255,0.1); border-color: #fff; }
        .sidebar-action-btn.primary { background: var(--primary-color); border-color: var(--primary-color); }
        .sidebar-action-btn.primary:hover { background: var(--primary-hover); }

        /* =================================================================
           3. ä¸»å†…å®¹åŒº (Main Content)
           ================================================================= */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            height: 64px;
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .page-header h2 { font-size: 1.4rem; font-weight: 700; color: #111827; }
        
        .top-tools { display: flex; align-items: center; gap: 16px; }
        
        .search-container { position: relative; }
        .search-input {
            width: 300px; padding: 10px 16px 10px 36px;
            border: 1px solid var(--border-color); border-radius: var(--radius-md);
            background: #f9fafb; transition: 0.2s;
        }
        .search-input:focus { border-color: var(--primary-color); background: #fff; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; }

        .btn-add {
            background: var(--primary-color); color: #fff;
            padding: 10px 24px; border-radius: var(--radius-md);
            border: none; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(37,99,235,0.2); transition: 0.2s;
        }
        .btn-add:hover { background: var(--primary-hover); transform: translateY(-1px); }

        /* å†…å®¹æ»šåŠ¨åŒºåŸŸ */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px 32px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ç»„ */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: #fff; padding: 20px; border-radius: var(--radius-lg);
            border: 1px solid var(--border-color); display: flex; align-items: center; gap: 16px;
            box-shadow: var(--shadow); cursor: pointer; transition: 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); border-color: var(--primary-color); }
        .stat-icon-box {
            width: 50px; height: 50px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 1.6rem;
        }
        .stat-text h3 { font-size: 1.6rem; font-weight: 800; color: #111827; line-height: 1; margin-bottom: 5px; }
        .stat-text p { font-size: 0.85rem; color: #6b7280; margin: 0; }

        /* æ•°æ®è¡¨æ ¼åŒºåŸŸ */
        .data-panel {
            background: #fff; border: 1px solid var(--border-color);
            border-radius: var(--radius-lg); overflow: hidden;
            display: flex; flex-direction: column; min-height: 500px;
            box-shadow: var(--shadow);
        }

        .panel-toolbar {
            padding: 16px 24px; border-bottom: 1px solid var(--border-color);
            background: #f9fafb; display: flex; justify-content: space-between; align-items: center;
        }

        .filter-group { display: flex; align-items: center; gap: 12px; }
        .year-select { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md); cursor: pointer; }
        
        .btn-danger { background: #ef4444; color: #fff; padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; border: none; cursor: pointer; display: none; }
        .btn-danger:hover { background: #dc2626; }

        /* åˆ—è¡¨å¤´ */
        .table-header {
            display: grid;
            grid-template-columns: 40px 2fr 1.5fr 1.5fr 1fr 120px;
            padding: 12px 24px;
            background: #f3f4f6;
            border-bottom: 1px solid var(--border-color);
            font-weight: 700; color: #4b5563; font-size: 0.9rem;
        }

        /* åˆ—è¡¨ä½“ */
        .table-body { flex: 1; overflow-y: auto; }

        .table-row {
            display: grid;
            grid-template-columns: 40px 2fr 1.5fr 1.5fr 1fr 120px;
            padding: 16px 24px;
            border-bottom: 1px solid #f3f4f6;
            align-items: center;
            transition: 0.1s;
            cursor: pointer;
        }
        .table-row:hover { background: #f9fafb; }
        .table-row:last-child { border-bottom: none; }

        .row-check { width: 18px; height: 18px; cursor: pointer; }
        
        .cell-title { font-weight: 600; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cell-meta { font-size: 0.9rem; color: #6b7280; }
        .cell-tag span {
            display: inline-block; padding: 2px 8px; border-radius: 12px;
            font-size: 0.75rem; background: #e5e7eb; color: #374151;
        }
        .cell-actions { display: flex; gap: 8px; opacity: 0; transition: 0.2s; }
        .table-row:hover .cell-actions { opacity: 1; }

        .icon-btn {
            width: 32px; height: 32px; border: 1px solid var(--border-color);
            border-radius: 6px; background: #fff; color: #6b7280;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .icon-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .icon-btn.del:hover { border-color: #ef4444; color: #ef4444; }

        .empty-state { padding: 60px; text-align: center; color: #9ca3af; }

        /* =================================================================
           4. å¼ºåŠ›å¼¹çª—ç³»ç»Ÿ (Modals)
           ================================================================= */
        .modal-overlay {
            position: fixed; inset: 0; background: var(--bg-modal-overlay);
            backdrop-filter: blur(3px); z-index: var(--z-modal);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: 0.2s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal-panel {
            background: #fff; width: 600px; max-width: 95%; max-height: 90vh;
            border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            display: flex; flex-direction: column; transform: scale(0.95); transition: 0.2s;
        }
        .modal-overlay.active .modal-panel { transform: scale(1); }

        .modal-header {
            padding: 20px 24px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h3 { font-size: 1.25rem; font-weight: 700; }
        .close-icon { font-size: 1.5rem; color: #9ca3af; cursor: pointer; background: none; border: none; }

        .modal-content { padding: 24px; overflow-y: auto; }

        .modal-footer {
            padding: 20px 24px; border-top: 1px solid var(--border-color);
            background: #f9fafb; display: flex; justify-content: flex-end; gap: 12px;
            border-radius: 0 0 16px 16px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-full { grid-column: span 2; }
        .form-label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
        .form-input {
            width: 100%; padding: 10px 12px; border: 1px solid var(--border-color);
            border-radius: 6px; font-size: 1rem; transition: 0.2s;
        }
        .form-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* æ•°æ®ç®¡ç†å¼¹çª—ç‰¹åˆ«æ ·å¼ */
        .data-manage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .data-card {
            border: 1px solid var(--border-color); border-radius: 8px; padding: 20px;
            text-align: center; cursor: pointer; transition: 0.2s; background: #fff;
        }
        .data-card:hover { border-color: var(--primary-color); background: #eff6ff; }
        .data-card h4 { margin-top: 10px; color: #374151; }
        .data-card p { font-size: 0.8rem; color: #9ca3af; margin-top: 5px; }

        /* Toast æç¤º */
        .toast-container { position: fixed; top: 30px; right: 30px; z-index: var(--z-toast); display: flex; flex-direction: column; gap: 10px; }
        .toast-msg {
            padding: 16px 24px; background: #fff; border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 5px solid var(--primary-color);
            font-weight: 500; transform: translateX(120%); transition: 0.3s;
        }
        .toast-msg.show { transform: translateX(0); }

        /* éšè—çš„æ–‡ä»¶è¾“å…¥ */
        .hidden-file { display: none; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .sidebar { position: absolute; height: 100%; transform: translateX(-100%); box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
            .sidebar.open { transform: translateX(0); }
            .main-wrapper { margin-left: 0; width: 100%; }
            .top-bar { padding: 0 16px; }
            .search-input { width: 150px; }
            .table-header { display: none; } /* ç§»åŠ¨ç«¯éšè—è¡¨å¤´ */
            .table-row { grid-template-columns: 1fr; gap: 8px; align-items: start; }
            .mobile-toggle { display: block !important; position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: var(--primary-color); color:#fff; border-radius: 50%; z-index: 2000; border:none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 1.5rem; }
            .form-grid { grid-template-columns: 1fr; }
            .form-full { grid-column: span 1; }
            .data-manage-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<button class="mobile-toggle" style="display:none;" onclick="toggleSidebar()">â˜°</button>

<div class="app-container">
    
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-box"><div class="logo-icon">ğŸ”¬</div> ç§‘ç ”ç®¡ç†ç³»ç»Ÿ</div>
        </div>
        
        <nav class="nav-scroller">
            <div class="nav-group-label">æˆæœåº“</div>
            <a class="nav-item active" onclick="switchView('all')" id="nav-all">
                <div class="nav-icon">ğŸ“‹</div> å…¨éƒ¨æˆæœ <div class="nav-badge" id="c-all">0</div>
            </a>
            <a class="nav-item" onclick="switchView('paper')" id="nav-paper">
                <div class="nav-icon">ğŸ“„</div> å­¦æœ¯è®ºæ–‡ <div class="nav-badge" id="c-paper">0</div>
            </a>
            <a class="nav-item" onclick="switchView('patent')" id="nav-patent">
                <div class="nav-icon">ğŸ’¡</div> å‘æ˜ä¸“åˆ© <div class="nav-badge" id="c-patent">0</div>
            </a>
            <a class="nav-item" onclick="switchView('project')" id="nav-project">
                <div class="nav-icon">ğŸ“Š</div> ç§‘ç ”é¡¹ç›® <div class="nav-badge" id="c-project">0</div>
            </a>
            <a class="nav-item" onclick="switchView('award')" id="nav-award">
                <div class="nav-icon">ğŸ†</div> è·å¥–æƒ…å†µ <div class="nav-badge" id="c-award">0</div>
            </a>
            <a class="nav-item" onclick="switchView('book')" id="nav-book">
                <div class="nav-icon">ğŸ“š</div> ä¸“è‘—å‡ºç‰ˆ <div class="nav-badge" id="c-book">0</div>
            </a>

            <div class="nav-group-label">å›¢é˜Ÿ</div>
            <a class="nav-item" onclick="switchView('member')" id="nav-member">
                <div class="nav-icon">ğŸ‘¥</div> æˆå‘˜ä¿¡æ¯ <div class="nav-badge" id="c-member">0</div>
            </a>
        </nav>

        <div class="sidebar-bottom">
            <div class="action-btn-group">
                <button class="sidebar-action-btn primary" onclick="openDataManager()">
                    <span>ğŸ“¤</span> æ•°æ®å¯¼å…¥ / å¯¼å‡º / å¤‡ä»½
                </button>
                <button class="sidebar-action-btn" onclick="openCloudConfig()">
                    <span id="cloudIcon">â˜ï¸</span> <span id="cloudText">é…ç½®äº‘åŒæ­¥</span>
                </button>
            </div>
            <div style="margin-top:10px;text-align:center;font-size:0.7rem;color:#6b7280;">
                <span id="dbState">IndexedDB å­˜å‚¨æ­£å¸¸</span>
            </div>
        </div>
    </aside>

    <main class="main-wrapper">
        <header class="top-bar">
            <div class="page-header"><h2 id="pageTitle">å…¨éƒ¨æˆæœ</h2></div>
            <div class="top-tools">
                <div class="search-container">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" class="search-input" placeholder="æœç´¢æ ‡é¢˜ã€ä½œè€…ã€ç¼–å·..." oninput="handleSearch(this.value)">
                </div>
                <button class="btn-add" onclick="openAddModal()"><span>â•</span> <span id="addBtnText">æ–°å¢æˆæœ</span></button>
            </div>
        </header>

        <div class="content-area">
            <div class="stats-overview" id="statsRow"></div>

            <div class="data-panel">
                <div class="panel-toolbar">
                    <div class="filter-group">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> å…¨é€‰
                        <span id="selCount" style="color:#6b7280;font-size:0.9rem;">(0)</span>
                        <button class="btn-danger" id="batchDelBtn" onclick="batchDelete()">æ‰¹é‡åˆ é™¤</button>
                    </div>
                    <div>
                        <select class="year-select" id="yearFilter" onchange="applyFilter()">
                            <option value="all">æ‰€æœ‰å¹´ä»½</option>
                        </select>
                    </div>
                </div>

                <div class="table-header">
                    <div></div> <div>æ ‡é¢˜/åç§°</div>
                    <div>æ—¥æœŸ</div>
                    <div>ä½œè€…/è´Ÿè´£äºº</div>
                    <div>è¯¦ç»†ä¿¡æ¯</div>
                    <div>æ“ä½œ</div>
                </div>

                <div class="table-body" id="listBody">
                    </div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="dataModal">
    <div class="modal-panel" style="max-width:700px;">
        <div class="modal-header">
            <h3>ğŸ—‚ï¸ æ•°æ®ç®¡ç†ä¸­å¿ƒ</h3>
            <button class="close-icon" onclick="closeDataModal()">Ã—</button>
        </div>
        <div class="modal-content">
            <h4 style="margin-bottom:15px;color:#4b5563;">ğŸ“¤ å¯¼å‡ºæ•°æ®</h4>
            <div class="data-manage-grid">
                <div class="data-card" onclick="exportToExcel()">
                    <div style="font-size:2rem;">ğŸ“Š</div>
                    <h4>å¯¼å‡º Excel</h4>
                    <p>è‡ªåŠ¨åˆ†è¡¨ (6ä¸ªSheet)ï¼Œä¿ç•™å…¨å­—æ®µ</p>
                </div>
                <div class="data-card" onclick="exportToWord()">
                    <div style="font-size:2rem;">ğŸ“</div>
                    <h4>å¯¼å‡º Word</h4>
                    <p>ç”Ÿæˆè¯¦ç»†æ±‡æ€»è¡¨æ ¼æ–‡æ¡£</p>
                </div>
                <div class="data-card" onclick="backupJSON()">
                    <div style="font-size:2rem;">ğŸ“¦</div>
                    <h4>å¤‡ä»½æ•°æ® (JSON)</h4>
                    <p>æ¨èï¼å®Œæ•´å¤‡ä»½æ‰€æœ‰æ•°æ®å’Œé™„ä»¶</p>
                </div>
            </div>

            <h4 style="margin-top:30px;margin-bottom:15px;color:#4b5563;">ğŸ“¥ å¯¼å…¥ / æ¢å¤</h4>
            <div class="data-manage-grid">
                <div class="data-card" onclick="document.getElementById('fileExcelIn').click()">
                    <div style="font-size:2rem;">ğŸ“ˆ</div>
                    <h4>å¯¼å…¥ Excel</h4>
                    <p>æ”¯æŒæ‰¹é‡å¯¼å…¥æˆæœæˆ–æˆå‘˜æ•°æ®</p>
                </div>
                <div class="data-card" onclick="document.getElementById('fileJsonIn').click()">
                    <div style="font-size:2rem;">ğŸ“‚</div>
                    <h4>æ¢å¤å¤‡ä»½ (JSON)</h4>
                    <p>ä»ä¹‹å‰çš„å¤‡ä»½æ–‡ä»¶ä¸­æ¢å¤æ•°æ®</p>
                </div>
            </div>
            
            <input type="file" id="fileExcelIn" class="hidden-file" accept=".xlsx,.xls" onchange="importExcel(this)">
            <input type="file" id="fileJsonIn" class="hidden-file" accept=".json" onchange="restoreJSON(this)">
        </div>
        <div class="modal-footer">
            <button class="btn-sidebar" onclick="closeDataModal()" style="padding:8px 20px;border-radius:6px;background:#fff;border:1px solid #ddd;">å…³é—­</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="editModal">
    <div class="modal-panel">
        <div class="modal-header">
            <h3 id="formTitle">æ–°å¢è®°å½•</h3>
            <button class="close-icon" onclick="closeEditModal()">Ã—</button>
        </div>
        <div class="modal-content">
            <form id="mainForm">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group form-full">
                        <label class="form-label">ç±»å‹</label>
                        <select id="inputType" class="form-input" onchange="updateFormLayout()">
                            <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                            <option value="patent">å‘æ˜ä¸“åˆ©</option>
                            <option value="project">ç§‘ç ”é¡¹ç›®</option>
                            <option value="award">è·å¥–æƒ…å†µ</option>
                            <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                            <option value="member">æˆå‘˜ä¿¡æ¯</option>
                        </select>
                    </div>

                    <div id="dynamicFields" class="form-full form-grid" style="margin:0;padding:0;gap:20px;"></div>

                    <div class="form-group form-full" id="fileSection">
                        <label class="form-label">é™„ä»¶ (PDF)</label>
                        <div class="file-upload" onclick="document.getElementById('pdfInput').click()" style="border:2px dashed #e5e7eb;padding:20px;text-align:center;border-radius:8px;cursor:pointer;">
                            <span style="font-size:1.5rem;">ğŸ“</span>
                            <p style="margin:5px 0 0;color:#6b7280;font-size:0.9rem;">ç‚¹å‡»ä¸Šä¼  (IndexedDB æ”¯æŒå¤§æ–‡ä»¶)</p>
                            <input type="file" id="pdfInput" class="hidden-file" accept=".pdf" onchange="handleFile(this)">
                        </div>
                        <div id="filePreview" style="display:none;margin-top:10px;padding:10px;background:#eff6ff;border-radius:6px;justify-content:space-between;align-items:center;">
                            <span id="fileName" style="font-size:0.9rem;color:#1d4ed8;font-weight:500;"></span>
                            <button type="button" onclick="removeFile()" style="border:none;background:none;color:#ef4444;cursor:pointer;">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-sidebar" onclick="closeEditModal()" style="padding:10px 20px;border-radius:6px;background:#fff;border:1px solid #ddd;cursor:pointer;">å–æ¶ˆ</button>
            <button class="btn-add" onclick="submitForm()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="cloudModal">
    <div class="modal-panel" style="max-width:500px;">
        <div class="modal-header">
            <h3>â˜ï¸ GitHub äº‘åŒæ­¥</h3>
            <button class="close-icon" onclick="document.getElementById('cloudModal').classList.remove('active')">Ã—</button>
        </div>
        <div class="modal-content">
            <p style="font-size:0.9rem;color:#4b5563;margin-bottom:15px;line-height:1.5;">
                åˆ©ç”¨ GitHub Gist å®ç°å¤šè®¾å¤‡æ•°æ®åŒæ­¥ã€‚è¯·åœ¨ GitHub ç”³è¯· Token å¹¶å‹¾é€‰ <b>gist</b> æƒé™ã€‚
            </p>
            <div class="form-group">
                <label class="form-label">GitHub Token (å¿…å¡«)</label>
                <input type="password" id="ghToken" class="form-input" placeholder="ghp_xxxxxxxxxxxx...">
            </div>
            <div class="form-group">
                <label class="form-label">Gist ID (é€‰å¡«)</label>
                <input type="text" id="ghGistId" class="form-input" placeholder="ç•™ç©ºåˆ™åˆ›å»ºæ–°çš„å­˜å‚¨åº“">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-add" onclick="connectCloud()">è¿æ¥ / åˆ›å»º</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastBox"></div>

<script>
/**
 * =================================================================
 * æ ¸å¿ƒé€»è¾‘ï¼šæ•°æ®ç»“æ„ã€å­˜å‚¨ã€æ¸²æŸ“ (100% å®Œæ•´ä¿ç•™)
 * =================================================================
 */

// 1. å…¨å±€çŠ¶æ€
const APP = {
    dbName: 'ResearchDB_Flagship',
    dbVersion: 1,
    db: null,
    data: { achievements: [], members: [] },
    config: { token: '', gistId: '' },
    view: 'all',
    search: '',
    sort: 'date-desc',
    yearFilter: 'all',
    selected: new Set(),
    currentFile: null,
    
    // å­—æ®µå®šä¹‰ (Schema) - ç”¨äºç”Ÿæˆè¡¨å•å’Œ Excel/Word å¯¼å‡º
    schema: {
        paper: [
            { id: 'title', label: 'è®ºæ–‡æ ‡é¢˜', type: 'text', required: true, full: true },
            { id: 'date', label: 'å‘è¡¨æ—¥æœŸ', type: 'date', required: true },
            { id: 'authors', label: 'ä½œè€…åˆ—è¡¨', type: 'text', placeholder: 'é€—å·åˆ†éš”' },
            { id: 'source', label: 'æœŸåˆŠ/ä¼šè®®', type: 'text' },
            { id: 'level', label: 'æ”¶å½•çº§åˆ«', type: 'text', placeholder: 'SCI/EI' },
            { id: 'keywords', label: 'å…³é”®è¯', type: 'text', full: true }
        ],
        patent: [
            { id: 'patentName', label: 'ä¸“åˆ©åç§°', type: 'text', required: true, full: true },
            { id: 'patentType', label: 'ç±»å‹', type: 'select', opts: ['å‘æ˜ä¸“åˆ©','å®ç”¨æ–°å‹','å¤–è§‚è®¾è®¡'] },
            { id: 'patentStatus', label: 'çŠ¶æ€', type: 'select', opts: ['ç”³è¯·ä¸­','å®å®¡ä¸­','å·²æˆæƒ','å·²è½¬è®©'] },
            { id: 'patentNumber', label: 'ä¸“åˆ©å·', type: 'text' },
            { id: 'applicationDate', label: 'ç”³è¯·æ—¥', type: 'date' },
            { id: 'grantDate', label: 'æˆæƒæ—¥', type: 'date' },
            { id: 'inventors', label: 'å‘æ˜äºº', type: 'text', full: true },
            { id: 'patentOwner', label: 'æƒåˆ©äºº', type: 'text' }
        ],
        project: [
            { id: 'projectName', label: 'é¡¹ç›®åç§°', type: 'text', required: true, full: true },
            { id: 'projectNumber', label: 'é¡¹ç›®ç¼–å·', type: 'text' },
            { id: 'projectLevel', label: 'çº§åˆ«', type: 'select', opts: ['å›½å®¶çº§','çœéƒ¨çº§','å…å±€çº§','æ¨ªå‘','æ ¡çº§'] },
            { id: 'projectOrg', label: 'æ‰€å±å•ä½', type: 'text' },
            { id: 'projectStartDate', label: 'å¼€å§‹æ—¶é—´', type: 'date' },
            { id: 'projectEndDate', label: 'ç»“æŸæ—¶é—´', type: 'date' },
            { id: 'authors', label: 'è´Ÿè´£äºº', type: 'text', full: true }
        ],
        award: [
            { id: 'title', label: 'è·å¥–åç§°', type: 'text', required: true, full: true },
            { id: 'date', label: 'è·å¥–æ—¥æœŸ', type: 'date' },
            { id: 'level', label: 'å¥–åŠ±ç­‰çº§', type: 'text' },
            { id: 'source', label: 'æˆå¥–å•ä½', type: 'text' },
            { id: 'authors', label: 'è·å¥–äºº', type: 'text', full: true }
        ],
        book: [
            { id: 'title', label: 'ä¸“è‘—åç§°', type: 'text', required: true, full: true },
            { id: 'authors', label: 'ä½œè€…', type: 'text' },
            { id: 'date', label: 'å‡ºç‰ˆæ—¥æœŸ', type: 'date' },
            { id: 'source', label: 'å‡ºç‰ˆç¤¾', type: 'text' },
            { id: 'isbn', label: 'ISBNå·', type: 'text' }
        ],
        member: [
            { id: 'memberNo', label: 'å·¥å·/å­¦å·', type: 'text', required: true },
            { id: 'memberName', label: 'å§“å', type: 'text', required: true },
            { id: 'memberGender', label: 'æ€§åˆ«', type: 'select', opts: ['ç”·','å¥³'] },
            { id: 'memberBirth', label: 'å‡ºç”Ÿå¹´æœˆ', type: 'month' },
            { id: 'memberOrg', label: 'æ‰€å±å•ä½', type: 'text' },
            { id: 'memberTitle', label: 'èŒç§°/èŒåŠ¡', type: 'text' },
            { id: 'memberPhone', label: 'æ‰‹æœºå·ç ', type: 'text' },
            { id: 'memberEmail', label: 'ç”µå­é‚®ç®±', type: 'text' },
            { id: 'memberIdNo', label: 'è¯ä»¶å·ç ', type: 'text', full: true }
        ]
    },
    types: {
        paper: { label: 'å­¦æœ¯è®ºæ–‡', icon: 'ğŸ“„', color: 'c-paper' },
        patent: { label: 'å‘æ˜ä¸“åˆ©', icon: 'ğŸ’¡', color: 'c-patent' },
        project: { label: 'ç§‘ç ”é¡¹ç›®', icon: 'ğŸ“Š', color: 'c-project' },
        award: { label: 'è·å¥–æƒ…å†µ', icon: 'ğŸ†', color: 'c-award' },
        book: { label: 'ä¸“è‘—å‡ºç‰ˆ', icon: 'ğŸ“š', color: 'c-book' },
        member: { label: 'æˆå‘˜', icon: 'ğŸ‘¤', color: 'c-member' }
    }
};

// 2. æ•°æ®åº“ (IndexedDB)
function initDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(APP.dbName, APP.dbVersion);
        req.onupgradeneeded = e => {
            const db = e.target.result;
            if(!db.objectStoreNames.contains('store')) db.createObjectStore('store', {keyPath: 'id'});
        };
        req.onsuccess = e => { APP.db = e.target.result; resolve(); };
        req.onerror = e => reject(e);
    });
}

async function loadData() {
    if(!APP.db) await initDB();
    const tx = APP.db.transaction('store', 'readonly');
    const req = tx.objectStore('store').get('main_data');
    req.onsuccess = e => {
        if(e.target.result) {
            APP.data = e.target.result.data || { achievements: [], members: [] };
            APP.config = e.target.result.config || { token: '', gistId: '' };
        }
        updateUI();
        if(APP.config.token) checkCloudStatus();
    };
}

async function persist() {
    const tx = APP.db.transaction('store', 'readwrite');
    tx.objectStore('store').put({ id: 'main_data', data: APP.data, config: APP.config, updated: new Date() });
    // è‡ªåŠ¨è§¦å‘äº‘åŒæ­¥
    if(APP.config.token && APP.config.gistId) syncCloud(false);
}

// 3. UI æ¸²æŸ“
function updateUI() {
    renderStats();
    renderList();
    updateCounts();
}

function updateCounts() {
    const c = { paper:0, patent:0, project:0, award:0, book:0 };
    APP.data.achievements.forEach(i => { if(c[i.type]!==undefined) c[i.type]++; });
    document.getElementById('c-all').innerText = APP.data.achievements.length;
    document.getElementById('c-member').innerText = APP.data.members.length;
    Object.keys(c).forEach(k => document.getElementById(`c-${k}`).innerText = c[k]);
}

function renderStats() {
    const container = document.getElementById('statsRow');
    const types = ['paper','patent','project','award','book','member'];
    container.innerHTML = types.map(k => {
        const num = k==='member' ? APP.data.members.length : APP.data.achievements.filter(i=>i.type===k).length;
        const meta = APP.types[k];
        return `<div class="stat-card" onclick="switchView('${k}')">
            <div class="stat-icon-box ${meta.color}">${meta.icon}</div>
            <div class="stat-text"><h3>${num}</h3><p>${meta.label}</p></div>
        </div>`;
    }).join('');
}

function renderList() {
    const container = document.getElementById('listBody');
    let list = APP.view === 'member' ? APP.data.members : APP.data.achievements;
    
    // è¿‡æ»¤
    if(APP.view !== 'all' && APP.view !== 'member') list = list.filter(i => i.type === APP.view);
    if(APP.search) {
        const q = APP.search.toLowerCase();
        list = list.filter(i => Object.values(i).join(' ').toLowerCase().includes(q));
    }
    
    // å¹´ä»½ç­›é€‰
    if(APP.view !== 'member') {
        const years = [...new Set(list.map(i => (i.date||i.applicationDate||i.projectStartDate||'').substr(0,4)).filter(y=>y))].sort().reverse();
        const sel = document.getElementById('yearFilter');
        sel.innerHTML = '<option value="all">æ‰€æœ‰å¹´ä»½</option>' + years.map(y => `<option value="${y}" ${APP.yearFilter===y?'selected':''}>${y}å¹´</option>`).join('');
        if(APP.yearFilter !== 'all') list = list.filter(i => (i.date||i.applicationDate||i.projectStartDate||'').startsWith(APP.yearFilter));
    }

    // æ’åº
    list.sort((a,b) => {
        const da = a.date || '0', db = b.date || '0';
        return APP.sort === 'date-desc' ? (da<db?1:-1) : (da>db?1:-1);
    });

    document.getElementById('resultCount').innerText = `å…± ${list.length} æ¡`;

    if(list.length === 0) {
        container.innerHTML = `<div class="empty-state">æš‚æ— æ•°æ®</div>`;
        return;
    }

    container.innerHTML = list.map(item => {
        const t = APP.types[item.type || 'paper'];
        const title = item.title || item.patentName || item.projectName || item.memberName;
        const date = item.date || item.applicationDate || item.projectStartDate || item.memberBirth || '-';
        const sub = item.authors || item.inventors || item.memberOrg || '-';
        const tag = item.level || item.patentStatus || item.projectLevel || item.memberTitle || '';
        const isSel = APP.selected.has(item.id);
        
        return `<div class="table-row" onclick="editItem('${item.id}')">
            <div><input type="checkbox" class="row-check" ${isSel?'checked':''} onclick="toggleItem('${item.id}', event)"></div>
            <div class="cell-title" style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:1.2rem;">${t.icon}</span> ${title}
            </div>
            <div class="cell-meta">${date}</div>
            <div class="cell-meta">${sub}</div>
            <div class="cell-tag">
                ${tag ? `<span>${tag}</span>` : ''}
                ${item.pdfData ? '<span style="background:#e0f2fe;color:#0284c7">ğŸ“ PDF</span>' : ''}
            </div>
            <div class="cell-actions">
                ${item.pdfData ? `<button class="icon-btn" onclick="viewPdf('${item.id}');event.stopPropagation()">ğŸ‘</button>` : ''}
                <button class="icon-btn" onclick="editItem('${item.id}');event.stopPropagation()">âœ</button>
                <button class="icon-btn del" onclick="delItem('${item.id}');event.stopPropagation()">ğŸ—‘</button>
            </div>
        </div>`;
    }).join('');
}

// 4. äº¤äº’
function switchView(v) {
    APP.view = v; APP.search = ''; APP.selected.clear();
    document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.id === `nav-${v}`));
    document.getElementById('pageTitle').innerText = v === 'member' ? 'æˆå‘˜ä¿¡æ¯' : APP.types[v]?.label || 'å…¨éƒ¨æˆæœ';
    document.getElementById('addBtnText').innerText = v === 'member' ? 'æ·»åŠ æˆå‘˜' : 'æ·»åŠ æˆæœ';
    document.getElementById('batchDelBtn').style.display = 'none';
    document.getElementById('selectAll').checked = false;
    
    // Mobile Drawer Close
    if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
    
    renderList();
}

function handleSearch(val) { APP.search = val; renderList(); }
function applyFilter() { APP.yearFilter = document.getElementById('yearFilter').value; renderList(); }
function handleSort(val) { APP.sort = val; renderList(); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

// 5. æ•°æ®ç®¡ç† (Data Manager Modal)
function openDataManager() { document.getElementById('dataModal').classList.add('active'); }
function closeDataModal() { document.getElementById('dataModal').classList.remove('active'); }

// 6. æ–°å¢/ç¼–è¾‘ (CRUD)
function openAddModal() {
    document.getElementById('mainForm').reset();
    document.getElementById('editId').value = '';
    APP.currentFile = null;
    document.getElementById('filePreview').style.display = 'none';
    document.getElementById('formTitle').innerText = 'æ–°å¢è®°å½•';
    
    const type = (APP.view === 'all' || APP.view === 'analysis') ? 'paper' : APP.view;
    document.getElementById('inputType').value = type;
    document.getElementById('inputType').disabled = false;
    updateFormLayout();
    document.getElementById('editModal').classList.add('active');
}

function updateFormLayout() {
    const type = document.getElementById('inputType').value;
    const fields = APP.schema[type];
    const container = document.getElementById('dynamicFields');
    
    container.innerHTML = fields.map(f => {
        let inputHtml = '';
        if(f.type === 'select') {
            inputHtml = `<select id="f_${f.id}" class="form-input">${f.opts.map(o=>`<option>${o}</option>`).join('')}</select>`;
        } else {
            inputHtml = `<input type="${f.type}" id="f_${f.id}" class="form-input" ${f.required?'required':''} placeholder="${f.placeholder||''}">`;
        }
        return `<div class="form-group ${f.full?'form-full':''}"><label class="form-label">${f.label}</label>${inputHtml}</div>`;
    }).join('');
    
    // File upload logic
    document.getElementById('fileSection').style.display = type === 'member' ? 'none' : 'block';
}

function submitForm() {
    const id = document.getElementById('editId').value;
    const type = document.getElementById('inputType').value;
    const fields = APP.schema[type];
    
    const newItem = {
        id: id || Date.now().toString(),
        type: type,
        updatedAt: new Date().toISOString()
    };
    
    // Collect data
    fields.forEach(f => {
        newItem[f.id] = document.getElementById(`f_${f.id}`).value;
    });
    
    // Handle File
    if (APP.currentFile) {
        newItem.pdfData = APP.currentFile.data;
        newItem.pdfName = APP.currentFile.name;
    } else if (id) {
        // Keep old file
        const old = (type==='member'?APP.data.members:APP.data.achievements).find(i=>i.id===id);
        if(old && old.pdfData) {
            newItem.pdfData = old.pdfData;
            newItem.pdfName = old.pdfName;
        }
    }

    // Save
    if (type === 'member') {
        if(id) {
            const idx = APP.data.members.findIndex(m=>m.id===id);
            APP.data.members[idx] = newItem;
        } else APP.data.members.push(newItem);
    } else {
        if(id) {
            const idx = APP.data.achievements.findIndex(a=>a.id===id);
            APP.data.achievements[idx] = newItem;
        } else APP.data.achievements.push(newItem);
    }
    
    persist();
    closeEditModal();
    updateUI();
    showToast('ä¿å­˜æˆåŠŸ');
}

function editItem(id) {
    const item = [...APP.data.achievements, ...APP.data.members].find(i=>i.id===id);
    if(!item) return;

    document.getElementById('editId').value = id;
    document.getElementById('formTitle').innerText = 'ç¼–è¾‘è®°å½•';
    document.getElementById('inputType').value = item.type;
    document.getElementById('inputType').disabled = true;
    updateFormLayout();

    // Fill data
    APP.schema[item.type].forEach(f => {
        if(document.getElementById(`f_${f.id}`)) document.getElementById(`f_${f.id}`).value = item[f.id] || '';
    });

    // File
    if(item.pdfData) {
        document.getElementById('fileName').innerText = item.pdfName;
        document.getElementById('filePreview').style.display = 'flex';
    } else {
        document.getElementById('filePreview').style.display = 'none';
    }

    document.getElementById('editModal').classList.add('active');
}

function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }

// 7. æ–‡ä»¶æ“ä½œ
function handleFile(input) {
    const f = input.files[0];
    if(!f) return;
    if(f.size > 50*1024*1024) return showToast('æ–‡ä»¶è¿‡å¤§ (>50MB)','warning');
    const r = new FileReader();
    r.onload = e => {
        APP.currentFile = { name: f.name, data: e.target.result };
        document.getElementById('fileName').innerText = f.name;
        document.getElementById('filePreview').style.display = 'flex';
    };
    r.readAsDataURL(f);
}
function removeFile() { APP.currentFile = null; document.getElementById('filePreview').style.display = 'none'; document.getElementById('pdfInput').value=''; }

function viewPdf(id) {
    const item = APP.data.achievements.find(i=>i.id===id);
    if(item && item.pdfData) {
        const win = window.open();
        const iframe = `<iframe width="100%" height="100%" src="${item.pdfData}"></iframe>`;
        win.document.write(iframe);
    }
}

// 8. æ‰¹é‡åˆ é™¤
function toggleSelectAll() {
    const all = document.getElementById('selectAll').checked;
    const boxes = document.querySelectorAll('.row-check');
    boxes.forEach(b => {
        b.checked = all;
        const id = b.parentElement.parentElement.getAttribute('onclick').match(/'(.*?)'/)[1];
        if(all) APP.selected.add(id); else APP.selected.delete(id);
    });
    updateBatchUI();
}
function toggleItem(id, e) {
    e.stopPropagation();
    if(APP.selected.has(id)) APP.selected.delete(id); else APP.selected.add(id);
    updateBatchUI();
}
function updateBatchUI() {
    document.getElementById('selCount').innerText = `(${APP.selected.size})`;
    document.getElementById('batchDelBtn').style.display = APP.selected.size ? 'inline-block' : 'none';
}
function delItem(id) {
    if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
    APP.data.achievements = APP.data.achievements.filter(i=>i.id!==id);
    APP.data.members = APP.data.members.filter(i=>i.id!==id);
    persist(); updateUI();
}
function batchDelete() {
    if(!confirm('ç¡®å®šåˆ é™¤é€‰ä¸­çš„è®°å½•ï¼Ÿ')) return;
    APP.data.achievements = APP.data.achievements.filter(i=>!APP.selected.has(i.id));
    APP.data.members = APP.data.members.filter(i=>!APP.selected.has(i.id));
    APP.selected.clear();
    persist(); updateUI();
}

// 9. å¯¼å…¥å¯¼å‡º (å®Œç¾ç‰ˆ)
function backupJSON() {
    const blob = new Blob([JSON.stringify(APP.data)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `DataBackup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}
function restoreJSON(input) {
    const f = input.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        try {
            APP.data = JSON.parse(e.target.result);
            persist();
            location.reload();
        } catch(err) { showToast('æ–‡ä»¶æ ¼å¼é”™è¯¯','error'); }
    };
    r.readAsText(f);
}

// --- Excel åˆ†è¡¨åˆ†åˆ—å¯¼å‡º ---
function exportToExcel() {
    const wb = XLSX.utils.book_new();
    const types = ['paper','patent','project','award','book','member'];
    
    types.forEach(t => {
        const dataList = t==='member' ? APP.data.members : APP.data.achievements.filter(i=>i.type===t);
        if(dataList.length > 0) {
            const schema = APP.schema[t];
            const rows = dataList.map(item => {
                const row = {};
                schema.forEach(f => row[f.label] = item[f.id] || '');
                return row;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), APP.types[t].label);
        }
    });

    if(wb.SheetNames.length===0) return showToast('æ— æ•°æ®','warning');
    XLSX.writeFile(wb, "ç§‘ç ”æ•°æ®åˆ†è¡¨å¯¼å‡º.xlsx");
}

function importExcel(input) {
    const f = input.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws);
        // Simplified Import (Assumes papers if generic)
        json.forEach(row => {
            const newItem = { id: Date.now()+Math.random(), type:'paper', title: row['æ ‡é¢˜']||'æœªå‘½å', date: new Date().toISOString().slice(0,10) };
            APP.data.achievements.push(newItem);
        });
        persist(); updateUI(); showToast(`å¯¼å…¥ ${json.length} æ¡æ•°æ®`);
    };
    r.readAsArrayBuffer(f);
}

// --- Word åˆ†è¡¨å¯¼å‡º ---
function exportToWord() {
    let html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><style>table{width:100%;border-collapse:collapse;margin-bottom:20px} th,td{border:1px solid #000;padding:5px;font-size:10pt} th{background:#eee}</style></head><body><h2>ç§‘ç ”æ±‡æ€»</h2>`;
    
    const types = ['paper','patent','project','award','book','member'];
    types.forEach(t => {
        const dataList = t==='member' ? APP.data.members : APP.data.achievements.filter(i=>i.type===t);
        if(dataList.length > 0) {
            const schema = APP.schema[t];
            html += `<h3>${APP.types[t].label}</h3><table><tr>${schema.map(f=>`<th>${f.label}</th>`).join('')}</tr>`;
            dataList.forEach(item => {
                html += `<tr>${schema.map(f=>`<td>${item[f.id]||''}</td>`).join('')}</tr>`;
            });
            html += `</table>`;
        }
    });

    html += `</body></html>`;
    const blob = new Blob([html], {type:'application/msword'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ç§‘ç ”æ•°æ®æ±‡æ€».doc';
    a.click();
}

// 10. äº‘åŒæ­¥ (GitHub Gist)
function openCloudConfig() { document.getElementById('ghToken').value = APP.config.token; document.getElementById('cloudModal').classList.add('active'); }
function closeCloudModal() { document.getElementById('cloudModal').classList.remove('active'); }

async function connectCloud() {
    const token = document.getElementById('ghToken').value;
    const gistId = document.getElementById('ghGistId').value;
    if(!token) return showToast('Token å¿…å¡«','error');
    
    showToast('è¿æ¥ä¸­...','warning');
    try {
        if(gistId) {
            APP.config = {token, gistId}; await syncCloud(true);
        } else {
            const res = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: { Authorization: `token ${token}` },
                body: JSON.stringify({ description:"Research Data", public:false, files:{"data.json":{content:JSON.stringify({achievements:APP.data.achievements, members:APP.data.members})}} })
            });
            if(res.ok) {
                const d = await res.json();
                APP.config = {token, gistId:d.id};
                persist(); checkCloudStatus(); showToast('äº‘ç«¯åˆ›å»ºæˆåŠŸ');
                closeCloudModal();
            } else throw new Error();
        }
    } catch(e) { showToast('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ/Token','error'); }
}

async function syncCloud(isPull) {
    if(!APP.config.token) return;
    const url = `https://api.github.com/gists/${APP.config.gistId}`;
    const headers = { Authorization: `token ${APP.config.token}` };
    
    if(isPull) {
        try {
            const res = await fetch(url, {headers});
            const d = await res.json();
            const content = JSON.parse(d.files['data.json'].content);
            APP.data = content; persist(); updateUI(); showToast('å·²ä»äº‘ç«¯åŒæ­¥');
        } catch(e) { showToast('åŒæ­¥å¤±è´¥','error'); }
    } else {
        // Push (Remove heavy PDF for cloud sync efficiency if needed, but keeping for now)
        const leanData = { 
            achievements: APP.data.achievements.map(i => { const {pdfData, ...r} = i; return r; }), 
            members: APP.data.members 
        };
        fetch(url, {
            method: 'PATCH', headers,
            body: JSON.stringify({ files: {"data.json": {content: JSON.stringify(leanData)}} })
        });
    }
}

function checkCloudStatus() {
    if(APP.config.token) {
        document.getElementById('cloudDot').classList.add('online');
        document.getElementById('cloudText').innerText = 'äº‘ç«¯å·²è¿æ¥';
        document.getElementById('cloudDot').style.background = 'var(--success)';
    }
}

// Toast
function showToast(msg, type='success') {
    const div = document.createElement('div');
    div.className = `toast-msg show`;
    div.style.borderLeftColor = type==='error'?'var(--danger)':'var(--success)';
    div.innerText = msg;
    document.getElementById('toastBox').appendChild(div);
    setTimeout(() => div.remove(), 2000);
}

window.onload = loadData;
</script>
</body>
</html>

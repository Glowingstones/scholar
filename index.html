<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- ä¿æŒæ‚¨åŸæœ‰çš„ CSS å˜é‡å’ŒåŸºç¡€æ ·å¼ --- */
        :root {
            --bg-primary: #f8fafc; --bg-secondary: #ffffff; --bg-card: #ffffff; --bg-hover: #f1f5f9;
            --text-primary: #1e293b; --text-secondary: #64748b; --text-muted: #94a3b8;
            --border: #e2e8f0; --border-light: #f1f5f9;
            --accent: #6366f1; --accent-light: #eef2ff; --accent-dark: #4f46e5;
            --success: #10b981; --success-light: #d1fae5;
            --warning: #f59e0b; --warning-light: #fef3c7;
            --danger: #ef4444; --danger-light: #fee2e2;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.1);
            --radius: 12px; --radius-sm: 8px;
            --od-blue: #0078D4; --od-hover: #005a9e; --od-light: #f3f9fd;
        }
        /* æš—é»‘æ¨¡å¼æ ·å¼æ”¯æŒ */
        html.dark {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #1e293b; --bg-hover: #334155;
            --text-primary: #f1f5f9; --text-secondary: #94a3b8; --text-muted: #64748b;
            --border: #334155; --border-light: #1e293b;
            --accent-light: #312e81; --success-light: #064e3b; --warning-light: #78350f; --danger-light: #7f1d1d; --od-light: #002c4e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans SC', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        .app-container { display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar & Menu */
        .sidebar { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; transition: transform 0.3s; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; }
        .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
        .nav-menu { flex: 1; padding: 16px 12px; overflow-y: auto; }
        .nav-section { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); padding: 12px 12px 8px; margin-top: 8px; text-transform: uppercase; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary); font-weight: 500; margin-bottom: 4px; transition: all 0.2s; }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-light); color: var(--accent); }
        .nav-item.disabled { opacity: 0.5; pointer-events: none; }
        .nav-item .badge { margin-left: auto; background: var(--bg-hover); padding: 2px 10px; border-radius: 10px; font-size: 0.8rem; }
        .nav-item.active .badge { background: var(--accent); color: white; }
        
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
        .storage-status { font-size: 0.85rem; color: var(--success); margin-bottom: 12px; }
        .storage-status.warning { color: var(--warning); }
        .data-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .data-btn { padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text-secondary); cursor: pointer; text-align: center; }
        .data-btn:hover { border-color: var(--accent); color: var(--accent); }
        .data-btn.onedrive { border-color: var(--od-blue); color: var(--od-blue); }
        .dropdown-menu { position: absolute; bottom: 100%; left: 10px; right: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: var(--shadow-lg); display: none; z-index: 200; }
        .dropdown-menu.show { display: block; }
        .menu-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-light); }
        .menu-item:hover { background: var(--bg-hover); color: var(--accent); }

        /* Main Content */
        .main-content { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0; }
        .page-title { font-size: 1.5rem; font-weight: 700; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .search-box input { padding: 12px 16px; border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg-card); color: var(--text-primary); width: 240px; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px; flex-shrink: 0; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .stat-icon.papers { background: #dbeafe; } .stat-icon.patents { background: #fef3c7; } .stat-icon.projects { background: #d1fae5; } 
        .stat-icon.awards { background: #fce7f3; } .stat-icon.books { background: #e0e7ff; } .stat-icon.members { background: #f3e8ff; }
        .stat-info h3 { font-size: 1.2rem; font-weight: 700; }

        /* List View & Filters */
        .filter-container { margin-bottom: 12px; flex-shrink: 0; }
        .filter-bar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .filter-chip { padding: 6px 14px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border); cursor: pointer; font-size: 0.85rem; }
        .filter-chip.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        /* --- æ–°å¢ï¼šæ—¥æœŸèŒƒå›´ç­›é€‰æ ·å¼ --- */
        .date-range-group { display: flex; align-items: center; gap: 8px; background: var(--bg-card); padding: 4px 10px; border: 1px solid var(--border); border-radius: 20px; }
        .date-range-group input { border: none; background: transparent; color: var(--text-secondary); width: 110px; font-size: 0.85rem; }
        .date-range-group input:focus { outline: none; color: var(--accent); }

        .results-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .results-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
        .results-list { flex: 1; overflow-y: auto; }
        .result-item { display: flex; align-items: flex-start; padding: 12px 16px; border-bottom: 1px solid var(--border-light); cursor: pointer; transition: background 0.2s; gap: 12px; }
        .result-item:hover { background: var(--bg-hover); }
        .result-checkbox { margin-top: 4px; }
        .result-type { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .type-paper { background: #dbeafe; } .type-patent { background: #fef3c7; } .type-project { background: #d1fae5; } 
        .type-award { background: #fce7f3; } .type-book { background: #e0e7ff; } .type-member { background: #f3e8ff; }
        
        .result-content { flex: 1; min-width: 0; }
        .result-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 6px; color: var(--text-primary); }
        .result-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; }
        .result-meta span { display: inline-flex; align-items: center; gap: 3px; background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; }
        .result-actions { display: flex; gap: 6px; align-items: center; }

        /* Buttons */
        .btn { padding: 10px 20px; border-radius: var(--radius); font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; }
        .btn-secondary { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .action-btn { width: 32px; height: 32px; border: none; background: var(--bg-hover); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .action-btn:hover { background: var(--accent-light); color: var(--accent); }

        /* --- æ–°å¢ï¼šåˆ†é¡µæ§ä»¶æ ·å¼ --- */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; padding: 12px; border-top: 1px solid var(--border); background: var(--bg-secondary); }
        .pagination button { background: var(--bg-card); border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Modals & Forms */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; visibility: hidden; opacity: 0; transition: 0.3s; backdrop-filter: blur(4px); }
        .modal-overlay.active { visibility: visible; opacity: 1; }
        .modal { background: var(--bg-card); width: 90%; max-width: 650px; max-height: 90vh; border-radius: var(--radius); display: flex; flex-direction: column; overflow: hidden; transform: translateY(20px); transition: 0.3s; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        /* --- æ–°å¢ï¼šä¸€é”®è·å–æŒ‰é’®æ ·å¼ --- */
        .input-group { display: flex; gap: 8px; }
        .btn-fetch { background: var(--accent-light); color: var(--accent); border: 1px solid var(--accent); padding: 0 12px; border-radius: var(--radius-sm); cursor: pointer; white-space: nowrap; font-size: 0.85rem; }
        .btn-fetch:hover { background: var(--accent); color: white; }

        /* Login Overlay */
        .login-overlay { position: fixed; inset: 0; background: var(--bg-primary); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .login-box { background: var(--bg-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-lg); width: 360px; text-align: center; border: 1px solid var(--border); }
        
        /* Toast & Others */
        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; }
        .toast { padding: 12px 24px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 10px; transform: translateY(-100%); transition: 0.3s; opacity: 0; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-color: var(--success); color: var(--success); }
        .toast.error { border-color: var(--danger); color: var(--danger); }
        
        /* è¯¦æƒ…é¡µæ ·å¼ */
        .detail-row { display: flex; padding: 12px 0; border-bottom: 1px solid var(--border-light); }
        .detail-label { width: 100px; font-weight: 600; color: var(--text-secondary); flex-shrink: 0; }
        .detail-value { color: var(--text-primary); flex: 1; word-break: break-all; }
        
        /* ç§»åŠ¨ç«¯ */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -280px; height: 100%; transition: 0.3s; }
            .sidebar.open { left: 0; }
            .mobile-menu-btn { display: block; position: fixed; top: 10px; left: 10px; z-index: 101; padding: 8px; background: var(--bg-card); border-radius: 4px; box-shadow: var(--shadow); }
            .header-actions { width: 100%; justify-content: space-between; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .form-row { grid-template-columns: 1fr; }
        }
        @media (min-width: 769px) { .mobile-menu-btn { display: none; } }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-overlay">
    <div class="login-box">
        <div class="logo-icon" style="margin: 0 auto 20px auto;">ğŸ”¬</div>
        <h2 style="margin-bottom: 10px;">ç§‘ç ”æˆæœç®¡ç†</h2>
        <p style="color:var(--text-secondary); margin-bottom: 20px;">è¯·è¾“å…¥ç³»ç»Ÿè®¿é—®å¯†ç </p>
        <div class="form-group">
            <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ..." onkeyup="if(event.key==='Enter') checkLogin()">
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="checkLogin()">ç™»å½•è¿›å…¥</button>
        <div style="margin-top:15px; font-size:0.8rem; color:var(--text-muted);">
            ç®¡ç†å‘˜: **** | å®¾å®¢: guest
        </div>
    </div>
</div>

<button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">ğŸ”¬</div>
                <div>
                    <div>ç§‘ç ”æˆæœç®¡ç†</div>
                    <div style="font-size:0.7rem;color:var(--text-muted);">æ”¯æŒ OneDrive äº‘åŒæ­¥</div>
                </div>
            </div>
        </div>

        <nav class="nav-menu">
            <div class="nav-section">æˆæœç®¡ç†</div>
            <div class="nav-item active" data-view="all" onclick="setView('all')">
                ğŸ“‹ <span>å…¨éƒ¨æˆæœ</span> <span class="badge" id="totalCount">0</span>
            </div>
            <div class="nav-item" data-view="paper" onclick="setView('paper')">
                ğŸ“„ <span>å­¦æœ¯è®ºæ–‡</span> <span class="badge" id="paperCount">0</span>
            </div>
            <div class="nav-item" data-view="patent" onclick="setView('patent')">
                ğŸ’¡ <span>å‘æ˜ä¸“åˆ©</span> <span class="badge" id="patentCount">0</span>
            </div>
            <div class="nav-item" data-view="project" onclick="setView('project')">
                ğŸ“Š <span>ç§‘ç ”é¡¹ç›®</span> <span class="badge" id="projectCount">0</span>
            </div>
            <div class="nav-item" data-view="award" onclick="setView('award')">
                ğŸ† <span>è·å¥–æƒ…å†µ</span> <span class="badge" id="awardCount">0</span>
            </div>
            <div class="nav-item" data-view="book" onclick="setView('book')">
                ğŸ“š <span>ä¸“è‘—å‡ºç‰ˆ</span> <span class="badge" id="bookCount">0</span>
            </div>
            <div class="nav-section">å›¢é˜Ÿç®¡ç†</div>
            <div class="nav-item" data-view="member" id="navMember" onclick="setView('member')">
                ğŸ‘¥ <span>æˆå‘˜ä¿¡æ¯</span> <span class="badge" id="memberCount">0</span>
            </div>
            <div class="nav-section">ç³»ç»Ÿç®¡ç†</div>
            <div class="nav-item" data-view="recycle" onclick="setView('recycle')">
                â™»ï¸ <span>å›æ”¶ç«™</span> <span class="badge" id="recycleCount">0</span>
            </div>
            <div class="nav-item" data-view="logs" onclick="setView('logs')">
                ğŸ“œ <span>æ“ä½œæ—¥å¿—</span>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="storage-status" id="storageStatus">âœ“ æ•°æ®å·²æœ¬åœ°ä¿å­˜</div>
            <div class="data-actions">
                <button class="data-btn" id="btnExport" onclick="toggleMenu('exportMenu')">ğŸ“¤ å¯¼å‡º</button>
                <button class="data-btn" id="btnImport" onclick="toggleMenu('importMenu')">ğŸ“¥ å¯¼å…¥</button>
                <button class="data-btn onedrive" id="btnOneDrive" onclick="openBackupModal()" style="grid-column: span 2;">
                    â˜ï¸ OneDrive åŒæ­¥/å¤‡ä»½
                </button>
            </div>
            
            <div id="exportMenu" class="dropdown-menu">
                <div class="menu-item" onclick="exportToExcelFile()">ğŸ“Š å¯¼å‡º Excel</div>
                <div class="menu-item" onclick="exportToWordFile()">ğŸ“ å¯¼å‡º Word</div>
                <div class="menu-item" id="menuExportJson" onclick="exportData()">ğŸ“¦ å¯¼å‡ºçº¯ JSON</div>
            </div>
            <div id="importMenu" class="dropdown-menu">
                <div class="menu-item" onclick="openExcelImport()">ğŸ“Š å¯¼å…¥ Excel</div>
                <div class="menu-item" onclick="triggerImport()">ğŸ“‚ æ¢å¤ JSON</div>
            </div>
            <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(event)">
            
            <button class="btn btn-sm btn-secondary" onclick="location.reload()" style="width:100%; margin-top:10px;">ğŸ”’ é€€å‡ºç™»å½•</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <h1 class="page-title" id="pageTitle">å…¨éƒ¨æˆæœ</h1>
            <div class="header-actions">
                <button class="btn btn-secondary btn-sm" onclick="toggleDarkMode()">ğŸŒ“</button>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢..." oninput="handleSearch()">
                </div>
                <button class="btn btn-primary" id="addBtn" onclick="openAddModal()">â• <span id="addBtnText">æ·»åŠ </span></button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
             <div class="stat-card" onclick="setView('paper')"><div class="stat-icon papers">ğŸ“„</div><div class="stat-info"><h3 id="statPaper">0</h3><p>è®ºæ–‡</p></div></div>
             <div class="stat-card" onclick="setView('patent')"><div class="stat-icon patents">ğŸ’¡</div><div class="stat-info"><h3 id="statPatent">0</h3><p>ä¸“åˆ©</p></div></div>
             <div class="stat-card" onclick="setView('project')"><div class="stat-icon projects">ğŸ“Š</div><div class="stat-info"><h3 id="statProject">0</h3><p>é¡¹ç›®</p></div></div>
             <div class="stat-card" onclick="setView('award')"><div class="stat-icon awards">ğŸ†</div><div class="stat-info"><h3 id="statAward">0</h3><p>è·å¥–</p></div></div>
             <div class="stat-card" onclick="setView('book')"><div class="stat-icon books">ğŸ“š</div><div class="stat-info"><h3 id="statBook">0</h3><p>è‘—ä½œ</p></div></div>
             <div class="stat-card" onclick="setView('member')"><div class="stat-icon members">ğŸ‘¥</div><div class="stat-info"><h3 id="statMember">0</h3><p>æˆå‘˜</p></div></div>
        </div>

        <div id="listViewContainer">
            <div class="filter-container">
                <div class="filter-bar" id="filterBar">
                    <div class="filter-chip active" data-year="all" onclick="setYearFilter('all')">å…¨éƒ¨å¹´ä»½</div>
                    <div class="date-range-group">
                        <input type="date" id="dateStart" onchange="handleDateRange()" title="å¼€å§‹æ—¥æœŸ">
                        <span>-</span>
                        <input type="date" id="dateEnd" onchange="handleDateRange()" title="ç»“æŸæ—¥æœŸ">
                    </div>
                </div>
                <div class="keyword-bar" id="keywordBar" style="display:none;"></div>
            </div>

            <div class="results-container" id="resultsContainer">
                <div class="results-header">
                    <div class="batch-actions">
                        <label class="select-all-wrapper">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <span>å…¨é€‰</span>
                        </label>
                        <button class="btn btn-danger btn-sm" id="batchDeleteBtn" onclick="batchDelete()" style="display:none;">
                            ğŸ—‘ åˆ é™¤ (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span class="results-count" id="resultsCount">å…± 0 æ¡</span>
                        <select id="sortSelect" onchange="handleSort()" style="padding:8px; border-radius:6px; border:1px solid var(--border);">
                            <option value="date-desc">æœ€æ–°ä¼˜å…ˆ</option>
                            <option value="date-asc">æœ€æ—©ä¼˜å…ˆ</option>
                            <option value="title-asc">æ ‡é¢˜æ’åº</option>
                        </select>
                    </div>
                </div>
                <div class="results-list" id="resultsList"></div>
                <div class="pagination" id="pagination" style="display:none;">
                    <button onclick="changePage(-1)">â—€ ä¸Šä¸€é¡µ</button>
                    <span id="pageIndicator">1 / 1</span>
                    <button onclick="changePage(1)">ä¸‹ä¸€é¡µ â–¶</button>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="formModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="modalTitle">æ·»åŠ ç§‘ç ”æˆæœ</h2>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="researchForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label>æˆæœç±»å‹ *</label>
                        <select id="type" required onchange="toggleFormFields()">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                            <option value="patent">å‘æ˜ä¸“åˆ©</option>
                            <option value="project">ç§‘ç ”é¡¹ç›®</option>
                            <option value="award">è·å¥–æƒ…å†µ</option>
                            <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                        </select>
                    </div>
                    <div class="form-group" id="dateGroup">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="date">
                    </div>
                </div>
                
                <div id="generalFields">
                    <div class="form-group"><label>æ ‡é¢˜ *</label><input type="text" id="title" placeholder="è¯·è¾“å…¥æˆæœæ ‡é¢˜"></div>
                    <div class="form-group"><label>ä½œè€…/æˆå‘˜</label><input type="text" id="authors" placeholder="å¤šä¸ªä½œè€…ç”¨é€—å·åˆ†éš”"></div>
                    <div class="form-row"><div class="form-group"><label>æ¥æº/æœŸåˆŠ</label><input type="text" id="source"></div><div class="form-group"><label>çº§åˆ«</label><input type="text" id="level"></div></div>
                    <div class="form-group">
                        <label>DOI (å¯è‡ªåŠ¨è·å–)</label>
                        <div class="input-group">
                            <input type="text" id="doi" placeholder="ä¾‹å¦‚: 10.1109/XXX.2023.XXX">
                            <button type="button" class="btn-fetch" onclick="fetchMetadata('doi')">ğŸª„ è·å–</button>
                        </div>
                    </div>
                </div>
                
                <div id="patentFields" class="hidden">
                    <div class="form-group"><label>ä¸“åˆ©åç§° *</label><input type="text" id="patentName"></div>
                    <div class="form-row"><div class="form-group"><label>ç±»å‹</label><select id="patentType"><option value="å‘æ˜ä¸“åˆ©">å‘æ˜ä¸“åˆ©</option><option value="å®ç”¨æ–°å‹">å®ç”¨æ–°å‹</option><option value="å¤–è§‚è®¾è®¡">å¤–è§‚è®¾è®¡</option></select></div><div class="form-group"><label>çŠ¶æ€</label><select id="patentStatus"><option value="å—ç†">å—ç†</option><option value="æˆæƒ">æˆæƒ</option><option value="å®¡ä¸­">å®¡ä¸­</option><option value="å¤±æ•ˆ">å¤±æ•ˆ</option></select></div></div>
                    <div class="form-row"><div class="form-group"><label>å‘æ˜äºº</label><input type="text" id="inventors"></div><div class="form-group"><label>ä¸“åˆ©æƒäºº</label><input type="text" id="patentOwner"></div></div>
                    <div class="form-row"><div class="form-group"><label>ç”³è¯·æ—¥</label><input type="date" id="applicationDate"></div><div class="form-group"><label>æˆæƒæ—¥</label><input type="date" id="grantDate"></div></div>
                    <div class="form-group"><label>ä¸“åˆ©å·</label><input type="text" id="patentNumber"></div>
                </div>
                
                <div id="projectFields" class="hidden">
                    <div class="form-group"><label>é¡¹ç›®åç§° *</label><input type="text" id="projectName"></div>
                    <div class="form-row"><div class="form-group"><label>çº§åˆ«</label><input type="text" id="projectLevel"></div><div class="form-group"><label>ç¼–å·</label><input type="text" id="projectNumber"></div></div>
                    <div class="form-row"><div class="form-group"><label>å¼€å§‹</label><input type="date" id="projectStartDate"></div><div class="form-group"><label>ç»“æŸ</label><input type="date" id="projectEndDate"></div></div>
                    <div class="form-group"><label>å•ä½</label><input type="text" id="projectOrg"></div>
                </div>
                
                <div id="awardFields" class="hidden">
                    <div class="form-group"><label>å¥–é¡¹åç§° *</label><input type="text" id="awardName"></div>
                    <div class="form-group"><label>è·å¥–äºº</label><input type="text" id="awardRecipients"></div>
                    <div class="form-row"><div class="form-group"><label>æˆå¥–å•ä½</label><input type="text" id="awardAgency"></div><div class="form-group"><label>è·å¥–çº§åˆ«</label><input type="text" id="awardLevel"></div></div>
                    <div class="form-group"><label>è·å¥–æ—¥æœŸ</label><input type="date" id="awardDate"></div>
                </div>
                
                <div id="bookFields" class="hidden">
                    <div class="form-group"><label>è‘—ä½œåç§° *</label><input type="text" id="bookTitle"></div>
                    <div class="form-group"><label>ä½œè€…</label><input type="text" id="bookAuthors"></div>
                    <div class="form-row"><div class="form-group"><label>å‡ºç‰ˆç¤¾</label><input type="text" id="bookPublisher"></div>
                    <div class="form-group">
                        <label>ISBN (å¯è‡ªåŠ¨è·å–)</label>
                        <div class="input-group">
                            <input type="text" id="bookIsbn">
                            <button type="button" class="btn-fetch" onclick="fetchMetadata('isbn')">ğŸª„ è·å–</button>
                        </div>
                    </div></div>
                    <div class="form-group"><label>å‡ºç‰ˆæ—¥æœŸ</label><input type="date" id="bookDate"></div>
                </div>

                <div class="form-group">
                    <label>ğŸ“ é™„ä»¶ (PDF, Word, Excel, PPT, Zip ç­‰)</label>
                    <div class="file-upload" id="fileUpload" onclick="document.getElementById('pdfInput').click()">
                        <input type="file" id="pdfInput" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.7z,.txt" onchange="handleFileSelect(event)">
                        <div class="file-upload-icon">ğŸ“„</div>
                        <div class="file-upload-text">ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</div>
                    </div>
                    <div class="file-info hidden" id="fileInfo">
                        <span class="file-info-name"><span>ğŸ“„</span><span id="fileName"></span></span>
                        <button type="button" class="file-remove" onclick="removeFile()">âœ•</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="submit" form="researchForm" class="btn btn-primary" id="submitBtn">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="backupModal">
    <div class="modal">
        <div class="modal-header">
            <h2>â˜ï¸ æ•°æ®åŒæ­¥ä¸å¤‡ä»½</h2>
            <button class="modal-close" onclick="closeBackupModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="backup-section" style="background:var(--od-light); border-color:var(--od-blue);">
                <h4 style="color:var(--od-blue)">â˜ï¸ Microsoft OneDrive åŒæ­¥ (Beta)</h4>
                <div class="backup-info">ç™»å½•å¾®è½¯è´¦å·ï¼Œå°†æ•°æ®åŒæ­¥åˆ° OneDrive ä¸ªäººç©ºé—´ã€‚<br>è·¯å¾„: <code>/Apps/ResearchManager/backup.json</code></div>
                <div id="onedrive-login-panel">
                     <button class="btn btn-od" onclick="OneDriveService.signIn()" style="width:100%">ğŸ”‘ ç™»å½•å¾®è½¯è´¦å·</button>
                </div>
                <div id="onedrive-actions-panel" class="hidden">
                    <div class="user-profile">
                        <div class="user-avatar" id="odUserInitials">?</div>
                        <div style="flex:1;overflow:hidden;">
                            <div style="font-weight:600;font-size:0.9rem;" id="odUserName">User</div>
                            <div style="font-size:0.75rem;color:var(--text-secondary);" id="odUserEmail">email</div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="OneDriveService.signOut()">æ³¨é”€</button>
                    </div>
                    <div style="display:grid; gap:10px;">
                        <button class="btn btn-od" id="btnOdUpload" onclick="OneDriveService.upload()">â¬†ï¸ ä¸Šä¼ å½“å‰æ•°æ®åˆ°äº‘ç«¯</button>
                        <button class="btn btn-od-outline" id="btnOdDownload" onclick="OneDriveService.download()">â¬‡ï¸ ä»äº‘ç«¯æ¢å¤/åˆå¹¶æ•°æ®</button>
                    </div>
                </div>
            </div>
            <div style="border-top:1px solid var(--border); padding-top:20px; margin-top:20px;">
                <h4 style="margin-bottom:12px;font-size:1rem;">ğŸ’¾ æœ¬åœ°æ–‡ä»¶å¤‡ä»½</h4>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-secondary" id="btnLocalExport" style="flex:1;" onclick="exportData()">å¯¼å‡º JSON</button>
                    <button class="btn btn-secondary" style="flex:1;" onclick="triggerImport()">å¯¼å…¥ JSON</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="detailModal"><div class="modal wide"><div class="modal-header"><h2 id="detailTitle">è¯¦ç»†ä¿¡æ¯</h2><button class="modal-close" onclick="closeDetailModal()">âœ•</button></div><div class="modal-body" id="detailContent"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeDetailModal()">å…³é—­</button><button class="btn btn-primary" id="detailEditBtn" onclick="editFromDetail()">âœ ç¼–è¾‘</button></div></div></div>
<div class="modal-overlay" id="memberModal"><div class="modal wide"><div class="modal-header"><h2 id="memberModalTitle">æ·»åŠ æˆå‘˜</h2><button class="modal-close" onclick="closeMemberModal()">âœ•</button></div><div class="modal-body"><form id="memberForm" onsubmit="handleMemberSubmit(event)"><input type="hidden" id="memberEditId"><div class="form-row"><div class="form-group"><label>å­¦å·/å·¥å· *</label><input type="text" id="memberNo" required></div><div class="form-group"><label>å§“å *</label><input type="text" id="memberName" required></div></div><div class="form-row"><div class="form-group"><label>æ€§åˆ«</label><select id="memberGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div><div class="form-group"><label>æ°‘æ—</label><input type="text" id="memberNation"></div></div><div class="form-group"><label>è¯ä»¶å·ç </label><input type="text" id="memberIdCard" oninput="handleIdCardInput(this)"></div><div class="form-row"><div class="form-group"><label>å‡ºç”Ÿå¹´æœˆ</label><input type="text" id="memberDob"></div><div class="form-group"><label>ç”µè¯</label><input type="text" id="memberPhone"></div></div><div class="form-row"><div class="form-group"><label>å•ä½</label><input type="text" id="memberOrg"></div><div class="form-group"><label>èŒç§°</label><input type="text" id="memberTitle"></div></div><div class="form-group"><label>é‚®ç®±</label><input type="email" id="memberEmail"></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeMemberModal()">å–æ¶ˆ</button><button type="submit" form="memberForm" class="btn btn-primary">ä¿å­˜</button></div></div></div>
<div class="modal-overlay" id="excelModal"><div class="modal wide"><div class="modal-header"><h2>å¯¼å…¥ Excel</h2><button class="modal-close" onclick="closeExcelModal()">âœ•</button></div><div class="modal-body"><div class="form-group"><label>ç±»å‹</label><select id="excelImportType" onchange="updateMappingFields()"><option value="paper">å­¦æœ¯è®ºæ–‡</option><option value="patent">å‘æ˜ä¸“åˆ©</option><option value="project">ç§‘ç ”é¡¹ç›®</option><option value="award">è·å¥–æƒ…å†µ</option><option value="book">ä¸“è‘—å‡ºç‰ˆ</option><option value="member">æˆå‘˜ä¿¡æ¯</option></select></div><div class="form-group"><label>æ–‡ä»¶</label><div class="file-upload" onclick="document.getElementById('excelInput').click()"><input type="file" id="excelInput" accept=".xlsx,.xls,.csv" onchange="handleExcelSelect(event)"><div class="file-upload-icon">ğŸ“Š</div><div class="file-upload-text">ç‚¹å‡»é€‰æ‹© Excel</div></div></div><div id="excelPreviewContainer" class="hidden"><div class="excel-preview" id="excelPreview"></div></div><div id="mappingContainer" class="hidden" style="margin-top:20px;"><div id="mappingFields"></div></div><div id="duplicateWarning" class="duplicate-warning hidden"><h4>âš ï¸ é‡å¤é¡¹</h4><ul class="duplicate-list" id="duplicateList"></ul></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeExcelModal()">å–æ¶ˆ</button><button class="btn btn-primary" id="importExcelBtn" onclick="confirmExcelImport()" disabled>ç¡®è®¤å¯¼å…¥</button></div></div></div>
<div class="modal-overlay" id="confirmModal"><div class="confirm-dialog"><p id="confirmMessage">ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ</p><div class="btn-group"><button class="btn btn-secondary" onclick="closeConfirmModal()">å–æ¶ˆ</button><button class="btn btn-danger" onclick="confirmDelete()">åˆ é™¤</button></div></div></div>
<div class="toast-container" id="toastContainer"></div>

<script>
    // --- Login & Permissions ---
    let currentUserRole = null; 
    function checkLogin() {
        const pwd = document.getElementById('loginPassword').value;
        if (pwd === '1399') { currentUserRole = 'admin'; closeLogin(); showToast('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ', 'success'); }
        else if (pwd === 'guest') { currentUserRole = 'guest'; closeLogin(); showToast('å®¾å®¢ç™»å½•æˆåŠŸ', 'success'); }
        else { showToast("å¯†ç é”™è¯¯", 'error'); }
    }
    function closeLogin() { document.getElementById('loginOverlay').style.display = 'none'; applyPermissions(); }
    
    function applyPermissions() {
        const isAdmin = currentUserRole === 'admin';
        const navMember = document.getElementById('navMember');
        const btnOdUpload = document.getElementById('btnOdUpload');
        const btnLocalExport = document.getElementById('btnLocalExport');
        const menuExportJson = document.getElementById('menuExportJson');
        // æ–°å¢æƒé™æ§åˆ¶ï¼šå›æ”¶ç«™å’Œæ—¥å¿—
        const recycleNav = document.querySelector('[data-view="recycle"]');
        const logsNav = document.querySelector('[data-view="logs"]');

        if (!isAdmin) {
            navMember.classList.add('disabled'); navMember.style.opacity = '0.3';
            if(recycleNav) { recycleNav.classList.add('disabled'); recycleNav.style.opacity = '0.3'; }
            if(logsNav) { logsNav.classList.add('disabled'); logsNav.style.opacity = '0.3'; }
            if(btnOdUpload) { btnOdUpload.disabled = true; btnOdUpload.innerHTML = 'ğŸš« æš‚æ— ä¸Šä¼ æƒé™'; btnOdUpload.style.opacity = '0.6'; }
            if(btnLocalExport) { btnLocalExport.disabled = true; btnLocalExport.innerHTML = 'ğŸš« ç¦æ­¢å¯¼å‡º JSON'; btnLocalExport.style.opacity = '0.6'; }
            if(menuExportJson) { menuExportJson.classList.add('disabled'); menuExportJson.removeAttribute('onclick'); }
        } else {
            navMember.classList.remove('disabled'); navMember.style.opacity = '1';
            if(recycleNav) { recycleNav.classList.remove('disabled'); recycleNav.style.opacity = '1'; }
            if(logsNav) { logsNav.classList.remove('disabled'); logsNav.style.opacity = '1'; }
            if(btnOdUpload) { btnOdUpload.disabled = false; btnOdUpload.innerHTML = 'â¬†ï¸ ä¸Šä¼ å½“å‰æ•°æ®åˆ°äº‘ç«¯'; btnOdUpload.style.opacity = '1'; }
            if(btnLocalExport) { btnLocalExport.disabled = false; btnLocalExport.innerHTML = 'å¯¼å‡º JSON'; btnLocalExport.style.opacity = '1'; }
            if(menuExportJson) { menuExportJson.classList.remove('disabled'); menuExportJson.setAttribute('onclick', 'exportData()'); }
        }
    }

    // --- MSAL & OneDrive ---
    const msalConfig = { auth: { clientId: "c453313f-fd40-4534-9d66-6a0847396d3b", authority: "https://login.microsoftonline.com/common", redirectUri: window.location.origin + window.location.pathname }, cache: { cacheLocation: "localStorage" } };
    const loginRequest = { scopes: ["User.Read", "Files.ReadWrite"] };
    let msalInstance = null;
    const OneDriveService = {
        init: async function() { try { msalInstance = new msal.PublicClientApplication(msalConfig); const accounts = msalInstance.getAllAccounts(); if (accounts.length > 0) { msalInstance.setActiveAccount(accounts[0]); this.updateUI(accounts[0]); } } catch (e) { console.error(e); } },
        signIn: async function() { try { const r = await msalInstance.loginPopup(loginRequest); msalInstance.setActiveAccount(r.account); this.updateUI(r.account); showToast("ç™»å½•æˆåŠŸ", "success"); } catch (e) { showToast(e.message, "error"); } },
        signOut: function() { msalInstance.logoutPopup({ postLogoutRedirectUri: window.location.href }); this.updateUI(null); },
        getToken: async function() { const account = msalInstance.getActiveAccount(); if (!account) throw new Error("æœªç™»å½•"); try { const r = await msalInstance.acquireTokenSilent({ ...loginRequest, account }); return r.accessToken; } catch { const r = await msalInstance.acquireTokenPopup(loginRequest); return r.accessToken; } },
        updateUI: function(account) { 
            const login = document.getElementById('onedrive-login-panel'); const action = document.getElementById('onedrive-actions-panel');
            if(account) { login.classList.add('hidden'); action.classList.remove('hidden'); document.getElementById('odUserName').textContent = account.name; document.getElementById('odUserEmail').textContent = account.username; document.getElementById('odUserInitials').textContent = account.name ? account.name.charAt(0).toUpperCase() : "U"; }
            else { login.classList.remove('hidden'); action.classList.add('hidden'); }
        },
        upload: async function() {
            if (currentUserRole !== 'admin') { showToast('æ— æƒé™', 'error'); return; }
            const btn = document.getElementById('btnOdUpload'); const txt = btn.innerHTML; btn.innerHTML = 'â³ ä¸Šä¼ ä¸­...'; btn.disabled = true;
            try {
                const token = await this.getToken();
                const data = { version: '5.0', backupDate: new Date().toISOString(), achievements, members, recycleBin, operationLogs }; // Added new arrays
                const url = `https://graph.microsoft.com/v1.0/me/drive/root:/ResearchManager/backup.json:/content`;
                const res = await fetch(url, { method: 'PUT', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!res.ok) throw new Error("ä¸Šä¼ å¤±è´¥"); showToast("âœ… å¤‡ä»½æˆåŠŸ", "success");
            } catch (e) { showToast("âŒ " + e.message, "error"); } finally { btn.innerHTML = txt; btn.disabled = false; }
        },
        download: async function() {
            const btn = document.getElementById('btnOdDownload'); const txt = btn.innerHTML; btn.innerHTML = 'â³ ä¸‹è½½ä¸­...'; btn.disabled = true;
            try {
                const token = await this.getToken();
                const url = `https://graph.microsoft.com/v1.0/me/drive/root:/ResearchManager/backup.json:/content`;
                const res = await fetch(url, { method: 'GET', headers: { 'Authorization': `Bearer ${token}` } });
                if (res.status === 404) throw new Error("æœªæ‰¾åˆ°å¤‡ä»½"); if (!res.ok) throw new Error("ä¸‹è½½å¤±è´¥");
                const data = await res.json();
                if (confirm(`ä¸‹è½½æˆåŠŸï¼æ˜¯å¦åˆå¹¶æ•°æ®ï¼Ÿ`)) {
                    const newA = data.achievements||[]; const newM = data.members||[];
                    newA.forEach(i => { if(!achievements.some(e=>e.id===i.id)) achievements.push(i); });
                    newM.forEach(i => { if(!members.some(e=>e.id===i.id)) members.push(i); });
                    // Restore recycle bin and logs if needed, or merge
                    saveToLocal(); updateStats(); renderResults(); showToast("âœ… æ•°æ®å·²åˆå¹¶", "success"); closeBackupModal();
                }
            } catch (e) { showToast("âŒ " + e.message, "error"); } finally { btn.innerHTML = txt; btn.disabled = false; }
        }
    };

    // --- Global State ---
    var achievements = [];
    var members = [];
    var recycleBin = []; // New: Recycle Bin
    var operationLogs = []; // New: Logs
    
    var currentView = 'all';
    var currentYearFilter = 'all';
    var searchQuery = '';
    var dateRange = { start: '', end: '' }; // New: Date Filter
    var sortOrder = 'date-desc';
    var deleteTargetIds = [];
    var deleteTargetType = 'achievement';
    var currentPdfData = null; 
    var currentPdfName = null;
    var excelData = null;
    var excelHeaders = [];
    var selectedItems = new Set();
    var currentDetailId = null;
    
    // Pagination
    var currentPage = 1;
    var itemsPerPage = 20;
    
    // Configs... (Keep typeConfig and fieldMappings from previous code)
    var typeConfig = { paper: { icon: 'ğŸ“„', label: 'å­¦æœ¯è®ºæ–‡', class: 'type-paper' }, patent: { icon: 'ğŸ’¡', label: 'å‘æ˜ä¸“åˆ©', class: 'type-patent' }, project: { icon: 'ğŸ“Š', label: 'ç§‘ç ”é¡¹ç›®', class: 'type-project' }, award: { icon: 'ğŸ†', label: 'è·å¥–æƒ…å†µ', class: 'type-award' }, book: { icon: 'ğŸ“š', label: 'ä¸“è‘—å‡ºç‰ˆ', class: 'type-book' }, member: { icon: 'ğŸ‘¤', label: 'æˆå‘˜ä¿¡æ¯', class: 'type-member' } };
    var fieldMappings = { paper: [{ key: 'title', label: 'æ ‡é¢˜', required: true }, { key: 'authors', label: 'ä½œè€…' }, { key: 'date', label: 'å‘è¡¨æ—¥æœŸ' }, { key: 'source', label: 'æœŸåˆŠ/æ¥æº' }, { key: 'level', label: 'çº§åˆ«' }, { key: 'doi', label: 'DOI' }], patent: [{ key: 'patentName', label: 'ä¸“åˆ©åç§°', required: true }, { key: 'patentType', label: 'ä¸“åˆ©ç±»å‹' }, { key: 'inventors', label: 'å‘æ˜äºº' }, { key: 'patentOwner', label: 'ä¸“åˆ©æƒäºº' }, { key: 'applicationDate', label: 'ç”³è¯·æ—¥' }, { key: 'grantDate', label: 'æˆæƒæ—¶é—´' }, { key: 'patentNumber', label: 'ä¸“åˆ©å·' }, { key: 'patentStatus', label: 'ä¸“åˆ©çŠ¶æ€' }], project: [{ key: 'projectName', label: 'é¡¹ç›®åç§°', required: true }, { key: 'projectLevel', label: 'é¡¹ç›®çº§åˆ«' }, { key: 'projectNumber', label: 'é¡¹ç›®ç¼–å·' }, { key: 'projectStartDate', label: 'å¼€å§‹æ—¶é—´' }, { key: 'projectEndDate', label: 'ç»“æŸæ—¶é—´' }, { key: 'projectOrg', label: 'æ‰€å±å•ä½' }], award: [{ key: 'awardName', label: 'å¥–é¡¹åç§°', required: true }, { key: 'awardRecipients', label: 'è·å¥–äºº' }, { key: 'awardDate', label: 'è·å¥–æ—¥æœŸ' }, { key: 'awardLevel', label: 'çº§åˆ«' }, { key: 'awardAgency', label: 'æˆå¥–å•ä½' }], book: [{ key: 'bookTitle', label: 'è‘—ä½œåç§°', required: true }, { key: 'bookAuthors', label: 'ä½œè€…' }, { key: 'bookDate', label: 'å‡ºç‰ˆæ—¥æœŸ' }, { key: 'bookPublisher', label: 'å‡ºç‰ˆç¤¾' }, { key: 'bookIsbn', label: 'ISBN' }], member: [{ key: 'memberNo', label: 'å­¦å·/å·¥å·', required: true }, { key: 'memberName', label: 'å§“å', required: true }, { key: 'memberGender', label: 'æ€§åˆ«' }, { key: 'memberOrg', label: 'å·¥ä½œå•ä½' }, { key: 'memberTitle', label: 'èŒç§°' }, { key: 'memberEmail', label: 'é‚®ç®±' }, { key: 'memberIdCard', label: 'è¯ä»¶å·ç ' }, { key: 'memberDob', label: 'å‡ºç”Ÿå¹´æœˆ' }, { key: 'memberNation', label: 'æ°‘æ—' }, { key: 'memberPhone', label: 'ç”µè¯' }] };

    // --- Database ---
    const DB_NAME = 'ResearchDB_V5'; // Bump version
    const DB_VERSION = 1;
    let db;
    function initDB() { return new Promise((resolve, reject) => { var r = indexedDB.open(DB_NAME, DB_VERSION); r.onerror = reject; r.onupgradeneeded = e => { e.target.result.createObjectStore('appState', { keyPath: 'id' }); }; r.onsuccess = e => { db = e.target.result; resolve(db); }; }); }
    async function saveToLocal() { if(!db) await initDB(); db.transaction(['appState'], 'readwrite').objectStore('appState').put({ id: 'main_data', achievements, members, recycleBin, operationLogs, updatedAt: new Date().toISOString() }); document.getElementById('storageStatus').innerHTML = 'âœ“ æ•°æ®å·²æœ¬åœ°ä¿å­˜'; }
    async function loadFromLocal() { if(!db) await initDB(); return new Promise(resolve => { var r = db.transaction(['appState'], 'readonly').objectStore('appState').get('main_data'); r.onsuccess = e => { if(e.target.result) { achievements = e.target.result.achievements||[]; members = e.target.result.members||[]; recycleBin = e.target.result.recycleBin||[]; operationLogs = e.target.result.operationLogs||[]; resolve(true); } else resolve(false); }; r.onerror = ()=>resolve(false); }); }

    // --- Logging & Helper ---
    function addLog(action, details) {
        operationLogs.unshift({ id: Date.now(), time: new Date().toLocaleString(), user: currentUserRole, action, details });
        if(operationLogs.length > 200) operationLogs.pop(); // Keep last 200
        saveToLocal();
    }
    
    function generateCitation(id) {
        var item = achievements.find(a => a.id === id);
        if(!item) return;
        var text = "";
        // Simple GB/T 7714 style approximation
        if(item.type === 'paper') {
            text = `${item.authors}. ${item.title}[J]. ${item.source}, ${item.date ? item.date.substring(0,4) : ''}.`;
        } else if (item.type === 'book') {
            text = `${item.bookAuthors}. ${item.bookTitle}[M]. ${item.bookPublisher}, ${item.bookDate ? item.bookDate.substring(0,4) : ''}.`;
        } else {
            text = `${item.title || item.patentName || item.projectName}. ${item.date || item.applicationDate}.`;
        }
        navigator.clipboard.writeText(text).then(() => showToast("å·²å¤åˆ¶å¼•ç”¨æ ¼å¼", "success"));
    }

    // --- Smart Entry (Feature 1) ---
    async function fetchMetadata(type) {
        const id = document.getElementById(type).value.trim();
        if(!id) { showToast("è¯·è¾“å…¥ " + type.toUpperCase(), "warning"); return; }
        const btn = event.target; btn.innerHTML = 'â³...'; btn.disabled = true;
        
        try {
            if(type === 'doi') {
                const res = await fetch(`https://api.crossref.org/works/${id}`);
                if(!res.ok) throw new Error("æœªæ‰¾åˆ°è¯¥ DOI");
                const data = await res.json();
                const item = data.message;
                document.getElementById('title').value = item.title ? item.title[0] : '';
                document.getElementById('source').value = item['container-title'] ? item['container-title'][0] : '';
                if(item.author) {
                    document.getElementById('authors').value = item.author.map(a => `${a.given} ${a.family}`).join(', ');
                }
                if(item.published && item.published['date-parts']) {
                    const d = item.published['date-parts'][0];
                    document.getElementById('date').value = `${d[0]}-${String(d[1]||1).padStart(2,'0')}-${String(d[2]||1).padStart(2,'0')}`;
                }
                showToast("æŠ“å–æˆåŠŸ", "success");
            } else if (type === 'isbn') {
                const res = await fetch(`https://openlibrary.org/isbn/${id}.json`);
                if(!res.ok) throw new Error("æœªæ‰¾åˆ°è¯¥ ISBN");
                const data = await res.json();
                document.getElementById('bookTitle').value = data.title || '';
                if(data.publish_date) document.getElementById('bookDate').value = new Date(data.publish_date).toISOString().slice(0,10);
                if(data.publishers) document.getElementById('bookPublisher').value = data.publishers.join(', ');
                showToast("æŠ“å–æˆåŠŸ", "success");
            }
        } catch(e) {
            showToast("è·å–å¤±è´¥: " + e.message, "error");
        } finally {
            btn.innerHTML = 'ğŸª„ è·å–'; btn.disabled = false;
        }
    }

    // --- Core View Logic ---
    function setView(view) {
        if((view === 'member' || view === 'recycle' || view === 'logs') && currentUserRole !== 'admin') { showToast('æ— æƒè®¿é—®', 'error'); return; }
        currentView = view; currentPage = 1; selectedItems.clear(); updateBatchDeleteBtn();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.view === view));
        
        const titles = { all: 'å…¨éƒ¨æˆæœ', recycle: 'â™»ï¸ å›æ”¶ç«™', logs: 'ğŸ“œ æ“ä½œæ—¥å¿—' };
        document.getElementById('pageTitle').textContent = titles[view] || typeConfig[view]?.label || 'ç®¡ç†ç³»ç»Ÿ';
        
        // Hide/Show controls
        document.getElementById('addBtn').style.display = (view === 'recycle' || view === 'logs') ? 'none' : 'inline-flex';
        document.getElementById('filterBar').style.display = (view === 'logs') ? 'none' : 'flex';
        
        closeSidebar(); renderResults();
    }

    function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }
    function handleDateRange() { dateRange.start = document.getElementById('dateStart').value; dateRange.end = document.getElementById('dateEnd').value; renderResults(); }
    function changePage(delta) { currentPage += delta; renderResults(); }

    function renderResults() {
        const container = document.getElementById('resultsList');
        if(currentView === 'member') { renderMembers(container); return; }
        if(currentView === 'logs') { renderLogs(container); return; }
        
        // 1. Source Data
        let source = currentView === 'recycle' ? recycleBin : achievements;
        
        // 2. Filtering
        let filtered = source.slice();
        if(currentView !== 'all' && currentView !== 'recycle') {
            filtered = filtered.filter(a => a.type === currentView);
        }
        
        // Search & Date Filter
        if(searchQuery) {
            filtered = filtered.filter(a => Object.values(a).some(v => String(v).toLowerCase().includes(searchQuery)));
        }
        if(dateRange.start) filtered = filtered.filter(a => (a.date || a.applicationDate || a.projectStartDate || a.awardDate || a.bookDate || '9999') >= dateRange.start);
        if(dateRange.end) filtered = filtered.filter(a => (a.date || a.applicationDate || a.projectStartDate || a.awardDate || a.bookDate || '0000') <= dateRange.end);

        // 3. Sorting
        filtered.sort((a,b) => sortOrder === 'date-asc' ? (a.date||'').localeCompare(b.date||'') : (b.date||'').localeCompare(a.date||''));

        // 4. Pagination
        const total = filtered.length;
        const totalPages = Math.ceil(total / itemsPerPage) || 1;
        if(currentPage > totalPages) currentPage = totalPages;
        if(currentPage < 1) currentPage = 1;
        
        const pageData = filtered.slice((currentPage-1)*itemsPerPage, currentPage*itemsPerPage);
        
        document.getElementById('resultsCount').textContent = `å…± ${total} æ¡`;
        document.getElementById('pageIndicator').textContent = `${currentPage} / ${totalPages}`;
        document.getElementById('pagination').style.display = total > 0 ? 'flex' : 'none';

        if(total === 0) { container.innerHTML = '<div class="empty-state"><p>æ— æ•°æ®</p></div>'; return; }

        container.innerHTML = pageData.map(item => {
            const config = typeConfig[item.type] || typeConfig.paper;
            // Display Logic (Same as before but with Restore button if recycle)
            let displayTitle = item.title || item.patentName || item.projectName || item.awardName || item.bookTitle;
            let metaHtml = '';
            
            function addMeta(icon, text) { if(text) metaHtml += `<span>${icon} ${escapeHtml(text)}</span>`; }
            
            if(item.type === 'patent') { addMeta('ğŸ“…', item.applicationDate); addMeta('ğŸ‘¤', item.inventors); addMeta('ğŸ”¢', item.patentNumber); addMeta('ğŸ”–', item.patentStatus); }
            else if(item.type === 'project') { addMeta('ğŸ“…', item.projectStartDate); addMeta('ğŸ¢', item.projectOrg); addMeta('ğŸ”¢', item.projectNumber); }
            else if(item.type === 'award') { addMeta('ğŸ“…', item.awardDate); addMeta('ğŸ‘¤', item.awardRecipients); addMeta('ğŸ…', item.awardLevel); }
            else if(item.type === 'book') { addMeta('ğŸ“…', item.bookDate); addMeta('ğŸ‘¤', item.bookAuthors); addMeta('ğŸ“–', item.bookPublisher); }
            else { addMeta('ğŸ“…', item.date); addMeta('ğŸ‘¤', item.authors); addMeta('ğŸ“–', item.source); addMeta('ğŸ”—', item.doi); }

            const actionBtns = currentView === 'recycle' 
                ? `<button class="action-btn" onclick="restoreItem('${item.id}')" title="è¿˜åŸ">â™»ï¸</button>
                   <button class="action-btn delete" onclick="hardDelete('${item.id}')" title="å½»åº•åˆ é™¤">âŒ</button>`
                : `<button class="action-btn" onclick="generateCitation('${item.id}'); event.stopPropagation();" title="å¼•ç”¨">â</button>
                   <button class="action-btn" onclick="viewDetail('${item.id}'); event.stopPropagation();">ğŸ‘ï¸</button>
                   <button class="action-btn" onclick="downloadPdf('${item.id}'); event.stopPropagation();">â¬‡ï¸</button>
                   <button class="action-btn delete" onclick="promptDelete('${item.id}', 'achievement'); event.stopPropagation();">ğŸ—‘</button>`;

            return `<div class="result-item" onclick="viewDetail('${item.id}')">
                ${currentView!=='recycle' ? `<input type="checkbox" class="result-checkbox" onclick="event.stopPropagation()">` : ''}
                <div class="result-type ${config.class}">${config.icon}</div>
                <div class="result-content">
                    <div class="result-title">${escapeHtml(displayTitle)}</div>
                    <div class="result-meta">${metaHtml}</div>
                </div>
                <div class="result-actions">${actionBtns}</div>
            </div>`;
        }).join('');
    }

    function renderLogs(container) {
        document.getElementById('resultsCount').textContent = `å…± ${operationLogs.length} æ¡`;
        document.getElementById('pagination').style.display = 'none';
        container.innerHTML = operationLogs.map(log => `
            <div class="result-item" style="cursor:default">
                <div class="result-content">
                    <div class="result-title" style="font-size:0.85rem">${log.time} - [${log.user}] ${log.action}</div>
                    <div class="result-meta" style="color:var(--text-muted)">${escapeHtml(log.details)}</div>
                </div>
            </div>
        `).join('');
    }

    // --- Delete / Restore Logic ---
    function promptDelete(id, type) {
        if(currentUserRole !== 'admin') return;
        if(confirm("ç¡®å®šè¦ç§»å…¥å›æ”¶ç«™å—ï¼Ÿ")) {
            const list = type === 'member' ? members : achievements;
            const idx = list.findIndex(i => i.id === id);
            if(idx > -1) {
                const item = list.splice(idx, 1)[0];
                item.deletedType = type; // mark source
                recycleBin.unshift(item);
                addLog('åˆ é™¤', `ç§»å…¥å›æ”¶ç«™: ${item.title || item.memberName}`);
                saveToLocal(); updateStats(); renderResults();
            }
        }
    }

    function restoreItem(id) {
        const idx = recycleBin.findIndex(i => i.id === id);
        if(idx > -1) {
            const item = recycleBin.splice(idx, 1)[0];
            if(item.deletedType === 'member') members.push(item);
            else achievements.push(item);
            addLog('è¿˜åŸ', `ä»å›æ”¶ç«™è¿˜åŸ: ${item.title || item.memberName}`);
            saveToLocal(); updateStats(); renderResults();
        }
    }

    function hardDelete(id) {
        if(confirm("å½»åº•åˆ é™¤æ— æ³•æ¢å¤ï¼Œç¡®å®šå—ï¼Ÿ")) {
            recycleBin = recycleBin.filter(i => i.id !== id);
            saveToLocal(); renderResults();
        }
    }

    // --- Keep existing helper functions (handleSearch, handleSort, Modal logic...) ---
    // (Ensure handleSearch and others are present as per previous code)
    function handleSearch() { searchQuery = document.getElementById('searchInput').value.toLowerCase(); currentPage = 1; renderResults(); }
    function handleSort() { sortOrder = document.getElementById('sortSelect').value; renderResults(); }
    function setYearFilter(y) { currentYearFilter = y; renderResults(); }
    // ... [Previous Modal/Form Logic here - omitted for brevity but assumed present from Part 1] ...
    // è¯·ç¡®ä¿ä¸Šé¢çš„ toggleFormFields, openAddModal, editAchievement ç­‰å‡½æ•°éƒ½åœ¨è¿™é‡Œ

    function toggleFormFields() {
        var type = document.getElementById('type').value; 
        document.getElementById('patentFields').classList.toggle('hidden', type !== 'patent');
        document.getElementById('projectFields').classList.toggle('hidden', type !== 'project');
        document.getElementById('awardFields').classList.toggle('hidden', type !== 'award');
        document.getElementById('bookFields').classList.toggle('hidden', type !== 'book');
        var isGeneral = type === 'paper' || type === '';
        document.getElementById('generalFields').classList.toggle('hidden', !isGeneral);
        document.getElementById('dateGroup').classList.toggle('hidden', !isGeneral);
    }
    // ... [More Existing Functions] ... (viewDetail, editMember, etc. from previous response)

    window.onload = function() { OneDriveService.init(); loadFromLocal().then(() => { updateStats(); renderResults(); }); };
</script>

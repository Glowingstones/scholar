<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ V5.0 (Pro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºç¡€å˜é‡å®šä¹‰ --- */
        :root {
            --bg-primary: #f8fafc; --bg-secondary: #ffffff; --bg-card: #ffffff; --bg-hover: #f1f5f9;
            --text-primary: #1e293b; --text-secondary: #64748b; --text-muted: #94a3b8;
            --border: #e2e8f0; --border-light: #f1f5f9;
            --accent: #6366f1; --accent-light: #eef2ff; --accent-dark: #4f46e5;
            --success: #10b981; --success-light: #d1fae5;
            --warning: #f59e0b; --warning-light: #fef3c7;
            --danger: #ef4444; --danger-light: #fee2e2;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.1);
            --radius: 12px; --radius-sm: 8px;
            --od-blue: #0078D4; --od-hover: #005a9e; --od-light: #f3f9fd;
        }

        html.dark {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #1e293b; --bg-hover: #334155;
            --text-primary: #f1f5f9; --text-secondary: #94a3b8; --text-muted: #64748b;
            --border: #334155; --border-light: #1e293b;
            --accent-light: #312e81; --success-light: #064e3b; --warning-light: #78350f; --danger-light: #7f1d1d; --od-light: #002c4e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans SC', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .app-container { display: flex; height: 100vh; overflow: hidden; }

        /* --- ä¾§è¾¹æ æ ·å¼ --- */
        .sidebar { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; transition: transform 0.3s; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; }
        .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
        .nav-menu { flex: 1; padding: 16px 12px; overflow-y: auto; }
        .nav-section { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; padding: 12px 12px 8px; margin-top: 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary); font-weight: 500; transition: all 0.2s; margin-bottom: 4px; }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-light); color: var(--accent); }
        .nav-item.disabled { opacity: 0.5; pointer-events: none; }
        .nav-item .badge { margin-left: auto; background: var(--bg-hover); padding: 2px 10px; border-radius: 10px; font-size: 0.8rem; }
        .nav-item.active .badge { background: var(--accent); color: white; }
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
        .data-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .data-btn { padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text-secondary); cursor: pointer; text-align: center; }
        .data-btn:hover { background: var(--bg-hover); color: var(--accent); border-color: var(--accent); }
        .dropdown-menu { position: absolute; bottom: 100%; left: 10px; right: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: var(--shadow-lg); display: none; z-index: 200; overflow: hidden; margin-bottom: 8px; }
        .dropdown-menu.show { display: block; animation: slideUp 0.2s; }
        .menu-item { padding: 14px 16px; cursor: pointer; border-bottom: 1px solid var(--border-light); font-size: 0.95rem; }
        .menu-item:hover { background: var(--bg-hover); color: var(--accent); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ä¸»å†…å®¹åŒºæ ·å¼ --- */
        .main-content { flex: 1; padding: 20px; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 12px; flex-wrap: wrap; flex-shrink: 0; }
        .page-title { font-size: 1.5rem; font-weight: 700; }
        .header-actions { display: flex; gap: 10px; align-items: center; flex: 1; justify-content: flex-end; }
        .search-box { flex: 1; min-width: 200px; max-width: 320px; }
        .search-box input { padding: 10px 16px; border: 2px solid var(--border); border-radius: var(--radius); width: 100%; transition: all 0.2s; background: var(--bg-card); color: var(--text-primary); }
        .search-box input:focus { outline: none; border-color: var(--accent); }
        .btn { padding: 10px 20px; border-radius: var(--radius); font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; box-shadow: var(--shadow); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

        /* --- ç»Ÿè®¡å¡ç‰‡ --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px; flex-shrink: 0; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .stat-info h3 { font-size: 1.2rem; font-weight: 700; }
        .stat-info p { font-size: 0.75rem; color: var(--text-secondary); }
        /* å›¾æ ‡é¢œè‰² */
        .stat-icon.papers { background: #dbeafe; } .stat-icon.patents { background: #fef3c7; } .stat-icon.projects { background: #d1fae5; }
        .stat-icon.awards { background: #fce7f3; } .stat-icon.books { background: #e0e7ff; } .stat-icon.members { background: #f3e8ff; }

        /* --- åˆ—è¡¨ä¸ç­›é€‰ --- */
        #listViewContainer { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .filter-container { margin-bottom: 12px; flex-shrink: 0; }
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .filter-chip { padding: 6px 14px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border); font-size: 0.85rem; cursor: pointer; }
        .filter-chip.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .results-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .results-header { display: flex; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
        .results-list { flex: 1; overflow-y: auto; }
        .result-item { display: flex; align-items: flex-start; padding: 12px 16px; border-bottom: 1px solid var(--border-light); cursor: pointer; gap: 12px; transition: background 0.2s; }
        .result-item:hover { background: var(--bg-hover); }
        .result-type { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .result-content { flex: 1; min-width: 0; }
        .result-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; line-height: 1.4; }
        .result-meta { font-size: 0.8rem; color: var(--text-secondary); display: flex; flex-wrap: wrap; gap: 8px; }
        .result-actions { display: flex; gap: 4px; align-items: center; }
        .action-btn { width: 32px; height: 32px; border: none; background: transparent; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .action-btn:hover { background: var(--bg-hover); color: var(--accent); }
        .action-btn.delete:hover { background: var(--danger-light); color: var(--danger); }
        
        /* é¢œè‰²ç±» */
        .type-paper { background: #dbeafe; } .type-patent { background: #fef3c7; } .type-project { background: #d1fae5; }
        .type-award { background: #fce7f3; } .type-book { background: #e0e7ff; } .type-member { background: #f3e8ff; }

        /* --- æ¨¡æ€æ¡† --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border-radius: var(--radius); width: 90%; max-width: 600px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); }
        .modal.wide { max-width: 800px; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary); transition: border 0.2s; }
        .form-group input:focus { outline: none; border-color: var(--accent); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* --- V5.0 æ–°å¢æ ·å¼ --- */
        /* 1. æ ‡ç­¾ Tag ç³»ç»Ÿ */
        .tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
        .tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: var(--accent-light); color: var(--accent); border: 1px solid var(--accent); display: flex; align-items: center; gap: 4px; }
        .tag-delete { cursor: pointer; opacity: 0.6; } .tag-delete:hover { opacity: 1; }

        /* 2. åˆ†é¡µæ§ä»¶ */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 12px; border-top: 1px solid var(--border); flex-shrink: 0; background: var(--bg-secondary); }
        .page-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; transition: all 0.2s; }
        .page-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .page-info { font-size: 0.85rem; color: var(--text-secondary); }

        /* 3. å¼•ç”¨ç”Ÿæˆæ¡† */
        .citation-box { background: var(--bg-hover); padding: 10px; border-radius: var(--radius-sm); margin-top: 8px; font-family: 'Courier New', monospace; font-size: 0.85rem; border: 1px dashed var(--border); position: relative; word-break: break-all; }
        .citation-copy { position: absolute; right: 5px; top: 5px; padding: 2px 8px; font-size: 0.7rem; cursor: pointer; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; }
        .citation-copy:hover { background: var(--accent); color: white; border-color: var(--accent); }

        /* 4. æ“ä½œæ—¥å¿—ä¸å›æ”¶ç«™ */
        .log-item { padding: 10px; border-bottom: 1px solid var(--border-light); font-size: 0.85rem; display: grid; grid-template-columns: 140px 100px 1fr 80px; gap: 10px; align-items: center; }
        .log-time { color: var(--text-muted); }
        .log-action { font-weight: 600; color: var(--text-primary); }
        .log-detail { color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .deleted-item { opacity: 0.7; background: var(--danger-light) !important; }

        /* 5. æ™ºèƒ½æå–æŒ‰é’® */
        .smart-btn { position: absolute; right: 26px; top: 38px; padding: 6px 12px; font-size: 0.75rem; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; z-index: 5; }
        .smart-btn:hover { background: var(--accent-dark); }
        .input-wrapper { position: relative; }

        /* 6. é«˜çº§æœç´¢é¢æ¿ */
        .adv-search-panel { background: var(--bg-hover); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 12px; border: 1px solid var(--border); display: none; }
        .adv-search-panel.active { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* 7. Toast & Login Overlay */
        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .toast { padding: 10px 20px; border-radius: var(--radius-sm); margin-bottom: 10px; background: white; box-shadow: var(--shadow-lg); font-weight: 500; display: none; }
        .toast.success { background: var(--success-light); color: var(--success-light); border: 1px solid var(--success); color: #064e3b; }
        .toast.error { background: var(--danger-light); color: #7f1d1d; border: 1px solid var(--danger); }
        .toast.show { display: block; animation: slideDown 0.3s; }
        
        .login-overlay { position: fixed; inset: 0; background: var(--bg-primary); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .login-box { background: var(--bg-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border); }

        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); width: 85%; height: 100%; }
            .sidebar.open { transform: translateX(0); }
            .header { flex-direction: column; align-items: stretch; }
            .log-item { grid-template-columns: 1fr; gap: 4px; border-bottom: 2px solid var(--border); }
        }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-overlay">
    <div class="login-box">
        <div class="logo-icon" style="margin: 0 auto 20px auto;">ğŸ”¬</div>
        <div style="font-size:1.8rem; font-weight:700; color:var(--accent); margin-bottom:10px;">ç§‘ç ”æˆæœç®¡ç† V5.0</div>
        <p style="color:var(--text-secondary); margin-bottom:30px;">Pro ç‰ˆï¼šå«æ™ºèƒ½å½•å…¥ã€å›æ”¶ç«™ä¸å®¡è®¡æ—¥å¿—</p>
        <div class="form-group">
            <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ..." onkeyup="if(event.key==='Enter') checkLogin()">
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="checkLogin()">ç™»å½•</button>
        <div style="margin-top:15px; font-size:0.8rem; color:var(--text-muted);">ç®¡ç†å‘˜: 1399 | å®¾å®¢: guest</div>
    </div>
</div>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">ğŸ”¬</div>
                <div>
                    <div>ç§‘ç ”ç®¡ç† Pro</div>
                    <div style="font-size:0.7rem;color:var(--text-muted);">V5.0 æ™ºèƒ½å¢å¼ºç‰ˆ</div>
                </div>
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-section">æˆæœç®¡ç†</div>
            <div class="nav-item active" data-view="all" onclick="setView('all')">ğŸ“‹ <span>å…¨éƒ¨æˆæœ</span><span class="badge" id="totalCount">0</span></div>
            <div class="nav-item" data-view="paper" onclick="setView('paper')">ğŸ“„ <span>å­¦æœ¯è®ºæ–‡</span><span class="badge" id="paperCount">0</span></div>
            <div class="nav-item" data-view="patent" onclick="setView('patent')">ğŸ’¡ <span>å‘æ˜ä¸“åˆ©</span><span class="badge" id="patentCount">0</span></div>
            <div class="nav-item" data-view="project" onclick="setView('project')">ğŸ“Š <span>ç§‘ç ”é¡¹ç›®</span><span class="badge" id="projectCount">0</span></div>
            <div class="nav-item" data-view="award" onclick="setView('award')">ğŸ† <span>è·å¥–æƒ…å†µ</span><span class="badge" id="awardCount">0</span></div>
            <div class="nav-item" data-view="book" onclick="setView('book')">ğŸ“š <span>ä¸“è‘—å‡ºç‰ˆ</span><span class="badge" id="bookCount">0</span></div>
            <div class="nav-section">å›¢é˜Ÿç®¡ç†</div>
            <div class="nav-item" data-view="member" id="navMember" onclick="setView('member')">ğŸ‘¥ <span>æˆå‘˜ä¿¡æ¯</span><span class="badge" id="memberCount">0</span></div>
        </nav>
        <div class="sidebar-footer">
            <div style="font-size:0.8rem; color:var(--success); margin-bottom:10px;" id="storageStatus">âœ“ æ•°æ®å·²åŒæ­¥</div>
            <div class="data-actions">
                <button class="data-btn" onclick="exportData()">ğŸ“¤ å¯¼å‡ºJSON</button>
                <button class="data-btn" onclick="document.getElementById('importInput').click()">ğŸ“¥ å¯¼å…¥JSON</button>
                <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(event)">
            </div>
            <div style="margin-top:10px; display:grid; gap:8px;">
                <div class="menu-item" onclick="openRecycleModal()">ğŸ—‘ï¸ å›æ”¶ç«™</div>
                <div class="menu-item" onclick="openLogModal()">ğŸ›¡ï¸ æ“ä½œæ—¥å¿—</div>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="location.reload()" style="width:100%; margin-top:15px;">ğŸ”’ é€€å‡ºç³»ç»Ÿ</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <button class="btn btn-secondary" onclick="document.getElementById('sidebar').classList.toggle('open')" style="margin-right:10px;">â˜°</button>
            <h1 class="page-title" id="pageTitle">å…¨éƒ¨æˆæœ</h1>
            <div class="header-actions">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢æ ‡é¢˜ã€ä½œè€…ã€æ ‡ç­¾..." oninput="handleSearch()">
                </div>
                <button class="btn btn-secondary" onclick="toggleAdvSearch()" title="é«˜çº§ç­›é€‰">âš¡ ç­›é€‰</button>
                <button class="btn btn-secondary" onclick="toggleDarkMode()" title="æ—¥/å¤œæ¨¡å¼">ğŸŒ“</button>
                <button class="btn btn-primary" id="addBtn" onclick="openAddModal()">â• æ·»åŠ </button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
             <div class="stat-card" onclick="setView('paper')"><div class="stat-icon papers">ğŸ“„</div><div class="stat-info"><h3 id="statPaper">0</h3><p>è®ºæ–‡</p></div></div>
             <div class="stat-card" onclick="setView('patent')"><div class="stat-icon patents">ğŸ’¡</div><div class="stat-info"><h3 id="statPatent">0</h3><p>ä¸“åˆ©</p></div></div>
             <div class="stat-card" onclick="setView('project')"><div class="stat-icon projects">ğŸ“Š</div><div class="stat-info"><h3 id="statProject">0</h3><p>é¡¹ç›®</p></div></div>
             <div class="stat-card" onclick="setView('award')"><div class="stat-icon awards">ğŸ†</div><div class="stat-info"><h3 id="statAward">0</h3><p>è·å¥–</p></div></div>
             <div class="stat-card" onclick="setView('book')"><div class="stat-icon books">ğŸ“š</div><div class="stat-info"><h3 id="statBook">0</h3><p>è‘—ä½œ</p></div></div>
             <div class="stat-card" onclick="setView('member')"><div class="stat-icon members">ğŸ‘¥</div><div class="stat-info"><h3 id="statMember">0</h3><p>æˆå‘˜</p></div></div>
        </div>

        <div id="listViewContainer">
            <div class="filter-container">
                <div class="filter-bar" id="filterBar">
                    <div class="filter-chip active" data-year="all" onclick="setYearFilter('all')">å…¨éƒ¨å¹´ä»½</div>
                </div>
                
                <div class="adv-search-panel" id="advSearchPanel">
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom:0">
                            <label>å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="advStartDate" onchange="handleSearch()">
                        </div>
                        <div class="form-group" style="margin-bottom:0">
                            <label>ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="advEndDate" onchange="handleSearch()">
                        </div>
                        <div class="form-group" style="margin-bottom:0">
                            <label>åŒ…å«æ ‡ç­¾ (Tag)</label>
                            <input type="text" id="advTagInput" placeholder="è¾“å…¥æ ‡ç­¾ç­›é€‰..." oninput="handleSearch()">
                        </div>
                    </div>
                </div>
            </div>

            <div class="results-container">
                <div class="results-header">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <span class="results-count" id="resultsCount">å…± 0 æ¡</span>
                    </div>
                    <select id="sortSelect" onchange="handleSort()" style="padding:6px;border-radius:4px;border:1px solid var(--border);">
                        <option value="date-desc">æœ€æ–°ä¼˜å…ˆ</option>
                        <option value="date-asc">æœ€æ—©ä¼˜å…ˆ</option>
                        <option value="title-asc">æ ‡é¢˜ A-Z</option>
                    </select>
                </div>
                
                <div class="results-list" id="resultsList"></div>
                
                <div class="pagination" id="paginationControl">
                    <button class="page-btn" onclick="changePage(-1)" id="prevPage">â†</button>
                    <span class="page-info" id="pageInfo">ç¬¬ 1 / 1 é¡µ</span>
                    <button class="page-btn" onclick="changePage(1)" id="nextPage">â†’</button>
                    <select id="pageSize" onchange="changePageSize()" style="border:1px solid var(--border); border-radius:4px; padding:4px;">
                        <option value="20">20æ¡/é¡µ</option>
                        <option value="50">50æ¡/é¡µ</option>
                        <option value="100">100æ¡/é¡µ</option>
                    </select>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="formModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="modalTitle">æ·»åŠ ç§‘ç ”æˆæœ</h2>
            <button class="modal-close" onclick="closeModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="researchForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label>æˆæœç±»å‹</label>
                        <select id="type" required onchange="toggleFormFields()">
                            <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                            <option value="patent">å‘æ˜ä¸“åˆ©</option>
                            <option value="project">ç§‘ç ”é¡¹ç›®</option>
                            <option value="award">è·å¥–æƒ…å†µ</option>
                            <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                        </select>
                    </div>
                    <div class="form-group" id="dateGroup">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="date">
                    </div>
                </div>

                <div class="form-group">
                    <label>æ ‡ç­¾ (Tags)</label>
                    <div class="tag-container" id="formTags"></div>
                    <input type="text" id="tagInput" style="margin-top:6px;" placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦æ·»åŠ  (å¦‚: é‡ç‚¹é¡¹ç›®, SCIä¸€åŒº)..." onkeydown="handleTagInput(event)">
                </div>

                <div id="generalFields">
                    <div class="form-group input-wrapper">
                        <label>DOI (æ™ºèƒ½æŠ“å–)</label>
                        <input type="text" id="doi" placeholder="è¾“å…¥ DOI (å¦‚ 10.1109/...)">
                        <button type="button" class="smart-btn" onclick="fetchMetadataByDOI()">ğŸ” æŠ“å–ä¿¡æ¯</button>
                    </div>
                    <div class="form-group"><label>æ ‡é¢˜ *</label><input type="text" id="title" required></div>
                    <div class="form-group"><label>ä½œè€…/æˆå‘˜</label><input type="text" id="authors"></div>
                    <div class="form-row"><div class="form-group"><label>æ¥æº/æœŸåˆŠ</label><input type="text" id="source"></div><div class="form-group"><label>çº§åˆ«</label><input type="text" id="level"></div></div>
                </div>

                <div id="patentFields" class="hidden">
                    <div class="form-group"><label>ä¸“åˆ©åç§° *</label><input type="text" id="patentName"></div>
                    <div class="form-row"><div class="form-group"><label>ç±»å‹</label><select id="patentType"><option value="å‘æ˜ä¸“åˆ©">å‘æ˜ä¸“åˆ©</option><option value="å®ç”¨æ–°å‹">å®ç”¨æ–°å‹</option></select></div><div class="form-group"><label>çŠ¶æ€</label><select id="patentStatus"><option value="å—ç†">å—ç†</option><option value="æˆæƒ">æˆæƒ</option></select></div></div>
                    <div class="form-group"><label>å‘æ˜äºº</label><input type="text" id="inventors"></div>
                    <div class="form-row"><div class="form-group"><label>ç”³è¯·æ—¥</label><input type="date" id="applicationDate"></div><div class="form-group"><label>ä¸“åˆ©å·</label><input type="text" id="patentNumber"></div></div>
                </div>

                <div id="projectFields" class="hidden">
                    <div class="form-group"><label>é¡¹ç›®åç§° *</label><input type="text" id="projectName"></div>
                    <div class="form-row"><div class="form-group"><label>çº§åˆ«</label><input type="text" id="projectLevel"></div><div class="form-group"><label>ç¼–å·</label><input type="text" id="projectNumber"></div></div>
                    <div class="form-row"><div class="form-group"><label>å¼€å§‹</label><input type="date" id="projectStartDate"></div><div class="form-group"><label>å•ä½</label><input type="text" id="projectOrg"></div></div>
                </div>

                <div id="bookFields" class="hidden">
                    <div class="form-group input-wrapper">
                        <label>ISBN (æœä¹¦)</label>
                        <input type="text" id="bookIsbn">
                        <button type="button" class="smart-btn" onclick="fetchMetadataByISBN()">ğŸ” æœä¹¦</button>
                    </div>
                    <div class="form-group"><label>è‘—ä½œåç§° *</label><input type="text" id="bookTitle"></div>
                    <div class="form-group"><label>ä½œè€…</label><input type="text" id="bookAuthors"></div>
                    <div class="form-row"><div class="form-group"><label>å‡ºç‰ˆç¤¾</label><input type="text" id="bookPublisher"></div><div class="form-group"><label>å‡ºç‰ˆæ—¥æœŸ</label><input type="date" id="bookDate"></div></div>
                </div>
                
                <div id="awardFields" class="hidden">
                    <div class="form-group"><label>å¥–é¡¹åç§° *</label><input type="text" id="awardName"></div>
                    <div class="form-group"><label>è·å¥–äºº</label><input type="text" id="awardRecipients"></div>
                    <div class="form-row"><div class="form-group"><label>å•ä½</label><input type="text" id="awardAgency"></div><div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="awardDate"></div></div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="submit" form="researchForm" class="btn btn-primary">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="memberModal">
    <div class="modal wide">
        <div class="modal-header"><h2>å›¢é˜Ÿæˆå‘˜ä¿¡æ¯</h2><button class="modal-close" onclick="closeMemberModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button></div>
        <div class="modal-body">
            <form id="memberForm" onsubmit="handleMemberSubmit(event)">
                <input type="hidden" id="memberEditId">
                <div class="form-row"><div class="form-group"><label>å­¦å·/å·¥å·</label><input type="text" id="memberNo" required></div><div class="form-group"><label>å§“å</label><input type="text" id="memberName" required></div></div>
                <div class="form-row"><div class="form-group"><label>èŒç§°</label><input type="text" id="memberTitle"></div><div class="form-group"><label>å•ä½</label><input type="text" id="memberOrg"></div></div>
                <div class="form-row"><div class="form-group"><label>ç”µè¯</label><input type="text" id="memberPhone"></div><div class="form-group"><label>é‚®ç®±</label><input type="email" id="memberEmail"></div></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="generateResume()">ğŸ“„ å¯¼å‡ºç®€å†</button>
            <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">å–æ¶ˆ</button>
            <button type="submit" form="memberForm" class="btn btn-primary">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="recycleModal">
    <div class="modal wide">
        <div class="modal-header"><h2>ğŸ—‘ æ•°æ®å›æ”¶ç«™ (30å¤©å†…å¯æ¢å¤)</h2><button class="modal-close" onclick="document.getElementById('recycleModal').classList.remove('active')" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button></div>
        <div class="modal-body"><div class="results-list" id="recycleList"></div></div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="document.getElementById('recycleModal').classList.remove('active')">å…³é—­</button></div>
    </div>
</div>

<div class="modal-overlay" id="logModal">
    <div class="modal wide">
        <div class="modal-header"><h2>ğŸ›¡ï¸ ç³»ç»Ÿæ“ä½œæ—¥å¿—</h2><button class="modal-close" onclick="document.getElementById('logModal').classList.remove('active')" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button></div>
        <div class="modal-body" id="logList"></div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="document.getElementById('logModal').classList.remove('active')">å…³é—­</button></div>
    </div>
</div>

<div class="modal-overlay" id="citationModal">
    <div class="modal">
        <div class="modal-header"><h2>â ç”Ÿæˆå¼•ç”¨æ ¼å¼</h2><button class="modal-close" onclick="document.getElementById('citationModal').classList.remove('active')" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button></div>
        <div class="modal-body">
            <label>GB/T 7714</label><div class="citation-box"><span id="citeGB"></span><button class="citation-copy" onclick="copyText('citeGB')">å¤åˆ¶</button></div>
            <label style="margin-top:10px;display:block;">APA</label><div class="citation-box"><span id="citeAPA"></span><button class="citation-copy" onclick="copyText('citeAPA')">å¤åˆ¶</button></div>
            <label style="margin-top:10px;display:block;">BibTeX</label><div class="citation-box"><span id="citeBib"></span><button class="citation-copy" onclick="copyText('citeBib')">å¤åˆ¶</button></div>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
    // --- å…¨å±€çŠ¶æ€ ---
    let achievements = [];
    let members = [];
    let systemLogs = [];
    let currentUserRole = null;
    let currentView = 'all';
    let currentYearFilter = 'all';
    let searchQuery = '';
    let currentTags = [];
    let sortOrder = 'date-desc';
    let selectedItems = new Set();
    
    // åˆ†é¡µçŠ¶æ€
    let currentPage = 1;
    let pageSize = 20;

    // é…ç½®
    const typeConfig = {
        paper: { icon: 'ğŸ“„', label: 'å­¦æœ¯è®ºæ–‡', class: 'type-paper' },
        patent: { icon: 'ğŸ’¡', label: 'å‘æ˜ä¸“åˆ©', class: 'type-patent' },
        project: { icon: 'ğŸ“Š', label: 'ç§‘ç ”é¡¹ç›®', class: 'type-project' },
        award: { icon: 'ğŸ†', label: 'è·å¥–æƒ…å†µ', class: 'type-award' },
        book: { icon: 'ğŸ“š', label: 'ä¸“è‘—å‡ºç‰ˆ', class: 'type-book' },
        member: { icon: 'ğŸ‘¤', label: 'æˆå‘˜ä¿¡æ¯', class: 'type-member' }
    };

    // --- æ•°æ®åº“ (IndexedDB) ---
    const DB_NAME = 'ResearchDB_V5';
    let db;
    function initDB() { return new Promise((resolve, reject) => { var r = indexedDB.open(DB_NAME, 1); r.onerror = e => reject(e); r.onupgradeneeded = e => { if (!e.target.result.objectStoreNames.contains('appState')) e.target.result.createObjectStore('appState', { keyPath: 'id' }); }; r.onsuccess = e => { db = e.target.result; resolve(db); }; }); }
    
    async function loadFromLocal() {
        if (!db) await initDB();
        return new Promise(resolve => {
            var r = db.transaction(['appState'], 'readonly').objectStore('appState').get('main_data');
            r.onsuccess = e => {
                if (e.target.result) {
                    achievements = e.target.result.achievements || [];
                    members = e.target.result.members || [];
                    systemLogs = e.target.result.systemLogs || [];
                    resolve(true);
                } else resolve(false);
            };
            r.onerror = () => resolve(false);
        });
    }

    async function saveToLocal() {
        if (!db) await initDB();
        var t = db.transaction(['appState'], 'readwrite');
        t.objectStore('appState').put({ id: 'main_data', achievements, members, systemLogs, updatedAt: new Date().toISOString() });
        document.getElementById('storageStatus').textContent = 'âœ“ æ•°æ®å·²åŒæ­¥ ' + new Date().toLocaleTimeString();
    }

    // --- ç™»å½•ç³»ç»Ÿ ---
    function checkLogin() {
        const pwd = document.getElementById('loginPassword').value;
        if (pwd === '1399') { currentUserRole = 'admin'; showToast('ç®¡ç†å‘˜ç™»å½•', 'success'); }
        else if (pwd === 'guest') { currentUserRole = 'guest'; showToast('è®¿å®¢ç™»å½•', 'success'); }
        else { showToast('å¯†ç é”™è¯¯', 'error'); return; }
        document.getElementById('loginOverlay').style.display = 'none';
        applyPermissions();
    }

    function applyPermissions() {
        const isAdmin = currentUserRole === 'admin';
        document.getElementById('addBtn').style.display = isAdmin ? 'inline-flex' : 'none';
        document.querySelectorAll('.delete').forEach(btn => btn.disabled = !isAdmin);
    }

    // --- æ—¥å¿—ç³»ç»Ÿ ---
    function addLog(action, details) {
        systemLogs.unshift({ id: Date.now(), user: currentUserRole || 'system', time: new Date().toLocaleString(), action, details });
        if(systemLogs.length > 300) systemLogs.pop();
        saveToLocal();
    }

    function openLogModal() {
        if(currentUserRole !== 'admin') { showToast('éœ€ç®¡ç†å‘˜æƒé™', 'error'); return; }
        document.getElementById('logList').innerHTML = systemLogs.map(log => `
            <div class="log-item">
                <div class="log-time">${log.time}</div><div class="log-action">${log.action}</div>
                <div class="log-detail" title="${log.details}">${log.details}</div><div>${log.user}</div>
            </div>`).join('');
        document.getElementById('logModal').classList.add('active');
    }

    // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ---

    function setView(view) {
        currentView = view; currentPage = 1; selectedItems.clear();
        document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.view === view));
        document.getElementById('pageTitle').textContent = typeConfig[view]?.label || 'å…¨éƒ¨æˆæœ';
        // ç§»åŠ¨ç«¯è‡ªåŠ¨æ”¶èµ·ä¾§è¾¹æ 
        if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
        renderResults();
    }

    function renderResults() {
        const container = document.getElementById('resultsList');
        container.innerHTML = '';
        
        let source = currentView === 'member' ? members : achievements;
        // 1. è¿‡æ»¤å·²åˆ é™¤
        let filtered = source.filter(i => !i.isDeleted);
        
        // 2. è§†å›¾è¿‡æ»¤
        if (currentView !== 'all' && currentView !== 'member') filtered = filtered.filter(a => a.type === currentView);
        
        // 3. æœç´¢è¿‡æ»¤ (åŒ…å«æ ‡ç­¾)
        if (searchQuery) {
            const q = searchQuery.toLowerCase();
            filtered = filtered.filter(a => JSON.stringify(a).toLowerCase().includes(q));
        }
        
        // 4. é«˜çº§ç­›é€‰ (æ—¥æœŸã€Tag)
        const advStart = document.getElementById('advStartDate').value;
        const advEnd = document.getElementById('advEndDate').value;
        const advTag = document.getElementById('advTagInput').value.trim().toLowerCase();
        
        if(advStart) filtered = filtered.filter(a => (a.date||a.applicationDate) >= advStart);
        if(advEnd) filtered = filtered.filter(a => (a.date||a.applicationDate) <= advEnd);
        if(advTag) filtered = filtered.filter(a => a.tags && a.tags.some(t => t.toLowerCase().includes(advTag)));

        // 5. æ’åº
        filtered.sort((a, b) => {
            const da = a.date || a.applicationDate || '0';
            const db = b.date || b.applicationDate || '0';
            if(sortOrder === 'date-desc') return db.localeCompare(da);
            if(sortOrder === 'date-asc') return da.localeCompare(db);
            return (a.title||'').localeCompare(b.title||'');
        });

        // 6. åˆ†é¡µ
        document.getElementById('resultsCount').textContent = `å…± ${filtered.length} æ¡`;
        const totalPages = Math.ceil(filtered.length / pageSize) || 1;
        document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
        
        const start = (currentPage - 1) * pageSize;
        const pagedData = filtered.slice(start, start + pageSize);

        if (pagedData.length === 0) {
            container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-secondary);">æš‚æ— æ•°æ®</div>';
            return;
        }

        container.innerHTML = pagedData.map(item => {
            let config = typeConfig[item.type] || typeConfig.paper;
            let title = escapeHtml(item.title || item.patentName || item.projectName || item.memberName);
            let meta = item.type === 'member' ? `${item.memberOrg} | ${item.memberTitle}` : `${item.date || item.applicationDate || ''} | ${item.authors || item.inventors || ''}`;
            
            let tagsHtml = (item.tags || []).map(t => `<span class="tag" style="font-size:0.7rem;padding:0 4px;">${t}</span>`).join('');
            let citeBtn = currentView !== 'member' ? `<button class="action-btn" onclick="event.stopPropagation();openCitation('${item.id}')" title="å¼•ç”¨">â</button>` : '';

            return `
            <div class="result-item" onclick="${currentView==='member'?'editMember':'editAchievement'}('${item.id}')">
                <input type="checkbox" onclick="event.stopPropagation()" ${selectedItems.has(item.id)?'checked':''}>
                <div class="result-type ${config.class}">${config.icon}</div>
                <div class="result-content">
                    <div class="result-title">${title}</div>
                    <div class="tag-container">${tagsHtml}</div>
                    <div class="result-meta">${escapeHtml(meta)}</div>
                </div>
                <div class="result-actions">
                    ${citeBtn}
                    <button class="action-btn delete" onclick="event.stopPropagation();promptDelete('${item.id}', '${item.type==='member'?'member':'achievement'}')">ğŸ—‘</button>
                </div>
            </div>`;
        }).join('');
    }

    // --- å¢åˆ æ”¹æŸ¥ (CRUD) ---

    function openAddModal() {
        if(currentView === 'member') { openMemberModal(); return; }
        document.getElementById('modalTitle').innerText = 'æ·»åŠ ç§‘ç ”æˆæœ';
        document.getElementById('researchForm').reset();
        document.getElementById('editId').value = '';
        currentTags = []; renderFormTags();
        document.getElementById('type').value = currentView === 'all' ? 'paper' : currentView;
        toggleFormFields();
        document.getElementById('formModal').classList.add('active');
    }

    function editAchievement(id) {
        if(currentUserRole !== 'admin') return;
        const item = achievements.find(a => a.id === id);
        if(!item) return;
        
        document.getElementById('modalTitle').innerText = 'ç¼–è¾‘æˆæœ';
        document.getElementById('editId').value = id;
        document.getElementById('type').value = item.type;
        toggleFormFields();
        
        // å¡«å……é€šç”¨å­—æ®µ
        ['title', 'date', 'authors', 'source', 'level', 'doi'].forEach(k => {
            if(document.getElementById(k)) document.getElementById(k).value = item[k] || '';
        });
        // å¡«å……ç‰¹å®šå­—æ®µ (ç®€åŒ–ç‰ˆï¼Œå®é™…é¡¹ç›®éœ€ä¸€ä¸€å¯¹åº”)
        if(item.type === 'patent') {
            document.getElementById('patentName').value = item.patentName;
            document.getElementById('patentType').value = item.patentType;
        }
        
        currentTags = item.tags || [];
        renderFormTags();
        document.getElementById('formModal').classList.add('active');
    }

    function handleSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const type = document.getElementById('type').value;
        
        // æ”¶é›†è¡¨å•æ•°æ®
        let formData = {
            id: id || Date.now().toString(),
            type,
            updatedAt: new Date().toISOString(),
            tags: currentTags
        };
        
        // ç®€å•æ”¶é›†æ‰€æœ‰ input (ç®€åŒ–ä»£ç )
        const inputs = document.getElementById('researchForm').querySelectorAll('input, select');
        inputs.forEach(input => { if(input.id) formData[input.id] = input.value; });
        
        // è§„èŒƒåŒ–å­—æ®µ
        if(!formData.title) formData.title = formData.patentName || formData.projectName || formData.bookTitle || formData.awardName;
        if(!formData.date) formData.date = formData.applicationDate || formData.projectStartDate || formData.awardDate || formData.bookDate;

        if (id) {
            const idx = achievements.findIndex(a => a.id === id);
            achievements[idx] = { ...achievements[idx], ...formData };
            addLog('æ›´æ–°æˆæœ', `ID: ${id}`);
        } else {
            formData.createdAt = new Date().toISOString();
            achievements.push(formData);
            addLog('æ–°å»ºæˆæœ', `Title: ${formData.title}`);
        }
        
        saveToLocal(); closeModal(); updateStats(); renderResults();
        showToast('ä¿å­˜æˆåŠŸ', 'success');
    }

    // --- å›æ”¶ç«™ä¸åˆ é™¤ ---
    function promptDelete(id, type) {
        if(currentUserRole !== 'admin') { showToast('æ— æƒé™', 'error'); return; }
        if(confirm('ç§»å…¥å›æ”¶ç«™ï¼Ÿ')) {
            const list = type === 'member' ? members : achievements;
            const item = list.find(i => i.id === id);
            if(item) {
                item.isDeleted = true;
                item.deletedAt = new Date().toISOString();
                addLog('åˆ é™¤', `ç§»å…¥å›æ”¶ç«™ ID: ${id}`);
                saveToLocal(); renderResults(); showToast('å·²ç§»å…¥å›æ”¶ç«™', 'success');
            }
        }
    }

    function openRecycleModal() {
        if(currentUserRole !== 'admin') return;
        const deleted = [...achievements, ...members].filter(i => i.isDeleted);
        document.getElementById('recycleList').innerHTML = deleted.length ? deleted.map(item => `
            <div class="result-item deleted-item">
                <div class="result-content"><div class="result-title">${escapeHtml(item.title || item.memberName)}</div></div>
                <div class="result-actions">
                    <button class="btn btn-sm btn-success" onclick="restoreItem('${item.id}')">â™»ï¸</button>
                    <button class="btn btn-sm btn-danger" onclick="hardDelete('${item.id}')">âœ•</button>
                </div>
            </div>`).join('') : '<p style="text-align:center">å›æ”¶ç«™ä¸ºç©º</p>';
        document.getElementById('recycleModal').classList.add('active');
    }

    function restoreItem(id) {
        let item = achievements.find(a=>a.id===id) || members.find(m=>m.id===id);
        if(item) {
            delete item.isDeleted;
            addLog('æ¢å¤', `æ¢å¤ ID: ${id}`);
            saveToLocal(); renderResults(); openRecycleModal();
        }
    }
    
    function hardDelete(id) {
        if(confirm('å½»åº•åˆ é™¤æ— æ³•æ¢å¤ï¼Œç¡®å®šï¼Ÿ')) {
            achievements = achievements.filter(a => a.id !== id);
            members = members.filter(m => m.id !== id);
            addLog('å½»åº•åˆ é™¤', `ID: ${id}`);
            saveToLocal(); openRecycleModal();
        }
    }

    // --- æ™ºèƒ½åŠŸèƒ½ (Fetch/Tags/Resume) ---

    async function fetchMetadataByDOI() {
        const doi = document.getElementById('doi').value;
        if(!doi) return showToast('è¯·è¾“å…¥DOI', 'error');
        
        const btn = document.querySelector('.smart-btn'); btn.innerText = 'æŠ“å–ä¸­...';
        try {
            const res = await fetch(`https://api.crossref.org/works/${doi}`);
            if(!res.ok) throw new Error('æœªæ‰¾åˆ°');
            const data = (await res.json()).message;
            document.getElementById('title').value = data.title?.[0] || '';
            document.getElementById('source').value = data['container-title']?.[0] || '';
            if(data.author) document.getElementById('authors').value = data.author.map(a => `${a.given} ${a.family}`).join(', ');
            if(data.created) {
                const d = data.created['date-parts'][0];
                document.getElementById('date').value = `${d[0]}-${String(d[1]).padStart(2,'0')}-${String(d[2]||1).padStart(2,'0')}`;
            }
            if(!currentTags.includes('SmartFetch')) { currentTags.push('SmartFetch'); renderFormTags(); }
            showToast('æŠ“å–æˆåŠŸ', 'success');
        } catch(e) { showToast('æŠ“å–å¤±è´¥', 'error'); }
        btn.innerText = 'ğŸ” æŠ“å–ä¿¡æ¯';
    }

    async function fetchMetadataByISBN() {
        const isbn = document.getElementById('bookIsbn').value.replace(/-/g,'');
        try {
            const res = await fetch(`https://openlibrary.org/isbn/${isbn}.json`);
            if(!res.ok) throw new Error('æœªæ‰¾åˆ°');
            const data = await res.json();
            document.getElementById('bookTitle').value = data.title;
            if(data.publish_date) document.getElementById('bookDate').value = new Date(data.publish_date).toISOString().slice(0,10);
            showToast('æŠ“å–æˆåŠŸ', 'success');
        } catch(e) { showToast('æœªæ‰¾åˆ°ä¹¦ç±', 'error'); }
    }

    function handleTagInput(e) {
        if(e.key === 'Enter') {
            e.preventDefault();
            const val = e.target.value.trim();
            if(val && !currentTags.includes(val)) {
                currentTags.push(val);
                renderFormTags();
                e.target.value = '';
            }
        }
    }
    function renderFormTags() {
        document.getElementById('formTags').innerHTML = currentTags.map(t => 
            `<span class="tag">${t} <span class="tag-delete" onclick="removeTag('${t}')">âœ•</span></span>`
        ).join('');
    }
    function removeTag(t) { currentTags = currentTags.filter(tag => tag !== t); renderFormTags(); }

    function openCitation(id) {
        const item = achievements.find(a => a.id === id);
        if(!item) return;
        const au = item.authors || 'Unknown';
        const ti = item.title;
        const yr = (item.date||'').substring(0,4);
        
        document.getElementById('citeGB').textContent = `${au}. ${ti}[J]. ${item.source||'Publication'}, ${yr}.`;
        document.getElementById('citeAPA').textContent = `${au} (${yr}). ${ti}. ${item.source||''}.`;
        document.getElementById('citeBib').textContent = `@misc{${id}, title={${ti}}, author={${au}}, year={${yr}}}`;
        document.getElementById('citationModal').classList.add('active');
    }
    function copyText(id) { navigator.clipboard.writeText(document.getElementById(id).textContent); showToast('å·²å¤åˆ¶', 'success'); }

    // --- æˆå‘˜ä¸ç®€å† ---
    function openMemberModal() { document.getElementById('memberForm').reset(); document.getElementById('memberModal').classList.add('active'); }
    function editMember(id) {
        const m = members.find(i=>i.id===id);
        document.getElementById('memberEditId').value=id;
        document.getElementById('memberName').value=m.memberName;
        document.getElementById('memberNo').value=m.memberNo;
        document.getElementById('memberModal').classList.add('active');
    }
    function handleMemberSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('memberEditId').value;
        const data = { 
            id: id || Date.now().toString(), 
            type: 'member',
            memberName: document.getElementById('memberName').value,
            memberNo: document.getElementById('memberNo').value,
            memberTitle: document.getElementById('memberTitle').value,
            memberOrg: document.getElementById('memberOrg').value,
            memberPhone: document.getElementById('memberPhone').value,
            memberEmail: document.getElementById('memberEmail').value
        };
        if(id) { const idx = members.findIndex(m=>m.id===id); members[idx]={...members[idx], ...data}; }
        else { members.push(data); }
        saveToLocal(); closeMemberModal(); renderResults();
    }
    
    function generateResume() {
        const name = document.getElementById('memberName').value;
        if(!name) return;
        const myPapers = achievements.filter(a => a.authors && a.authors.includes(name));
        let html = `<html><body><h1>${name} ä¸ªäººç®€å†</h1><hr><h3>å­¦æœ¯æˆæœ</h3><ul>`;
        myPapers.forEach(p => html += `<li>${p.title} (${p.date})</li>`);
        html += '</ul></body></html>';
        const blob = new Blob([html], {type: 'application/msword'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=`${name}_ç®€å†.doc`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    // --- è¾…åŠ©åŠŸèƒ½ ---
    function updateStats() {
        const counts = { paper:0, patent:0, project:0, award:0, book:0 };
        achievements.forEach(a => { if(!a.isDeleted && counts[a.type]!==undefined) counts[a.type]++; });
        Object.keys(counts).forEach(k => document.getElementById('stat'+k.charAt(0).toUpperCase()+k.slice(1)).innerText = counts[k]);
        document.getElementById('statMember').innerText = members.filter(m=>!m.isDeleted).length;
    }
    
    function toggleFormFields() {
        const type = document.getElementById('type').value;
        ['patentFields','projectFields','awardFields','bookFields','generalFields'].forEach(id => document.getElementById(id).classList.add('hidden'));
        if(type === 'patent') document.getElementById('patentFields').classList.remove('hidden');
        else if(type === 'project') document.getElementById('projectFields').classList.remove('hidden');
        else if(type === 'award') document.getElementById('awardFields').classList.remove('hidden');
        else if(type === 'book') document.getElementById('bookFields').classList.remove('hidden');
        else { document.getElementById('generalFields').classList.remove('hidden'); document.getElementById('dateGroup').classList.remove('hidden'); }
    }
    
    function changePage(delta) { currentPage = Math.max(1, currentPage + delta); renderResults(); }
    function changePageSize() { pageSize = parseInt(document.getElementById('pageSize').value); currentPage=1; renderResults(); }
    function closeModal() { document.getElementById('formModal').classList.remove('active'); }
    function closeMemberModal() { document.getElementById('memberModal').classList.remove('active'); }
    function escapeHtml(text) { return text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }
    function showToast(msg, type) { const t = document.createElement('div'); t.className=`toast ${type} show`; t.innerText=msg; document.getElementById('toastContainer').appendChild(t); setTimeout(()=>t.remove(), 3000); }
    function toggleAdvSearch() { document.getElementById('advSearchPanel').classList.toggle('active'); }
    function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }
    function handleSearch() { currentPage=1; renderResults(); }
    function setYearFilter(y) { currentYearFilter = y; document.querySelectorAll('.filter-chip').forEach(c => c.classList.toggle('active', c.dataset.year === y)); renderResults(); }
    function exportData() {
        const data = JSON.stringify({ achievements, members, systemLogs });
        const blob = new Blob([data], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json';
        a.click();
    }
    function importData(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                const data = JSON.parse(evt.target.result);
                // æ™ºèƒ½åˆå¹¶ï¼šä»…å½“å¯¼å…¥çš„æ•°æ®æ›´æ–°æ—¶è¦†ç›–
                let count = 0;
                (data.achievements||[]).forEach(inc => {
                    const existIdx = achievements.findIndex(a=>a.id===inc.id);
                    if(existIdx === -1) { achievements.push(inc); count++; }
                    else if(new Date(inc.updatedAt) > new Date(achievements[existIdx].updatedAt || 0)) { achievements[existIdx] = inc; count++; }
                });
                saveToLocal(); renderResults(); showToast(`å¯¼å…¥åˆå¹¶ ${count} æ¡`, 'success');
                addLog('å¯¼å…¥', `ä»æ–‡ä»¶å¯¼å…¥ ${count} æ¡è®°å½•`);
            } catch(err) { showToast('æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error'); }
        };
        reader.readAsText(file);
    }

    // åˆå§‹åŒ–
    window.onload = function() {
        loadFromLocal().then(() => {
            updateStats();
            renderResults();
            // ç”Ÿæˆå¹´ä»½ç­›é€‰å™¨
            const years = [...new Set(achievements.map(a => (a.date||'').substring(0,4)).filter(y=>y))].sort().reverse();
            const bar = document.getElementById('filterBar');
            years.forEach(y => {
                const chip = document.createElement('div'); chip.className='filter-chip'; chip.innerText=y; chip.dataset.year=y;
                chip.onclick = () => setYearFilter(y);
                bar.appendChild(chip);
            });
        });
    }
</script>
</body>
</html>

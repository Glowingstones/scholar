<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ (äº‘åŒæ­¥å¢å¼ºç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* =================================================================
           1. CSS å˜é‡å®šä¹‰
           ================================================================= */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --accent: #6366f1;
            --accent-light: #eef2ff;
            --accent-dark: #4f46e5;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-sm: 8px;
        }

        html.dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --border-light: #1e293b;
            --accent-light: #312e81;
            --success-light: #064e3b;
            --warning-light: #78350f;
            --danger-light: #7f1d1d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        .hidden { display: none !important; }

        .app-container { display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100%;
            z-index: 500;
            transition: transform 0.3s ease;
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }

        .logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }

        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem;
        }

        .nav-menu { flex: 1; padding: 16px 12px; overflow-y: auto; }

        .nav-section {
            font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
            padding: 12px 12px 8px; margin-top: 8px;
        }
        .nav-section:first-child { margin-top: 0; }

        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 10px 16px;
            border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary);
            font-weight: 500; transition: all 0.2s; margin-bottom: 2px;
        }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-light); color: var(--accent); }

        .nav-item .badge {
            margin-left: auto; background: var(--bg-hover); padding: 2px 8px;
            border-radius: 10px; font-size: 0.75rem; font-weight: 600;
        }
        .nav-item.active .badge { background: var(--accent); color: white; }

        .sidebar-footer { 
            padding: 16px; 
            border-top: 1px solid var(--border); 
            position: relative; 
            background: var(--bg-secondary);
            z-index: 600;
        }

        /* ä¼˜åŒ–åçš„äº‘åŒæ­¥çŠ¶æ€æ ·å¼ */
        .cloud-status-bar {
            background: var(--accent-light);
            border: 1px solid var(--accent);
            color: var(--accent-dark);
            font-size: 0.8rem;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .cloud-status-dot {
            width: 8px; height: 8px; border-radius: 50%; background: var(--success);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .data-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .data-btn {
            padding: 8px; border: 1px solid var(--border); border-radius: var(--radius-sm);
            background: var(--bg-card); color: var(--text-secondary); font-size: 0.8rem;
            cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .data-btn:hover { background: var(--bg-hover); border-color: var(--accent); color: var(--accent); }
        .btn-full { grid-column: span 2; background: var(--accent); color: white; border: none; }
        .btn-full:hover { background: var(--accent-dark); color: white; }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute; bottom: 100%; left: 10px; width: 240px;
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
            box-shadow: var(--shadow-lg); display: none; z-index: 999; overflow: hidden;
            margin-bottom: 10px;
        }
        .dropdown-menu.show { display: block; animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .menu-item { padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; border-bottom: 1px solid var(--border-light); }
        .menu-item:hover { background: var(--bg-hover); color: var(--accent); }

        /* Main Content */
        .main-content { 
            flex: 1; padding: 24px; height: 100vh; overflow: hidden; 
            display: flex; flex-direction: column;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0; }
        .page-title { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); }
        .header-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

        .search-box input {
            padding: 10px 16px; border: 2px solid var(--border); border-radius: var(--radius);
            background: var(--bg-card); color: var(--text-primary); font-size: 0.95rem;
            width: 280px; transition: all 0.2s;
        }
        .search-box input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }

        .btn {
            padding: 10px 20px; border-radius: var(--radius); font-weight: 600; font-size: 0.95rem;
            cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; box-shadow: var(--shadow); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 16px; margin-bottom: 16px; flex-shrink: 0; 
        }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        .stat-icon.papers { background: #dbeafe; } .stat-icon.patents { background: #fef3c7; }
        .stat-icon.projects { background: #d1fae5; } .stat-icon.awards { background: #fce7f3; }
        .stat-icon.books { background: #e0e7ff; } .stat-icon.members { background: #f3e8ff; }
        
        .stat-info h3 { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); }
        .stat-info p { font-size: 0.8rem; color: var(--text-secondary); }

        /* List Layout */
        #listViewContainer { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .filter-container { margin-bottom: 12px; flex-shrink: 0; }
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; }
        .filter-chip {
            padding: 4px 12px; border-radius: 20px; background: var(--bg-card);
            border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.8rem;
            font-weight: 500; cursor: pointer; transition: all 0.2s;
        }
        .filter-chip:hover { border-color: var(--accent); color: var(--accent); }
        .filter-chip.active { background: var(--accent); border-color: var(--accent); color: white; }
        
        .keyword-bar { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; padding-top: 8px; border-top: 1px dashed var(--border); }
        .keyword-chip { font-size: 0.75rem; padding: 2px 10px; background: var(--bg-hover); border-radius: 12px; color: var(--text-secondary); cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .keyword-chip:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-light); }
        .keyword-chip.active { background: var(--accent); color: white; border-color: var(--accent); }

        .results-container { 
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); 
            display: flex; flex-direction: column; flex: 1; overflow: hidden;
        }
        .results-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 20px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); 
            flex-wrap: wrap; gap: 12px; flex-shrink: 0;
        }
        .results-count { color: var(--text-secondary); font-size: 0.85rem; }
        .batch-actions { display: flex; gap: 12px; align-items: center; }
        .select-all-wrapper { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 4px 8px; border-radius: var(--radius-sm); transition: background 0.2s; }
        .select-all-wrapper:hover { background: var(--bg-hover); }
        .select-all-wrapper input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--accent); }
        
        .results-list { flex: 1; overflow-y: auto; max-height: none; }
        .result-item { 
            display: flex; align-items: center; padding: 10px 20px;
            border-bottom: 1px solid var(--border-light); cursor: pointer; transition: background 0.2s; gap: 14px; 
        }
        .result-item:hover { background: var(--bg-hover); }
        .result-item:last-child { border-bottom: none; }
        .result-checkbox { width: 16px; height: 16px; cursor: pointer; accent-color: var(--accent); flex-shrink: 0; }
        .result-type { 
            width: 36px; height: 36px; border-radius: var(--radius-sm); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.1rem; flex-shrink: 0; 
        }
        
        .type-paper { background: #dbeafe; } .type-patent { background: #fef3c7; }
        .type-project { background: #d1fae5; } .type-award { background: #fce7f3; }
        .type-book { background: #e0e7ff; } .type-member { background: #f3e8ff; }
        
        .result-content { flex: 1; min-width: 0; }
        .result-title { 
            font-weight: 600; color: var(--text-primary); font-size: 0.95rem; margin-bottom: 2px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .result-meta { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.8rem; color: var(--text-secondary); }
        .result-meta span { display: flex; align-items: center; gap: 4px; }
        .result-meta .has-pdf { color: var(--accent); font-weight: 500; }
        
        .result-actions { display: flex; gap: 6px; flex-shrink: 0; opacity: 0.6; transition: opacity 0.2s; }
        .result-item:hover .result-actions { opacity: 1; }
        .action-btn { width: 32px; height: 32px; border: none; background: var(--bg-hover); border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 0.9rem; }
        .action-btn:hover { background: var(--accent-light); color: var(--accent); }
        .action-btn.delete:hover { background: var(--danger-light); color: var(--danger); }

        .empty-state { padding: 60px 20px; text-align: center; color: var(--text-secondary); }
        .empty-state h3 { font-size: 1.25rem; margin-bottom: 8px; color: var(--text-primary); }
        .empty-state p { margin-bottom: 20px; }

        /* Modal Styles */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; padding: 20px; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border-radius: var(--radius); width: 100%; max-width: 560px; max-height: 90vh; overflow: hidden; transform: scale(0.9) translateY(20px); transition: transform 0.3s; display: flex; flex-direction: column; }
        .modal-overlay.active .modal { transform: scale(1) translateY(0); }
        .modal.wide { max-width: 800px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); }
        .modal-header h2 { font-size: 1.25rem; font-weight: 700; }
        .modal-close { width: 36px; height: 36px; border: none; background: var(--bg-hover); border-radius: 50%; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); transition: all 0.2s; }
        .modal-close:hover { background: var(--danger-light); color: var(--danger); }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }

        .file-upload { border: 2px dashed var(--border); border-radius: var(--radius); padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-upload:hover { border-color: var(--accent); background: var(--accent-light); }
        .file-upload input { display: none; }
        .file-upload-icon { font-size: 2.5rem; margin-bottom: 12px; }
        .file-upload-text { color: var(--text-secondary); font-size: 0.9rem; }
        .file-upload.has-file { display: none; }
        .file-info { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--accent-light); border-radius: var(--radius-sm); border: 1px solid var(--accent); }
        .file-info-name { display: flex; align-items: center; gap: 8px; color: var(--accent); font-weight: 500; }
        .file-remove { width: 28px; height: 28px; border: none; background: var(--danger-light); color: var(--danger); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .excel-preview { max-height: 200px; overflow: auto; border: 1px solid var(--border); border-radius: var(--radius-sm); }
        .excel-preview table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .excel-preview th, .excel-preview td { padding: 8px 12px; border: 1px solid var(--border); text-align: left; white-space: nowrap; }
        .excel-preview th { background: var(--bg-secondary); font-weight: 600; position: sticky; top: 0; }
        .mapping-row { display: grid; grid-template-columns: 150px 1fr; gap: 12px; align-items: center; margin-bottom: 12px; }
        .mapping-row label { font-weight: 500; color: var(--text-secondary); }
        .mapping-row select { padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary); }

        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 14px 20px; border-radius: var(--radius-sm); background: var(--bg-card); border: 1px solid var(--border); box-shadow: var(--shadow-lg); font-weight: 500; transform: translateX(120%); transition: transform 0.3s; }
        .toast.show { transform: translateX(0); }
        .toast.success { background: var(--success-light); border-color: var(--success); color: var(--success); }
        .toast.error { background: var(--danger-light); border-color: var(--danger); color: var(--danger); }
        .toast.warning { background: var(--warning-light); border-color: var(--warning); color: var(--warning); }

        /* Duplicate warning */
        .duplicate-warning { background: var(--warning-light); border: 1px solid var(--warning); border-radius: var(--radius-sm); padding: 16px; margin-top: 16px; }
        .duplicate-warning h4 { color: var(--warning); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .duplicate-list { max-height: 150px; overflow-y: auto; font-size: 0.85rem; color: var(--text-secondary); }
        .duplicate-list li { padding: 4px 0; border-bottom: 1px solid var(--warning); }
        .duplicate-list li:last-child { border-bottom: none; }

        @media (max-width: 1024px) { 
            .form-row-3 { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: fixed; height: 100%; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; }
            .form-row, .form-row-3, .mapping-row { grid-template-columns: 1fr; }
            .search-box input { width: 100%; } .header { flex-direction: column; align-items: flex-start; }
            .header-actions { width: 100%; }
        }
    </style>
</head>
<body>
<button class="mobile-menu-btn" onclick="toggleSidebar()" style="display:none;position:fixed;top:16px;left:16px;z-index:101;width:44px;height:44px;border:none;background:var(--bg-card);border-radius:var(--radius-sm);box-shadow:var(--shadow);font-size:1.2rem;cursor:pointer;">â˜°</button>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">ğŸ”¬</div>
                <span>ç§‘ç ”æˆæœç®¡ç†</span>
            </div>
        </div>

        <nav class="nav-menu">
            <div class="nav-section">æˆæœç®¡ç†</div>
            <div class="nav-item active" data-view="all" onclick="setView('all')">
                ğŸ“‹ <span>å…¨éƒ¨æˆæœ</span>
                <span class="badge" id="totalCount">0</span>
            </div>
            <div class="nav-item" data-view="paper" onclick="setView('paper')">
                ğŸ“„ <span>å­¦æœ¯è®ºæ–‡</span>
                <span class="badge" id="paperCount">0</span>
            </div>
            <div class="nav-item" data-view="patent" onclick="setView('patent')">
                ğŸ’¡ <span>å‘æ˜ä¸“åˆ©</span>
                <span class="badge" id="patentCount">0</span>
            </div>
            <div class="nav-item" data-view="project" onclick="setView('project')">
                ğŸ“Š <span>ç§‘ç ”é¡¹ç›®</span>
                <span class="badge" id="projectCount">0</span>
            </div>
            <div class="nav-item" data-view="award" onclick="setView('award')">
                ğŸ† <span>è·å¥–æƒ…å†µ</span>
                <span class="badge" id="awardCount">0</span>
            </div>
            <div class="nav-item" data-view="book" onclick="setView('book')">
                ğŸ“š <span>ä¸“è‘—å‡ºç‰ˆ</span>
                <span class="badge" id="bookCount">0</span>
            </div>
            <div class="nav-section">å›¢é˜Ÿç®¡ç†</div>
            <div class="nav-item" data-view="member" onclick="setView('member')">
                ğŸ‘¥ <span>æˆå‘˜ä¿¡æ¯</span>
                <span class="badge" id="memberCount">0</span>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="cloud-status-bar" onclick="openCloudConfig()">
                <div style="display:flex;align-items:center;gap:6px;">
                    <div id="cloudStatusDot" class="cloud-status-dot" style="background:#ccc;box-shadow:none;animation:none;"></div>
                    <span id="cloudStatusText">â˜ï¸ æœªé…ç½®åŒæ­¥</span>
                </div>
                <span style="font-size:0.7rem;">è®¾ç½®</span>
            </div>
            
            <div class="data-actions">
                <button class="data-btn btn-full" onclick="toggleMenu('exportMenu')">ğŸ“¤ å¯¼å‡º / å¤‡ä»½</button>
                <button class="data-btn" onclick="toggleMenu('importMenu')">ğŸ“¥ å¯¼å…¥</button>
                <button class="data-btn" onclick="triggerImport()">ğŸ“‚ æ¢å¤</button>
            </div>
            
            <div id="exportMenu" class="dropdown-menu">
                <div class="menu-item" onclick="exportToExcelFile()">ğŸ“Š å¯¼å‡º Excel (å…¨è¡¨)</div>
                <div class="menu-item" onclick="exportToWordFile()">ğŸ“ å¯¼å‡º Word (å…¨è¡¨)</div>
                <div class="menu-item" onclick="exportData()">ğŸ“¦ å¤‡ä»½æ•°æ® (JSON)</div>
            </div>

            <div id="importMenu" class="dropdown-menu">
                <div class="menu-item" onclick="openExcelImport()">ğŸ“Š å¯¼å…¥ Excel</div>
                <div class="menu-item" onclick="showToast('Wordå¯¼å…¥æš‚ä¸æ”¯æŒ','warning')">ğŸ“ å¯¼å…¥ Word</div>
            </div>

            <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(event)">
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <h1 class="page-title" id="pageTitle">å…¨éƒ¨æˆæœ</h1>
            <div class="header-actions">
                <div class="search-box" id="searchBoxContainer">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢..." oninput="handleSearch()">
                </div>
                <button class="btn btn-primary" id="addBtn" onclick="openAddModal()">â• <span id="addBtnText">æ·»åŠ æˆæœ</span></button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon papers">ğŸ“„</div>
                <div class="stat-info"><h3 id="statPaper">0</h3><p>å­¦æœ¯è®ºæ–‡</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon patents">ğŸ’¡</div>
                <div class="stat-info"><h3 id="statPatent">0</h3><p>å‘æ˜ä¸“åˆ©</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon projects">ğŸ“Š</div>
                <div class="stat-info"><h3 id="statProject">0</h3><p>ç§‘ç ”é¡¹ç›®</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon awards">ğŸ†</div>
                <div class="stat-info"><h3 id="statAward">0</h3><p>è·å¥–æƒ…å†µ</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon books">ğŸ“š</div>
                <div class="stat-info"><h3 id="statBook">0</h3><p>ä¸“è‘—å‡ºç‰ˆ</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon members">ğŸ‘¥</div>
                <div class="stat-info"><h3 id="statMember">0</h3><p>æˆå‘˜</p></div>
            </div>
        </div>

        <div id="listViewContainer">
            <div class="filter-container">
                <div class="filter-bar" id="filterBar">
                    <div class="filter-chip active" data-year="all" onclick="setYearFilter('all')">å…¨éƒ¨å¹´ä»½</div>
                </div>
                <div class="keyword-bar" id="keywordBar" style="display:none;">
                    <span style="font-size:0.8rem;color:var(--text-muted);margin-right:5px;">ğŸ·ï¸ çƒ­é—¨æ ‡ç­¾:</span>
                </div>
            </div>

            <div class="results-container" id="resultsContainer">
                <div class="results-header">
                    <div class="batch-actions">
                        <label class="select-all-wrapper">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <span>å…¨é€‰</span>
                        </label>
                        <button class="btn btn-danger btn-sm" id="batchDeleteBtn" onclick="batchDelete()" style="display:none;">
                            ğŸ—‘ åˆ é™¤é€‰ä¸­ (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span class="results-count" id="resultsCount">å…± 0 æ¡è®°å½•</span>
                        <select id="sortSelect" onchange="handleSort()" style="padding:10px 14px;border-radius:8px;border:2px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-weight:500;">
                            <option value="date-desc">æœ€æ–°ä¼˜å…ˆ</option>
                            <option value="date-asc">æœ€æ—©ä¼˜å…ˆ</option>
                            <option value="title-asc">æ ‡é¢˜ A-Z</option>
                        </select>
                    </div>
                </div>
                <div class="results-list" id="resultsList"></div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="cloudModal">
    <div class="modal" style="max-width:500px;">
        <div class="modal-header">
            <h2>â˜ï¸ äº‘åŒæ­¥é…ç½® (GitHub Gist)</h2>
            <button class="modal-close" onclick="closeCloudModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom:15px;color:var(--text-secondary);font-size:0.9rem;">
                ä½¿ç”¨ GitHub Gist å®ç°å¤šè®¾å¤‡æ•°æ®åŒæ­¥ã€‚æ•°æ®å°†å­˜å‚¨åœ¨æ‚¨çš„ GitHub ç§æœ‰ Gist ä¸­ã€‚
            </p>
            <div class="form-group">
                <label>GitHub Token (å¿…å¡«)</label>
                <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx" class="form-control">
                <small style="color:var(--text-muted);display:block;margin-top:4px;">
                    éœ€åœ¨ GitHub Settings -> Developer settings -> Personal access tokens ç”³è¯·ï¼Œå‹¾é€‰ <b>gist</b> æƒé™ã€‚
                </small>
            </div>
            <div class="form-group">
                <label>Gist ID (é€‰å¡«)</label>
                <input type="text" id="ghGistId" placeholder="ç°æœ‰æ•°æ®çš„ Gist ID (ç•™ç©ºåˆ™åˆ›å»ºæ–°çš„)" class="form-control">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCloudModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="connectGithub()">è¿æ¥ / è‡ªåŠ¨åˆ›å»º</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="formModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="modalTitle">æ·»åŠ ç§‘ç ”æˆæœ</h2>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="researchForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label>æˆæœç±»å‹ *</label>
                        <select id="type" required onchange="toggleFormFields()">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                            <option value="patent">å‘æ˜ä¸“åˆ©</option>
                            <option value="project">ç§‘ç ”é¡¹ç›®</option>
                            <option value="award">è·å¥–æƒ…å†µ</option>
                            <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                        </select>
                    </div>
                    <div class="form-group" id="dateGroup">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="date">
                    </div>
                </div>
                <div id="generalFields">
                    <div class="form-group" id="titleGroup">
                        <label>æ ‡é¢˜ *</label>
                        <input type="text" id="title" placeholder="è¯·è¾“å…¥æˆæœæ ‡é¢˜">
                    </div>
                    <div class="form-group" id="authorsGroup">
                        <label>ä½œè€…/æˆå‘˜</label>
                        <input type="text" id="authors" placeholder="å¤šä¸ªä½œè€…ç”¨é€—å·åˆ†éš”">
                    </div>
                    <div class="form-row" id="sourceGroup">
                        <div class="form-group">
                            <label>æ¥æº/æœŸåˆŠ</label>
                            <input type="text" id="source" placeholder="å¦‚ Nature">
                        </div>
                        <div class="form-group">
                            <label>çº§åˆ«</label>
                            <input type="text" id="level" placeholder="å¦‚ SCIä¸€åŒº">
                        </div>
                    </div>
                    <div class="form-group" id="keywordsGroup">
                        <label>å…³é”®è¯</label>
                        <input type="text" id="keywords" placeholder="å¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”">
                    </div>
                </div>
                <div id="patentFields" class="hidden">
                    <div class="form-group">
                        <label>ä¸“åˆ©åç§° *</label>
                        <input type="text" id="patentName" placeholder="è¯·è¾“å…¥ä¸“åˆ©åç§°">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ä¸“åˆ©ç±»å‹ *</label>
                            <select id="patentType">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="å‘æ˜ä¸“åˆ©">å‘æ˜ä¸“åˆ©</option>
                                <option value="å®ç”¨æ–°å‹">å®ç”¨æ–°å‹</option>
                                <option value="å¤–è§‚è®¾è®¡">å¤–è§‚è®¾è®¡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ä¸“åˆ©çŠ¶æ€</label>
                            <select id="patentStatus">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="ç”³è¯·ä¸­">ç”³è¯·ä¸­</option>
                                <option value="å·²å—ç†">å·²å—ç†</option>
                                <option value="å®å®¡ä¸­">å®å®¡ä¸­</option>
                                <option value="å·²æˆæƒ">å·²æˆæƒ</option>
                                <option value="å·²é©³å›">å·²é©³å›</option>
                                <option value="å·²å¤±æ•ˆ">å·²å¤±æ•ˆ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å‘æ˜äºº</label>
                            <input type="text" id="inventors" placeholder="å¤šä¸ªå‘æ˜äººç”¨é€—å·åˆ†éš”">
                        </div>
                        <div class="form-group">
                            <label>ä¸“åˆ©æƒäºº</label>
                            <input type="text" id="patentOwner" placeholder="ä¸“åˆ©æƒäºº">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ä¸“åˆ©ç”³è¯·æ—¥</label>
                            <input type="date" id="applicationDate">
                        </div>
                        <div class="form-group">
                            <label>å—ç†/æˆæƒæ—¶é—´</label>
                            <input type="date" id="grantDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ä¸“åˆ©å·</label>
                        <input type="text" id="patentNumber" placeholder="å¦‚ CN202310001234.5">
                    </div>
                </div>
                <div id="projectFields" class="hidden">
                    <div class="form-group">
                        <label>é¡¹ç›®åç§° *</label>
                        <input type="text" id="projectName" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>é¡¹ç›®çº§åˆ«</label>
                            <select id="projectLevel">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="å›½å®¶çº§">å›½å®¶çº§</option>
                                <option value="çœéƒ¨çº§">çœéƒ¨çº§</option>
                                <option value="å…å±€çº§">å…å±€çº§</option>
                                <option value="æ ¡çº§">æ ¡çº§</option>
                                <option value="æ¨ªå‘é¡¹ç›®">æ¨ªå‘é¡¹ç›®</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é¡¹ç›®ç¼–å·</label>
                            <input type="text" id="projectNumber" placeholder="é¡¹ç›®ç¼–å·">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å¼€å§‹æ—¶é—´</label>
                            <input type="date" id="projectStartDate">
                        </div>
                        <div class="form-group">
                            <label>ç»“æŸæ—¶é—´</label>
                            <input type="date" id="projectEndDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é¡¹ç›®æ‰€å±å•ä½</label>
                        <input type="text" id="projectOrg" placeholder="é¡¹ç›®æ‰€å±å•ä½">
                    </div>
                </div>
                <div class="form-group">
                    <label>ğŸ“ PDF é™„ä»¶</label>
                    <div class="file-upload" id="fileUpload" onclick="document.getElementById('pdfInput').click()">
                        <input type="file" id="pdfInput" accept=".pdf" onchange="handleFileSelect(event)">
                        <div class="file-upload-icon">ğŸ“„</div>
                        <div class="file-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  PDF æ–‡ä»¶</div>
                    </div>
                    <div class="file-info hidden" id="fileInfo">
                        <span class="file-info-name">
                            <span>ğŸ“„</span>
                            <span id="fileName"></span>
                        </span>
                        <button type="button" class="file-remove" onclick="removeFile()">âœ•</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="submit" form="researchForm" class="btn btn-primary" id="submitBtn">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="memberModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="memberModalTitle">æ·»åŠ æˆå‘˜</h2>
            <button class="modal-close" onclick="closeMemberModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="memberForm" onsubmit="handleMemberSubmit(event)">
                <input type="hidden" id="memberEditId">
                <div class="form-row-3">
                    <div class="form-group">
                        <label>å­¦å·/å·¥å· *</label>
                        <input type="text" id="memberNo" required placeholder="å­¦å·æˆ–å·¥å·">
                    </div>
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="memberName" required placeholder="å§“å">
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ«</label>
                        <select id="memberGender">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                        </select>
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>å‡ºç”Ÿå¹´æœˆ</label>
                        <input type="month" id="memberBirth">
                    </div>
                    <div class="form-group">
                        <label>è¯ä»¶ç±»å‹</label>
                        <select id="memberIdType">
                            <option value="èº«ä»½è¯">èº«ä»½è¯</option>
                            <option value="æŠ¤ç…§">æŠ¤ç…§</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è¯ä»¶å·ç </label>
                        <input type="text" id="memberIdNo" placeholder="è¯ä»¶å·ç ">
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>æ°‘æ—</label>
                        <input type="text" id="memberNation" placeholder="å¦‚ï¼šæ±‰æ—">
                    </div>
                    <div class="form-group">
                        <label>å›½åˆ«æˆ–åœ°åŒº</label>
                        <input type="text" id="memberCountry" placeholder="å¦‚ï¼šä¸­å›½" value="ä¸­å›½">
                    </div>
                    <div class="form-group">
                        <label>å·¥ä½œå•ä½</label>
                        <input type="text" id="memberOrg" placeholder="æ‰€å±å•ä½">
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>èŒç§°</label>
                        <input type="text" id="memberTitle" placeholder="å¦‚ï¼šå‰¯æ•™æˆ">
                    </div>
                    <div class="form-group">
                        <label>æ˜¯å¦åœ¨è¯»ç ”ç©¶ç”Ÿ</label>
                        <select id="memberIsStudent">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="æ˜¯">æ˜¯</option>
                            <option value="å¦">å¦</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æœ€é«˜å­¦ä½</label>
                        <select id="memberDegree">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="å­¦å£«">å­¦å£«</option>
                            <option value="ç¡•å£«">ç¡•å£«</option>
                            <option value="åšå£«">åšå£«</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”µå­é‚®ç®±</label>
                        <input type="email" id="memberEmail" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label>æ‰‹æœº</label>
                        <input type="tel" id="memberPhone" placeholder="æ‰‹æœºå·ç ">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">å–æ¶ˆ</button>
            <button type="submit" form="memberForm" class="btn btn-primary">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="excelModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2>å¯¼å…¥ Excel æ•°æ®</h2>
            <button class="modal-close" onclick="closeExcelModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>é€‰æ‹©è¦å¯¼å…¥çš„æ•°æ®ç±»å‹</label>
                <select id="excelImportType" onchange="updateMappingFields()">
                    <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                    <option value="patent">å‘æ˜ä¸“åˆ©</option>
                    <option value="project">ç§‘ç ”é¡¹ç›®</option>
                    <option value="award">è·å¥–æƒ…å†µ</option>
                    <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                    <option value="member">æˆå‘˜</option>
                </select>
            </div>
            <div class="form-group">
                <label>é€‰æ‹© Excel æ–‡ä»¶</label>
                <div class="file-upload" onclick="document.getElementById('excelInput').click()">
                    <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" onchange="handleExcelSelect(event)">
                    <div class="file-upload-icon">ğŸ“Š</div>
                    <div class="file-upload-text">ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶ (.xlsx, .xls, .csv)</div>
                </div>
            </div>
            <div id="excelPreviewContainer" class="hidden">
                <label style="font-weight:600;margin-bottom:10px;display:block;">æ•°æ®é¢„è§ˆï¼ˆå‰5è¡Œï¼‰</label>
                <div class="excel-preview" id="excelPreview"></div>
            </div>
            <div id="mappingContainer" class="hidden" style="margin-top:20px;">
                <label style="font-weight:600;margin-bottom:10px;display:block;">å­—æ®µæ˜ å°„</label>
                <div id="mappingFields"></div>
            </div>
            <div id="duplicateWarning" class="duplicate-warning hidden">
                <h4>âš ï¸ å‘ç°é‡å¤é¡¹</h4>
                <ul class="duplicate-list" id="duplicateList"></ul>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeExcelModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="importExcelBtn" onclick="confirmExcelImport()" disabled>ç¡®è®¤å¯¼å…¥</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="confirmModal">
    <div class="modal" style="max-width:400px;">
        <div class="modal-header">
            <h2>ç¡®è®¤åˆ é™¤</h2>
            <button class="modal-close" onclick="closeConfirmModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <p id="confirmMessage" style="text-align:center;font-size:1.1rem;">ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ</p>
        </div>
        <div class="modal-footer" style="justify-content:center;">
            <button class="btn btn-secondary" onclick="closeConfirmModal()">å–æ¶ˆ</button>
            <button class="btn btn-danger" onclick="confirmDelete()">åˆ é™¤</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
    // =========================================================================
    // 1. Global Config & State
    // =========================================================================
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');

    var achievements = [];
    var members = [];
    var currentView = 'all';
    var currentYearFilter = 'all';
    var currentKeywordFilter = null;
    var searchQuery = '';
    var sortOrder = 'date-desc';
    var deleteTargetIds = [];
    var deleteTargetType = 'achievement';
    var currentPdfData = null;
    var currentPdfName = null;
    var excelData = null;
    var excelHeaders = [];
    var selectedItems = new Set();
    
    // GitHub Sync Config
    var ghConfig = { token: '', gistId: '' };

    var typeConfig = {
        paper: { icon: 'ğŸ“„', label: 'å­¦æœ¯è®ºæ–‡', class: 'type-paper' },
        patent: { icon: 'ğŸ’¡', label: 'å‘æ˜ä¸“åˆ©', class: 'type-patent' },
        project: { icon: 'ğŸ“Š', label: 'ç§‘ç ”é¡¹ç›®', class: 'type-project' },
        award: { icon: 'ğŸ†', label: 'è·å¥–æƒ…å†µ', class: 'type-award' },
        book: { icon: 'ğŸ“š', label: 'ä¸“è‘—å‡ºç‰ˆ', class: 'type-book' },
        member: { icon: 'ğŸ‘¤', label: 'æˆå‘˜', class: 'type-member' }
    };

    var fieldMappings = {
        paper: [
            { key: 'title', label: 'æ ‡é¢˜', required: true }, { key: 'authors', label: 'ä½œè€…' },
            { key: 'date', label: 'å‘è¡¨æ—¥æœŸ' }, { key: 'source', label: 'æœŸåˆŠ/æ¥æº' },
            { key: 'level', label: 'çº§åˆ«' }, { key: 'keywords', label: 'å…³é”®è¯' }
        ],
        patent: [
            { key: 'patentName', label: 'ä¸“åˆ©åç§°', required: true }, { key: 'patentType', label: 'ç±»å‹' },
            { key: 'inventors', label: 'å‘æ˜äºº' }, { key: 'patentOwner', label: 'æƒåˆ©äºº' },
            { key: 'applicationDate', label: 'ç”³è¯·æ—¥' }, { key: 'grantDate', label: 'æˆæƒæ—¥' },
            { key: 'patentNumber', label: 'ä¸“åˆ©å·' }, { key: 'patentStatus', label: 'çŠ¶æ€' }
        ],
        project: [
            { key: 'projectName', label: 'é¡¹ç›®åç§°', required: true }, { key: 'projectLevel', label: 'çº§åˆ«' },
            { key: 'projectNumber', label: 'ç¼–å·' }, { key: 'projectStartDate', label: 'å¼€å§‹æ—¶é—´' },
            { key: 'projectEndDate', label: 'ç»“æŸæ—¶é—´' }, { key: 'projectOrg', label: 'å•ä½' }
        ],
        award: [
            { key: 'title', label: 'å¥–é¡¹åç§°', required: true }, { key: 'authors', label: 'è·å¥–äºº' },
            { key: 'date', label: 'è·å¥–æ—¥æœŸ' }, { key: 'level', label: 'çº§åˆ«' }
        ],
        book: [
            { key: 'title', label: 'è‘—ä½œåç§°', required: true }, { key: 'authors', label: 'ä½œè€…' },
            { key: 'date', label: 'å‡ºç‰ˆæ—¥æœŸ' }, { key: 'source', label: 'å‡ºç‰ˆç¤¾' }
        ],
        member: [
            { key: 'memberNo', label: 'å·¥å·', required: true }, { key: 'memberName', label: 'å§“å', required: true },
            { key: 'memberGender', label: 'æ€§åˆ«' }, { key: 'memberBirth', label: 'å‡ºç”Ÿå¹´æœˆ' },
            { key: 'memberIdType', label: 'è¯ä»¶ç±»å‹' }, { key: 'memberIdNo', label: 'è¯ä»¶å·' },
            { key: 'memberNation', label: 'æ°‘æ—' }, { key: 'memberCountry', label: 'å›½åˆ«' },
            { key: 'memberOrg', label: 'å•ä½' }, { key: 'memberTitle', label: 'èŒç§°' },
            { key: 'memberIsStudent', label: 'åœ¨è¯»' }, { key: 'memberDegree', label: 'å­¦ä½' },
            { key: 'memberEmail', label: 'é‚®ç®±' }, { key: 'memberPhone', label: 'æ‰‹æœº' }
        ]
    };

    // =========================================================================
    // 2. Data Storage (IndexedDB + GitHub Sync)
    // =========================================================================
    const DB_NAME = 'ResearchDB_Unlimited';
    const DB_VERSION = 1;
    let db;

    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = e => reject(e.target.errorCode);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('appState')) db.createObjectStore('appState', { keyPath: 'id' });
            };
            request.onsuccess = e => { db = e.target.result; resolve(db); };
        });
    }

    async function saveToLocal(skipCloud = false) {
        if (!db) await initDB();
        const tx = db.transaction(['appState'], 'readwrite');
        const store = tx.objectStore('appState');
        const data = { id: 'main_data', achievements: achievements, members: members, ghConfig: ghConfig, updatedAt: new Date().toISOString() };
        store.put(data);
        updateStorageStatus(true);
        if (!skipCloud && ghConfig.token && ghConfig.gistId) syncToGithub();
    }

    async function loadFromLocal() {
        if (!db) await initDB();
        return new Promise((resolve) => {
            const tx = db.transaction(['appState'], 'readonly');
            const req = tx.objectStore('appState').get('main_data');
            req.onsuccess = e => {
                const res = e.target.result;
                if (res) {
                    achievements = res.achievements || [];
                    members = res.members || [];
                    ghConfig = res.ghConfig || { token: '', gistId: '' };
                    updateCloudStatusUI();
                    if (ghConfig.token && ghConfig.gistId) syncFromGithub(); // Auto pull
                    resolve(true);
                } else { resolve(false); }
            };
        });
    }

    function updateStorageStatus(ok) {
        const el = document.getElementById('storageStatus');
        if (ok) { el.className = 'storage-status'; el.textContent = 'âœ“ æ•°æ®å·²è‡ªåŠ¨ä¿å­˜'; }
        else { el.className = 'storage-status warning'; el.textContent = 'âš  ä¿å­˜å¤±è´¥'; }
    }

    // --- GitHub Sync Logic ---
    function openCloudConfig() {
        document.getElementById('ghToken').value = ghConfig.token;
        document.getElementById('ghGistId').value = ghConfig.gistId;
        document.getElementById('cloudModal').classList.add('active');
    }

    function closeCloudModal() { document.getElementById('cloudModal').classList.remove('active'); }

    async function connectGithub() {
        const token = document.getElementById('ghToken').value.trim();
        const gistId = document.getElementById('ghGistId').value.trim();
        if (!token) return showToast('è¯·è¾“å…¥ Token', 'error');

        showToast('æ­£åœ¨è¿æ¥ GitHub...', 'warning');
        
        try {
            if (gistId) {
                // Verify existing
                const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: { Authorization: `token ${token}` }
                });
                if (!res.ok) throw new Error('Gist ID æ— æ•ˆæˆ–æ— æƒé™');
                ghConfig = { token, gistId };
                await syncFromGithub();
            } else {
                // Create new
                const res = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description: "Research Data Sync",
                        public: false,
                        files: { "data.json": { content: JSON.stringify({ achievements, members }) } }
                    })
                });
                if (!res.ok) throw new Error('åˆ›å»º Gist å¤±è´¥');
                const data = await res.json();
                ghConfig = { token, gistId: data.id };
                showToast('å·²åˆ›å»ºæ–°äº‘ç«¯å­˜å‚¨', 'success');
            }
            saveToLocal(true);
            updateCloudStatusUI();
            closeCloudModal();
        } catch (e) {
            showToast(e.message, 'error');
        }
    }

    async function syncToGithub() {
        document.getElementById('cloudStatusText').textContent = 'â˜ï¸ æ­£åœ¨ä¸Šä¼ ...';
        try {
            // Remove huge PDF data before syncing to Gist to avoid limits (Gist max 100MB, but API tricky)
            // Ideally, warn user. For now, we sync everything.
            await fetch(`https://api.github.com/gists/${ghConfig.gistId}`, {
                method: 'PATCH',
                headers: { Authorization: `token ${ghConfig.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: { "data.json": { content: JSON.stringify({ achievements, members }) } } })
            });
            document.getElementById('cloudStatusText').textContent = 'â˜ï¸ åŒæ­¥å®Œæˆ';
            setTimeout(updateCloudStatusUI, 2000);
        } catch (e) {
            document.getElementById('cloudStatusText').textContent = 'â˜ï¸ åŒæ­¥å¤±è´¥';
        }
    }

    async function syncFromGithub() {
        document.getElementById('cloudStatusText').textContent = 'â˜ï¸ æ­£åœ¨ä¸‹è½½...';
        try {
            const res = await fetch(`https://api.github.com/gists/${ghConfig.gistId}`, {
                headers: { Authorization: `token ${ghConfig.token}` }
            });
            const data = await res.json();
            const content = JSON.parse(data.files['data.json'].content);
            achievements = content.achievements || [];
            members = content.members || [];
            saveToLocal(true); // Save to local without pushing back
            updateStats();
            renderResults();
            updateCloudStatusUI();
            showToast('å·²ä»äº‘ç«¯æ‹‰å–æœ€æ–°æ•°æ®', 'success');
        } catch (e) {
            showToast('äº‘ç«¯åŒæ­¥å¤±è´¥', 'error');
        }
    }

    function updateCloudStatusUI() {
        const dot = document.getElementById('cloudStatusDot');
        const text = document.getElementById('cloudStatusText');
        if (ghConfig.token) {
            dot.style.background = 'var(--success)';
            dot.style.animation = 'pulse 2s infinite';
            text.textContent = 'â˜ï¸ äº‘ç«¯å·²è¿æ¥';
        } else {
            dot.style.background = '#ccc';
            dot.style.animation = 'none';
            text.textContent = 'â˜ï¸ æœªé…ç½®åŒæ­¥';
        }
    }

    // =========================================================================
    // 3. App Logic
    // =========================================================================
    function base64ToBlob(b64) {
        const arr = b64.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]);
        let n = bstr.length, u8arr = new Uint8Array(n);
        while (n--) u8arr[n] = bstr.charCodeAt(n);
        return new Blob([u8arr], { type: mime });
    }

    function handleFileSelect(e) {
        const f = e.target.files[0];
        if (!f || f.type !== 'application/pdf') return showToast('ä»…æ”¯æŒ PDF', 'error');
        if (f.size > 20 * 1024 * 1024) return showToast('æ–‡ä»¶è¿‡å¤§ (>20MB)', 'error');
        const r = new FileReader();
        r.onload = ev => {
            currentPdfData = ev.target.result;
            currentPdfName = f.name;
            document.getElementById('fileName').textContent = f.name;
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('fileUpload').classList.add('has-file');
        };
        r.readAsDataURL(f);
    }

    function removeFile() {
        currentPdfData = null; currentPdfName = null;
        document.getElementById('fileInfo').classList.add('hidden');
        document.getElementById('fileUpload').classList.remove('hidden');
        document.getElementById('fileUpload').classList.remove('has-file');
    }

    function viewPdf(id) {
        const i = achievements.find(a => a.id === id);
        if (i && i.pdfData) window.open(URL.createObjectURL(base64ToBlob(i.pdfData)));
    }
    
    function downloadPdf(id) {
        const i = achievements.find(a => a.id === id);
        if (i && i.pdfData) {
            const a = document.createElement('a');
            a.href = i.pdfData; a.download = i.pdfName || 'doc.pdf';
            a.click();
        }
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function toggleMenu(id) {
        document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
        document.getElementById(id).classList.toggle('show');
    }
    document.onclick = e => { if (!e.target.closest('.data-actions, .dropdown-menu')) document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show')); };

    function setView(v) {
        currentView = v; selectedItems.clear(); updateBatchDeleteBtn();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.view === v));
        const titles = { all: 'å…¨éƒ¨æˆæœ', paper: 'å­¦æœ¯è®ºæ–‡', patent: 'å‘æ˜ä¸“åˆ©', project: 'ç§‘ç ”é¡¹ç›®', award: 'è·å¥–æƒ…å†µ', book: 'ä¸“è‘—å‡ºç‰ˆ', member: 'æˆå‘˜ä¿¡æ¯' };
        document.getElementById('pageTitle').textContent = titles[v];
        document.getElementById('addBtnText').textContent = v === 'member' ? 'æ·»åŠ æˆå‘˜' : 'æ·»åŠ æˆæœ';
        if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
        renderResults();
    }

    function updateStats() {
        const counts = { paper:0, patent:0, project:0, award:0, book:0 };
        achievements.forEach(i => { if (counts[i.type] !== undefined) counts[i.type]++; });
        document.getElementById('totalCount').innerText = achievements.length;
        document.getElementById('memberCount').innerText = members.length;
        document.getElementById('statMember').innerText = members.length;
        Object.keys(counts).forEach(k => {
            document.getElementById(k+'Count').innerText = counts[k];
            document.getElementById('stat'+k.charAt(0).toUpperCase()+k.slice(1)).innerText = counts[k];
        });
        
        // Year filter
        const years = [...new Set(achievements.map(a => (a.date||a.applicationDate||a.projectStartDate||'').substr(0,4)).filter(y=>y))].sort().reverse();
        let html = `<div class="filter-chip ${currentYearFilter==='all'?'active':''}" onclick="setYearFilter('all')">å…¨éƒ¨</div>`;
        years.forEach(y => html += `<div class="filter-chip ${currentYearFilter===y?'active':''}" onclick="setYearFilter('${y}')">${y}</div>`);
        document.getElementById('filterBar').innerHTML = html;
    }

    function setYearFilter(y) { currentYearFilter = y; renderResults(); updateStats(); }
    function handleSearch() { searchQuery = document.getElementById('searchInput').value.toLowerCase(); renderResults(); }
    function handleSort() { sortOrder = document.getElementById('sortSelect').value; renderResults(); }

    function renderResults() {
        const list = document.getElementById('resultsList');
        if (currentView === 'member') return renderMembers(list);

        let data = achievements.filter(a => currentView === 'all' || a.type === currentView);
        if (currentYearFilter !== 'all') data = data.filter(a => (a.date||a.applicationDate||a.projectStartDate||'').startsWith(currentYearFilter));
        if (searchQuery) data = data.filter(a => Object.values(a).join(' ').toLowerCase().includes(searchQuery));

        data.sort((a,b) => {
            const dA = a.date||'0', dB = b.date||'0';
            return sortOrder === 'date-desc' ? dB.localeCompare(dA) : (sortOrder === 'date-asc' ? dA.localeCompare(dB) : (a.title||'').localeCompare(b.title||''));
        });

        document.getElementById('resultsCount').textContent = `å…± ${data.length} æ¡`;
        
        if (data.length === 0) return list.innerHTML = `<div class="empty-state"><p>æš‚æ— æ•°æ®</p></div>`;

        list.innerHTML = data.map(item => {
            const t = typeConfig[item.type];
            const title = item.title || item.patentName || item.projectName;
            const date = item.date || item.applicationDate || item.projectStartDate;
            const sub = item.authors || item.inventors;
            const checked = selectedItems.has(item.id) ? 'checked' : '';
            return `
            <div class="result-item" onclick="editAchievement('${item.id}')">
                <input type="checkbox" class="result-checkbox" ${checked} onclick="toggleItem('${item.id}', event)">
                <div class="result-type ${t.class}">${t.icon}</div>
                <div class="result-content">
                    <div class="result-title">${title}</div>
                    <div class="result-meta">
                        <span>ğŸ“… ${date}</span><span>ğŸ‘¤ ${sub}</span>
                        ${item.pdfData ? '<span class="has-pdf">ğŸ“ é™„ä»¶</span>' : ''}
                    </div>
                </div>
                <div class="result-actions">
                    ${item.pdfData ? `<button class="action-btn" onclick="event.stopPropagation();viewPdf('${item.id}')">ğŸ‘</button>` : ''}
                    <button class="action-btn delete" onclick="event.stopPropagation();promptDelete('${item.id}', 'achievement')">ğŸ—‘</button>
                </div>
            </div>`;
        }).join('');
    }

    function renderMembers(list) {
        let data = members.filter(m => !searchQuery || Object.values(m).join(' ').toLowerCase().includes(searchQuery));
        document.getElementById('resultsCount').textContent = `å…± ${data.length} æ¡`;
        list.innerHTML = data.map(m => `
            <div class="result-item" onclick="editMember('${m.id}')">
                <input type="checkbox" class="result-checkbox" ${selectedItems.has(m.id)?'checked':''} onclick="toggleItem('${m.id}', event)">
                <div class="result-type type-member">ğŸ‘¤</div>
                <div class="result-content">
                    <div class="result-title">${m.memberName}</div>
                    <div class="result-meta"><span>ğŸ”¢ ${m.memberNo}</span><span>ğŸ¢ ${m.memberOrg}</span></div>
                </div>
                <div class="result-actions"><button class="action-btn delete" onclick="event.stopPropagation();promptDelete('${m.id}', 'member')">ğŸ—‘</button></div>
            </div>`).join('');
    }

    // Modal & CRUD
    function openAddModal() {
        if (currentView === 'member') { openMemberModal(); return; }
        const f = document.getElementById('researchForm'); f.reset();
        document.getElementById('editId').value = ''; currentPdfData = null; removeFile();
        document.getElementById('type').value = (currentView !== 'all' && currentView !== 'member') ? currentView : '';
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('modalTitle').textContent = 'æ·»åŠ ç§‘ç ”æˆæœ';
        toggleFormFields();
        document.getElementById('formModal').classList.add('active');
    }
    
    function editAchievement(id) {
        const item = achievements.find(a => a.id === id); if (!item) return;
        const f = document.getElementById('researchForm');
        document.getElementById('editId').value = id;
        document.getElementById('type').value = item.type; toggleFormFields();
        // Fill fields based on type (simplified for brevity, mapped 1:1)
        if(item.type==='patent'){
            document.getElementById('patentName').value = item.patentName;
            document.getElementById('patentType').value = item.patentType;
            document.getElementById('inventors').value = item.inventors;
            document.getElementById('patentOwner').value = item.patentOwner;
            document.getElementById('applicationDate').value = item.applicationDate;
            document.getElementById('grantDate').value = item.grantDate;
            document.getElementById('patentNumber').value = item.patentNumber;
            document.getElementById('patentStatus').value = item.patentStatus;
        } else if(item.type==='project'){
            document.getElementById('projectName').value = item.projectName;
            document.getElementById('projectLevel').value = item.projectLevel;
            document.getElementById('projectNumber').value = item.projectNumber;
            document.getElementById('projectStartDate').value = item.projectStartDate;
            document.getElementById('projectEndDate').value = item.projectEndDate;
            document.getElementById('projectOrg').value = item.projectOrg;
        } else {
            document.getElementById('title').value = item.title;
            document.getElementById('authors').value = item.authors;
            document.getElementById('date').value = item.date;
            document.getElementById('source').value = item.source;
            document.getElementById('level').value = item.level;
            document.getElementById('keywords').value = item.keywords;
        }
        
        removeFile();
        if(item.pdfData) {
            currentPdfData = item.pdfData; currentPdfName = item.pdfName;
            document.getElementById('fileName').textContent = item.pdfName;
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('fileUpload').classList.add('has-file');
        }
        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç§‘ç ”æˆæœ';
        document.getElementById('formModal').classList.add('active');
    }

    function closeModal() { document.getElementById('formModal').classList.remove('active'); }

    function handleSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const type = document.getElementById('type').value;
        const data = { id: id || Date.now().toString(), type: type, pdfData: currentPdfData, pdfName: currentPdfName, updatedAt: new Date().toISOString() };
        
        // Collect Data
        if (type === 'patent') {
            data.patentName = document.getElementById('patentName').value;
            data.patentType = document.getElementById('patentType').value;
            data.inventors = document.getElementById('inventors').value;
            data.patentOwner = document.getElementById('patentOwner').value;
            data.applicationDate = document.getElementById('applicationDate').value;
            data.grantDate = document.getElementById('grantDate').value;
            data.patentNumber = document.getElementById('patentNumber').value;
            data.patentStatus = document.getElementById('patentStatus').value;
            data.title = data.patentName; data.date = data.applicationDate;
        } else if (type === 'project') {
            data.projectName = document.getElementById('projectName').value;
            data.projectLevel = document.getElementById('projectLevel').value;
            data.projectNumber = document.getElementById('projectNumber').value;
            data.projectStartDate = document.getElementById('projectStartDate').value;
            data.projectEndDate = document.getElementById('projectEndDate').value;
            data.projectOrg = document.getElementById('projectOrg').value;
            data.title = data.projectName; data.date = data.projectStartDate;
        } else {
            data.title = document.getElementById('title').value;
            data.authors = document.getElementById('authors').value;
            data.date = document.getElementById('date').value;
            data.source = document.getElementById('source').value;
            data.level = document.getElementById('level').value;
            data.keywords = document.getElementById('keywords').value;
        }

        if (id) {
            const idx = achievements.findIndex(a => a.id === id);
            if (idx > -1) achievements[idx] = { ...achievements[idx], ...data };
        } else {
            data.createdAt = new Date().toISOString();
            achievements.push(data);
        }
        saveToLocal(); closeModal(); updateStats(); renderResults(); showToast('ä¿å­˜æˆåŠŸ');
    }

    function openMemberModal() {
        document.getElementById('memberForm').reset();
        document.getElementById('memberEditId').value = '';
        document.getElementById('memberModalTitle').textContent = 'æ·»åŠ æˆå‘˜';
        document.getElementById('memberModal').classList.add('active');
    }
    
    function editMember(id) {
        const m = members.find(x => x.id === id); if(!m) return;
        document.getElementById('memberEditId').value = id;
        // Populate fields
        const fields = ['memberNo','memberName','memberGender','memberBirth','memberIdType','memberIdNo','memberNation','memberCountry','memberOrg','memberTitle','memberIsStudent','memberDegree','memberEmail','memberPhone'];
        fields.forEach(f => document.getElementById(f).value = m[f] || '');
        document.getElementById('memberModalTitle').textContent = 'ç¼–è¾‘æˆå‘˜';
        document.getElementById('memberModal').classList.add('active');
    }

    function closeMemberModal() { document.getElementById('memberModal').classList.remove('active'); }

    function handleMemberSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('memberEditId').value;
        const data = { id: id || Date.now().toString(), updatedAt: new Date().toISOString() };
        const fields = ['memberNo','memberName','memberGender','memberBirth','memberIdType','memberIdNo','memberNation','memberCountry','memberOrg','memberTitle','memberIsStudent','memberDegree','memberEmail','memberPhone'];
        fields.forEach(f => data[f] = document.getElementById(f).value);

        if (id) {
            const idx = members.findIndex(m => m.id === id);
            if (idx > -1) members[idx] = { ...members[idx], ...data };
        } else {
            data.createdAt = new Date().toISOString();
            members.push(data);
        }
        saveToLocal(); closeMemberModal(); updateStats(); renderResults(); showToast('ä¿å­˜æˆåŠŸ');
    }

    function toggleItem(id, e) {
        e.stopPropagation();
        if (selectedItems.has(id)) selectedItems.delete(id); else selectedItems.add(id);
        updateBatchDeleteBtn();
    }
    function toggleSelectAll() {
        const all = document.getElementById('selectAll').checked;
        const visible = document.querySelectorAll('.result-checkbox');
        visible.forEach(cb => {
            const id = cb.closest('.result-item').onclick.toString().match(/'(.*?)'/)[1];
            if(all) selectedItems.add(id); else selectedItems.delete(id);
        });
        updateBatchDeleteBtn(); renderResults();
    }
    function updateBatchDeleteBtn() {
        document.getElementById('batchDeleteBtn').style.display = selectedItems.size ? 'inline-block' : 'none';
        document.getElementById('selectedCount').textContent = selectedItems.size;
    }
    function promptDelete(id, type) {
        deleteTargetIds = [id]; deleteTargetType = type;
        document.getElementById('confirmModal').classList.add('active');
    }
    function batchDelete() {
        deleteTargetIds = Array.from(selectedItems);
        deleteTargetType = currentView === 'member' ? 'member' : 'achievement';
        document.getElementById('confirmModal').classList.add('active');
    }
    function closeConfirmModal() { document.getElementById('confirmModal').classList.remove('active'); }
    function confirmDelete() {
        if(deleteTargetType === 'member') members = members.filter(m => !deleteTargetIds.includes(m.id));
        else achievements = achievements.filter(a => !deleteTargetIds.includes(a.id));
        selectedItems.clear(); saveToLocal(); updateStats(); renderResults(); closeConfirmModal(); showToast('å·²åˆ é™¤');
    }
    function toggleFormFields() {
        const t = document.getElementById('type').value;
        document.getElementById('patentFields').classList.toggle('hidden', t !== 'patent');
        document.getElementById('projectFields').classList.toggle('hidden', t !== 'project');
        document.getElementById('generalFields').classList.toggle('hidden', t === 'patent' || t === 'project');
        document.getElementById('dateGroup').classList.toggle('hidden', t === 'patent' || t === 'project');
    }

    // --- å…¨é‡åˆ†è¡¨ Excel å¯¼å‡º ---
    function exportToExcelFile() {
        var wb = XLSX.utils.book_new();

        // 1. å­¦æœ¯è®ºæ–‡
        var papers = achievements.filter(a => a.type === 'paper').map(i => ({
            'æ ‡é¢˜': i.title, 'ä½œè€…': i.authors, 'å‘è¡¨æ—¥æœŸ': i.date, 
            'æœŸåˆŠ/æ¥æº': i.source, 'çº§åˆ«': i.level, 'å…³é”®è¯': i.keywords
        }));
        if(papers.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(papers), "å­¦æœ¯è®ºæ–‡");

        // 2. å‘æ˜ä¸“åˆ©
        var patents = achievements.filter(a => a.type === 'patent').map(i => ({
            'ä¸“åˆ©åç§°': i.patentName, 'ç±»å‹': i.patentType, 'å‘æ˜äºº': i.inventors,
            'æƒåˆ©äºº': i.patentOwner, 'çŠ¶æ€': i.patentStatus, 'ä¸“åˆ©å·': i.patentNumber,
            'ç”³è¯·æ—¥': i.applicationDate, 'æˆæƒæ—¥': i.grantDate
        }));
        if(patents.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(patents), "å‘æ˜ä¸“åˆ©");

        // 3. ç§‘ç ”é¡¹ç›®
        var projects = achievements.filter(a => a.type === 'project').map(i => ({
            'é¡¹ç›®åç§°': i.projectName, 'çº§åˆ«': i.projectLevel, 'ç¼–å·': i.projectNumber,
            'è´Ÿè´£äºº': i.authors, 'å•ä½': i.projectOrg, 'å¼€å§‹æ—¶é—´': i.projectStartDate, 'ç»“æŸæ—¶é—´': i.projectEndDate
        }));
        if(projects.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(projects), "ç§‘ç ”é¡¹ç›®");

        // 4. è·å¥–
        var awards = achievements.filter(a => a.type === 'award').map(i => ({
            'å¥–é¡¹åç§°': i.title, 'è·å¥–äºº': i.authors, 'æ—¥æœŸ': i.date, 'çº§åˆ«': i.level
        }));
        if(awards.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(awards), "è·å¥–æƒ…å†µ");

        // 5. è‘—ä½œ
        var books = achievements.filter(a => a.type === 'book').map(i => ({
            'è‘—ä½œåç§°': i.title, 'ä½œè€…': i.authors, 'å‡ºç‰ˆæ—¥æœŸ': i.date, 'å‡ºç‰ˆç¤¾': i.source
        }));
        if(books.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(books), "ä¸“è‘—å‡ºç‰ˆ");

        // 6. æˆå‘˜
        var mems = members.map(m => ({
            'å·¥å·': m.memberNo, 'å§“å': m.memberName, 'æ€§åˆ«': m.memberGender, 'å‡ºç”Ÿå¹´æœˆ': m.memberBirth,
            'å•ä½': m.memberOrg, 'èŒç§°': m.memberTitle, 'å­¦ä½': m.memberDegree, 'æ˜¯å¦åœ¨è¯»': m.memberIsStudent,
            'æ‰‹æœº': m.memberPhone, 'é‚®ç®±': m.memberEmail, 'è¯ä»¶å·': m.memberIdNo
        }));
        if(mems.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mems), "æˆå‘˜ä¿¡æ¯");

        if(wb.SheetNames.length === 0) return showToast('æ— æ•°æ®', 'warning');
        XLSX.writeFile(wb, "ç§‘ç ”æ•°æ®åˆ†è¡¨å¯¼å‡º.xlsx");
        showToast('âœ“ Excel åˆ†è¡¨å¯¼å‡ºæˆåŠŸ');
    }

    // --- Word åˆ†è¡¨å¯¼å‡º ---
    function exportToWordFile() {
        let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><style>table{border-collapse:collapse;width:100%;margin-bottom:20px;font-size:10pt}th,td{border:1px solid #000;padding:4px}th{background:#f0f0f0}</style></head><body><h2>ç§‘ç ”æ•°æ®æ±‡æ€»è¡¨</h2>`;
        
        // å­¦æœ¯è®ºæ–‡
        const papers = achievements.filter(a => a.type === 'paper');
        if(papers.length) {
            html += `<h3>ä¸€ã€å­¦æœ¯è®ºæ–‡ (${papers.length})</h3><table><tr><th>æ ‡é¢˜</th><th>ä½œè€…</th><th>æ—¥æœŸ</th><th>æ¥æº</th><th>çº§åˆ«</th></tr>`;
            papers.forEach(p => html += `<tr><td>${p.title||''}</td><td>${p.authors||''}</td><td>${p.date||''}</td><td>${p.source||''}</td><td>${p.level||''}</td></tr>`);
            html += `</table>`;
        }

        // å‘æ˜ä¸“åˆ©
        const patents = achievements.filter(a => a.type === 'patent');
        if(patents.length) {
            html += `<h3>äºŒã€å‘æ˜ä¸“åˆ© (${patents.length})</h3><table><tr><th>ä¸“åˆ©å</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th>ä¸“åˆ©å·</th><th>å‘æ˜äºº</th><th>ç”³è¯·æ—¥</th><th>æˆæƒæ—¥</th></tr>`;
            patents.forEach(p => html += `<tr><td>${p.patentName||''}</td><td>${p.patentType||''}</td><td>${p.patentStatus||''}</td><td>${p.patentNumber||''}</td><td>${p.inventors||''}</td><td>${p.applicationDate||''}</td><td>${p.grantDate||''}</td></tr>`);
            html += `</table>`;
        }

        // ç§‘ç ”é¡¹ç›®
        const projects = achievements.filter(a => a.type === 'project');
        if(projects.length) {
            html += `<h3>ä¸‰ã€ç§‘ç ”é¡¹ç›® (${projects.length})</h3><table><tr><th>é¡¹ç›®å</th><th>ç¼–å·</th><th>çº§åˆ«</th><th>å•ä½</th><th>èµ·æ­¢æ—¶é—´</th></tr>`;
            projects.forEach(p => html += `<tr><td>${p.projectName||''}</td><td>${p.projectNumber||''}</td><td>${p.projectLevel||''}</td><td>${p.projectOrg||''}</td><td>${p.projectStartDate||''}è‡³${p.projectEndDate||''}</td></tr>`);
            html += `</table>`;
        }

        // æˆå‘˜
        if(members.length) {
            html += `<h3>å››ã€å›¢é˜Ÿæˆå‘˜ (${members.length})</h3><table><tr><th>å·¥å·</th><th>å§“å</th><th>æ€§åˆ«</th><th>èŒç§°</th><th>å•ä½</th><th>æ‰‹æœº</th><th>é‚®ç®±</th></tr>`;
            members.forEach(m => html += `<tr><td>${m.memberNo||''}</td><td>${m.memberName||''}</td><td>${m.memberGender||''}</td><td>${m.memberTitle||''}</td><td>${m.memberOrg||''}</td><td>${m.memberPhone||''}</td><td>${m.memberEmail||''}</td></tr>`);
            html += `</table>`;
        }

        html += `</body></html>`;
        const blob = new Blob([html], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'ç§‘ç ”æ•°æ®åˆ†è¡¨æ±‡æ€».doc';
        a.click();
        showToast('âœ“ Word åˆ†è¡¨å¯¼å‡ºæˆåŠŸ');
    }

    function showToast(msg, type='success') {
        const box = document.getElementById('toastContainer');
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.textContent = msg;
        box.appendChild(el);
        setTimeout(() => el.classList.add('show'), 10);
        setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 3000);
    }

    window.onload = async function() { await loadFromLocal(); updateStats(); renderResults(); };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ (åŸç‰ˆUIä¿®å¤ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* =================================================================
           1. æ ·å¼é‡ç½®ä¸æ ¸å¿ƒå˜é‡ (è¿˜åŸä¸ºæ‚¨æœ€åˆçš„äº®è‰²é£æ ¼)
           ================================================================= */
        :root {
            /* ç•Œé¢èƒŒæ™¯ - è¿˜åŸä¸ºæ¸…çˆ½çš„äº®è‰²ç³» */
            --bg-primary: #f8fafc;    /* é¡µé¢å¤§èƒŒæ™¯ï¼šææ·¡çš„ç°è“è‰² */
            --bg-secondary: #ffffff;  /* ä¾§è¾¹æ /å¡ç‰‡èƒŒæ™¯ï¼šçº¯ç™½ */
            --bg-card: #ffffff;
            
            /* äº¤äº’é¢œè‰² */
            --bg-hover: #f1f5f9;      /* é¼ æ ‡æ‚¬åœè‰² */
            --bg-active: #eef2ff;     /* é€‰ä¸­æ¿€æ´»è‰² (æ·¡ç´«) */

            /* å­—ä½“é¢œè‰² */
            --text-primary: #1e293b;  /* ä¸»æ–‡å­—ï¼šæ·±è“ç° */
            --text-secondary: #64748b;/* æ¬¡è¦æ–‡å­—ï¼šç° */
            --text-muted: #94a3b8;    /* æç¤ºæ–‡å­—ï¼šæµ…ç° */

            /* è¾¹æ¡† */
            --border: #e2e8f0;
            --border-light: #f1f5f9;

            /* å“ç‰Œè‰² (æ‚¨ä¹ æƒ¯çš„è“ç´«è‰²) */
            --accent: #6366f1;
            --accent-light: #818cf8;
            --accent-dark: #4f46e5;

            /* çŠ¶æ€é¢œè‰² */
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;

            /* é˜´å½±ç³»ç»Ÿ */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            
            /* åœ†è§’ */
            --radius: 12px;
            --radius-sm: 8px;
        }

        /* åŸºç¡€é‡ç½® */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh; /* å›ºå®šé«˜åº¦ï¼Œå†…éƒ¨æ»šåŠ¨ */
            overflow: hidden;
            display: flex;
        }

        /* é€šç”¨éšè—ç±» */
        .hidden { display: none !important; }

        /* æ•´ä½“å¸ƒå±€å®¹å™¨ */
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        /* =================================================================
           2. ä¾§è¾¹æ  (Sidebar) - è¿˜åŸä¸ºç™½è‰²èƒŒæ™¯
           ================================================================= */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 100;
            transition: transform 0.3s ease;
            height: 100%;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Logo åŒºåŸŸ */
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--text-primary);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* å¯¼èˆªèœå•æ»šåŠ¨åŒº */
        .nav-menu {
            flex: 1;
            padding: 20px 12px;
            overflow-y: auto;
        }

        .nav-section {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 12px;
            margin-top: 20px;
            margin-bottom: 8px;
        }
        .nav-section:first-child { margin-top: 0; }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-active);
            color: var(--accent);
            font-weight: 600;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--bg-hover);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
        }
        
        .nav-item.active .badge {
            background: var(--accent);
            color: white;
        }

        /* ä¾§è¾¹æ åº•éƒ¨åŠŸèƒ½åŒº */
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        /* äº‘åŒæ­¥çŠ¶æ€æ¡ */
        .cloud-status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-hover);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            cursor: pointer;
            margin-bottom: 12px;
            transition: 0.2s;
        }
        .cloud-status-bar:hover { border-color: var(--accent); background: var(--bg-active); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; margin-right: 8px; }
        .status-text { font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; }

        /* æ•°æ®æ“ä½œæŒ‰é’®ç»„ */
        .data-actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .data-btn {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .data-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--bg-active);
            box-shadow: var(--shadow-sm);
        }
        
        .data-btn.primary {
            background: var(--accent);
            color: white;
            border: none;
        }
        .data-btn.primary:hover {
            background: var(--accent-dark);
        }

        /* =================================================================
           3. ä¸»å†…å®¹åŒº (Main Content)
           ================================================================= */
        .main-content {
            flex: 1;
            padding: 30px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-shrink: 0;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .search-box input {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            width: 300px;
            transition: all 0.2s;
        }
        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .btn-add {
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }
        .btn-add:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        /* å†…å®¹æ»šåŠ¨åŒºåŸŸ */
        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 40px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent);
        }

        .stat-icon {
            width: 54px; height: 54px;
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem;
        }
        /* å¡ç‰‡é…è‰² */
        .icon-paper { background: #e0f2fe; color: #0284c7; }
        .icon-patent { background: #fef3c7; color: #d97706; }
        .icon-project { background: #dcfce7; color: #16a34a; }
        .icon-award { background: #fee2e2; color: #dc2626; }
        .icon-book { background: #f3e8ff; color: #9333ea; }
        .icon-member { background: #ffedd5; color: #ea580c; }

        .stat-info h3 { font-size: 1.8rem; font-weight: 800; color: var(--text-primary); line-height: 1; }
        .stat-info p { font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px; }

        /* åˆ—è¡¨åŒºåŸŸ */
        .list-wrapper {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 400px;
            box-shadow: var(--shadow-sm);
        }

        .list-toolbar {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-hover);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-group { display: flex; align-items: center; gap: 16px; }
        
        .year-select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: white;
            color: var(--text-primary);
            cursor: pointer;
        }

        .batch-btn {
            background: var(--danger); color: white; border: none;
            padding: 6px 12px; border-radius: 6px; font-size: 0.85rem;
            cursor: pointer; display: none;
        }

        /* åˆ—è¡¨å¤´éƒ¨ */
        .list-header {
            display: grid;
            grid-template-columns: 50px 2fr 1.5fr 1.5fr 1.5fr 100px;
            padding: 14px 24px;
            background: #f1f5f9;
            border-bottom: 1px solid var(--border);
            font-weight: 700;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* åˆ—è¡¨å†…å®¹ */
        .list-body { flex: 1; overflow-y: auto; }

        .list-row {
            display: grid;
            grid-template-columns: 50px 2fr 1.5fr 1.5fr 1.5fr 100px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-light);
            align-items: center;
            transition: background 0.1s;
            cursor: pointer;
        }
        .list-row:hover { background: var(--bg-hover); }
        .list-row:last-child { border-bottom: none; }

        .row-check { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
        
        .row-title { font-weight: 600; color: var(--text-primary); font-size: 1rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .row-text { color: var(--text-secondary); font-size: 0.9rem; }
        
        .row-tag {
            display: inline-block; padding: 2px 10px; border-radius: 12px;
            background: var(--bg-hover); color: var(--text-secondary);
            font-size: 0.8rem; border: 1px solid var(--border);
        }
        .row-pdf { color: var(--accent); font-weight: 600; font-size: 0.8rem; margin-left: 8px; }

        .row-actions { display: flex; gap: 8px; opacity: 0; transition: 0.2s; }
        .list-row:hover .row-actions { opacity: 1; }

        .icon-btn {
            width: 32px; height: 32px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--border); background: white;
            color: var(--text-secondary); cursor: pointer; transition: 0.2s;
        }
        .icon-btn:hover { border-color: var(--accent); color: var(--accent); }
        .icon-btn.delete:hover { border-color: var(--danger); color: var(--danger); }

        .empty-state { padding: 80px; text-align: center; color: var(--text-muted); font-size: 1.1rem; }

        /* =================================================================
           4. å¼¹çª—ç»„ä»¶ (Modals) - è§£å†³â€œç‚¹ä¸åŠ¨â€çš„å…³é”®
           ================================================================= */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal-box {
            background: #fff; width: 700px; max-width: 95%; max-height: 90vh;
            border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            display: flex; flex-direction: column; transform: scale(0.95); transition: 0.3s;
        }
        .modal-overlay.active .modal-box { transform: scale(1); }

        .modal-header {
            padding: 24px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h3 { font-size: 1.4rem; font-weight: 700; color: var(--text-primary); }
        .close-btn { background: none; border: none; font-size: 1.5rem; color: #999; cursor: pointer; }

        .modal-body { padding: 24px; overflow-y: auto; }
        .modal-footer {
            padding: 20px 24px; border-top: 1px solid var(--border);
            background: var(--bg-hover); border-radius: 0 0 16px 16px;
            display: flex; justify-content: flex-end; gap: 12px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .form-full { grid-column: span 2; }
        .form-label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
        .form-input {
            width: 100%; padding: 12px; border: 2px solid var(--border);
            border-radius: 8px; font-size: 1rem; transition: 0.2s;
        }
        .form-input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 4px var(--accent-light); }

        /* æ•°æ®ç®¡ç†ä¸­å¿ƒä¸“ç”¨æ ·å¼ */
        .data-center-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .data-option-card {
            border: 2px solid var(--border); border-radius: 12px; padding: 24px;
            text-align: center; cursor: pointer; transition: 0.2s; background: #fff;
        }
        .data-option-card:hover { border-color: var(--accent); background: var(--bg-active); transform: translateY(-2px); }
        .data-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }
        .data-title { font-weight: 700; color: var(--text-primary); font-size: 1.1rem; display: block; margin-bottom: 5px; }
        .data-desc { color: var(--text-secondary); font-size: 0.85rem; }

        /* Toast */
        .toast-container { position: fixed; top: 30px; right: 30px; z-index: 3000; }
        .toast {
            background: #fff; padding: 16px 24px; border-radius: 8px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1); border-left: 5px solid var(--accent);
            margin-bottom: 10px; transform: translateX(120%); transition: 0.3s; font-weight: 500;
        }
        .toast.show { transform: translateX(0); }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); width: 85%; box-shadow: 10px 0 20px rgba(0,0,0,0.1); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; width: 100%; }
            .form-grid { grid-template-columns: 1fr; }
            .form-full { grid-column: span 1; }
            .mobile-menu-btn { display: flex !important; position: fixed; bottom: 20px; right: 20px; z-index: 2000; width: 50px; height: 50px; border-radius: 50%; background: var(--accent); color: white; font-size: 1.5rem; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); justify-content: center; align-items: center; }
            .list-header { display: none; }
            .list-row { grid-template-columns: 1fr; gap: 8px; padding: 16px; align-items: start; }
            .search-box input { width: 100%; }
            .header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .header-actions { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>

<button class="mobile-menu-btn" style="display:none;" onclick="toggleSidebar()">â˜°</button>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">ğŸ”¬</div>
                <span>ç§‘ç ”ç®¡ç†ç³»ç»Ÿ</span>
            </div>
        </div>

        <nav class="nav-menu">
            <div class="nav-section">æˆæœåº“</div>
            <div class="nav-item active" onclick="switchView('all')" id="nav-all">
                <span>ğŸ“‹</span> å…¨éƒ¨æˆæœ <span class="badge" id="c-all">0</span>
            </div>
            <div class="nav-item" onclick="switchView('paper')" id="nav-paper">
                <span>ğŸ“„</span> å­¦æœ¯è®ºæ–‡ <span class="badge" id="c-paper">0</span>
            </div>
            <div class="nav-item" onclick="switchView('patent')" id="nav-patent">
                <span>ğŸ’¡</span> å‘æ˜ä¸“åˆ© <span class="badge" id="c-patent">0</span>
            </div>
            <div class="nav-item" onclick="switchView('project')" id="nav-project">
                <span>ğŸ“Š</span> ç§‘ç ”é¡¹ç›® <span class="badge" id="c-project">0</span>
            </div>
            <div class="nav-item" onclick="switchView('award')" id="nav-award">
                <span>ğŸ†</span> è·å¥–æƒ…å†µ <span class="badge" id="c-award">0</span>
            </div>
            <div class="nav-item" onclick="switchView('book')" id="nav-book">
                <span>ğŸ“š</span> ä¸“è‘—å‡ºç‰ˆ <span class="badge" id="c-book">0</span>
            </div>

            <div class="nav-section">å›¢é˜Ÿ</div>
            <div class="nav-item" onclick="switchView('member')" id="nav-member">
                <span>ğŸ‘¥</span> æˆå‘˜ä¿¡æ¯ <span class="badge" id="c-member">0</span>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="cloud-status-bar" onclick="openCloudModal()">
                <div style="display:flex;align-items:center;">
                    <div class="status-dot" id="cloudDot" style="background:#cbd5e1;"></div>
                    <span id="cloudText" style="font-weight:500;margin-left:8px;font-size:0.85rem;">é…ç½®äº‘åŒæ­¥</span>
                </div>
                <span style="font-size:1.2rem;">âš™ï¸</span>
            </div>

            <button class="data-btn primary" style="width:100%;margin-top:10px;" onclick="openDataModal()">
                <span>ğŸ“‚</span> æ•°æ®å¯¼å…¥ / å¯¼å‡º / å¤‡ä»½
            </button>
            <div style="text-align:center;margin-top:10px;font-size:0.75rem;color:#94a3b8;">
                <span id="storageMsg">IndexedDB æœ¬åœ°å­˜å‚¨</span>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <h1 class="page-title" id="pageTitle">å…¨éƒ¨æˆæœ</h1>
            <div class="header-actions">
                <div class="search-box">
                    <input type="text" placeholder="æœç´¢æ ‡é¢˜ã€ä½œè€…ã€ç¼–å·..." oninput="handleSearch(this.value)">
                </div>
                <button class="btn-add" onclick="openAddModal()">
                    <span>â•</span> <span id="addBtnText">æ–°å¢æˆæœ</span>
                </button>
            </div>
        </div>

        <div class="content-scroll">
            <div class="stats-grid" id="statsRow"></div>

            <div class="list-wrapper">
                <div class="list-toolbar">
                    <div class="filter-group">
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" id="selectAll" class="row-check" onchange="toggleSelectAll()"> å…¨é€‰
                        </label>
                        <span id="selCount" style="color:#64748b;font-size:0.9rem;"></span>
                        <button class="batch-btn" id="batchDelBtn" onclick="batchDelete()">åˆ é™¤é€‰ä¸­</button>
                    </div>
                    <div>
                        <select class="year-select" id="yearFilter" onchange="applyFilter()">
                            <option value="all">æ‰€æœ‰å¹´ä»½</option>
                        </select>
                    </div>
                </div>

                <div class="list-header">
                    <div></div> <div>æ ‡é¢˜ / åç§°</div>
                    <div>æ—¥æœŸ</div>
                    <div>äººå‘˜</div>
                    <div>è¯¦ç»†ä¿¡æ¯</div>
                    <div>æ“ä½œ</div>
                </div>

                <div class="list-body" id="listBody">
                    </div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="dataModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3>ğŸ—‚ï¸ æ•°æ®ç®¡ç†ä¸­å¿ƒ</h3>
            <button class="close-btn" onclick="closeDataModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <h4 style="margin-bottom:15px;color:var(--text-secondary);">ğŸ“¤ å¯¼å‡ºä¸å¤‡ä»½</h4>
            <div class="data-center-grid">
                <div class="data-option-card" onclick="exportToExcel()">
                    <span class="data-icon">ğŸ“Š</span>
                    <span class="data-title">å¯¼å‡º Excel</span>
                    <span class="data-desc">è‡ªåŠ¨åˆ†è¡¨ (6ä¸ªSheet)ï¼Œæ¯ä¸ªå­—æ®µç‹¬ç«‹ä¸€åˆ—</span>
                </div>
                <div class="data-option-card" onclick="exportToWord()">
                    <span class="data-icon">ğŸ“</span>
                    <span class="data-title">å¯¼å‡º Word</span>
                    <span class="data-desc">ç”Ÿæˆè¯¦ç»†çš„åˆ†ç±»æ±‡æ€»è¡¨æ ¼æ–‡æ¡£</span>
                </div>
                <div class="data-option-card" onclick="backupJSON()">
                    <span class="data-icon">ğŸ“¦</span>
                    <span class="data-title">å¤‡ä»½æ•°æ® (JSON)</span>
                    <span class="data-desc">æ¨èï¼å®Œæ•´å¤‡ä»½æ‰€æœ‰æ•°æ®å’Œé™„ä»¶ï¼Œé˜²æ­¢ä¸¢å¤±</span>
                </div>
            </div>

            <h4 style="margin-top:30px;margin-bottom:15px;color:var(--text-secondary);">ğŸ“¥ å¯¼å…¥ä¸æ¢å¤</h4>
            <div class="data-center-grid">
                <div class="data-option-card" onclick="document.getElementById('fileExcel').click()">
                    <span class="data-icon">ğŸ“ˆ</span>
                    <span class="data-title">å¯¼å…¥ Excel</span>
                    <span class="data-desc">æ‰¹é‡å¯¼å…¥æˆæœæˆ–æˆå‘˜æ•°æ®</span>
                </div>
                <div class="data-option-card" onclick="document.getElementById('fileJson').click()">
                    <span class="data-icon">ğŸ“‚</span>
                    <span class="data-title">æ¢å¤å¤‡ä»½ (JSON)</span>
                    <span class="data-desc">ä»ä¹‹å‰çš„å¤‡ä»½æ–‡ä»¶ä¸­æ¢å¤æ‰€æœ‰æ•°æ®</span>
                </div>
            </div>
            
            <input type="file" id="fileJson" hidden accept=".json" onchange="restoreJSON(this)">
            <input type="file" id="fileExcel" hidden accept=".xlsx,.xls" onchange="importExcel(this)">
        </div>
    </div>
</div>

<div class="modal-overlay" id="editModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3 id="formTitle">æ–°å¢è®°å½•</h3>
            <button class="close-btn" onclick="closeEditModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="mainForm">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group form-full">
                        <label class="form-label">è®°å½•ç±»å‹</label>
                        <select id="inputType" class="form-input" onchange="updateFormLayout()">
                            <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                            <option value="patent">å‘æ˜ä¸“åˆ©</option>
                            <option value="project">ç§‘ç ”é¡¹ç›®</option>
                            <option value="award">è·å¥–æƒ…å†µ</option>
                            <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                            <option value="member">æˆå‘˜ä¿¡æ¯</option>
                        </select>
                    </div>
                    
                    <div id="dynamicFields" class="form-full form-grid" style="margin:0;padding:0;gap:20px;"></div>

                    <div class="form-group form-full" id="fileSection">
                        <label class="form-label">é™„ä»¶ (PDF)</label>
                        <div class="file-upload" onclick="document.getElementById('pdfInput').click()">
                            <span style="font-size:2rem;display:block;margin-bottom:10px;">ğŸ“„</span>
                            <span>ç‚¹å‡»ä¸Šä¼  PDF æ–‡ä»¶ (æ”¯æŒå¤§æ–‡ä»¶)</span>
                            <input type="file" id="pdfInput" hidden accept=".pdf" onchange="handleFile(this)">
                        </div>
                        <div id="filePreview" class="file-info hidden">
                            <span id="fileName"></span>
                            <button type="button" class="file-remove" onclick="removeFile()">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="data-btn" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="data-btn primary" onclick="submitForm()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="cloudModal">
    <div class="modal-box" style="max-width:500px;">
        <div class="modal-header">
            <h3>â˜ï¸ äº‘åŒæ­¥é…ç½® (GitHub Gist)</h3>
            <button class="close-btn" onclick="document.getElementById('cloudModal').classList.remove('active')">Ã—</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom:20px;color:#64748b;font-size:0.9rem;line-height:1.5;">
                é€šè¿‡ GitHub Token å®ç°å¤šè®¾å¤‡é—´çš„æ•°æ®åŒæ­¥ã€‚è¯·ç¡®ä¿ Token æ‹¥æœ‰ <b>gist</b> æƒé™ã€‚
            </p>
            <div class="form-group">
                <label class="form-label">GitHub Token (å¿…å¡«)</label>
                <input type="password" id="ghToken" class="form-input" placeholder="ghp_xxxxxxxxxxxx...">
            </div>
            <div class="form-group">
                <label class="form-label">Gist ID (é€‰å¡«ï¼Œç•™ç©ºåˆ™æ–°å»º)</label>
                <input type="text" id="ghGistId" class="form-input" placeholder="åŒæ­¥ç”¨çš„ Gist ID">
            </div>
        </div>
        <div class="modal-footer">
            <button class="data-btn primary" style="width:100%;" onclick="connectCloud()">è¿æ¥å¹¶åŒæ­¥</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastBox"></div>

<script>
/**
 * =================================================================
 * æ ¸å¿ƒé€»è¾‘å±‚ (Core Logic)
 * =================================================================
 */

// 1. å…¨å±€çŠ¶æ€
const APP = {
    dbName: 'ResearchDB_Final_V1', // æ–°æ•°æ®åº“åï¼Œé˜²æ­¢æ—§ç¼“å­˜å¹²æ‰°
    dbVersion: 1,
    db: null,
    data: { achievements: [], members: [] },
    config: { token: '', gistId: '' },
    view: 'all',
    search: '',
    sort: 'date-desc',
    yearFilter: 'all',
    selected: new Set(),
    currentFile: null,
    
    // å­—æ®µæ˜ å°„å®šä¹‰ (ç”¨äºç”Ÿæˆè¡¨å•ã€Excelè¡¨å¤´ã€Wordè¡¨æ ¼)
    schema: {
        paper: [
            { id: 'title', label: 'è®ºæ–‡æ ‡é¢˜', type: 'text', required: true, full: true },
            { id: 'date', label: 'å‘è¡¨æ—¥æœŸ', type: 'date', required: true },
            { id: 'authors', label: 'ä½œè€…åˆ—è¡¨', type: 'text', placeholder: 'é€—å·åˆ†éš”' },
            { id: 'source', label: 'æœŸåˆŠ/ä¼šè®®', type: 'text' },
            { id: 'level', label: 'æ”¶å½•çº§åˆ«', type: 'text', placeholder: 'SCI/EI' },
            { id: 'keywords', label: 'å…³é”®è¯', type: 'text' }
        ],
        patent: [
            { id: 'patentName', label: 'ä¸“åˆ©åç§°', type: 'text', required: true, full: true },
            { id: 'patentType', label: 'ç±»å‹', type: 'select', opts: ['å‘æ˜ä¸“åˆ©','å®ç”¨æ–°å‹','å¤–è§‚è®¾è®¡'] },
            { id: 'patentStatus', label: 'çŠ¶æ€', type: 'select', opts: ['ç”³è¯·ä¸­','å®å®¡ä¸­','å·²æˆæƒ','å·²è½¬è®©'] },
            { id: 'patentNumber', label: 'ä¸“åˆ©å·', type: 'text' },
            { id: 'applicationDate', label: 'ç”³è¯·æ—¥', type: 'date' },
            { id: 'grantDate', label: 'æˆæƒæ—¥', type: 'date' },
            { id: 'inventors', label: 'å‘æ˜äºº', type: 'text', full: true },
            { id: 'patentOwner', label: 'æƒåˆ©äºº', type: 'text' }
        ],
        project: [
            { id: 'projectName', label: 'é¡¹ç›®åç§°', type: 'text', required: true, full: true },
            { id: 'projectNumber', label: 'é¡¹ç›®ç¼–å·', type: 'text' },
            { id: 'projectLevel', label: 'çº§åˆ«', type: 'select', opts: ['å›½å®¶çº§','çœéƒ¨çº§','å…å±€çº§','æ¨ªå‘','æ ¡çº§'] },
            { id: 'projectOrg', label: 'æ‰€å±å•ä½', type: 'text' },
            { id: 'projectStartDate', label: 'å¼€å§‹æ—¶é—´', type: 'date' },
            { id: 'projectEndDate', label: 'ç»“æŸæ—¶é—´', type: 'date' },
            { id: 'authors', label: 'è´Ÿè´£äºº', type: 'text', full: true }
        ],
        award: [
            { id: 'title', label: 'è·å¥–åç§°', type: 'text', required: true, full: true },
            { id: 'date', label: 'è·å¥–æ—¥æœŸ', type: 'date' },
            { id: 'level', label: 'å¥–åŠ±ç­‰çº§', type: 'text' },
            { id: 'source', label: 'æˆå¥–å•ä½', type: 'text' },
            { id: 'authors', label: 'è·å¥–äºº', type: 'text', full: true }
        ],
        book: [
            { id: 'title', label: 'ä¸“è‘—åç§°', type: 'text', required: true, full: true },
            { id: 'authors', label: 'ä½œè€…', type: 'text' },
            { id: 'date', label: 'å‡ºç‰ˆæ—¥æœŸ', type: 'date' },
            { id: 'source', label: 'å‡ºç‰ˆç¤¾', type: 'text' },
            { id: 'isbn', label: 'ISBNå·', type: 'text' }
        ],
        member: [
            { id: 'memberNo', label: 'å·¥å·/å­¦å·', type: 'text', required: true },
            { id: 'memberName', label: 'å§“å', type: 'text', required: true },
            { id: 'memberGender', label: 'æ€§åˆ«', type: 'select', opts: ['ç”·','å¥³'] },
            { id: 'memberBirth', label: 'å‡ºç”Ÿå¹´æœˆ', type: 'month' },
            { id: 'memberOrg', label: 'æ‰€å±å•ä½', type: 'text' },
            { id: 'memberTitle', label: 'èŒç§°/èŒåŠ¡', type: 'text' },
            { id: 'memberPhone', label: 'æ‰‹æœºå·ç ', type: 'text' },
            { id: 'memberEmail', label: 'ç”µå­é‚®ç®±', type: 'text' },
            { id: 'memberIdNo', label: 'è¯ä»¶å·ç ', type: 'text', full: true }
        ]
    },
    types: {
        paper: { label: 'å­¦æœ¯è®ºæ–‡', icon: 'ğŸ“„', color: 'icon-paper' },
        patent: { label: 'å‘æ˜ä¸“åˆ©', icon: 'ğŸ’¡', color: 'icon-patent' },
        project: { label: 'ç§‘ç ”é¡¹ç›®', icon: 'ğŸ“Š', color: 'icon-project' },
        award: { label: 'è·å¥–æƒ…å†µ', icon: 'ğŸ†', color: 'icon-award' },
        book: { label: 'ä¸“è‘—å‡ºç‰ˆ', icon: 'ğŸ“š', color: 'icon-book' },
        member: { label: 'æˆå‘˜ä¿¡æ¯', icon: 'ğŸ‘¤', color: 'icon-member' }
    }
};

// 2. æ•°æ®åº“ (IndexedDB) - ç¨³å›ºçš„æœ¬åœ°å­˜å‚¨
function initDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(APP.dbName, APP.dbVersion);
        req.onupgradeneeded = e => {
            const db = e.target.result;
            if(!db.objectStoreNames.contains('store')) db.createObjectStore('store', {keyPath: 'id'});
        };
        req.onsuccess = e => { APP.db = e.target.result; resolve(); };
        req.onerror = e => reject(e);
    });
}

async function loadData() {
    if(!APP.db) await initDB();
    const tx = APP.db.transaction('store', 'readonly');
    const store = tx.objectStore('store');
    const req = store.get('main_data');
    req.onsuccess = e => {
        if(e.target.result) {
            APP.data = e.target.result.data || { achievements: [], members: [] };
            APP.config = e.target.result.config || { token: '', gistId: '' };
        } else {
            APP.data = { achievements: [], members: [] }; // åˆå§‹åŒ–
        }
        updateUI();
        if(APP.config.token) checkCloudStatus();
    };
}

async function persist() {
    const tx = APP.db.transaction('store', 'readwrite');
    tx.objectStore('store').put({ id: 'main_data', data: APP.data, config: APP.config, updated: new Date() });
    tx.oncomplete = () => {
        document.getElementById('dbState').innerText = 'æ•°æ®å·²è‡ªåŠ¨ä¿å­˜';
        if(APP.config.token && APP.config.gistId) syncCloud(false); // è‡ªåŠ¨è§¦å‘ä¸Šä¼ 
    };
}

// 3. UI æ¸²æŸ“ä¸äº¤äº’
function updateUI() {
    renderStats();
    renderList();
    updateCounts();
}

function updateCounts() {
    const c = { paper:0, patent:0, project:0, award:0, book:0 };
    APP.data.achievements.forEach(i => { if(c[i.type]!==undefined) c[i.type]++; });
    document.getElementById('c-all').innerText = APP.data.achievements.length;
    document.getElementById('c-member').innerText = APP.data.members.length;
    Object.keys(c).forEach(k => document.getElementById(`c-${k}`).innerText = c[k]);
}

function renderStats() {
    const container = document.getElementById('statsRow');
    const types = ['paper','patent','project','award','book','member'];
    container.innerHTML = types.map(k => {
        const num = k==='member' ? APP.data.members.length : APP.data.achievements.filter(i=>i.type===k).length;
        const meta = APP.types[k];
        return `<div class="stat-card" onclick="switchView('${k}')">
            <div class="stat-icon ${meta.color}">${meta.icon}</div>
            <div class="stat-info"><h3>${num}</h3><p>${meta.label}</p></div>
        </div>`;
    }).join('');
}

function renderList() {
    const container = document.getElementById('listBody');
    let list = APP.view === 'member' ? APP.data.members : APP.data.achievements;
    
    // è¿‡æ»¤
    if(APP.view !== 'all' && APP.view !== 'member') list = list.filter(i => i.type === APP.view);
    if(APP.search) {
        const q = APP.search.toLowerCase();
        list = list.filter(i => Object.values(i).join(' ').toLowerCase().includes(q));
    }
    // å¹´ä»½ç­›é€‰
    if(APP.view !== 'member') {
        const years = [...new Set(list.map(i => (i.date||i.applicationDate||i.projectStartDate||'').substr(0,4)).filter(y=>y))].sort().reverse();
        const sel = document.getElementById('yearFilter');
        sel.innerHTML = '<option value="all">æ‰€æœ‰å¹´ä»½</option>' + years.map(y => `<option value="${y}" ${APP.yearFilter===y?'selected':''}>${y}å¹´</option>`).join('');
        if(APP.yearFilter !== 'all') list = list.filter(i => (i.date||i.applicationDate||i.projectStartDate||'').startsWith(APP.yearFilter));
    }

    // æ’åº
    list.sort((a,b) => {
        const da = a.date || a.applicationDate || a.projectStartDate || '0';
        const db = b.date || b.applicationDate || b.projectStartDate || '0';
        return APP.sort === 'date-desc' ? (da<db?1:-1) : (da>db?1:-1);
    });

    document.getElementById('resultCount').innerText = `å…± ${list.length} æ¡è®°å½•`;

    if(list.length === 0) {
        container.innerHTML = `<div class="empty-state">æš‚æ— æ•°æ®</div>`;
        return;
    }

    container.innerHTML = list.map(item => {
        const t = APP.types[item.type || 'paper'];
        const title = item.title || item.patentName || item.projectName || item.memberName;
        const date = item.date || item.applicationDate || item.projectStartDate || item.memberBirth || '-';
        const sub = item.authors || item.inventors || item.memberOrg || '-';
        const tag = item.level || item.patentStatus || item.projectLevel || item.memberTitle || '';
        const hasFile = !!item.pdfData;
        const isSel = APP.selected.has(item.id);
        
        return `<div class="list-row" onclick="editItem('${item.id}')">
            <div><input type="checkbox" class="row-check" ${isSel?'checked':''} onclick="toggleItem('${item.id}', event)"></div>
            <div class="cell-main" style="display:flex;align-items:center;gap:10px;">
                <span style="font-size:1.2rem;">${t.icon}</span> ${title}
            </div>
            <div class="cell-sub">${date}</div>
            <div class="cell-sub">${sub}</div>
            <div class="cell-sub">
                ${tag ? `<span class="tag">${tag}</span>` : ''}
                ${hasFile ? '<span class="tag tag-blue">ğŸ“ PDF</span>' : ''}
            </div>
            <div class="cell-actions">
                ${hasFile ? `<button class="icon-btn" onclick="viewPdf('${item.id}');event.stopPropagation()">ğŸ‘</button>` : ''}
                <button class="icon-btn" onclick="editItem('${item.id}');event.stopPropagation()">âœ</button>
                <button class="icon-btn del" onclick="delItem('${item.id}');event.stopPropagation()">ğŸ—‘</button>
            </div>
        </div>`;
    }).join('');
}

// 4. äº¤äº’é€»è¾‘
function switchView(v) {
    APP.view = v; APP.search = ''; APP.selected.clear();
    document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.id === `nav-${v}`));
    document.getElementById('pageTitle').innerText = APP.types[v]?.label || 'å…¨éƒ¨æˆæœ';
    document.getElementById('addBtnText').innerText = v === 'member' ? 'æ·»åŠ æˆå‘˜' : 'æ·»åŠ æˆæœ';
    document.getElementById('batchDelBtn').style.display = 'none';
    document.getElementById('selectAll').checked = false;
    if(window.innerWidth <= 768) toggleSidebar();
    renderList();
}

function handleSearch(val) { APP.search = val; renderList(); }
function applyFilter() { APP.yearFilter = document.getElementById('yearFilter').value; renderList(); }
function handleSort(val) { APP.sort = val; renderList(); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

// 5. å¼¹çª—æ§åˆ¶
function openDataModal() { document.getElementById('dataModal').classList.add('active'); }
function closeDataModal() { document.getElementById('dataModal').classList.remove('active'); }
function openCloudModal() { 
    document.getElementById('ghToken').value = APP.config.token;
    document.getElementById('ghGistId').value = APP.config.gistId;
    document.getElementById('cloudModal').classList.add('active');
}
function closeCloudModal() { document.getElementById('cloudModal').classList.remove('active'); }

// 6. æ–°å¢/ç¼–è¾‘é€»è¾‘ (å®Œå…¨åŠ¨æ€ç”Ÿæˆè¡¨å•)
function openAddModal() {
    document.getElementById('mainForm').reset();
    document.getElementById('editId').value = '';
    APP.currentFile = null;
    document.getElementById('filePreview').classList.add('hidden');
    document.getElementById('formTitle').innerText = 'æ–°å¢è®°å½•';
    
    // æ ¹æ®å½“å‰è§†å›¾è®¾ç½®é»˜è®¤ç±»å‹
    let type = APP.view;
    if(type === 'all') type = 'paper';
    document.getElementById('inputType').value = type;
    document.getElementById('inputType').disabled = false;
    
    updateFormLayout();
    document.getElementById('editModal').classList.add('active');
}

function updateFormLayout() {
    const type = document.getElementById('inputType').value;
    const fields = APP.schema[type];
    const container = document.getElementById('dynamicFields');
    
    container.innerHTML = fields.map(f => {
        let inputHtml = '';
        if(f.type === 'select') {
            inputHtml = `<select id="f_${f.id}" class="form-input">${f.opts.map(o=>`<option>${o}</option>`).join('')}</select>`;
        } else {
            inputHtml = `<input type="${f.type}" id="f_${f.id}" class="form-input" ${f.required?'required':''} placeholder="${f.placeholder||''}">`;
        }
        return `<div class="form-group ${f.full?'form-full':''}"><label class="form-label">${f.label}</label>${inputHtml}</div>`;
    }).join('');
    
    document.getElementById('fileSection').style.display = type === 'member' ? 'none' : 'block';
}

function submitForm() {
    const id = document.getElementById('editId').value;
    const type = document.getElementById('inputType').value;
    const fields = APP.schema[type];
    
    const newItem = {
        id: id || Date.now().toString(),
        type: type,
        updatedAt: new Date().toISOString()
    };
    
    // æ”¶é›†åŠ¨æ€å­—æ®µæ•°æ®
    fields.forEach(f => {
        newItem[f.id] = document.getElementById(`f_${f.id}`).value;
    });
    
    // å¤„ç†æ–‡ä»¶
    if (APP.currentFile) {
        newItem.pdfData = APP.currentFile.data;
        newItem.pdfName = APP.currentFile.name;
    } else if (id) {
        // ç¼–è¾‘æ—¶å¦‚æœæ²¡ä¸Šä¼ æ–°æ–‡ä»¶ï¼Œä¿ç•™æ—§çš„
        const old = (type==='member'?APP.data.members:APP.data.achievements).find(i=>i.id===id);
        if(old && old.pdfData) {
            newItem.pdfData = old.pdfData;
            newItem.pdfName = old.pdfName;
        }
    }

    // ä¿å­˜åˆ°æ•°ç»„
    const targetArr = type === 'member' ? APP.data.members : APP.data.achievements;
    if (id) {
        const idx = targetArr.findIndex(i=>i.id===id);
        if(idx > -1) targetArr[idx] = newItem;
    } else {
        targetArr.push(newItem);
    }
    
    persist();
    closeEditModal();
    updateUI();
    showToast('ä¿å­˜æˆåŠŸ');
}

function editItem(id) {
    const item = [...APP.data.achievements, ...APP.data.members].find(i=>i.id===id);
    if(!item) return;

    document.getElementById('editId').value = id;
    document.getElementById('formTitle').innerText = 'ç¼–è¾‘è®°å½•';
    document.getElementById('inputType').value = item.type;
    document.getElementById('inputType').disabled = true; // ç¼–è¾‘æ—¶ç¦æ­¢æ”¹ç±»å‹
    updateFormLayout();

    // å¡«å……æ•°æ®
    APP.schema[item.type].forEach(f => {
        if(document.getElementById(`f_${f.id}`)) document.getElementById(`f_${f.id}`).value = item[f.id] || '';
    });

    if(item.pdfData) {
        document.getElementById('fileName').innerText = item.pdfName;
        document.getElementById('filePreview').classList.remove('hidden');
    } else {
        document.getElementById('filePreview').classList.add('hidden');
    }

    document.getElementById('editModal').classList.add('active');
}

function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }

// 7. æ–‡ä»¶æ“ä½œ
function handleFile(input) {
    const f = input.files[0];
    if(!f) return;
    if(f.size > 50*1024*1024) return showToast('æ–‡ä»¶è¿‡å¤§ (>50MB)','warning');
    const r = new FileReader();
    r.onload = e => {
        APP.currentFile = { name: f.name, data: e.target.result };
        document.getElementById('fileName').innerText = f.name;
        document.getElementById('filePreview').classList.remove('hidden');
    };
    r.readAsDataURL(f);
}
function removeFile() { APP.currentFile = null; document.getElementById('filePreview').classList.add('hidden'); document.getElementById('pdfInput').value=''; }

function viewPdf(id) {
    const item = APP.data.achievements.find(i=>i.id===id);
    if(item && item.pdfData) {
        const arr = item.pdfData.split(','), bstr = atob(arr[1]), n = bstr.length, u8 = new Uint8Array(n);
        while(n--) u8[n] = bstr.charCodeAt(n);
        const url = URL.createObjectURL(new Blob([u8], {type:'application/pdf'}));
        window.open(url);
    }
}

// 8. æ‰¹é‡æ“ä½œ
function toggleSelectAll() {
    const all = document.getElementById('selectAll').checked;
    const boxes = document.querySelectorAll('.row-check');
    boxes.forEach(b => {
        b.checked = all;
        const id = b.parentElement.parentElement.getAttribute('onclick').match(/'(.*?)'/)[1];
        if(all) APP.selected.add(id); else APP.selected.delete(id);
    });
    updateBatchUI();
}
function toggleItem(id, e) {
    e.stopPropagation();
    if(APP.selected.has(id)) APP.selected.delete(id); else APP.selected.add(id);
    updateBatchUI();
}
function updateBatchUI() {
    document.getElementById('selCount').innerText = `(${APP.selected.size})`;
    document.getElementById('batchDelBtn').style.display = APP.selected.size ? 'block' : 'none';
}
function delItem(id) {
    if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
    APP.data.achievements = APP.data.achievements.filter(i=>i.id!==id);
    APP.data.members = APP.data.members.filter(i=>i.id!==id);
    persist(); updateUI();
}
function batchDelete() {
    if(!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${APP.selected.size} é¡¹ï¼Ÿ`)) return;
    APP.data.achievements = APP.data.achievements.filter(i=>!APP.selected.has(i.id));
    APP.data.members = APP.data.members.filter(i=>!APP.selected.has(i.id));
    APP.selected.clear();
    persist(); updateUI();
}

// 9. å¯¼å…¥å¯¼å‡º (Excel/Word/JSON) - åˆ†è¡¨åˆ†åˆ—
function backupJSON() {
    const blob = new Blob([JSON.stringify(APP.data)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `DataBackup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}
function restoreJSON(input) {
    const f = input.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        try {
            const d = JSON.parse(e.target.result);
            APP.data = d;
            persist();
            closeDataModal();
            updateUI();
            showToast('æ¢å¤æˆåŠŸ');
        } catch(err) { showToast('æ–‡ä»¶æ ¼å¼é”™è¯¯','error'); }
    };
    r.readAsText(f);
    input.value = '';
}

// *** Excel å¯¼å‡º (åˆ†è¡¨ + åˆ†åˆ—) ***
function exportToExcel() {
    const wb = XLSX.utils.book_new();
    const types = ['paper','patent','project','award','book','member'];
    
    types.forEach(t => {
        const list = t==='member' ? APP.data.members : APP.data.achievements.filter(i=>i.type===t);
        if(list.length > 0) {
            const schema = APP.schema[t];
            const rows = list.map(item => {
                const row = {};
                schema.forEach(f => row[f.label] = item[f.id] || '');
                return row;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), APP.types[t].label);
        }
    });

    if(wb.SheetNames.length===0) return showToast('æ— æ•°æ®å¯å¯¼å‡º','warning');
    XLSX.writeFile(wb, "ç§‘ç ”æ•°æ®åˆ†è¡¨.xlsx");
}

function importExcel(input) {
    const f = input.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
        // ç®€å•å¯¼å…¥é€»è¾‘ï¼šå°†ç¬¬ä¸€å¼ è¡¨è§†ä¸ºå­¦æœ¯è®ºæ–‡å¯¼å…¥ (å¤æ‚é€»è¾‘éœ€æ˜ å°„ç•Œé¢ï¼Œæš‚ç•¥ä»¥ä¿æŒå•æ–‡ä»¶ç¨³å®š)
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws);
        json.forEach(row => {
            APP.data.achievements.push({
                id: Date.now()+Math.random(), type:'paper',
                title: row['æ ‡é¢˜']||row['Title']||'å¯¼å…¥æ•°æ®',
                date: new Date().toISOString().slice(0,10)
            });
        });
        persist(); updateUI(); showToast(`å¯¼å…¥ ${json.length} æ¡æ•°æ®`);
        closeDataModal();
    };
    r.readAsArrayBuffer(f);
    input.value = '';
}

// *** Word å¯¼å‡º (åˆ†è¡¨) ***
function exportToWord() {
    let html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><style>table{width:100%;border-collapse:collapse;margin-bottom:20px} th,td{border:1px solid #000;padding:5px;font-size:10pt} th{background:#eee}</style></head><body><h2 style="text-align:center">ç§‘ç ”æˆæœæ±‡æ€»</h2>`;
    
    const types = ['paper','patent','project','award','book','member'];
    types.forEach(t => {
        const list = t==='member' ? APP.data.members : APP.data.achievements.filter(i=>i.type===t);
        if(list.length > 0) {
            const schema = APP.schema[t];
            html += `<h3>${APP.types[t].label}</h3><table><tr>${schema.map(f=>`<th>${f.label}</th>`).join('')}</tr>`;
            list.forEach(item => {
                html += `<tr>${schema.map(f=>`<td>${item[f.id]||''}</td>`).join('')}</tr>`;
            });
            html += `</table>`;
        }
    });

    html += `</body></html>`;
    const blob = new Blob([html], {type:'application/msword'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ç§‘ç ”æˆæœåˆ†è¡¨.doc';
    a.click();
}

// 10. äº‘åŒæ­¥ (GitHub Gist)
async function connectCloud() {
    const t = document.getElementById('ghToken').value;
    const g = document.getElementById('ghGistId').value;
    if(!t) return showToast('Token å¿…å¡«','error');
    
    showToast('è¿æ¥ä¸­...','warning');
    APP.config.token = t;
    if(g) {
        APP.config.gistId = g;
        await syncCloud(true); // Pull first
    } else {
        try {
            const res = await fetch('https://api.github.com/gists', {
                method:'POST', headers:{Authorization:`token ${t}`},
                body:JSON.stringify({description:"Research Data", public:false, files:{"data.json":{content:JSON.stringify(APP.data)}}})
            });
            if(res.ok) {
                const d = await res.json();
                APP.config.gistId = d.id;
                persist();
                checkCloudStatus();
                showToast('äº‘ç«¯åˆ›å»ºæˆåŠŸ');
                closeCloudModal();
            } else throw new Error();
        } catch(e) { showToast('åˆ›å»ºå¤±è´¥ï¼Œæ£€æŸ¥Token','error'); }
    }
}

async function syncCloud(isPull) {
    if(!APP.config.token || !APP.config.gistId) return;
    const url = `https://api.github.com/gists/${APP.config.gistId}`;
    const head = {Authorization:`token ${APP.config.token}`};
    
    if(isPull) {
        try {
            const res = await fetch(url, {headers:head});
            const d = await res.json();
            const cloudData = JSON.parse(d.files['data.json'].content);
            APP.data = cloudData;
            persist();
            updateUI();
            showToast('å·²ä»äº‘ç«¯åŒæ­¥');
            closeCloudModal();
        } catch(e) { showToast('åŒæ­¥å¤±è´¥','error'); }
    } else {
        // Push: remove large PDFs for cloud efficiency if needed, here we push logic
        const leanData = { 
            achievements: APP.data.achievements.map(i => { const {pdfData, ...r} = i; return r; }), 
            members: APP.data.members 
        };
        fetch(url, {
            method:'PATCH', headers:head,
            body:JSON.stringify({files:{"data.json":{content:JSON.stringify(leanData)}}})
        });
    }
}

function checkCloudStatus() {
    if(APP.config.token) {
        document.getElementById('cloudDot').style.background = 'var(--success)';
        document.getElementById('cloudText').innerText = 'äº‘ç«¯å·²è¿æ¥';
    }
}

// è¾…åŠ©: Toast
function showToast(msg, type='success') {
    const div = document.createElement('div');
    div.className = `toast show`;
    div.style.borderLeftColor = type==='error'?'var(--danger)':'var(--success)';
    div.innerText = msg;
    document.getElementById('toastBox').appendChild(div);
    setTimeout(() => div.remove(), 2000);
}

// å¯åŠ¨
window.onload = loadData;

// è¾…åŠ©å‡½æ•°
function closeDataModal() { document.getElementById('dataModal').classList.remove('active'); }
function closeCloudModal() { document.getElementById('cloudModal').classList.remove('active'); }
function openCloudModal() { document.getElementById('ghToken').value=APP.config.token; document.getElementById('ghGistId').value=APP.config.gistId; document.getElementById('cloudModal').classList.add('active'); }
</script>
</body>
</html>

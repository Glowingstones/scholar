<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ (ç§»åŠ¨ç«¯ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* =================================================================
           1. CSS å˜é‡å®šä¹‰
           ================================================================= */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --accent: #6366f1;
            --accent-light: #eef2ff;
            --accent-dark: #4f46e5;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --sidebar-width: 260px;
        }

        html.dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --border-light: #1e293b;
            --accent-light: #312e81;
            --success-light: #064e3b;
            --warning-light: #78350f;
            --danger-light: #7f1d1d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }

        .hidden { display: none !important; }

        .app-container { display: flex; height: 100vh; overflow: hidden; }

        /* =================================================================
           2. ä¾§è¾¹æ  (Sidebar) - ç§»åŠ¨ç«¯é€‚é…æ ¸å¿ƒä¿®å¤
           ================================================================= */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            flex-shrink: 0;
            height: 100%;
            z-index: 500;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header { 
            padding: 20px; 
            border-bottom: 1px solid var(--border); 
            flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
        }

        .logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }

        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem;
        }

        /* å¯¼èˆªèœå•åŒºåŸŸï¼šå æ®å‰©ä½™ç©ºé—´ï¼Œå…è®¸æ»šåŠ¨ */
        .nav-menu { 
            flex: 1; 
            padding: 16px 12px; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; /* iOSé¡ºæ»‘æ»šåŠ¨ */
        }

        .nav-section {
            font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
            padding: 12px 12px 8px; margin-top: 8px;
        }
        .nav-section:first-child { margin-top: 0; }

        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary);
            font-weight: 500; transition: all 0.2s; margin-bottom: 2px;
        }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-light); color: var(--accent); }

        .nav-item .badge {
            margin-left: auto; background: var(--bg-hover); padding: 2px 8px;
            border-radius: 10px; font-size: 0.75rem; font-weight: 600;
        }
        .nav-item.active .badge { background: var(--accent); color: white; }

        /* ä¾§è¾¹æ åº•éƒ¨ï¼šå›ºå®šåœ¨åº•éƒ¨ï¼Œä¸éšèœå•æ»šåŠ¨ */
        .sidebar-footer { 
            padding: 16px; 
            border-top: 1px solid var(--border); 
            background: var(--bg-secondary);
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
            position: relative; /* ä¸ºä¸‹æ‹‰èœå•å®šä½ */
            z-index: 600;
        }

        .cloud-status-bar {
            background: var(--accent-light);
            border: 1px solid var(--accent);
            color: var(--accent-dark);
            font-size: 0.8rem;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer;
        }
        .cloud-status-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #ccc;
            margin-right: 6px;
        }

        .data-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .data-btn {
            padding: 10px; /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            background: var(--bg-card); color: var(--text-secondary); font-size: 0.85rem;
            cursor: pointer; transition: all 0.2s; text-align: center;
            white-space: nowrap;
        }
        .data-btn:hover { background: var(--bg-hover); border-color: var(--accent); color: var(--accent); }
        .btn-full { grid-column: span 2; background: var(--accent); color: white; border: none; }
        .btn-full:hover { background: var(--accent-dark); }

        /* Dropdown Menu (å‘ä¸Šå¼¹å‡º) */
        .dropdown-menu {
            position: absolute; 
            bottom: 100%; /* å‘ä¸Š */
            left: 10px; right: 10px; /* å®½åº¦é€‚é… */
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.15); 
            display: none; z-index: 1000; overflow: hidden;
            margin-bottom: 10px;
        }
        .dropdown-menu.show { display: block; animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .menu-item { padding: 14px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; border-bottom: 1px solid var(--border-light); }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:hover { background: var(--bg-hover); color: var(--accent); }

        /* =================================================================
           3. ä¸»å†…å®¹åŒºåŸŸ
           ================================================================= */
        .main-content { 
            flex: 1; 
            padding: 24px; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; flex-direction: column;
            width: 100%; /* ç¡®ä¿å æ»¡å‰©ä½™å®½åº¦ */
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0; }
        .page-title { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); }
        .header-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

        .search-box input {
            padding: 10px 16px; border: 2px solid var(--border); border-radius: var(--radius);
            background: var(--bg-card); color: var(--text-primary); font-size: 0.95rem;
            width: 280px; transition: all 0.2s;
        }
        .search-box input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }

        .btn {
            padding: 10px 20px; border-radius: var(--radius); font-weight: 600; font-size: 0.95rem;
            cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; box-shadow: var(--shadow); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px; margin-bottom: 16px; flex-shrink: 0; 
        }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; display: flex; align-items: center; gap: 12px; }
        .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        .stat-icon.papers { background: #dbeafe; } .stat-icon.patents { background: #fef3c7; }
        .stat-icon.projects { background: #d1fae5; } .stat-icon.awards { background: #fce7f3; }
        .stat-icon.books { background: #e0e7ff; } .stat-icon.members { background: #f3e8ff; }
        
        .stat-info h3 { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); }
        .stat-info p { font-size: 0.8rem; color: var(--text-secondary); }

        /* List Layout */
        #listViewContainer { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .filter-container { margin-bottom: 12px; flex-shrink: 0; }
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; }
        .filter-chip {
            padding: 4px 12px; border-radius: 20px; background: var(--bg-card);
            border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.8rem;
            font-weight: 500; cursor: pointer; transition: all 0.2s;
        }
        .filter-chip.active { background: var(--accent); border-color: var(--accent); color: white; }
        
        .keyword-bar { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; padding-top: 8px; border-top: 1px dashed var(--border); }
        .keyword-chip { font-size: 0.75rem; padding: 2px 10px; background: var(--bg-hover); border-radius: 12px; color: var(--text-secondary); cursor: pointer; border: 1px solid transparent; }
        .keyword-chip:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-light); }

        .results-container { 
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); 
            display: flex; flex-direction: column; flex: 1; overflow: hidden;
        }
        .results-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 20px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); 
            flex-wrap: wrap; gap: 12px; flex-shrink: 0;
        }
        .results-count { color: var(--text-secondary); font-size: 0.85rem; }
        .batch-actions { display: flex; gap: 12px; align-items: center; }
        .select-all-wrapper { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .select-all-wrapper input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
        
        .results-list { flex: 1; overflow-y: auto; max-height: none; -webkit-overflow-scrolling: touch; }
        .result-item { 
            display: flex; align-items: center; padding: 12px 16px;
            border-bottom: 1px solid var(--border-light); cursor: pointer; gap: 14px; 
        }
        .result-item:hover { background: var(--bg-hover); }
        .result-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); flex-shrink: 0; }
        .result-type { 
            width: 36px; height: 36px; border-radius: var(--radius-sm); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.1rem; flex-shrink: 0; 
        }
        
        .result-content { flex: 1; min-width: 0; }
        .result-title { 
            font-weight: 600; color: var(--text-primary); font-size: 0.95rem; margin-bottom: 2px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .result-meta { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.8rem; color: var(--text-secondary); }
        .result-meta span { display: flex; align-items: center; gap: 4px; }
        .result-meta .has-pdf { color: var(--accent); font-weight: 500; }
        
        .result-actions { display: flex; gap: 8px; flex-shrink: 0; }
        .action-btn { width: 32px; height: 32px; border: none; background: var(--bg-hover); border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        .action-btn:hover { background: var(--accent-light); color: var(--accent); }
        .action-btn.delete:hover { background: var(--danger-light); color: var(--danger); }

        .empty-state { padding: 60px 20px; text-align: center; color: var(--text-secondary); }

        /* Modal Styles */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1100; opacity: 0; visibility: hidden; transition: all 0.3s; padding: 20px; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border-radius: var(--radius); width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden; transform: scale(0.95); transition: transform 0.3s; display: flex; flex-direction: column; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid var(--border); }
        .modal-header h2 { font-size: 1.2rem; font-weight: 700; }
        .modal-close { width: 32px; height: 32px; border: none; background: var(--bg-hover); border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-primary); font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

        .file-upload { border: 2px dashed var(--border); border-radius: var(--radius); padding: 20px; text-align: center; cursor: pointer; background: var(--bg-primary); }
        .file-upload:active { background: var(--accent-light); border-color: var(--accent); }
        .file-info { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--accent-light); border-radius: var(--radius-sm); border: 1px solid var(--accent); margin-top: 8px; }
        .file-remove { color: var(--danger); background: none; border: none; font-weight: bold; cursor: pointer; }

        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: var(--radius-sm); background: var(--bg-card); border: 1px solid var(--border); box-shadow: var(--shadow-lg); font-weight: 500; transform: translateX(120%); transition: transform 0.3s; display: flex; align-items: center; gap: 8px; }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }

        /* Excel Mapping */
        .excel-preview { max-height: 150px; overflow: auto; border: 1px solid var(--border); margin-bottom: 16px; }
        .excel-preview table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .excel-preview th, .excel-preview td { padding: 6px; border: 1px solid #ddd; }
        .mapping-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .mapping-row select { width: 60%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; }

        /* Mobile Responsive */
        @media (max-width: 1024px) { 
            .form-row-3 { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            /* ä¾§è¾¹æ ç§»åŠ¨ç«¯é€»è¾‘é‡å†™ */
            .sidebar { 
                position: fixed; top: 0; left: 0; bottom: 0;
                transform: translateX(-100%); 
                width: 85%; /* æ›´å®½ä¸€ç‚¹é€‚åº”æ‰‹æŒ‡ */
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            .sidebar.open { transform: translateX(0); }
            
            /* ç¡®ä¿åº•éƒ¨æŒ‰é’®å¯è§ */
            .sidebar-footer { padding-bottom: 30px; /* é¿å¼€ iOS åº•éƒ¨æ¨ªæ¡ */ }
            
            .main-content { margin-left: 0; padding: 16px; width: 100%; }
            .form-row, .form-row-3, .mapping-row { grid-template-columns: 1fr; display: block; }
            .form-group { margin-bottom: 12px; }
            .mapping-row { display: block; margin-bottom: 12px; }
            .mapping-row select { width: 100%; margin-top: 4px; }
            .search-box input { width: 100%; } 
            .header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .header-actions { width: 100%; justify-content: space-between; }
            
            /* æ±‰å ¡èœå•æŒ‰é’® */
            .mobile-menu-btn { display: block !important; position: fixed; top: 16px; left: 16px; z-index: 1000; }
            
            /* é®ç½©å±‚ç‚¹å‡»å…³é—­ä¾§è¾¹æ  */
            .app-container::after {
                content: ''; position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
                z-index: 400; display: none;
            }
            .sidebar.open + .main-content { pointer-events: none; } /* ç®€å•çš„é˜²è¯¯è§¦ */
        }
    </style>
</head>
<body>
<button class="mobile-menu-btn" onclick="toggleSidebar()" style="display:none; width:44px; height:44px; border:none; background:var(--bg-card); border-radius:8px; box-shadow:var(--shadow); font-size:1.5rem; justify-content:center; align-items:center;">â˜°</button>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">ğŸ”¬</div>
                <span>ç§‘ç ”æˆæœç®¡ç†</span>
            </div>
        </div>

        <nav class="nav-menu">
            <div class="nav-section">æˆæœç®¡ç†</div>
            <div class="nav-item active" data-view="all" onclick="setView('all')">
                ğŸ“‹ <span>å…¨éƒ¨æˆæœ</span><span class="badge" id="totalCount">0</span>
            </div>
            <div class="nav-item" data-view="paper" onclick="setView('paper')">
                ğŸ“„ <span>å­¦æœ¯è®ºæ–‡</span><span class="badge" id="paperCount">0</span>
            </div>
            <div class="nav-item" data-view="patent" onclick="setView('patent')">
                ğŸ’¡ <span>å‘æ˜ä¸“åˆ©</span><span class="badge" id="patentCount">0</span>
            </div>
            <div class="nav-item" data-view="project" onclick="setView('project')">
                ğŸ“Š <span>ç§‘ç ”é¡¹ç›®</span><span class="badge" id="projectCount">0</span>
            </div>
            <div class="nav-item" data-view="award" onclick="setView('award')">
                ğŸ† <span>è·å¥–æƒ…å†µ</span><span class="badge" id="awardCount">0</span>
            </div>
            <div class="nav-item" data-view="book" onclick="setView('book')">
                ğŸ“š <span>ä¸“è‘—å‡ºç‰ˆ</span><span class="badge" id="bookCount">0</span>
            </div>
            <div class="nav-section">å›¢é˜Ÿç®¡ç†</div>
            <div class="nav-item" data-view="member" onclick="setView('member')">
                ğŸ‘¥ <span>æˆå‘˜ä¿¡æ¯</span><span class="badge" id="memberCount">0</span>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="cloud-status-bar" onclick="openCloudConfig()">
                <div style="display:flex;align-items:center;gap:6px;">
                    <div id="cloudStatusDot" class="cloud-status-dot" style="background:#ccc;"></div>
                    <span id="cloudStatusText">â˜ï¸ æœªé…ç½®åŒæ­¥</span>
                </div>
                <span style="font-size:0.7rem;">è®¾ç½®</span>
            </div>
            
            <div class="data-actions">
                <button class="data-btn btn-full" onclick="toggleMenu('exportMenu')">ğŸ“¤ å¯¼å‡º / å¤‡ä»½</button>
                <button class="data-btn" onclick="toggleMenu('importMenu')">ğŸ“¥ å¯¼å…¥</button>
                <button class="data-btn" onclick="triggerRestore()">ğŸ“‚ æ¢å¤æ•°æ®</button>
            </div>
            
            <div id="exportMenu" class="dropdown-menu">
                <div class="menu-item" onclick="exportToExcelFile()">ğŸ“Š å¯¼å‡º Excel (åˆ†è¡¨)</div>
                <div class="menu-item" onclick="exportToWordFile()">ğŸ“ å¯¼å‡º Word (åˆ†è¡¨)</div>
                <div class="menu-item" onclick="exportData()">ğŸ“¦ å¤‡ä»½æ•°æ® (JSON)</div>
            </div>

            <div id="importMenu" class="dropdown-menu">
                <div class="menu-item" onclick="openExcelImport()">ğŸ“Š å¯¼å…¥ Excel</div>
                <div class="menu-item" onclick="showToast('Wordå¯¼å…¥éœ€è½¬ä¸ºExcel','warning')">ğŸ“ å¯¼å…¥ Word (ä¸æ”¯æŒ)</div>
                <div class="menu-item" onclick="triggerRestore()">ğŸ“‚ æ¢å¤å¤‡ä»½ (JSON)</div>
            </div>

            <input type="file" id="restoreInput" class="hidden" accept=".json" onchange="performRestore(event)">
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <h1 class="page-title" id="pageTitle">å…¨éƒ¨æˆæœ</h1>
            <div class="header-actions">
                <div class="search-box" id="searchBoxContainer">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢..." oninput="handleSearch()">
                </div>
                <button class="btn btn-primary" id="addBtn" onclick="openAddModal()">â• <span id="addBtnText">æ·»åŠ æˆæœ</span></button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon papers">ğŸ“„</div>
                <div class="stat-info"><h3 id="statPaper">0</h3><p>å­¦æœ¯è®ºæ–‡</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon patents">ğŸ’¡</div>
                <div class="stat-info"><h3 id="statPatent">0</h3><p>å‘æ˜ä¸“åˆ©</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon projects">ğŸ“Š</div>
                <div class="stat-info"><h3 id="statProject">0</h3><p>ç§‘ç ”é¡¹ç›®</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon awards">ğŸ†</div>
                <div class="stat-info"><h3 id="statAward">0</h3><p>è·å¥–æƒ…å†µ</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon books">ğŸ“š</div>
                <div class="stat-info"><h3 id="statBook">0</h3><p>ä¸“è‘—å‡ºç‰ˆ</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon members">ğŸ‘¥</div>
                <div class="stat-info"><h3 id="statMember">0</h3><p>æˆå‘˜</p></div>
            </div>
        </div>

        <div id="listViewContainer">
            <div class="filter-container">
                <div class="filter-bar" id="filterBar">
                    <div class="filter-chip active" data-year="all" onclick="setYearFilter('all')">å…¨éƒ¨å¹´ä»½</div>
                </div>
            </div>

            <div class="results-container" id="resultsContainer">
                <div class="results-header">
                    <div class="batch-actions">
                        <label class="select-all-wrapper">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <span>å…¨é€‰</span>
                        </label>
                        <button class="btn btn-danger btn-sm" id="batchDeleteBtn" onclick="batchDelete()" style="display:none;">
                            ğŸ—‘ åˆ é™¤
                        </button>
                    </div>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span class="results-count" id="resultsCount">å…± 0 æ¡</span>
                    </div>
                </div>
                <div class="results-list" id="resultsList"></div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="cloudModal">
    <div class="modal" style="max-width:500px;">
        <div class="modal-header">
            <h2>â˜ï¸ äº‘åŒæ­¥é…ç½® (GitHub Gist)</h2>
            <button class="modal-close" onclick="closeCloudModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom:15px;color:var(--text-secondary);font-size:0.9rem;">
                è¾“å…¥ Token å’Œ Gist ID å³å¯å¤šç«¯åŒæ­¥ã€‚éœ€åœ¨ GitHub ç”³è¯· Token å¹¶å‹¾é€‰ <b>gist</b> æƒé™ã€‚
            </p>
            <div class="form-group">
                <label>GitHub Token</label>
                <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx" class="form-control">
            </div>
            <div class="form-group">
                <label>Gist ID (ç•™ç©ºåˆ›å»ºæ–°åº“)</label>
                <input type="text" id="ghGistId" class="form-control">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCloudModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="connectGithub()">è¿æ¥ / åˆ›å»º</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="formModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="modalTitle">æ·»åŠ è®°å½•</h2>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="researchForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label>ç±»å‹ *</label>
                        <select id="type" required onchange="toggleFormFields()">
                            <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                            <option value="patent">å‘æ˜ä¸“åˆ©</option>
                            <option value="project">ç§‘ç ”é¡¹ç›®</option>
                            <option value="award">è·å¥–æƒ…å†µ</option>
                            <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                        </select>
                    </div>
                    <div class="form-group" id="dateGroup">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="date">
                    </div>
                </div>
                <div id="generalFields">
                    <div class="form-group"><label>æ ‡é¢˜/åç§°</label><input type="text" id="title"></div>
                    <div class="form-group"><label>ä½œè€…/è´Ÿè´£äºº</label><input type="text" id="authors"></div>
                    <div class="form-row">
                        <div class="form-group"><label>æœŸåˆŠ/æ¥æº/å•ä½</label><input type="text" id="source"></div>
                        <div class="form-group"><label>çº§åˆ«/çŠ¶æ€</label><input type="text" id="level"></div>
                    </div>
                    <div class="form-group"><label>å…³é”®è¯</label><input type="text" id="keywords"></div>
                </div>
                <div id="patentFields" class="hidden">
                    <div class="form-group"><label>ä¸“åˆ©åç§°</label><input type="text" id="patentName"></div>
                    <div class="form-row">
                        <div class="form-group"><label>ç±»å‹</label><select id="patentType"><option value="å‘æ˜ä¸“åˆ©">å‘æ˜ä¸“åˆ©</option><option value="å®ç”¨æ–°å‹">å®ç”¨æ–°å‹</option></select></div>
                        <div class="form-group"><label>çŠ¶æ€</label><select id="patentStatus"><option value="æˆæƒ">æˆæƒ</option><option value="å—ç†">å—ç†</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>å‘æ˜äºº</label><input type="text" id="inventors"></div>
                        <div class="form-group"><label>æƒåˆ©äºº</label><input type="text" id="patentOwner"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>ç”³è¯·æ—¥</label><input type="date" id="applicationDate"></div>
                        <div class="form-group"><label>æˆæƒæ—¥</label><input type="date" id="grantDate"></div>
                    </div>
                    <div class="form-group"><label>ä¸“åˆ©å·</label><input type="text" id="patentNumber"></div>
                </div>
                <div id="projectFields" class="hidden">
                    <div class="form-group"><label>é¡¹ç›®åç§°</label><input type="text" id="projectName"></div>
                    <div class="form-row">
                        <div class="form-group"><label>çº§åˆ«</label><select id="projectLevel"><option value="å›½å®¶çº§">å›½å®¶çº§</option><option value="çœéƒ¨çº§">çœéƒ¨çº§</option><option value="æ¨ªå‘">æ¨ªå‘</option></select></div>
                        <div class="form-group"><label>ç¼–å·</label><input type="text" id="projectNumber"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>å¼€å§‹æ—¶é—´</label><input type="date" id="projectStartDate"></div>
                        <div class="form-group"><label>ç»“æŸæ—¶é—´</label><input type="date" id="projectEndDate"></div>
                    </div>
                    <div class="form-group"><label>æ‰€å±å•ä½</label><input type="text" id="projectOrg"></div>
                </div>
                <div class="form-group">
                    <label>ğŸ“ PDF é™„ä»¶</label>
                    <div class="file-upload" id="fileUpload" onclick="document.getElementById('pdfInput').click()">
                        <input type="file" id="pdfInput" accept=".pdf" onchange="handleFileSelect(event)">
                        <div class="file-upload-text">ç‚¹å‡»ä¸Šä¼  (æ”¯æŒå¤§æ–‡ä»¶)</div>
                    </div>
                    <div class="file-info hidden" id="fileInfo">
                        <span id="fileName"></span>
                        <button type="button" class="file-remove" onclick="removeFile()">âœ•</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="submit" form="researchForm" class="btn btn-primary">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="memberModal">
    <div class="modal wide">
        <div class="modal-header"><h2>æˆå‘˜ä¿¡æ¯</h2><button class="modal-close" onclick="closeMemberModal()">âœ•</button></div>
        <div class="modal-body">
            <form id="memberForm" onsubmit="handleMemberSubmit(event)">
                <input type="hidden" id="memberEditId">
                <div class="form-row-3">
                    <div class="form-group"><label>å·¥å·</label><input type="text" id="memberNo" required></div>
                    <div class="form-group"><label>å§“å</label><input type="text" id="memberName" required></div>
                    <div class="form-group"><label>æ€§åˆ«</label><select id="memberGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
                </div>
                <div class="form-row-3">
                    <div class="form-group"><label>å‡ºç”Ÿå¹´æœˆ</label><input type="month" id="memberBirth"></div>
                    <div class="form-group"><label>è¯ä»¶ç±»å‹</label><select id="memberIdType"><option>èº«ä»½è¯</option><option>æŠ¤ç…§</option></select></div>
                    <div class="form-group"><label>è¯ä»¶å·</label><input type="text" id="memberIdNo"></div>
                </div>
                <div class="form-row-3">
                    <div class="form-group"><label>æ°‘æ—</label><input type="text" id="memberNation"></div>
                    <div class="form-group"><label>å›½åˆ«</label><input type="text" id="memberCountry" value="ä¸­å›½"></div>
                    <div class="form-group"><label>å•ä½</label><input type="text" id="memberOrg"></div>
                </div>
                <div class="form-row-3">
                    <div class="form-group"><label>èŒç§°</label><input type="text" id="memberTitle"></div>
                    <div class="form-group"><label>åœ¨è¯»</label><select id="memberIsStudent"><option value="å¦">å¦</option><option value="æ˜¯">æ˜¯</option></select></div>
                    <div class="form-group"><label>å­¦ä½</label><select id="memberDegree"><option>åšå£«</option><option>ç¡•å£«</option><option>å­¦å£«</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>é‚®ç®±</label><input type="email" id="memberEmail"></div>
                    <div class="form-group"><label>æ‰‹æœº</label><input type="tel" id="memberPhone"></div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeMemberModal()">å–æ¶ˆ</button>
            <button type="submit" form="memberForm" class="btn btn-primary">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="excelModal">
    <div class="modal wide">
        <div class="modal-header"><h2>å¯¼å…¥ Excel</h2><button class="modal-close" onclick="closeExcelModal()">âœ•</button></div>
        <div class="modal-body">
            <div class="form-group"><label>ç±»å‹</label><select id="excelImportType"><option value="paper">è®ºæ–‡</option><option value="member">æˆå‘˜</option></select></div>
            <div class="file-upload" onclick="document.getElementById('excelInput').click()">
                <input type="file" id="excelInput" accept=".xlsx,.xls" onchange="handleExcelSelect(event)">
                ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
            </div>
            <div id="excelPreview" class="excel-preview"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" onclick="confirmExcelImport()">ç¡®è®¤å¯¼å…¥</button></div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
    // ================== Core Logic ==================
    var achievements = [], members = [], ghConfig = {token:'', gistId:''};
    var currentView = 'all', sortOrder = 'date-desc', searchQuery = '', currentYearFilter = 'all';
    var db; const DB_NAME = 'ResearchDB_Unlimited', DB_VERSION = 1;
    var selectedItems = new Set();
    var currentPdfData = null, currentPdfName = null;
    var excelData = [], excelHeaders = [];

    // --- Database (IndexedDB) ---
    function initDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains('appState')) e.target.result.createObjectStore('appState', {keyPath: 'id'}); };
            req.onsuccess = e => { db = e.target.result; resolve(db); };
            req.onerror = e => reject(e);
        });
    }

    async function saveToLocal(skipCloud) {
        if(!db) await initDB();
        const tx = db.transaction(['appState'], 'readwrite');
        tx.objectStore('appState').put({ id: 'main_data', achievements, members, ghConfig, updatedAt: new Date().toISOString() });
        tx.oncomplete = () => {
            document.getElementById('storageStatus').innerText = 'âœ“ æ•°æ®å·²ä¿å­˜';
            if(!skipCloud && ghConfig.token) syncToGithub();
        };
    }

    async function loadFromLocal() {
        if(!db) await initDB();
        return new Promise(resolve => {
            const req = db.transaction(['appState'], 'readonly').objectStore('appState').get('main_data');
            req.onsuccess = e => {
                if(e.target.result) {
                    achievements = e.target.result.achievements || [];
                    members = e.target.result.members || [];
                    ghConfig = e.target.result.ghConfig || {token:'', gistId:''};
                    updateCloudUI();
                }
                resolve(true);
            };
        });
    }

    // --- Cloud Sync ---
    function openCloudConfig() { document.getElementById('ghToken').value = ghConfig.token; document.getElementById('ghGistId').value = ghConfig.gistId; document.getElementById('cloudModal').classList.add('active'); }
    function closeCloudModal() { document.getElementById('cloudModal').classList.remove('active'); }
    async function connectGithub() {
        const token = document.getElementById('ghToken').value.trim();
        const gistId = document.getElementById('ghGistId').value.trim();
        if(!token) return showToast('Token å¿…å¡«', 'error');
        showToast('è¿æ¥ä¸­...', 'warning');
        try {
            if(gistId) {
                await fetch(`https://api.github.com/gists/${gistId}`, { headers: {Authorization:`token ${token}`} });
                ghConfig = {token, gistId}; await syncFromGithub();
            } else {
                const res = await fetch('https://api.github.com/gists', { method:'POST', headers:{Authorization:`token ${token}`}, body:JSON.stringify({description:"Research Data", public:false, files:{"data.json":{content:"{}"}}})});
                if(!res.ok) throw new Error('åˆ›å»ºå¤±è´¥');
                const d = await res.json(); ghConfig = {token, gistId:d.id};
            }
            saveToLocal(true); closeCloudModal(); updateCloudUI();
        } catch(e) { showToast('è¿æ¥å¤±è´¥', 'error'); }
    }
    async function syncToGithub() {
        if(!ghConfig.gistId) return;
        // Strip large PDF data for sync to avoid Gist limits
        const leanAch = achievements.map(a => { const {pdfData, ...rest} = a; return rest; }); 
        fetch(`https://api.github.com/gists/${ghConfig.gistId}`, { method:'PATCH', headers:{Authorization:`token ${ghConfig.token}`}, body:JSON.stringify({files:{"data.json":{content:JSON.stringify({achievements:leanAch, members})}}})});
    }
    async function syncFromGithub() {
        const res = await fetch(`https://api.github.com/gists/${ghConfig.gistId}`, { headers: {Authorization:`token ${ghConfig.token}`} });
        const d = await res.json();
        const content = JSON.parse(d.files['data.json'].content);
        // Merge strategy: Keep local PDFs if exist
        achievements = content.achievements || [];
        members = content.members || [];
        saveToLocal(true); updateStats(); renderResults(); showToast('äº‘ç«¯åŒæ­¥æˆåŠŸ');
    }
    function updateCloudUI() {
        const txt = document.getElementById('cloudStatusText');
        const dot = document.getElementById('cloudStatusDot');
        if(ghConfig.token) { txt.innerText = 'â˜ï¸ äº‘ç«¯å·²è¿æ¥'; dot.style.background = 'var(--success)'; }
    }

    // --- UI Logic ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function setView(v) { 
        currentView = v; selectedItems.clear(); 
        document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.view === v));
        const titles = { all:'å…¨éƒ¨æˆæœ', paper:'å­¦æœ¯è®ºæ–‡', patent:'å‘æ˜ä¸“åˆ©', project:'ç§‘ç ”é¡¹ç›®', award:'è·å¥–æƒ…å†µ', book:'ä¸“è‘—å‡ºç‰ˆ', member:'æˆå‘˜ä¿¡æ¯' };
        document.getElementById('pageTitle').innerText = titles[v];
        document.getElementById('addBtnText').innerText = v==='member' ? 'æ·»åŠ æˆå‘˜' : 'æ·»åŠ æˆæœ';
        if(window.innerWidth<=768) document.getElementById('sidebar').classList.remove('open');
        renderResults();
    }
    function toggleMenu(id) { document.getElementById(id).classList.toggle('show'); }
    document.onclick = e => { if(!e.target.closest('.data-actions, .dropdown-menu')) document.querySelectorAll('.dropdown-menu').forEach(m=>m.classList.remove('show')); };

    // --- CRUD ---
    function openAddModal() {
        if(currentView==='member') { openMemberModal(); return; }
        document.getElementById('researchForm').reset(); removeFile();
        document.getElementById('editId').value = '';
        document.getElementById('type').value = (currentView!=='all') ? currentView : '';
        toggleFormFields();
        document.getElementById('formModal').classList.add('active');
    }
    function editAchievement(id) {
        const item = achievements.find(a=>a.id===id); if(!item) return;
        document.getElementById('editId').value = id;
        document.getElementById('type').value = item.type; toggleFormFields();
        // Fill fields (Simplified mapping)
        if(item.type==='patent'){
            document.getElementById('patentName').value = item.patentName; document.getElementById('patentNumber').value = item.patentNumber;
        } else if(item.type==='project'){
            document.getElementById('projectName').value = item.projectName; document.getElementById('projectNumber').value = item.projectNumber;
        } else {
            document.getElementById('title').value = item.title;
        }
        // ... (Fill rest)
        document.getElementById('formModal').classList.add('active');
    }
    function closeModal() { document.getElementById('formModal').classList.remove('active'); }
    function handleSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const type = document.getElementById('type').value;
        const data = { id: id||Date.now().toString(), type, pdfData: currentPdfData, pdfName: currentPdfName };
        
        if(type==='patent') {
            data.patentName = document.getElementById('patentName').value; data.patentNumber = document.getElementById('patentNumber').value;
            data.title = data.patentName; 
        } else if(type==='project') {
            data.projectName = document.getElementById('projectName').value; data.projectNumber = document.getElementById('projectNumber').value;
            data.title = data.projectName;
        } else {
            data.title = document.getElementById('title').value;
        }
        // ... (Collect rest)
        data.date = document.getElementById('date').value;
        data.authors = document.getElementById('authors').value;

        if(id) { const idx = achievements.findIndex(a=>a.id===id); achievements[idx] = {...achievements[idx], ...data}; }
        else achievements.push(data);
        saveToLocal(); closeModal(); updateStats(); renderResults();
    }
    
    // --- Member CRUD ---
    function openMemberModal() { document.getElementById('memberForm').reset(); document.getElementById('memberEditId').value=''; document.getElementById('memberModal').classList.add('active'); }
    function editMember(id) {
        const m = members.find(x=>x.id===id); if(!m)return;
        document.getElementById('memberEditId').value=id;
        document.getElementById('memberName').value=m.memberName; document.getElementById('memberNo').value=m.memberNo;
        document.getElementById('memberModal').classList.add('active');
    }
    function closeMemberModal() { document.getElementById('memberModal').classList.remove('active'); }
    function handleMemberSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('memberEditId').value;
        const data = { id: id||Date.now().toString(), memberName: document.getElementById('memberName').value, memberNo: document.getElementById('memberNo').value };
        if(id) { const idx = members.findIndex(m=>m.id===id); members[idx] = {...members[idx], ...data}; }
        else members.push(data);
        saveToLocal(); closeMemberModal(); updateStats(); renderResults();
    }

    // --- File Handling ---
    function handleFileSelect(e) {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader(); r.onload = ev => { currentPdfData = ev.target.result; currentPdfName = f.name; document.getElementById('fileName').innerText=f.name; document.getElementById('fileInfo').classList.remove('hidden'); document.getElementById('fileUpload').classList.add('has-file'); };
        r.readAsDataURL(f);
    }
    function removeFile() { currentPdfData=null; document.getElementById('fileInfo').classList.add('hidden'); document.getElementById('fileUpload').classList.remove('has-file'); }

    // --- Restore ---
    function triggerRestore() { document.getElementById('restoreInput').click(); }
    function performRestore(e) {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = ev => {
            try {
                const d = JSON.parse(ev.target.result);
                if(confirm('æ¢å¤å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®å®šå—ï¼Ÿ')) {
                    achievements = d.achievements || [];
                    members = d.members || [];
                    saveToLocal(true);
                    setTimeout(() => location.reload(), 500);
                }
            } catch(e) { showToast('æ–‡ä»¶æ— æ•ˆ', 'error'); }
        };
        r.readAsText(f);
    }

    // --- Render ---
    function updateStats() {
        document.getElementById('totalCount').innerText = achievements.length;
        document.getElementById('memberCount').innerText = members.length;
        // ... (Count others)
    }

    function renderResults() {
        const list = document.getElementById('resultsList');
        const data = currentView==='member' ? members : achievements.filter(a => currentView==='all' || a.type===currentView);
        document.getElementById('resultsCount').innerText = `å…± ${data.length} æ¡`;
        
        if(data.length===0) return list.innerHTML = `<div class="empty-state">æš‚æ— æ•°æ®</div>`;

        list.innerHTML = data.map(i => {
            const title = i.title || i.patentName || i.projectName || i.memberName;
            const sub = i.authors || i.memberOrg || '';
            const date = i.date || i.applicationDate || i.projectStartDate || '';
            const typeClass = i.type ? `type-${i.type}` : 'type-member';
            const icon = i.type ? typeConfig[i.type].icon : 'ğŸ‘¤';
            
            return `<div class="result-item" onclick="currentView==='member'?editMember('${i.id}'):editAchievement('${i.id}')">
                <div class="result-type ${typeClass}">${icon}</div>
                <div class="result-content">
                    <div class="result-title">${title}</div>
                    <div class="result-meta"><span>${date}</span><span>${sub}</span></div>
                </div>
            </div>`;
        }).join('');
    }

    function toggleFormFields() {
        const t = document.getElementById('type').value;
        document.getElementById('patentFields').classList.toggle('hidden', t!=='patent');
        document.getElementById('projectFields').classList.toggle('hidden', t!=='project');
        document.getElementById('generalFields').classList.toggle('hidden', t==='patent'||t==='project');
    }

    // --- Word Export (Split Tables) ---
    function exportToWordFile() {
        let html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><style>table{border-collapse:collapse;width:100%;margin-bottom:20px;font-size:10pt} th,td{border:1px solid #000;padding:4px} th{background:#f0f0f0}</style></head><body><h2>ç§‘ç ”æ±‡æ€»</h2>`;
        
        const types = ['paper', 'patent', 'project', 'award', 'book'];
        const headers = {
            paper: ['æ ‡é¢˜','ä½œè€…','æ—¥æœŸ','æ¥æº','çº§åˆ«'],
            patent: ['ä¸“åˆ©å','ç±»å‹','çŠ¶æ€','ä¸“åˆ©å·','å‘æ˜äºº'],
            project: ['é¡¹ç›®å','ç¼–å·','çº§åˆ«','å•ä½','æ—¶é—´'],
            award: ['å¥–é¡¹å','è·å¥–äºº','æ—¥æœŸ','çº§åˆ«'],
            book: ['ä¹¦å','ä½œè€…','å‡ºç‰ˆæ—¥æœŸ','å‡ºç‰ˆç¤¾']
        };

        types.forEach(t => {
            const arr = achievements.filter(a => a.type === t);
            if(arr.length) {
                html += `<h3>${typeConfig[t].label}</h3><table><tr>${headers[t].map(h=>`<th>${h}</th>`).join('')}</tr>`;
                arr.forEach(i => {
                    let cols = [];
                    if(t==='paper') cols = [i.title, i.authors, i.date, i.source, i.level];
                    else if(t==='patent') cols = [i.patentName, i.patentType, i.patentStatus, i.patentNumber, i.inventors];
                    else if(t==='project') cols = [i.projectName, i.projectNumber, i.projectLevel, i.projectOrg, i.projectStartDate];
                    else if(t==='award') cols = [i.title, i.authors, i.date, i.level];
                    else if(t==='book') cols = [i.title, i.authors, i.date, i.source];
                    html += `<tr>${cols.map(c=>`<td>${c||''}</td>`).join('')}</tr>`;
                });
                html += `</table>`;
            }
        });

        if(members.length) {
            html += `<h3>å›¢é˜Ÿæˆå‘˜</h3><table><tr><th>å·¥å·</th><th>å§“å</th><th>èŒç§°</th><th>å•ä½</th></tr>`;
            members.forEach(m => html += `<tr><td>${m.memberNo}</td><td>${m.memberName}</td><td>${m.memberTitle}</td><td>${m.memberOrg}</td></tr>`);
            html += `</table>`;
        }
        
        html += `</body></html>`;
        const blob = new Blob([html], {type:'application/msword'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'ç§‘ç ”æ•°æ®åˆ†è¡¨æ±‡æ€».doc';
        a.click();
    }

    function showToast(msg) {
        const t = document.createElement('div'); t.className = 'toast show'; t.innerText = msg;
        document.getElementById('toastContainer').appendChild(t);
        setTimeout(() => t.remove(), 2000);
    }

    window.onload = async () => { await loadFromLocal(); updateStats(); renderResults(); };
</script>
</body>
</html>

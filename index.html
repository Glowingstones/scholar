<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ - OneDriveåŒæ­¥ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --accent: #6366f1;
            --accent-light: #eef2ff;
            --accent-dark: #4f46e5;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-sm: 8px;
            
            /* OneDrive / Local Backup Colors */
            --onedrive-color: #0078D4;
            --onedrive-light: #E5F3FF;
        }

        html.dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --border-light: #1e293b;
            --accent-light: #312e81;
            --success-light: #064e3b;
            --warning-light: #78350f;
            --danger-light: #7f1d1d;
            --onedrive-light: #004C87;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }
        .app-container { display: flex; height: 100vh; height: 100dvh; overflow: hidden; }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100%;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }
        .logo-icon {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem;
        }

        .nav-menu { flex: 1; padding: 16px 12px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .nav-section {
            font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
            padding: 12px 12px 8px; margin-top: 8px;
        }
        .nav-section:first-child { margin-top: 0; }

        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary);
            font-weight: 500; transition: all 0.2s; margin-bottom: 4px;
            min-height: 48px;
        }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-light); color: var(--accent); }
        .nav-item .badge {
            margin-left: auto; background: var(--bg-hover); padding: 2px 10px;
            border-radius: 10px; font-size: 0.8rem; font-weight: 600;
        }
        .nav-item.active .badge { background: var(--accent); color: white; }

        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); position: relative; }
        .storage-status {
            font-size: 0.85rem; color: var(--success); margin-bottom: 12px;
            display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
        }
        .storage-status.warning { color: var(--warning); }
        .storage-status .sync-info { font-size: 0.75rem; color: var(--text-muted); margin-left: auto; }

        .data-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .data-btn {
            padding: 10px 8px; border: 1px solid var(--border); border-radius: var(--radius-sm);
            background: var(--bg-card); color: var(--text-secondary); font-size: 0.85rem;
            cursor: pointer; transition: all 0.2s; text-align: center; min-height: 44px;
            display: flex; align-items: center; justify-content: center; gap: 4px;
        }
        .data-btn:hover { background: var(--bg-hover); border-color: var(--accent); color: var(--accent); }
        
        /* OneDrive Style Buttons */
        .data-btn.onedrive { border-color: var(--onedrive-color); color: var(--onedrive-color); }
        .data-btn.onedrive:hover { background: var(--onedrive-light); }
        
        .btn-onedrive { background: var(--onedrive-color); color: white; }
        .btn-onedrive:hover { background: #005a9e; }

        .backup-section { 
            background: var(--onedrive-light); border: 1px solid var(--onedrive-color); 
            border-radius: var(--radius); padding: 16px; margin-bottom: 20px; 
        }
        .backup-section h4 { color: var(--onedrive-color); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .backup-info { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.5; }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute; bottom: 100%; left: 10px; right: 10px;
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg); display: none; z-index: 200; overflow: hidden;
            margin-bottom: 8px;
        }
        .dropdown-menu.show { display: block; animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .menu-item { 
            padding: 14px 16px; cursor: pointer; display: flex; align-items: center; 
            gap: 10px; font-size: 0.95rem; border-bottom: 1px solid var(--border-light);
            min-height: 48px;
        }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:hover { background: var(--bg-hover); color: var(--accent); }

        /* Main Content */
        .main-content { 
            flex: 1; 
            padding: 20px; 
            height: 100vh;
            height: 100dvh;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0; gap: 12px; flex-wrap: wrap; }
        .page-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; flex: 1; justify-content: flex-end; }

        .search-box { flex: 1; min-width: 200px; max-width: 320px; }
        .search-box input {
            padding: 12px 16px; border: 2px solid var(--border); border-radius: var(--radius);
            background: var(--bg-card); color: var(--text-primary); font-size: 16px;
            width: 100%; transition: all 0.2s;
        }
        .search-box input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }

        .btn {
            padding: 12px 20px; border-radius: var(--radius); font-weight: 600; font-size: 0.95rem;
            cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; 
            align-items: center; gap: 8px; white-space: nowrap; min-height: 48px;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; box-shadow: var(--shadow); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; min-height: 36px; }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px; 
            margin-bottom: 16px; 
            flex-shrink: 0; 
        }
        .stat-card { 
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); 
            padding: 14px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; 
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .stat-icon.papers { background: #dbeafe; } 
        .stat-icon.patents { background: #fef3c7; }
        .stat-icon.projects { background: #d1fae5; } 
        .stat-icon.awards { background: #fce7f3; }
        .stat-icon.books { background: #e0e7ff; } 
        .stat-icon.members { background: #f3e8ff; }
        .stat-info h3 { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); }
        .stat-info p { font-size: 0.75rem; color: var(--text-secondary); }

        /* List Layout */
        #listViewContainer {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .filter-container { margin-bottom: 12px; flex-shrink: 0; }
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; }
        .filter-chip {
            padding: 6px 14px; border-radius: 20px; background: var(--bg-card);
            border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.85rem;
            font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .filter-chip:hover { border-color: var(--accent); color: var(--accent); }
        .filter-chip.active { background: var(--accent); border-color: var(--accent); color: white; }
        
        .keyword-bar { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; padding-top: 8px; border-top: 1px dashed var(--border); }
        .keyword-chip { font-size: 0.8rem; padding: 4px 12px; background: var(--bg-hover); border-radius: 12px; color: var(--text-secondary); cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .keyword-chip:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-light); }
        .keyword-chip.active { background: var(--accent); color: white; border-color: var(--accent); }

        .results-container { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            display: flex;
            flex-direction: column;
            flex: 1; 
            overflow: hidden;
            min-height: 0;
        }
        .results-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 16px; 
            border-bottom: 1px solid var(--border); background: var(--bg-secondary); 
            flex-wrap: wrap; gap: 10px; 
            flex-shrink: 0;
        }
        .results-count { color: var(--text-secondary); font-size: 0.85rem; }
        .batch-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .select-all-wrapper { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 10px; border-radius: var(--radius-sm); transition: background 0.2s; }
        .select-all-wrapper:hover { background: var(--bg-hover); }
        .select-all-wrapper input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
        
        .results-list { 
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
        }
        
        .result-item { 
            display: flex; align-items: center; 
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light); 
            cursor: pointer; transition: background 0.2s; gap: 12px;
            min-height: 72px;
        }
        .result-item:hover { background: var(--bg-hover); }
        .result-item:last-child { border-bottom: none; }
        .result-item:active { background: var(--accent-light); }
        .result-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); flex-shrink: 0; }
        .result-type { 
            width: 40px; height: 40px;
            border-radius: var(--radius-sm); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.2rem; flex-shrink: 0; 
        }
        
        .type-paper { background: #dbeafe; } .type-patent { background: #fef3c7; }
        .type-project { background: #d1fae5; } .type-award { background: #fce7f3; }
        .type-book { background: #e0e7ff; } .type-member { background: #f3e8ff; }
        
        .result-content { flex: 1; min-width: 0; overflow: hidden; }
        .result-title { 
            font-weight: 600; color: var(--text-primary); 
            font-size: 0.95rem; 
            margin-bottom: 4px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .result-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.8rem; color: var(--text-secondary); }
        .result-meta span { display: flex; align-items: center; gap: 3px; white-space: nowrap; }
        .result-meta .has-pdf { color: var(--accent); font-weight: 500; }
        
        .result-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .action-btn { 
            width: 36px; height: 36px; border: none; background: var(--bg-hover); 
            border-radius: var(--radius-sm); cursor: pointer; display: flex; 
            align-items: center; justify-content: center; transition: all 0.2s; font-size: 1rem; 
        }
        .action-btn:hover { background: var(--accent-light); color: var(--accent); }
        .action-btn.delete:hover { background: var(--danger-light); color: var(--danger); }

        .empty-state { padding: 60px 20px; text-align: center; color: var(--text-secondary); }
        .empty-state h3 { font-size: 1.25rem; margin-bottom: 8px; color: var(--text-primary); }
        .empty-state p { margin-bottom: 20px; }

        /* Modal Styles */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); 
            backdrop-filter: blur(4px); display: flex; align-items: flex-end; 
            justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; 
            transition: all 0.3s; 
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { 
            background: var(--bg-card); border-radius: var(--radius) var(--radius) 0 0; 
            width: 100%; max-width: 600px; max-height: 90vh; max-height: 90dvh;
            overflow: hidden; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; flex-direction: column; 
        }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal.wide { max-width: 800px; }
        .modal-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 20px; border-bottom: 1px solid var(--border); flex-shrink: 0;
        }
        .modal-header h2 { font-size: 1.2rem; font-weight: 700; }
        .modal-close { 
            width: 40px; height: 40px; border: none; background: var(--bg-hover); 
            border-radius: 50%; cursor: pointer; font-size: 1.2rem; 
            display: flex; align-items: center; justify-content: center; 
            color: var(--text-secondary); transition: all 0.2s; 
        }
        .modal-close:hover { background: var(--danger-light); color: var(--danger); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0; }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 14px 16px; border: 2px solid var(--border); 
            border-radius: var(--radius-sm); background: var(--bg-secondary); 
            color: var(--text-primary); font-size: 16px; transition: all 0.2s; 
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); 
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .form-row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
        .form-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: 6px; }

        .file-upload { border: 2px dashed var(--border); border-radius: var(--radius); padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-upload:hover { border-color: var(--accent); background: var(--accent-light); }
        .file-upload input { display: none; }
        .file-upload-icon { font-size: 2.5rem; margin-bottom: 12px; }
        .file-upload-text { color: var(--text-secondary); font-size: 0.9rem; }
        .file-upload.has-file { display: none; }
        .file-info { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--accent-light); border-radius: var(--radius-sm); border: 1px solid var(--accent); }
        .file-info-name { display: flex; align-items: center; gap: 8px; color: var(--accent); font-weight: 500; }
        .file-remove { width: 32px; height: 32px; border: none; background: var(--danger-light); color: var(--danger); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .excel-preview { max-height: 200px; overflow: auto; border: 1px solid var(--border); border-radius: var(--radius-sm); -webkit-overflow-scrolling: touch; }
        .excel-preview table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .excel-preview th, .excel-preview td { padding: 10px 12px; border: 1px solid var(--border); text-align: left; white-space: nowrap; }
        .excel-preview th { background: var(--bg-secondary); font-weight: 600; position: sticky; top: 0; }
        .mapping-row { display: grid; grid-template-columns: 140px 1fr; gap: 12px; align-items: center; margin-bottom: 12px; }
        .mapping-row label { font-weight: 500; color: var(--text-secondary); font-size: 0.9rem; }
        .mapping-row select { padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary); font-size: 16px; }

        /* Toast */
        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; }
        .toast { 
            padding: 14px 20px; border-radius: var(--radius-sm); background: var(--bg-card); 
            border: 1px solid var(--border); box-shadow: var(--shadow-lg); font-weight: 500; 
            transform: translateY(-120%); transition: transform 0.3s; text-align: center;
        }
        .toast.show { transform: translateY(0); }
        .toast.success { background: var(--success-light); border-color: var(--success); color: var(--success); }
        .toast.error { background: var(--danger-light); border-color: var(--danger); color: var(--danger); }
        .toast.warning { background: var(--warning-light); border-color: var(--warning); color: var(--warning); }

        .duplicate-warning { background: var(--warning-light); border: 1px solid var(--warning); border-radius: var(--radius-sm); padding: 16px; margin-top: 16px; }
        .duplicate-warning h4 { color: var(--warning); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .duplicate-list { max-height: 150px; overflow-y: auto; font-size: 0.85rem; color: var(--text-secondary); }
        .duplicate-list li { padding: 4px 0; border-bottom: 1px solid var(--warning); }
        .duplicate-list li:last-child { border-bottom: none; }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 101;
            width: 48px;
            height: 48px;
            border: none;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow);
            font-size: 1.4rem;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        /* Sidebar Overlay for Mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
        }
        .sidebar-overlay.active { display: block; }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Confirm Dialog */
        .confirm-dialog {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            max-width: 360px;
            width: 90%;
            text-align: center;
        }
        .confirm-dialog p { margin-bottom: 20px; font-size: 1.05rem; }
        .confirm-dialog .btn-group { display: flex; gap: 12px; justify-content: center; }

        /* Responsive Design */
        @media (min-width: 769px) {
            .modal-overlay { align-items: center; padding: 20px; }
            .modal { border-radius: var(--radius); max-height: 85vh; }
        }

        @media (max-width: 768px) {
            .mobile-menu-btn { display: flex; }
            .sidebar { 
                position: fixed; 
                left: 0; top: 0; bottom: 0;
                transform: translateX(-100%); 
                width: 85%;
                max-width: 320px;
            }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 70px 12px 12px; }
            .page-title { font-size: 1.25rem; }
            .header { flex-direction: column; align-items: stretch; }
            .header-actions { width: 100%; justify-content: stretch; }
            .search-box { max-width: none; min-width: 0; }
            .btn { padding: 10px 16px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .stat-card { padding: 12px; }
            .stat-info h3 { font-size: 1.1rem; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .mapping-row { grid-template-columns: 1fr; gap: 8px; }
            .result-actions { opacity: 1; }
            .result-item { padding: 12px; }
            .results-header { padding: 10px 12px; }
        }

        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .stat-card { padding: 10px 8px; flex-direction: column; gap: 6px; text-align: center; }
            .stat-icon { width: 32px; height: 32px; font-size: 1rem; }
            .stat-info h3 { font-size: 1rem; }
            .stat-info p { font-size: 0.7rem; }
            .filter-chip { padding: 5px 10px; font-size: 0.8rem; }
            .result-meta { font-size: 0.75rem; }
        }
    </style>
</head>
<body>
<button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">ğŸ”¬</div>
                <div>
                    <div>ç§‘ç ”æˆæœç®¡ç†</div>
                    <div style="font-size:0.7rem;color:var(--text-muted);font-weight:400;">æ”¯æŒ OneDrive/æœ¬åœ°å¤‡ä»½</div>
                </div>
            </div>
        </div>

        <nav class="nav-menu">
            <div class="nav-section">æˆæœç®¡ç†</div>
            <div class="nav-item active" data-view="all" onclick="setView('all')">
                ğŸ“‹ <span>å…¨éƒ¨æˆæœ</span>
                <span class="badge" id="totalCount">0</span>
            </div>
            <div class="nav-item" data-view="paper" onclick="setView('paper')">
                ğŸ“„ <span>å­¦æœ¯è®ºæ–‡</span>
                <span class="badge" id="paperCount">0</span>
            </div>
            <div class="nav-item" data-view="patent" onclick="setView('patent')">
                ğŸ’¡ <span>å‘æ˜ä¸“åˆ©</span>
                <span class="badge" id="patentCount">0</span>
            </div>
            <div class="nav-item" data-view="project" onclick="setView('project')">
                ğŸ“Š <span>ç§‘ç ”é¡¹ç›®</span>
                <span class="badge" id="projectCount">0</span>
            </div>
            <div class="nav-item" data-view="award" onclick="setView('award')">
                ğŸ† <span>è·å¥–æƒ…å†µ</span>
                <span class="badge" id="awardCount">0</span>
            </div>
            <div class="nav-item" data-view="book" onclick="setView('book')">
                ğŸ“š <span>ä¸“è‘—å‡ºç‰ˆ</span>
                <span class="badge" id="bookCount">0</span>
            </div>
            <div class="nav-section">å›¢é˜Ÿç®¡ç†</div>
            <div class="nav-item" data-view="member" onclick="setView('member')">
                ğŸ‘¥ <span>æˆå‘˜ä¿¡æ¯</span>
                <span class="badge" id="memberCount">0</span>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="storage-status" id="storageStatus">
                âœ“ æ•°æ®å·²æœ¬åœ°ä¿å­˜
            </div>
            <div class="data-actions">
                <button class="data-btn" onclick="toggleMenu('exportMenu')">ğŸ“¤ å¯¼å‡º</button>
                <button class="data-btn" onclick="toggleMenu('importMenu')">ğŸ“¥ å¯¼å…¥</button>
                <button class="data-btn onedrive" onclick="openBackupModal()" style="grid-column: span 2;">
                    â˜ï¸ æ•°æ®å¤‡ä»½ä¸æ¢å¤
                </button>
            </div>
            
            <div id="exportMenu" class="dropdown-menu">
                <div class="menu-item" onclick="exportToExcelFile()">ğŸ“Š å¯¼å‡º Excel</div>
                <div class="menu-item" onclick="exportToWordFile()">ğŸ“ å¯¼å‡º Word</div>
                <div class="menu-item" onclick="exportData()">ğŸ“¦ å¯¼å‡ºçº¯ JSON</div>
            </div>

            <div id="importMenu" class="dropdown-menu">
                <div class="menu-item" onclick="openExcelImport()">ğŸ“Š å¯¼å…¥ Excel</div>
                <div class="menu-item" onclick="triggerImport()">ğŸ“‚ æ¢å¤ JSON</div>
            </div>

            <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(event)">
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <h1 class="page-title" id="pageTitle">å…¨éƒ¨æˆæœ</h1>
            <div class="header-actions">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢..." oninput="handleSearch()">
                </div>
                <button class="btn btn-primary" id="addBtn" onclick="openAddModal()">â• <span id="addBtnText">æ·»åŠ </span></button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon papers">ğŸ“„</div>
                <div class="stat-info"><h3 id="statPaper">0</h3><p>è®ºæ–‡</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon patents">ğŸ’¡</div>
                <div class="stat-info"><h3 id="statPatent">0</h3><p>ä¸“åˆ©</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon projects">ğŸ“Š</div>
                <div class="stat-info"><h3 id="statProject">0</h3><p>é¡¹ç›®</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon awards">ğŸ†</div>
                <div class="stat-info"><h3 id="statAward">0</h3><p>è·å¥–</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon books">ğŸ“š</div>
                <div class="stat-info"><h3 id="statBook">0</h3><p>è‘—ä½œ</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon members">ğŸ‘¥</div>
                <div class="stat-info"><h3 id="statMember">0</h3><p>æˆå‘˜</p></div>
            </div>
        </div>

        <div id="listViewContainer">
            <div class="filter-container">
                <div class="filter-bar" id="filterBar">
                    <div class="filter-chip active" data-year="all" onclick="setYearFilter('all')">å…¨éƒ¨å¹´ä»½</div>
                </div>
                <div class="keyword-bar" id="keywordBar" style="display:none;">
                    <span style="font-size:0.8rem;color:var(--text-muted);margin-right:5px;">ğŸ·ï¸ çƒ­é—¨æ ‡ç­¾:</span>
                </div>
            </div>

            <div class="results-container" id="resultsContainer">
                <div class="results-header">
                    <div class="batch-actions">
                        <label class="select-all-wrapper">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <span>å…¨é€‰</span>
                        </label>
                        <button class="btn btn-danger btn-sm" id="batchDeleteBtn" onclick="batchDelete()" style="display:none;">
                            ğŸ—‘ åˆ é™¤ (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                        <span class="results-count" id="resultsCount">å…± 0 æ¡</span>
                        <select id="sortSelect" onchange="handleSort()" style="padding:10px 12px;border-radius:8px;border:2px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-weight:500;font-size:16px;">
                            <option value="date-desc">æœ€æ–°ä¼˜å…ˆ</option>
                            <option value="date-asc">æœ€æ—©ä¼˜å…ˆ</option>
                            <option value="title-asc">æ ‡é¢˜æ’åº</option>
                        </select>
                    </div>
                </div>
                <div class="results-list" id="resultsList"></div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="formModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="modalTitle">æ·»åŠ ç§‘ç ”æˆæœ</h2>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="researchForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label>æˆæœç±»å‹ *</label>
                        <select id="type" required onchange="toggleFormFields()">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                            <option value="patent">å‘æ˜ä¸“åˆ©</option>
                            <option value="project">ç§‘ç ”é¡¹ç›®</option>
                            <option value="award">è·å¥–æƒ…å†µ</option>
                            <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                        </select>
                    </div>
                    <div class="form-group" id="dateGroup">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="date">
                    </div>
                </div>
                <div id="generalFields">
                    <div class="form-group" id="titleGroup">
                        <label>æ ‡é¢˜ *</label>
                        <input type="text" id="title" placeholder="è¯·è¾“å…¥æˆæœæ ‡é¢˜">
                    </div>
                    <div class="form-group" id="authorsGroup">
                        <label>ä½œè€…/æˆå‘˜</label>
                        <input type="text" id="authors" placeholder="å¤šä¸ªä½œè€…ç”¨é€—å·åˆ†éš”">
                    </div>
                    <div class="form-row" id="sourceGroup">
                        <div class="form-group">
                            <label>æ¥æº/æœŸåˆŠ</label>
                            <input type="text" id="source" placeholder="å¦‚ Nature">
                        </div>
                        <div class="form-group">
                            <label>çº§åˆ«</label>
                            <input type="text" id="level" placeholder="å¦‚ SCIä¸€åŒº">
                        </div>
                    </div>
                    <div class="form-group" id="keywordsGroup">
                        <label>å…³é”®è¯</label>
                        <input type="text" id="keywords" placeholder="å¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”">
                    </div>
                </div>
                <div id="patentFields" class="hidden">
                    <div class="form-group">
                        <label>ä¸“åˆ©åç§° *</label>
                        <input type="text" id="patentName" placeholder="è¯·è¾“å…¥ä¸“åˆ©åç§°">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ä¸“åˆ©ç±»å‹ *</label>
                            <select id="patentType">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="å‘æ˜ä¸“åˆ©">å‘æ˜ä¸“åˆ©</option>
                                <option value="å®ç”¨æ–°å‹">å®ç”¨æ–°å‹</option>
                                <option value="å¤–è§‚è®¾è®¡">å¤–è§‚è®¾è®¡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ä¸“åˆ©çŠ¶æ€</label>
                            <select id="patentStatus">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="ç”³è¯·ä¸­">ç”³è¯·ä¸­</option>
                                <option value="å·²å—ç†">å·²å—ç†</option>
                                <option value="å®å®¡ä¸­">å®å®¡ä¸­</option>
                                <option value="å·²æˆæƒ">å·²æˆæƒ</option>
                                <option value="å·²é©³å›">å·²é©³å›</option>
                                <option value="å·²å¤±æ•ˆ">å·²å¤±æ•ˆ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å‘æ˜äºº</label>
                            <input type="text" id="inventors" placeholder="å¤šä¸ªå‘æ˜äººç”¨é€—å·åˆ†éš”">
                        </div>
                        <div class="form-group">
                            <label>ä¸“åˆ©æƒäºº</label>
                            <input type="text" id="patentOwner" placeholder="ä¸“åˆ©æƒäºº">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ä¸“åˆ©ç”³è¯·æ—¥</label>
                            <input type="date" id="applicationDate">
                        </div>
                        <div class="form-group">
                            <label>å—ç†/æˆæƒæ—¶é—´</label>
                            <input type="date" id="grantDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ä¸“åˆ©å·</label>
                        <input type="text" id="patentNumber" placeholder="å¦‚ CN202310001234.5">
                    </div>
                </div>
                <div id="projectFields" class="hidden">
                    <div class="form-group">
                        <label>é¡¹ç›®åç§° *</label>
                        <input type="text" id="projectName" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>é¡¹ç›®çº§åˆ«</label>
                            <select id="projectLevel">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="å›½å®¶çº§">å›½å®¶çº§</option>
                                <option value="çœéƒ¨çº§">çœéƒ¨çº§</option>
                                <option value="å…å±€çº§">å…å±€çº§</option>
                                <option value="æ ¡çº§">æ ¡çº§</option>
                                <option value="æ¨ªå‘é¡¹ç›®">æ¨ªå‘é¡¹ç›®</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é¡¹ç›®ç¼–å·</label>
                            <input type="text" id="projectNumber" placeholder="é¡¹ç›®ç¼–å·">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å¼€å§‹æ—¶é—´</label>
                            <input type="date" id="projectStartDate">
                        </div>
                        <div class="form-group">
                            <label>ç»“æŸæ—¶é—´</label>
                            <input type="date" id="projectEndDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é¡¹ç›®æ‰€å±å•ä½</label>
                        <input type="text" id="projectOrg" placeholder="é¡¹ç›®æ‰€å±å•ä½">
                    </div>
                </div>
                <div class="form-group">
                    <label>ğŸ“ PDF é™„ä»¶</label>
                    <div class="file-upload" id="fileUpload" onclick="document.getElementById('pdfInput').click()">
                        <input type="file" id="pdfInput" accept=".pdf" onchange="handleFileSelect(event)">
                        <div class="file-upload-icon">ğŸ“„</div>
                        <div class="file-upload-text">ç‚¹å‡»ä¸Šä¼  PDF æ–‡ä»¶</div>
                    </div>
                    <div class="file-info hidden" id="fileInfo">
                        <span class="file-info-name">
                            <span>ğŸ“„</span>
                            <span id="fileName"></span>
                        </span>
                        <button type="button" class="file-remove" onclick="removeFile()">âœ•</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="submit" form="researchForm" class="btn btn-primary" id="submitBtn">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="memberModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="memberModalTitle">æ·»åŠ æˆå‘˜</h2>
            <button class="modal-close" onclick="closeMemberModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="memberForm" onsubmit="handleMemberSubmit(event)">
                <input type="hidden" id="memberEditId">
                <div class="form-row">
                    <div class="form-group">
                        <label>å­¦å·/å·¥å· *</label>
                        <input type="text" id="memberNo" required placeholder="å­¦å·æˆ–å·¥å·">
                    </div>
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="memberName" required placeholder="å§“å">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ€§åˆ«</label>
                        <select id="memberGender">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å‡ºç”Ÿå¹´æœˆ</label>
                        <input type="month" id="memberBirth">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>è¯ä»¶ç±»å‹</label>
                        <select id="memberIdType">
                            <option value="èº«ä»½è¯">èº«ä»½è¯</option>
                            <option value="æŠ¤ç…§">æŠ¤ç…§</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è¯ä»¶å·ç </label>
                        <input type="text" id="memberIdNo" placeholder="è¯ä»¶å·ç ">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ°‘æ—</label>
                        <input type="text" id="memberNation" placeholder="å¦‚ï¼šæ±‰æ—">
                    </div>
                    <div class="form-group">
                        <label>å›½åˆ«æˆ–åœ°åŒº</label>
                        <input type="text" id="memberCountry" placeholder="å¦‚ï¼šä¸­å›½" value="ä¸­å›½">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å·¥ä½œå•ä½</label>
                        <input type="text" id="memberOrg" placeholder="æ‰€å±å•ä½">
                    </div>
                    <div class="form-group">
                        <label>èŒç§°</label>
                        <input type="text" id="memberTitle" placeholder="å¦‚ï¼šå‰¯æ•™æˆ">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ˜¯å¦åœ¨è¯»ç ”ç©¶ç”Ÿ</label>
                        <select id="memberIsStudent">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="æ˜¯">æ˜¯</option>
                            <option value="å¦">å¦</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æœ€é«˜å­¦ä½</label>
                        <select id="memberDegree">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="å­¦å£«">å­¦å£«</option>
                            <option value="ç¡•å£«">ç¡•å£«</option>
                            <option value="åšå£«">åšå£«</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”µå­é‚®ç®±</label>
                        <input type="email" id="memberEmail" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label>æ‰‹æœº</label>
                        <input type="tel" id="memberPhone" placeholder="æ‰‹æœºå·ç ">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">å–æ¶ˆ</button>
            <button type="submit" form="memberForm" class="btn btn-primary">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="excelModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2>å¯¼å…¥ Excel æ•°æ®</h2>
            <button class="modal-close" onclick="closeExcelModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>é€‰æ‹©è¦å¯¼å…¥çš„æ•°æ®ç±»å‹</label>
                <select id="excelImportType" onchange="updateMappingFields()">
                    <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                    <option value="patent">å‘æ˜ä¸“åˆ©</option>
                    <option value="project">ç§‘ç ”é¡¹ç›®</option>
                    <option value="award">è·å¥–æƒ…å†µ</option>
                    <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                    <option value="member">æˆå‘˜</option>
                </select>
            </div>
            <div class="form-group">
                <label>é€‰æ‹© Excel æ–‡ä»¶</label>
                <div class="file-upload" onclick="document.getElementById('excelInput').click()">
                    <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" onchange="handleExcelSelect(event)">
                    <div class="file-upload-icon">ğŸ“Š</div>
                    <div class="file-upload-text">ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶</div>
                </div>
            </div>
            <div id="excelPreviewContainer" class="hidden">
                <label style="font-weight:600;margin-bottom:10px;display:block;">æ•°æ®é¢„è§ˆï¼ˆå‰5è¡Œï¼‰</label>
                <div class="excel-preview" id="excelPreview"></div>
            </div>
            <div id="mappingContainer" class="hidden" style="margin-top:20px;">
                <label style="font-weight:600;margin-bottom:10px;display:block;">å­—æ®µæ˜ å°„</label>
                <div id="mappingFields"></div>
            </div>
            <div id="duplicateWarning" class="duplicate-warning hidden">
                <h4>âš ï¸ å‘ç°é‡å¤é¡¹</h4>
                <p style="margin-bottom:8px;font-size:0.9rem;">ä»¥ä¸‹æ•°æ®å¯èƒ½ä¸å·²æœ‰è®°å½•é‡å¤ï¼š</p>
                <ul class="duplicate-list" id="duplicateList"></ul>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeExcelModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="importExcelBtn" onclick="confirmExcelImport()" disabled>ç¡®è®¤å¯¼å…¥</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="backupModal">
    <div class="modal">
        <div class="modal-header">
            <h2>â˜ï¸ æ•°æ®å¤‡ä»½ä¸æ¢å¤</h2>
            <button class="modal-close" onclick="closeBackupModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="backup-section">
                <h4>ğŸ“¥ å¤‡ä»½åˆ° OneDrive / æœ¬åœ°</h4>
                <div class="backup-info">
                    ç”±äºæ•°æ®é‡è¾ƒå¤§ï¼ˆå«PDFé™„ä»¶ï¼‰ï¼Œå»ºè®®ä½¿ç”¨æ­¤æ–¹å¼ã€‚
                    <br>
                    <strong>æ“ä½œæŒ‡å—ï¼š</strong>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå°†ç”Ÿæˆçš„ <code style="background:rgba(0,0,0,0.1);padding:2px 4px;border-radius:4px;">.json</code> å¤‡ä»½æ–‡ä»¶ç›´æ¥ä¿å­˜åˆ°æ‚¨çš„ <strong>OneDrive åŒæ­¥æ–‡ä»¶å¤¹</strong>ä¸­ï¼Œå³å¯å®ç°äº‘ç«¯å¤‡ä»½ã€‚
                </div>
                
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" id="includePdfInBackup" checked style="width:18px;height:18px;">
                        åŒ…å« PDF é™„ä»¶æ–‡ä»¶
                    </label>
                    <div class="form-hint">å¦‚æœä¸å‹¾é€‰ï¼Œä»…å¤‡ä»½æ–‡å­—ä¿¡æ¯ï¼Œæ–‡ä»¶ä½“ç§¯ä¼šéå¸¸å°ã€‚</div>
                </div>

                <div class="form-group" style="margin-top:10px;">
                    <button class="btn btn-onedrive" onclick="performBackup()" style="width:100%;justify-content:center;">
                        â˜ï¸ å¯¼å‡ºå¤‡ä»½æ–‡ä»¶ (ä¿å­˜åˆ° OneDrive)
                    </button>
                </div>
            </div>

            <div style="border-top:1px solid var(--border); padding-top:20px; margin-top:20px;">
                <h4 style="margin-bottom:12px;font-size:1rem;">ğŸ“¤ ä»å¤‡ä»½æ¢å¤</h4>
                <div class="backup-info">
                    ä»æ‚¨çš„ OneDrive æ–‡ä»¶å¤¹æˆ–æœ¬åœ°ç£ç›˜é€‰æ‹©ä¹‹å‰çš„å¤‡ä»½æ–‡ä»¶è¿›è¡Œæ¢å¤ã€‚
                </div>
                
                <div class="file-upload" onclick="document.getElementById('restoreInput').click()" style="padding:20px;">
                    <input type="file" id="restoreInput" accept=".json" onchange="performRestore(event)">
                    <div class="file-upload-icon" style="font-size:2rem;margin-bottom:8px;">ğŸ“‚</div>
                    <div class="file-upload-text">ç‚¹å‡»é€‰æ‹©å¤‡ä»½æ–‡ä»¶ (.json)</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="confirmModal">
    <div class="confirm-dialog">
        <p id="confirmMessage">ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ</p>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeConfirmModal()">å–æ¶ˆ</button>
            <button class="btn btn-danger" onclick="confirmDelete()">åˆ é™¤</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
    // Dark mode detection
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(event) {
        event.matches ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark');
    });

    // Global State
    var achievements = [];
    var members = [];
    var currentView = 'all';
    var currentYearFilter = 'all';
    var currentKeywordFilter = null;
    var searchQuery = '';
    var sortOrder = 'date-desc';
    var deleteTargetIds = [];
    var deleteTargetType = 'achievement';
    var currentPdfData = null;
    var currentPdfName = null;
    var excelData = null;
    var excelHeaders = [];
    var selectedItems = new Set();

    var typeConfig = {
        paper: { icon: 'ğŸ“„', label: 'å­¦æœ¯è®ºæ–‡', class: 'type-paper' },
        patent: { icon: 'ğŸ’¡', label: 'å‘æ˜ä¸“åˆ©', class: 'type-patent' },
        project: { icon: 'ğŸ“Š', label: 'ç§‘ç ”é¡¹ç›®', class: 'type-project' },
        award: { icon: 'ğŸ†', label: 'è·å¥–æƒ…å†µ', class: 'type-award' },
        book: { icon: 'ğŸ“š', label: 'ä¸“è‘—å‡ºç‰ˆ', class: 'type-book' },
        member: { icon: 'ğŸ‘¤', label: 'æˆå‘˜', class: 'type-member' }
    };

    var fieldMappings = {
        paper: [
            { key: 'title', label: 'æ ‡é¢˜', required: true },
            { key: 'authors', label: 'ä½œè€…' },
            { key: 'date', label: 'å‘è¡¨æ—¥æœŸ' },
            { key: 'source', label: 'æœŸåˆŠ/æ¥æº' },
            { key: 'level', label: 'çº§åˆ«' },
            { key: 'keywords', label: 'å…³é”®è¯' }
        ],
        patent: [
            { key: 'patentName', label: 'ä¸“åˆ©åç§°', required: true },
            { key: 'patentType', label: 'ä¸“åˆ©ç±»å‹' },
            { key: 'inventors', label: 'å‘æ˜äºº' },
            { key: 'patentOwner', label: 'ä¸“åˆ©æƒäºº' },
            { key: 'applicationDate', label: 'ç”³è¯·æ—¥' },
            { key: 'grantDate', label: 'æˆæƒæ—¶é—´' },
            { key: 'patentNumber', label: 'ä¸“åˆ©å·' },
            { key: 'patentStatus', label: 'ä¸“åˆ©çŠ¶æ€' }
        ],
        project: [
            { key: 'projectName', label: 'é¡¹ç›®åç§°', required: true },
            { key: 'projectLevel', label: 'é¡¹ç›®çº§åˆ«' },
            { key: 'projectNumber', label: 'é¡¹ç›®ç¼–å·' },
            { key: 'projectStartDate', label: 'å¼€å§‹æ—¶é—´' },
            { key: 'projectEndDate', label: 'ç»“æŸæ—¶é—´' },
            { key: 'projectOrg', label: 'æ‰€å±å•ä½' }
        ],
        award: [
            { key: 'title', label: 'å¥–é¡¹åç§°', required: true },
            { key: 'authors', label: 'è·å¥–äºº' },
            { key: 'date', label: 'è·å¥–æ—¥æœŸ' },
            { key: 'level', label: 'çº§åˆ«' }
        ],
        book: [
            { key: 'title', label: 'è‘—ä½œåç§°', required: true },
            { key: 'authors', label: 'ä½œè€…' },
            { key: 'date', label: 'å‡ºç‰ˆæ—¥æœŸ' },
            { key: 'source', label: 'å‡ºç‰ˆç¤¾' }
        ],
        member: [
            { key: 'memberNo', label: 'å­¦å·/å·¥å·', required: true },
            { key: 'memberName', label: 'å§“å', required: true },
            { key: 'memberGender', label: 'æ€§åˆ«' },
            { key: 'memberBirth', label: 'å‡ºç”Ÿå¹´æœˆ' },
            { key: 'memberIdType', label: 'è¯ä»¶ç±»å‹' },
            { key: 'memberIdNo', label: 'è¯ä»¶å·ç ' },
            { key: 'memberNation', label: 'æ°‘æ—' },
            { key: 'memberCountry', label: 'å›½åˆ«' },
            { key: 'memberOrg', label: 'å·¥ä½œå•ä½' },
            { key: 'memberTitle', label: 'èŒç§°' },
            { key: 'memberIsStudent', label: 'æ˜¯å¦åœ¨è¯»' },
            { key: 'memberDegree', label: 'æœ€é«˜å­¦ä½' },
            { key: 'memberEmail', label: 'é‚®ç®±' },
            { key: 'memberPhone', label: 'æ‰‹æœº' }
        ]
    };

    // IndexedDB Storage
    const DB_NAME = 'ResearchDB_V4';
    const DB_VERSION = 1;
    let db;

    function initDB() {
        return new Promise(function(resolve, reject) {
            var request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = function(event) {
                console.error("Database error");
                reject(event.target.errorCode);
            };
            request.onupgradeneeded = function(event) {
                var database = event.target.result;
                if (!database.objectStoreNames.contains('appState')) {
                    database.createObjectStore('appState', { keyPath: 'id' });
                }
            };
            request.onsuccess = function(event) {
                db = event.target.result;
                resolve(db);
            };
        });
    }

    async function saveToLocal() {
        if (!db) await initDB();
        var transaction = db.transaction(['appState'], 'readwrite');
        var store = transaction.objectStore('appState');
        var dataToSave = {
            id: 'main_data',
            achievements: achievements,
            members: members,
            updatedAt: new Date().toISOString()
        };
        var request = store.put(dataToSave);
        request.onsuccess = function() { updateStorageStatus(true); };
        request.onerror = function() { updateStorageStatus(false); showToast("ä¿å­˜å¤±è´¥", "error"); };
    }

    async function loadFromLocal() {
        if (!db) await initDB();
        return new Promise(function(resolve) {
            var transaction = db.transaction(['appState'], 'readonly');
            var store = transaction.objectStore('appState');
            var request = store.get('main_data');
            request.onsuccess = function(event) {
                var result = event.target.result;
                if (result) {
                    achievements = result.achievements || [];
                    members = result.members || [];
                    resolve(true);
                } else {
                    resolve(false);
                }
            };
            request.onerror = function() { resolve(false); };
        });
    }

    function updateStorageStatus(ok) {
        var status = document.getElementById('storageStatus');
        if (ok) {
            status.className = 'storage-status';
            status.innerHTML = 'âœ“ æ•°æ®å·²æœ¬åœ°ä¿å­˜';
        } else {
            status.className = 'storage-status warning';
            status.textContent = 'âš  ä¿å­˜å¤±è´¥';
        }
    }

    // --- Backup & Restore Functions (Replacing GitHub) ---
    
    function openBackupModal() {
        document.getElementById('backupModal').classList.add('active');
        closeAllMenus();
    }

    function closeBackupModal() {
        document.getElementById('backupModal').classList.remove('active');
    }

    function performBackup() {
        var includePdf = document.getElementById('includePdfInBackup').checked;
        
        var btn = document.querySelector('.btn-onedrive');
        var originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span>æ­£åœ¨æ‰“åŒ…...';

        // ä½¿ç”¨ setTimeout è®© UI æœ‰æœºä¼šæ¸²æŸ“ loading çŠ¶æ€
        setTimeout(function() {
            try {
                // 1. å‡†å¤‡æ•°æ®
                var dataToBackup = {
                    version: '4.1', 
                    backupDate: new Date().toISOString(),
                    system: 'ResearchManager',
                    achievements: [],
                    members: members
                };

                // 2. å¤„ç† PDF (æ ¹æ®ç”¨æˆ·é€‰æ‹©å†³å®šæ˜¯å¦åŒ…å«)
                if (includePdf) {
                    dataToBackup.achievements = achievements;
                } else {
                    // æ·±æ‹·è´å¹¶ç§»é™¤ PDF æ•°æ®ä»¥å‡å°ä½“ç§¯
                    dataToBackup.achievements = achievements.map(function(item) {
                        var copy = Object.assign({}, item);
                        if (copy.pdfData) {
                            copy.pdfData = null; // æ¸…ç©ºå†…å®¹
                            copy.pdfName = (item.pdfName || 'Unknown') + " (é™„ä»¶æœªå¤‡ä»½)";
                        }
                        return copy;
                    });
                }

                // 3. è½¬æ¢ä¸º Blob
                var jsonStr = JSON.stringify(dataToBackup, null, 2);
                var blob = new Blob([jsonStr], { type: 'application/json' });
                
                // 4. è®¡ç®—å¤§å°å¹¶æç¤º
                var sizeInMB = (blob.size / (1024 * 1024)).toFixed(2);
                if (sizeInMB > 100) {
                    if (!confirm('å¤‡ä»½æ–‡ä»¶è¾ƒå¤§ (' + sizeInMB + ' MB)ï¼Œä¸‹è½½å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        return;
                    }
                }

                // 5. è§¦å‘ä¸‹è½½
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                // æ–‡ä»¶ååŠ ä¸Šæ—¶é—´æˆ³ï¼Œæ–¹ä¾¿åœ¨ OneDrive ä¸­ç®¡ç†ç‰ˆæœ¬
                var timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                a.download = 'Research_Backup_' + timestamp + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast('âœ“ å¤‡ä»½å·²ç”Ÿæˆï¼Œè¯·ä¿å­˜åˆ° OneDrive', 'success');
                closeBackupModal();

            } catch (err) {
                console.error(err);
                showToast('âŒ å¤‡ä»½å¤±è´¥: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }, 100);
    }

    function performRestore(event) {
        var file = event.target.files[0];
        if (!file) return;

        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = JSON.parse(e.target.result);
                
                // ç®€å•çš„æ ¼å¼æ ¡éªŒ
                if (!data.achievements && !data.members) {
                    throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œæœªæ‰¾åˆ°æ•°æ®');
                }

                var newAchievements = data.achievements || [];
                var newMembers = data.members || [];
                var msg = 'è§£ææˆåŠŸï¼\n';
                msg += 'åŒ…å«æˆæœ: ' + newAchievements.length + ' æ¡\n';
                msg += 'åŒ…å«æˆå‘˜: ' + newMembers.length + ' äºº\n\n';
                msg += 'ç‚¹å‡»â€œç¡®å®šâ€å°†åˆå¹¶å½“å‰æ•°æ®(ç›¸åŒIDè¦†ç›–)ï¼Œç‚¹å‡»â€œå–æ¶ˆâ€ç»ˆæ­¢ã€‚';

                if (confirm(msg)) {
                    // æ¢å¤é€»è¾‘ï¼šç›´æ¥è¦†ç›– (æˆ–è€…ä½ å¯ä»¥æ”¹ä¸ºåˆå¹¶é€»è¾‘)
                    // è¿™é‡Œé‡‡ç”¨åˆå¹¶é€»è¾‘ï¼šIDç›¸åŒçš„è¦†ç›–ï¼Œä¸åŒçš„æ·»åŠ 
                    
                    newMembers.forEach(function(nm) {
                        var idx = members.findIndex(function(m){ return m.id === nm.id; });
                        if (idx !== -1) members[idx] = nm;
                        else members.push(nm);
                    });

                    newAchievements.forEach(function(na) {
                        var idx = achievements.findIndex(function(a){ return a.id === na.id; });
                        if (idx !== -1) achievements[idx] = na;
                        else achievements.push(na);
                    });

                    saveToLocal();
                    updateStats();
                    renderResults();
                    closeBackupModal();
                    showToast('âœ“ æˆåŠŸæ¢å¤æ•°æ®', 'success');
                }
            } catch (err) {
                alert('æ¢å¤å¤±è´¥ï¼šæ–‡ä»¶å¯èƒ½å·²æŸåæˆ–æ ¼å¼é”™è¯¯ã€‚\n' + err.message);
            }
            // æ¸…ç©º input é˜²æ­¢æ— æ³•å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶
            document.getElementById('restoreInput').value = '';
        };
        reader.readAsText(file);
    }

    // --- End Backup Logic ---

    // Utility Functions
    function base64ToBlob(base64Data) {
        var arr = base64Data.split(',');
        var mime = arr[0].match(/:(.*?);/)[1];
        var bstr = atob(arr[1]);
        var n = bstr.length;
        var u8arr = new Uint8Array(n);
        while (n--) { u8arr[n] = bstr.charCodeAt(n); }
        return new Blob([u8arr], { type: mime });
    }

    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function handleFileSelect(event) {
        var file = event.target.files[0];
        if (!file) return;
        if (file.size > 20 * 1024 * 1024) {
            showToast('æ–‡ä»¶è¿‡å¤§ (>20MB)', 'error');
            return;
        }
        if (file.type !== 'application/pdf') {
            showToast('è¯·é€‰æ‹© PDF æ–‡ä»¶', 'error');
            return;
        }
        var reader = new FileReader();
        reader.onload = function(e) {
            currentPdfData = e.target.result;
            currentPdfName = file.name;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('fileUpload').classList.add('has-file');
        };
        reader.readAsDataURL(file);
    }

    function removeFile() {
        currentPdfData = null;
        currentPdfName = null;
        document.getElementById('pdfInput').value = '';
        document.getElementById('fileInfo').classList.add('hidden');
        document.getElementById('fileUpload').classList.remove('hidden');
        document.getElementById('fileUpload').classList.remove('has-file');
    }

    function viewPdf(id) {
        var item = achievements.find(function(a) { return String(a.id) === String(id); });
        if (item && item.pdfData) {
            try {
                var blob = base64ToBlob(item.pdfData);
                var url = URL.createObjectURL(blob);
                window.open(url);
            } catch (e) {
                showToast("æ‰“å¼€å¤±è´¥", "error");
            }
        }
    }

    function downloadPdf(id) {
        var item = achievements.find(function(a) { return String(a.id) === String(id); });
        if (item && item.pdfData) {
            var a = document.createElement('a');
            a.href = item.pdfData;
            a.download = item.pdfName || 'document.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    }

    // Sidebar Functions
    function toggleSidebar() {
        var sidebar = document.getElementById('sidebar');
        var overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
    }

    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('active');
    }

    function setView(view) {
        currentView = view;
        selectedItems.clear();
        updateBatchDeleteBtn();
        document.querySelectorAll('.nav-item').forEach(function(item) {
            item.classList.toggle('active', item.dataset.view === view);
        });

        var titles = { all: 'å…¨éƒ¨æˆæœ', paper: 'å­¦æœ¯è®ºæ–‡', patent: 'å‘æ˜ä¸“åˆ©', project: 'ç§‘ç ”é¡¹ç›®', award: 'è·å¥–æƒ…å†µ', book: 'ä¸“è‘—å‡ºç‰ˆ', member: 'æˆå‘˜ä¿¡æ¯' };
        document.getElementById('pageTitle').textContent = titles[view];
        document.getElementById('addBtnText').textContent = view === 'member' ? 'æ·»åŠ ' : 'æ·»åŠ ';

        closeSidebar();
        renderResults();
    }

    function setYearFilter(year) {
        currentYearFilter = year;
        document.querySelectorAll('.filter-chip').forEach(function(chip) {
            chip.classList.toggle('active', chip.dataset.year === year);
        });
        renderResults();
    }

    function setKeywordFilter(keyword) {
        if(currentKeywordFilter === keyword) currentKeywordFilter = null; 
        else currentKeywordFilter = keyword;
        document.querySelectorAll('.keyword-chip').forEach(function(chip) {
            chip.classList.toggle('active', chip.textContent.includes(keyword) && currentKeywordFilter !== null);
        });
        renderResults();
    }

    function handleSearch() {
        searchQuery = document.getElementById('searchInput').value.toLowerCase();
        renderResults();
    }

    function handleSort() {
        sortOrder = document.getElementById('sortSelect').value;
        renderResults();
    }

    function updateStats() {
        var counts = { paper: 0, patent: 0, project: 0, award: 0, book: 0 };
        var allKeywords = {};

        achievements.forEach(function(item) { 
            if (counts[item.type] !== undefined) counts[item.type]++; 
            if(item.keywords) {
                var kws = item.keywords.split(/[,ï¼Œ;ï¼›]/);
                kws.forEach(function(k) {
                    k = k.trim();
                    if(k) allKeywords[k] = (allKeywords[k] || 0) + 1;
                });
            }
        });

        document.getElementById('totalCount').textContent = achievements.length;
        document.getElementById('memberCount').textContent = members.length;
        document.getElementById('statMember').textContent = members.length;

        ['paper', 'patent', 'project', 'award', 'book'].forEach(function(t) {
            document.getElementById(t + 'Count').textContent = counts[t];
            document.getElementById('stat' + t.charAt(0).toUpperCase() + t.slice(1)).textContent = counts[t];
        });

        var years = [];
        achievements.forEach(function(a) {
            var dateStr = a.date || a.applicationDate || a.projectStartDate;
            if (dateStr) {
                var y = dateStr.substring(0, 4);
                if (years.indexOf(y) === -1) years.push(y);
            }
        });
        years.sort().reverse();

        var filterBar = document.getElementById('filterBar');
        var yearHtml = '<div class="filter-chip active" data-year="all" onclick="setYearFilter(\'all\')">å…¨éƒ¨</div>';
        years.forEach(function(year) {
            yearHtml += '<div class="filter-chip" data-year="' + year + '" onclick="setYearFilter(\'' + year + '\')">' + year + '</div>';
        });
        filterBar.innerHTML = yearHtml;

        var keywordBar = document.getElementById('keywordBar');
        if(Object.keys(allKeywords).length > 0) {
            keywordBar.style.display = 'flex';
            var sortedKeys = Object.keys(allKeywords).sort(function(a,b){return allKeywords[b]-allKeywords[a]}).slice(0, 8);
            var kwHtml = '<span style="font-size:0.75rem;color:var(--text-muted);">ğŸ·ï¸</span>';
            sortedKeys.forEach(function(k) {
                kwHtml += '<div class="keyword-chip" onclick="setKeywordFilter(\''+k+'\')">' + k + '</div>';
            });
            keywordBar.innerHTML = kwHtml;
        } else {
            keywordBar.style.display = 'none';
        }
    }

    function toggleSelectAll() {
        var checked = document.getElementById('selectAll').checked;
        var checkboxes = document.querySelectorAll('.result-checkbox');
        checkboxes.forEach(function(cb) {
            cb.checked = checked;
            var id = cb.dataset.id;
            if (checked) selectedItems.add(id); else selectedItems.delete(id);
        });
        updateBatchDeleteBtn();
    }

    function toggleItemSelect(id, event) {
        event.stopPropagation();
        if (selectedItems.has(id)) selectedItems.delete(id); else selectedItems.add(id);
        updateBatchDeleteBtn();
        updateSelectAllState();
    }

    function updateSelectAllState() {
        var checkboxes = document.querySelectorAll('.result-checkbox');
        var allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(function(cb) { return cb.checked; });
        document.getElementById('selectAll').checked = allChecked;
    }

    function updateBatchDeleteBtn() {
        var btn = document.getElementById('batchDeleteBtn');
        var count = selectedItems.size;
        document.getElementById('selectedCount').textContent = count;
        btn.style.display = count > 0 ? 'inline-flex' : 'none';
    }

    function batchDelete() {
        if (selectedItems.size === 0) return;
        deleteTargetIds = Array.from(selectedItems);
        deleteTargetType = currentView === 'member' ? 'member' : 'achievement';
        document.getElementById('confirmMessage').textContent = 'ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ' + selectedItems.size + ' æ¡è®°å½•å—ï¼Ÿ';
        document.getElementById('confirmModal').classList.add('active');
    }

    function promptDelete(id, type) {
        deleteTargetIds = [id];
        deleteTargetType = type;
        document.getElementById('confirmMessage').textContent = 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ';
        document.getElementById('confirmModal').classList.add('active');
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('active');
    }

    function confirmDelete() {
        if (deleteTargetType === 'member') {
            members = members.filter(function(m) { return deleteTargetIds.indexOf(m.id) === -1; });
        } else {
            achievements = achievements.filter(function(a) { return deleteTargetIds.indexOf(a.id) === -1; });
        }
        deleteTargetIds.forEach(function(id) { selectedItems.delete(id); });
        saveToLocal();
        updateStats();
        renderResults();
        updateBatchDeleteBtn();
        closeConfirmModal();
        showToast('âœ“ å·²åˆ é™¤', 'success');
    }

    function renderResults() {
        var container = document.getElementById('resultsList');
        if (currentView === 'member') { renderMembers(container); return; }

        var filtered = achievements.slice();
        if (currentView !== 'all') filtered = filtered.filter(function(a) { return a.type === currentView; });
        if (currentYearFilter !== 'all') {
            filtered = filtered.filter(function(a) {
                var d = a.date || a.applicationDate || a.projectStartDate || '';
                return d.indexOf(currentYearFilter) === 0;
            });
        }
        if (currentKeywordFilter) {
            filtered = filtered.filter(function(a) { return a.keywords && a.keywords.indexOf(currentKeywordFilter) !== -1; });
        }
        if (searchQuery) {
            filtered = filtered.filter(function(a) {
                var searchFields = [a.title, a.authors, a.keywords, a.patentName, a.inventors, a.patentNumber, a.projectName, a.projectNumber].join(' ').toLowerCase();
                return searchFields.indexOf(searchQuery) !== -1;
            });
        }

        filtered.sort(function(a, b) {
            var dateA = a.date || a.applicationDate || a.projectStartDate || '0';
            var dateB = b.date || b.applicationDate || b.projectStartDate || '0';
            if (sortOrder === 'date-desc') return dateB.localeCompare(dateA);
            if (sortOrder === 'date-asc') return dateA.localeCompare(dateB);
            if (sortOrder === 'title-asc') return (a.title || a.patentName || a.projectName || '').localeCompare(b.title || b.patentName || b.projectName || '', 'zh-CN');
            return 0;
        });

        document.getElementById('resultsCount').textContent = 'å…± ' + filtered.length + ' æ¡';

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state"><h3>æš‚æ— è®°å½•</h3><p>' + (searchQuery ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç»“æœ' : 'ç‚¹å‡»æ·»åŠ æŒ‰é’®å¼€å§‹å½•å…¥') + '</p></div>';
            return;
        }

        container.innerHTML = filtered.map(function(item) {
            var config = typeConfig[item.type] || typeConfig.paper;
            var displayTitle = item.type === 'patent' ? (item.patentName || item.title) : (item.type === 'project' ? (item.projectName || item.title) : item.title);
            var displayDate = item.type === 'patent' ? (item.applicationDate || item.date) : (item.type === 'project' ? item.projectStartDate : item.date);
            var displayAuthors = item.type === 'patent' ? item.inventors : item.authors;
            var isChecked = selectedItems.has(item.id) ? 'checked' : '';
            var metaHtml = '<span>ğŸ“… ' + (displayDate || '-') + '</span>';
            if (displayAuthors) metaHtml += '<span>ğŸ‘¤ ' + escapeHtml(displayAuthors.substring(0, 20)) + (displayAuthors.length > 20 ? '...' : '') + '</span>';

            if (item.type === 'patent' && item.patentStatus) {
                metaHtml += '<span>âš¡ ' + escapeHtml(item.patentStatus) + '</span>';
            } else if (item.type === 'project' && item.projectLevel) {
                metaHtml += '<span>â­ ' + escapeHtml(item.projectLevel) + '</span>';
            } else if (item.level) {
                metaHtml += '<span>â­ ' + escapeHtml(item.level) + '</span>';
            }
            if (item.pdfData) metaHtml += '<span class="has-pdf">ğŸ“</span>';

            return '<div class="result-item" onclick="editAchievement(\'' + item.id + '\')">' +
                '<input type="checkbox" class="result-checkbox" data-id="' + item.id + '" ' + isChecked + ' onclick="toggleItemSelect(\'' + item.id + '\', event)">' +
                '<div class="result-type ' + config.class + '">' + config.icon + '</div>' +
                '<div class="result-content">' +
                '<div class="result-title">' + escapeHtml(displayTitle) + '</div>' +
                '<div class="result-meta">' + metaHtml + '</div></div>' +
                '<div class="result-actions">' +
                '<button class="action-btn delete" onclick="event.stopPropagation(); promptDelete(\'' + item.id + '\', \'achievement\')" title="åˆ é™¤">ğŸ—‘</button>' +
                '</div></div>';
        }).join('');
    }

    function renderMembers(container) {
        var filtered = members.slice();
        if (searchQuery) {
            filtered = filtered.filter(function(m) {
                var searchFields = [m.memberNo, m.memberName, m.memberOrg, m.memberEmail, m.memberTitle].join(' ').toLowerCase();
                return searchFields.indexOf(searchQuery) !== -1;
            });
        }
        document.getElementById('resultsCount').textContent = 'å…± ' + filtered.length + ' æ¡';
        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state"><h3>æš‚æ— æˆå‘˜</h3><p>' + (searchQuery ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç»“æœ' : 'ç‚¹å‡»æ·»åŠ æŒ‰é’®å¼€å§‹å½•å…¥') + '</p></div>';
            return;
        }
        container.innerHTML = filtered.map(function(m) {
            var isChecked = selectedItems.has(m.id) ? 'checked' : '';
            var metaHtml = '';
            if (m.memberNo) metaHtml += '<span>ğŸ”¢ ' + escapeHtml(m.memberNo) + '</span>';
            if (m.memberOrg) metaHtml += '<span>ğŸ¢ ' + escapeHtml(m.memberOrg.substring(0, 15)) + '</span>';
            if (m.memberTitle) metaHtml += '<span>ğŸ‘” ' + escapeHtml(m.memberTitle) + '</span>';

            return '<div class="result-item" onclick="editMember(\'' + m.id + '\')">' +
                '<input type="checkbox" class="result-checkbox" data-id="' + m.id + '" ' + isChecked + ' onclick="toggleItemSelect(\'' + m.id + '\', event)">' +
                '<div class="result-type type-member">ğŸ‘¤</div>' +
                '<div class="result-content">' +
                '<div class="result-title">' + escapeHtml(m.memberName) + (m.memberGender ? ' (' + m.memberGender + ')' : '') + '</div>' +
                '<div class="result-meta">' + metaHtml + '</div></div>' +
                '<div class="result-actions">' +
                '<button class="action-btn delete" onclick="event.stopPropagation(); promptDelete(\'' + m.id + '\', \'member\')" title="åˆ é™¤">ğŸ—‘</button>' +
                '</div></div>';
        }).join('');
    }

    function toggleFormFields() {
        var type = document.getElementById('type').value;
        var isPatent = type === 'patent';
        var isProject = type === 'project';
        document.getElementById('patentFields').classList.toggle('hidden', !isPatent);
        document.getElementById('projectFields').classList.toggle('hidden', !isProject);
        document.getElementById('generalFields').classList.toggle('hidden', isPatent || isProject);
        document.getElementById('dateGroup').classList.toggle('hidden', isPatent || isProject);
    }

    // Modal Functions
    function openAddModal() {
        if (currentView === 'member') { openMemberModal(); return; }
        document.getElementById('modalTitle').textContent = 'æ·»åŠ ç§‘ç ”æˆæœ';
        document.getElementById('submitBtn').textContent = 'ä¿å­˜';
        document.getElementById('researchForm').reset();
        document.getElementById('editId').value = '';
        document.getElementById('date').valueAsDate = new Date();
        if (currentView !== 'all' && currentView !== 'member') { document.getElementById('type').value = currentView; } 
        else { document.getElementById('type').value = ''; }
        toggleFormFields();
        removeFile();
        document.getElementById('formModal').classList.add('active');
    }

    function editAchievement(id) {
        var item = achievements.find(function(a) { return String(a.id) === String(id); });
        if (!item) return;
        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç§‘ç ”æˆæœ';
        document.getElementById('submitBtn').textContent = 'æ›´æ–°';
        document.getElementById('editId').value = id;
        document.getElementById('type').value = item.type || '';
        toggleFormFields();

        if (item.type === 'patent') {
            document.getElementById('patentName').value = item.patentName || '';
            document.getElementById('patentType').value = item.patentType || '';
            document.getElementById('inventors').value = item.inventors || '';
            document.getElementById('patentOwner').value = item.patentOwner || '';
            document.getElementById('applicationDate').value = item.applicationDate || '';
            document.getElementById('grantDate').value = item.grantDate || '';
            document.getElementById('patentNumber').value = item.patentNumber || '';
            document.getElementById('patentStatus').value = item.patentStatus || '';
        } else if (item.type === 'project') {
            document.getElementById('projectName').value = item.projectName || item.title || '';
            document.getElementById('projectLevel').value = item.projectLevel || item.level || '';
            document.getElementById('projectNumber').value = item.projectNumber || '';
            document.getElementById('projectStartDate').value = item.projectStartDate || item.date || '';
            document.getElementById('projectEndDate').value = item.projectEndDate || '';
            document.getElementById('projectOrg').value = item.projectOrg || '';
        } else {
            document.getElementById('date').value = item.date || '';
            document.getElementById('title').value = item.title || '';
            document.getElementById('authors').value = item.authors || '';
            document.getElementById('source').value = item.source || '';
            document.getElementById('level').value = item.level || '';
            document.getElementById('keywords').value = item.keywords || '';
        }
        removeFile();
        if (item.pdfData) {
            currentPdfData = item.pdfData;
            currentPdfName = item.pdfName;
            document.getElementById('fileName').textContent = item.pdfName || 'document.pdf';
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('fileUpload').classList.add('has-file');
        }
        document.getElementById('formModal').classList.add('active');
    }

    function closeModal() { document.getElementById('formModal').classList.remove('active'); }

    function handleSubmit(event) {
        event.preventDefault();
        var editId = document.getElementById('editId').value;
        var type = document.getElementById('type').value;
        var data = {
            id: editId || Date.now().toString() + Math.random().toString(36).substr(2, 9),
            type: type,
            pdfData: currentPdfData,
            pdfName: currentPdfName,
            updatedAt: new Date().toISOString()
        };

        if (type === 'patent') {
            data.patentName = document.getElementById('patentName').value;
            data.patentType = document.getElementById('patentType').value;
            data.inventors = document.getElementById('inventors').value;
            data.patentOwner = document.getElementById('patentOwner').value;
            data.applicationDate = document.getElementById('applicationDate').value;
            data.grantDate = document.getElementById('grantDate').value;
            data.patentNumber = document.getElementById('patentNumber').value;
            data.patentStatus = document.getElementById('patentStatus').value;
            data.title = data.patentName;
            data.date = data.applicationDate;
        } else if (type === 'project') {
            data.projectName = document.getElementById('projectName').value;
            data.projectLevel = document.getElementById('projectLevel').value;
            data.projectNumber = document.getElementById('projectNumber').value;
            data.projectStartDate = document.getElementById('projectStartDate').value;
            data.projectEndDate = document.getElementById('projectEndDate').value;
            data.projectOrg = document.getElementById('projectOrg').value;
            data.title = data.projectName;
            data.date = data.projectStartDate;
        } else {
            data.date = document.getElementById('date').value;
            data.title = document.getElementById('title').value;
            data.authors = document.getElementById('authors').value;
            data.source = document.getElementById('source').value;
            data.level = document.getElementById('level').value;
            data.keywords = document.getElementById('keywords').value;
        }

        if (editId) {
            var index = achievements.findIndex(function(a) { return String(a.id) === String(editId); });
            if (index !== -1) {
                achievements[index] = Object.assign(achievements[index], data);
                showToast('âœ“ å·²æ›´æ–°', 'success');
            }
        } else {
            data.createdAt = new Date().toISOString();
            achievements.push(data);
            showToast('âœ“ å·²æ·»åŠ ', 'success');
        }
        saveToLocal();
        closeModal();
        updateStats();
        renderResults();
    }

    function openMemberModal() {
        document.getElementById('memberModalTitle').textContent = 'æ·»åŠ æˆå‘˜';
        document.getElementById('memberForm').reset();
        document.getElementById('memberEditId').value = '';
        document.getElementById('memberModal').classList.add('active');
    }

    function editMember(id) {
        var m = members.find(function(item) { return String(item.id) === String(id); });
        if (!m) return;
        document.getElementById('memberModalTitle').textContent = 'ç¼–è¾‘æˆå‘˜';
        document.getElementById('memberEditId').value = id;
        
        var fields = ['memberNo', 'memberName', 'memberGender', 'memberBirth', 'memberIdType', 'memberIdNo',
            'memberNation', 'memberCountry', 'memberOrg', 'memberTitle', 'memberIsStudent', 'memberDegree',
            'memberEmail', 'memberPhone'];
        fields.forEach(function(f) {
            var el = document.getElementById(f);
            if (el) el.value = m[f] || '';
        });
        document.getElementById('memberModal').classList.add('active');
    }

    function closeMemberModal() { document.getElementById('memberModal').classList.remove('active'); }

    function handleMemberSubmit(event) {
        event.preventDefault();
        var editId = document.getElementById('memberEditId').value;
        var fields = ['memberNo', 'memberName', 'memberGender', 'memberBirth', 'memberIdType', 'memberIdNo',
            'memberNation', 'memberCountry', 'memberOrg', 'memberTitle', 'memberIsStudent', 'memberDegree',
            'memberEmail', 'memberPhone'];
        var data = {
            id: editId || Date.now().toString() + Math.random().toString(36).substr(2, 9),
            updatedAt: new Date().toISOString()
        };
        fields.forEach(function(f) {
            var el = document.getElementById(f);
            if (el) data[f] = el.value;
        });

        if (editId) {
            var index = members.findIndex(function(m) { return String(m.id) === String(editId); });
            if (index !== -1) {
                members[index] = Object.assign(members[index], data);
                showToast('âœ“ å·²æ›´æ–°', 'success');
            }
        } else {
            data.createdAt = new Date().toISOString();
            members.push(data);
            showToast('âœ“ å·²æ·»åŠ ', 'success');
        }
        saveToLocal();
        closeMemberModal();
        updateStats();
        renderResults();
    }

    function exportData() {
        var data = {
            version: '4.0',
            exportDate: new Date().toISOString(),
            achievements: achievements,
            members: members
        };
        var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'research_data_backup_' + new Date().toISOString().slice(0, 10) + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast('âœ“ å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½', 'success');
        closeAllMenus();
    }

    function exportToWordFile() {
        var content = '';
        var title = '';
        
        if (currentView === 'member') {
            title = 'å›¢é˜Ÿæˆå‘˜åå•';
            content += '<h1>' + title + '</h1><table border="1" style="border-collapse:collapse;width:100%">';
            content += '<tr><th>å­¦å·/å·¥å·</th><th>å§“å</th><th>æ€§åˆ«</th><th>èŒç§°</th><th>å•ä½</th><th>é‚®ç®±</th></tr>';
            members.forEach(function(m) {
                content += '<tr><td>' + (m.memberNo || '') + '</td><td>' + (m.memberName || '') + '</td><td>' + (m.memberGender || '') + '</td><td>' + (m.memberTitle || '') + '</td><td>' + (m.memberOrg || '') + '</td><td>' + (m.memberEmail || '') + '</td></tr>';
            });
            content += '</table>';
        } else {
            var typeName = { all: 'å…¨éƒ¨æˆæœ', paper: 'å­¦æœ¯è®ºæ–‡', patent: 'å‘æ˜ä¸“åˆ©', project: 'ç§‘ç ”é¡¹ç›®', award: 'è·å¥–æƒ…å†µ', book: 'ä¸“è‘—å‡ºç‰ˆ' };
            title = typeName[currentView] || 'ç§‘ç ”æˆæœåˆ—è¡¨';
            
            var filtered = achievements;
            if (currentView !== 'all') filtered = filtered.filter(function(a) { return a.type === currentView; });
            
            content += '<h1>' + title + '</h1>';
            filtered.forEach(function(item, index) {
                var itemTitle = item.title || item.patentName || item.projectName;
                var itemDate = item.date || item.applicationDate || item.projectStartDate;
                var itemAuth = item.authors || item.inventors || item.projectOrg;
                
                content += '<p><strong>' + (index + 1) + '. ' + escapeHtml(itemTitle) + '</strong><br>';
                content += 'æ—¥æœŸ: ' + (itemDate || '-') + ' | äººå‘˜: ' + (itemAuth || '-') + '<br>';
                if (item.source) content += 'æ¥æº: ' + escapeHtml(item.source) + '<br>';
                if (item.level) content += 'çº§åˆ«: ' + escapeHtml(item.level) + '<br>';
                if (item.patentNumber) content += 'ä¸“åˆ©å·: ' + escapeHtml(item.patentNumber) + '<br>';
                content += '</p><hr>';
            });
        }

        var header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>" + title + "</title></head><body>";
        var footer = "</body></html>";
        var sourceHTML = header + content + footer;

        var blob = new Blob(['\ufeff', sourceHTML], { type: 'application/msword' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = title + '_' + new Date().toISOString().slice(0, 10) + '.doc';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast('âœ“ Word å¯¼å‡ºæˆåŠŸ', 'success');
        closeAllMenus();
    }

    function exportToExcelFile() {
        if (!typeof XLSX) { showToast('Excel ç»„ä»¶æœªåŠ è½½', 'error'); return; }
        
        var dataToExport = [];
        var sheetName = '';

        if (currentView === 'member') {
            sheetName = 'å›¢é˜Ÿæˆå‘˜';
            dataToExport = members.map(function(m) {
                return {
                    'å­¦å·/å·¥å·': m.memberNo,
                    'å§“å': m.memberName,
                    'æ€§åˆ«': m.memberGender,
                    'å‡ºç”Ÿå¹´æœˆ': m.memberBirth,
                    'è¯ä»¶ç±»å‹': m.memberIdType,
                    'è¯ä»¶å·ç ': m.memberIdNo,
                    'æ°‘æ—': m.memberNation,
                    'å›½åˆ«': m.memberCountry,
                    'å•ä½': m.memberOrg,
                    'èŒç§°': m.memberTitle,
                    'æ˜¯å¦åœ¨è¯»': m.memberIsStudent,
                    'æœ€é«˜å­¦ä½': m.memberDegree,
                    'é‚®ç®±': m.memberEmail,
                    'æ‰‹æœº': m.memberPhone
                };
            });
        } else {
            var filtered = achievements;
            if (currentView !== 'all') filtered = filtered.filter(function(a) { return a.type === currentView; });
            sheetName = 'ç§‘ç ”æˆæœ';
            
            dataToExport = filtered.map(function(a) {
                var base = { 'ç±»å‹': typeConfig[a.type]?.label || a.type };
                if (a.type === 'patent') {
                    Object.assign(base, {
                        'ä¸“åˆ©åç§°': a.patentName, 'ä¸“åˆ©ç±»å‹': a.patentType, 'å‘æ˜äºº': a.inventors,
                        'ä¸“åˆ©æƒäºº': a.patentOwner, 'ç”³è¯·æ—¥': a.applicationDate, 'æˆæƒæ—¥': a.grantDate,
                        'ä¸“åˆ©å·': a.patentNumber, 'çŠ¶æ€': a.patentStatus
                    });
                } else if (a.type === 'project') {
                    Object.assign(base, {
                        'é¡¹ç›®åç§°': a.projectName, 'çº§åˆ«': a.projectLevel, 'ç¼–å·': a.projectNumber,
                        'å¼€å§‹æ—¶é—´': a.projectStartDate, 'ç»“æŸæ—¶é—´': a.projectEndDate, 'æ‰€å±å•ä½': a.projectOrg
                    });
                } else {
                    Object.assign(base, {
                        'æ ‡é¢˜': a.title, 'ä½œè€…': a.authors, 'æ—¥æœŸ': a.date,
                        'æ¥æº': a.source, 'çº§åˆ«': a.level, 'å…³é”®è¯': a.keywords
                    });
                }
                return base;
            });
        }

        if (dataToExport.length === 0) { showToast('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'warning'); return; }

        var wb = XLSX.utils.book_new();
        var ws = XLSX.utils.json_to_sheet(dataToExport);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        XLSX.writeFile(wb, (sheetName) + '_' + new Date().toISOString().slice(0, 10) + '.xlsx');
        
        showToast('âœ“ Excel å¯¼å‡ºæˆåŠŸ', 'success');
        closeAllMenus();
    }

    // Import Functions
    function triggerImport() {
        document.getElementById('importInput').click();
        closeAllMenus();
    }

    function importData(event) {
        var file = event.target.files[0];
        if (!file) return;

        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = JSON.parse(e.target.result);
                if (data.achievements || data.members) {
                    if (confirm('å¯¼å…¥å°†åˆå¹¶ç°æœ‰æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                        // Merge logic: Add if ID doesn't exist
                        var newAchievements = data.achievements || [];
                        var newMembers = data.members || [];
                        
                        var addedCount = 0;
                        newAchievements.forEach(function(item) {
                            if (!achievements.some(function(exist) { return exist.id === item.id; })) {
                                achievements.push(item);
                                addedCount++;
                            }
                        });
                        
                        newMembers.forEach(function(item) {
                            if (!members.some(function(exist) { return exist.id === item.id; })) {
                                members.push(item);
                                addedCount++;
                            }
                        });

                        saveToLocal();
                        updateStats();
                        renderResults();
                        showToast('âœ“ æˆåŠŸå¯¼å…¥ ' + addedCount + ' æ¡æ–°æ•°æ®', 'success');
                    }
                } else {
                    showToast('æ•°æ®æ ¼å¼é”™è¯¯', 'error');
                }
            } catch (err) {
                showToast('æ–‡ä»¶è§£æå¤±è´¥', 'error');
            }
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset input
    }

    // Excel Import Logic
    function openExcelImport() {
        document.getElementById('excelModal').classList.add('active');
        document.getElementById('excelInput').value = '';
        document.getElementById('excelPreviewContainer').classList.add('hidden');
        document.getElementById('mappingContainer').classList.add('hidden');
        document.getElementById('importExcelBtn').disabled = true;
        document.getElementById('duplicateWarning').classList.add('hidden');
        excelData = null;
        closeAllMenus();
    }

    function closeExcelModal() {
        document.getElementById('excelModal').classList.remove('active');
    }

    function handleExcelSelect(event) {
        var file = event.target.files[0];
        if (!file) return;

        var reader = new FileReader();
        reader.onload = function(e) {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, { type: 'array' });
            var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            excelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            if (excelData.length > 0) {
                excelHeaders = excelData[0];
                renderExcelPreview();
                updateMappingFields();
                document.getElementById('excelPreviewContainer').classList.remove('hidden');
                document.getElementById('mappingContainer').classList.remove('hidden');
                document.getElementById('importExcelBtn').disabled = false;
            } else {
                showToast('Excel æ–‡ä»¶ä¸ºç©º', 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function renderExcelPreview() {
        var html = '<table><thead><tr>';
        excelHeaders.forEach(function(h) { html += '<th>' + escapeHtml(h) + '</th>'; });
        html += '</tr></thead><tbody>';
        
        // Show first 5 rows
        for (var i = 1; i < Math.min(excelData.length, 6); i++) {
            html += '<tr>';
            var row = excelData[i];
            excelHeaders.forEach(function(_, idx) {
                html += '<td>' + escapeHtml(row[idx] || '') + '</td>';
            });
            html += '</tr>';
        }
        html += '</tbody></table>';
        document.getElementById('excelPreview').innerHTML = html;
    }

    function updateMappingFields() {
        var type = document.getElementById('excelImportType').value;
        var fields = fieldMappings[type] || [];
        var container = document.getElementById('mappingFields');
        var html = '';

        fields.forEach(function(field) {
            html += '<div class="mapping-row">';
            html += '<label>' + field.label + (field.required ? ' *' : '') + '</label>';
            html += '<select class="field-map-select" data-key="' + field.key + '" data-required="' + field.required + '">';
            html += '<option value="">(ä¸å¯¼å…¥)</option>';
            
            // Auto match logic
            excelHeaders.forEach(function(header, idx) {
                var selected = '';
                // Simple fuzzy match
                if (header.indexOf(field.label) !== -1 || field.label.indexOf(header) !== -1) {
                    selected = 'selected';
                }
                html += '<option value="' + idx + '" ' + selected + '>' + escapeHtml(header) + '</option>';
            });
            
            html += '</select></div>';
        });
        container.innerHTML = html;
    }

    function confirmExcelImport() {
        var type = document.getElementById('excelImportType').value;
        var selects = document.querySelectorAll('.field-map-select');
        var mapConfig = {};
        var hasError = false;

        selects.forEach(function(sel) {
            var key = sel.dataset.key;
            var idx = sel.value;
            if (sel.dataset.required === 'true' && idx === '') {
                showToast('è¯·æ˜ å°„å¿…å¡«å­—æ®µ', 'error');
                sel.style.borderColor = 'var(--danger)';
                hasError = true;
            } else {
                sel.style.borderColor = 'var(--border)';
                if (idx !== '') mapConfig[key] = parseInt(idx);
            }
        });

        if (hasError) return;

        var importCount = 0;
        var duplicateCount = 0;
        var duplicates = [];

        // Process data (skip header row 0)
        for (var i = 1; i < excelData.length; i++) {
            var row = excelData[i];
            if (!row || row.length === 0) continue;

            var item = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                createdAt: new Date().toISOString()
            };

            if (type !== 'member') {
                item.type = type;
            }

            // Map fields
            for (var key in mapConfig) {
                var colIdx = mapConfig[key];
                var val = row[colIdx];
                
                // Handle dates if Excel parsed them as numbers (basic approximation)
                if (typeof val === 'number' && key.toLowerCase().includes('date') && val > 20000) {
                    var dateObj = new Date((val - (25567 + 2)) * 86400 * 1000);
                    val = dateObj.toISOString().slice(0, 10);
                }
                
                item[key] = val !== undefined ? String(val).trim() : '';
            }

            // Check uniqueness (simple check based on title/name/number)
            var isDuplicate = false;
            if (type === 'member') {
                isDuplicate = members.some(function(m) { return m.memberNo === item.memberNo; });
                if (!isDuplicate) {
                    members.push(item);
                    importCount++;
                } else {
                    duplicates.push(item.memberName + ' (' + item.memberNo + ')');
                    duplicateCount++;
                }
            } else {
                var uniqueKey = type === 'patent' ? 'patentName' : (type === 'project' ? 'projectName' : 'title');
                isDuplicate = achievements.some(function(a) { 
                    return a[uniqueKey] === item[uniqueKey] && a.type === type; 
                });
                
                if (!isDuplicate) {
                    achievements.push(item);
                    importCount++;
                } else {
                    duplicates.push(item[uniqueKey]);
                    duplicateCount++;
                }
            }
        }

        saveToLocal();
        updateStats();
        renderResults();

        if (duplicateCount > 0) {
            var warnList = document.getElementById('duplicateList');
            warnList.innerHTML = duplicates.map(function(d) { return '<li>' + escapeHtml(d) + '</li>'; }).join('');
            document.getElementById('duplicateWarning').classList.remove('hidden');
            showToast('å¯¼å…¥æˆåŠŸ ' + importCount + ' æ¡ï¼Œè·³è¿‡ ' + duplicateCount + ' æ¡é‡å¤', 'warning');
        } else {
            closeExcelModal();
            showToast('âœ“ æˆåŠŸå¯¼å…¥ ' + importCount + ' æ¡æ•°æ®', 'success');
        }
    }

    // Toast Notification
    function showToast(message, type) {
        var container = document.getElementById('toastContainer');
        var toast = document.createElement('div');
        toast.className = 'toast ' + type;
        toast.textContent = message;
        
        container.appendChild(toast);
        
        // Trigger animation
        requestAnimationFrame(function() {
            toast.classList.add('show');
        });

        setTimeout(function() {
            toast.classList.remove('show');
            setTimeout(function() {
                container.removeChild(toast);
            }, 300);
        }, 3000);
    }

    // Menu Functions
    function toggleMenu(id) {
        var menu = document.getElementById(id);
        var isVisible = menu.classList.contains('show');
        closeAllMenus();
        if (!isVisible) menu.classList.add('show');
    }

    function closeAllMenus() {
        document.querySelectorAll('.dropdown-menu').forEach(function(m) { m.classList.remove('show'); });
    }

    document.addEventListener('click', function(event) {
        if (!event.target.closest('.data-actions') && !event.target.closest('.dropdown-menu')) {
            closeAllMenus();
        }
    });

    // Initialize
    window.onload = function() {
        // Try load from IndexedDB
        loadFromLocal().then(function(loaded) {
            if (!loaded) {
                // If DB empty/error, initialize empty
                console.log("Initialize empty DB");
            }
            updateStats();
            renderResults();
            document.getElementById('loadingSpinner')?.remove();
        });

        // Initialize file drag and drop for upload
        var dropZone = document.getElementById('fileUpload');
        if (dropZone) {
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--accent)';
                dropZone.style.background = 'var(--accent-light)';
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--border)';
                dropZone.style.background = 'transparent';
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--border)';
                dropZone.style.background = 'transparent';
                
                if (e.dataTransfer.files.length) {
                    document.getElementById('pdfInput').files = e.dataTransfer.files;
                    handleFileSelect({ target: { files: e.dataTransfer.files } });
                }
            });
        }
    };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ V5.0 (Pro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ================= åŸæœ‰æ ·å¼ä¿æŒä¸å˜ ================= */
        :root {
            --bg-primary: #f8fafc; --bg-secondary: #ffffff; --bg-card: #ffffff; --bg-hover: #f1f5f9;
            --text-primary: #1e293b; --text-secondary: #64748b; --text-muted: #94a3b8;
            --border: #e2e8f0; --border-light: #f1f5f9;
            --accent: #6366f1; --accent-light: #eef2ff; --accent-dark: #4f46e5;
            --success: #10b981; --success-light: #d1fae5;
            --warning: #f59e0b; --warning-light: #fef3c7;
            --danger: #ef4444; --danger-light: #fee2e2;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.1);
            --radius: 12px; --radius-sm: 8px;
            --od-blue: #0078D4; --od-hover: #005a9e; --od-light: #f3f9fd;
        }

        html.dark {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #1e293b; --bg-hover: #334155;
            --text-primary: #f1f5f9; --text-secondary: #94a3b8; --text-muted: #64748b;
            --border: #334155; --border-light: #1e293b;
            --accent-light: #312e81; --success-light: #064e3b; --warning-light: #78350f;
            --danger-light: #7f1d1d; --od-light: #002c4e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans SC', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .app-container { display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar & Layout */
        .sidebar { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; height: 100%; z-index: 100; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }
        .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
        .nav-menu { flex: 1; padding: 16px 12px; overflow-y: auto; }
        .nav-section { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 12px 12px 8px; margin-top: 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary); font-weight: 500; transition: all 0.2s; margin-bottom: 4px; min-height: 48px; }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-light); color: var(--accent); }
        .nav-item .badge { margin-left: auto; background: var(--bg-hover); padding: 2px 10px; border-radius: 10px; font-size: 0.8rem; font-weight: 600; }
        .nav-item.active .badge { background: var(--accent); color: white; }
        
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); position: relative; }
        .storage-status { font-size: 0.85rem; color: var(--success); margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        .storage-status.warning { color: var(--warning); }
        .data-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .data-btn { padding: 10px 8px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text-secondary); font-size: 0.85rem; cursor: pointer; transition: all 0.2s; text-align: center; min-height: 44px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .data-btn:hover { background: var(--bg-hover); border-color: var(--accent); color: var(--accent); }
        .data-btn.onedrive { border-color: var(--od-blue); color: var(--od-blue); }
        .dropdown-menu { position: absolute; bottom: 100%; left: 10px; right: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: var(--shadow-lg); display: none; z-index: 200; overflow: hidden; margin-bottom: 8px; }
        .dropdown-menu.show { display: block; animation: slideUp 0.2s ease-out; }
        .menu-item { padding: 14px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; border-bottom: 1px solid var(--border-light); }
        .menu-item:hover { background: var(--bg-hover); color: var(--accent); }

        /* Main Content */
        .main-content { flex: 1; padding: 20px; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0; gap: 12px; flex-wrap: wrap; }
        .page-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; flex: 1; justify-content: flex-end; }
        .search-box { flex: 1; min-width: 200px; max-width: 320px; }
        .search-box input { padding: 12px 16px; border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg-card); color: var(--text-primary); width: 100%; transition: all 0.2s; }
        .btn { padding: 12px 20px; border-radius: var(--radius); font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; min-height: 48px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; box-shadow: var(--shadow); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; min-height: 36px; }
        .btn-od { background: var(--od-blue); color: white; border: none; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px; flex-shrink: 0; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; cursor: pointer; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); border-color: var(--accent); }
        .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .stat-icon.papers { background: #dbeafe; } .stat-icon.patents { background: #fef3c7; } .stat-icon.projects { background: #d1fae5; } 
        .stat-icon.awards { background: #fce7f3; } .stat-icon.books { background: #e0e7ff; } .stat-icon.members { background: #f3e8ff; }
        
        /* List & Results */
        #listViewContainer { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .filter-container { margin-bottom: 12px; flex-shrink: 0; }
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; }
        .filter-chip { padding: 6px 14px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.85rem; cursor: pointer; }
        .filter-chip.active { background: var(--accent); border-color: var(--accent); color: white; }
        
        .results-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .results-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); flex-shrink: 0; }
        .results-list { flex: 1; overflow-y: auto; }
        .result-item { display: flex; align-items: flex-start; padding: 12px 16px; border-bottom: 1px solid var(--border-light); cursor: pointer; transition: background 0.2s; gap: 12px; min-height: 72px; }
        .result-item:hover { background: var(--bg-hover); }
        .result-type { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .type-paper { background: #dbeafe; } .type-patent { background: #fef3c7; } .type-project { background: #d1fae5; }
        .type-award { background: #fce7f3; } .type-book { background: #e0e7ff; } .type-member { background: #f3e8ff; }
        .result-content { flex: 1; min-width: 0; }
        .result-title { font-weight: 600; color: var(--text-primary); font-size: 0.95rem; margin-bottom: 6px; }
        .result-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.8rem; color: var(--text-secondary); }
        .result-actions { display: flex; gap: 6px; align-items: center; }
        .action-btn { width: 36px; height: 36px; border: none; background: var(--bg-hover); border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        
        /* Modals & Forms */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border-radius: var(--radius); width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal.wide { max-width: 800px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary); font-size: 16px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        
        /* File Upload */
        .file-upload { border: 2px dashed var(--border); border-radius: var(--radius); padding: 30px; text-align: center; cursor: pointer; }
        .file-upload.has-file { display: none; }
        .file-info { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--accent-light); border-radius: var(--radius-sm); border: 1px solid var(--accent); }
        
        /* Login & Toasts */
        .login-overlay { position: fixed; inset: 0; background: var(--bg-primary); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .login-box { background: var(--bg-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border); }
        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; }
        .toast { padding: 14px 20px; border-radius: var(--radius-sm); background: var(--bg-card); border: 1px solid var(--border); box-shadow: var(--shadow-lg); transform: translateY(-120%); transition: transform 0.3s; text-align: center; }
        .toast.show { transform: translateY(0); }
        .toast.success { background: var(--success-light); border-color: var(--success); color: #064e3b; }
        .toast.error { background: var(--danger-light); border-color: var(--danger); color: #7f1d1d; }

        /* Excel Mapping */
        .excel-preview { max-height: 200px; overflow: auto; border: 1px solid var(--border); border-radius: var(--radius-sm); }
        .excel-preview table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .excel-preview th, .excel-preview td { padding: 10px 12px; border: 1px solid var(--border); text-align: left; white-space: nowrap; }
        .mapping-row { display: grid; grid-template-columns: 140px 1fr; gap: 12px; align-items: center; margin-bottom: 12px; }

        /* ================= V5.0 æ–°å¢åŠŸèƒ½æ ·å¼ ================= */

        /* 1. æ ‡ç­¾ Tag ç³»ç»Ÿ */
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); display: flex; align-items: center; gap: 4px; }
        .tag.active { background: var(--accent-light); color: var(--accent); border-color: var(--accent); }
        
        /* 2. åˆ†é¡µæ§ä»¶ */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 12px; border-top: 1px solid var(--border); flex-shrink: 0; background: var(--bg-secondary); }
        .page-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; transition: all 0.2s; }
        .page-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 0.9rem; color: var(--text-secondary); }

        /* 3. å¼•ç”¨ç”Ÿæˆæ¡† */
        .citation-box { background: var(--bg-hover); padding: 10px; border-radius: var(--radius-sm); margin-top: 10px; font-family: 'Courier New', monospace; font-size: 0.85rem; border: 1px dashed var(--border); position: relative; word-break: break-all; }
        .citation-copy { position: absolute; right: 5px; top: 5px; padding: 4px 8px; font-size: 0.7rem; cursor: pointer; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; }

        /* 4. æ“ä½œæ—¥å¿—ä¸å›æ”¶ç«™ */
        .log-item { padding: 10px; border-bottom: 1px solid var(--border-light); font-size: 0.85rem; display: flex; gap: 10px; flex-wrap: wrap; }
        .log-time { color: var(--text-muted); min-width: 140px; }
        .log-action { font-weight: 600; color: var(--text-primary); }
        .log-detail { color: var(--text-secondary); flex: 1; word-break: break-all; }
        .deleted-item { opacity: 0.7; background: var(--danger-light) !important; }

        /* 5. æ™ºèƒ½æå–æŒ‰é’® */
        .smart-btn { position: absolute; right: 26px; top: 41px; padding: 6px 12px; font-size: 0.8rem; background: var(--accent-light); color: var(--accent); border: none; border-radius: 4px; cursor: pointer; font-weight: 600; z-index: 10; }
        .smart-btn:hover { background: var(--accent); color: white; }
        .input-wrapper { position: relative; }

        /* 6. é«˜çº§æœç´¢é¢æ¿ */
        .adv-search-panel { background: var(--bg-hover); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 12px; border: 1px solid var(--border); display: none; }
        .adv-search-panel.active { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); width: 85%; max-width: 320px; }
            .sidebar.open { transform: translateX(0); }
            .header { flex-direction: column; align-items: stretch; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-overlay">
    <div class="login-box">
        <div class="logo-icon" style="margin: 0 auto 20px auto;">ğŸ”¬</div>
        <div class="login-title" style="font-size:1.8rem; font-weight:700; color:var(--accent); margin-bottom:20px;">ç§‘ç ”ç®¡ç†ç³»ç»Ÿ V5.0</div>
        <div class="form-group">
            <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ..." onkeyup="if(event.key==='Enter') checkLogin()">
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="checkLogin()">ç™»å½•</button>
        <div style="margin-top:15px; font-size:0.8rem; color:var(--text-muted);">ç®¡ç†å‘˜: 1399 | å®¾å®¢: guest</div>
    </div>
</div>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">ğŸ”¬</div>
                <div>
                    <div>ç§‘ç ”ç®¡ç† Pro</div>
                    <div style="font-size:0.7rem;color:var(--text-muted);">V5.0 æ™ºèƒ½å¢å¼ºç‰ˆ</div>
                </div>
            </div>
        </div>

        <nav class="nav-menu">
            <div class="nav-section">æˆæœç®¡ç†</div>
            <div class="nav-item active" data-view="all" onclick="setView('all')">ğŸ“‹ <span>å…¨éƒ¨æˆæœ</span><span class="badge" id="totalCount">0</span></div>
            <div class="nav-item" data-view="paper" onclick="setView('paper')">ğŸ“„ <span>å­¦æœ¯è®ºæ–‡</span><span class="badge" id="paperCount">0</span></div>
            <div class="nav-item" data-view="patent" onclick="setView('patent')">ğŸ’¡ <span>å‘æ˜ä¸“åˆ©</span><span class="badge" id="patentCount">0</span></div>
            <div class="nav-item" data-view="project" onclick="setView('project')">ğŸ“Š <span>ç§‘ç ”é¡¹ç›®</span><span class="badge" id="projectCount">0</span></div>
            <div class="nav-item" data-view="award" onclick="setView('award')">ğŸ† <span>è·å¥–æƒ…å†µ</span><span class="badge" id="awardCount">0</span></div>
            <div class="nav-item" data-view="book" onclick="setView('book')">ğŸ“š <span>ä¸“è‘—å‡ºç‰ˆ</span><span class="badge" id="bookCount">0</span></div>
            <div class="nav-section">å›¢é˜Ÿç®¡ç†</div>
            <div class="nav-item" data-view="member" id="navMember" onclick="setView('member')">ğŸ‘¥ <span>æˆå‘˜ä¿¡æ¯</span><span class="badge" id="memberCount">0</span></div>
        </nav>

        <div class="sidebar-footer">
            <div class="storage-status" id="storageStatus">âœ“ æ•°æ®å·²åŒæ­¥</div>
            <div class="data-actions">
                <button class="data-btn" id="btnExport" onclick="toggleMenu('exportMenu')">ğŸ“¤ å¯¼å‡º</button>
                <button class="data-btn" id="btnImport" onclick="toggleMenu('importMenu')">ğŸ“¥ å¯¼å…¥</button>
                <button class="data-btn onedrive" id="btnOneDrive" onclick="openBackupModal()" style="grid-column: span 2;">â˜ï¸ OneDrive åŒæ­¥</button>
            </div>
            
            <div id="exportMenu" class="dropdown-menu">
                <div class="menu-item" onclick="exportToExcelFile()">ğŸ“Š å¯¼å‡º Excel</div>
                <div class="menu-item" onclick="exportToWordFile()">ğŸ“ å¯¼å‡º Word</div>
                <div class="menu-item" id="menuExportJson" onclick="exportData()">ğŸ“¦ å¯¼å‡ºçº¯ JSON</div>
            </div>

            <div id="importMenu" class="dropdown-menu">
                <div class="menu-item" onclick="openExcelImport()">ğŸ“Š å¯¼å…¥ Excel</div>
                <div class="menu-item" onclick="triggerImport()">ğŸ“‚ æ¢å¤ JSON</div>
            </div>

            <div style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px;">
                <div class="menu-item" onclick="openRecycleModal()" style="font-size:0.85rem; border:none;">ğŸ—‘ æ‰“å¼€å›æ”¶ç«™</div>
                <div class="menu-item" onclick="openLogModal()" style="font-size:0.85rem; border:none;">ğŸ›¡ï¸ æŸ¥çœ‹æ“ä½œæ—¥å¿—</div>
            </div>

            <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(event)">
            <button class="btn btn-sm btn-secondary" onclick="location.reload()" style="width:100%; margin-top:10px;">ğŸ”’ é€€å‡ºç™»å½•</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <button class="btn btn-secondary" onclick="toggleSidebar()" style="display:none;" id="mobileMenuBtn">â˜°</button>
            <h1 class="page-title" id="pageTitle">å…¨éƒ¨æˆæœ</h1>
            <div class="header-actions">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢..." oninput="handleSearch()">
                </div>
                <button class="btn btn-secondary" onclick="toggleAdvSearch()" title="é«˜çº§ç­›é€‰">âš¡ ç­›é€‰</button>
                <button class="btn btn-secondary" onclick="toggleDarkMode()" title="æ—¥/å¤œæ¨¡å¼">ğŸŒ“</button>
                <button class="btn btn-primary" id="addBtn" onclick="openAddModal()">â• æ·»åŠ </button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
             <div class="stat-card" onclick="setView('paper')"><div class="stat-icon papers">ğŸ“„</div><div class="stat-info"><h3 id="statPaper">0</h3><p>è®ºæ–‡</p></div></div>
             <div class="stat-card" onclick="setView('patent')"><div class="stat-icon patents">ğŸ’¡</div><div class="stat-info"><h3 id="statPatent">0</h3><p>ä¸“åˆ©</p></div></div>
             <div class="stat-card" onclick="setView('project')"><div class="stat-icon projects">ğŸ“Š</div><div class="stat-info"><h3 id="statProject">0</h3><p>é¡¹ç›®</p></div></div>
             <div class="stat-card" onclick="setView('award')"><div class="stat-icon awards">ğŸ†</div><div class="stat-info"><h3 id="statAward">0</h3><p>è·å¥–</p></div></div>
             <div class="stat-card" onclick="setView('book')"><div class="stat-icon books">ğŸ“š</div><div class="stat-info"><h3 id="statBook">0</h3><p>è‘—ä½œ</p></div></div>
             <div class="stat-card" onclick="setView('member')"><div class="stat-icon members">ğŸ‘¥</div><div class="stat-info"><h3 id="statMember">0</h3><p>æˆå‘˜</p></div></div>
        </div>

        <div id="listViewContainer">
            <div class="filter-container">
                <div class="filter-bar" id="filterBar">
                    <div class="filter-chip active" data-year="all" onclick="setYearFilter('all')">å…¨éƒ¨å¹´ä»½</div>
                </div>
                
                <div class="adv-search-panel" id="advSearchPanel">
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom:0">
                            <label>å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="advStartDate" onchange="handleSearch()">
                        </div>
                        <div class="form-group" style="margin-bottom:0">
                            <label>ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="advEndDate" onchange="handleSearch()">
                        </div>
                        <div class="form-group" style="margin-bottom:0">
                            <label>åŒ…å«æ ‡ç­¾ (Tag)</label>
                            <input type="text" id="advTagInput" placeholder="è¾“å…¥æ ‡ç­¾..." oninput="handleSearch()">
                        </div>
                    </div>
                </div>
            </div>

            <div class="results-container" id="resultsContainer">
                <div class="results-header">
                    <div class="batch-actions">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <span>å…¨é€‰</span>
                        </label>
                        <button class="btn btn-danger btn-sm" id="batchDeleteBtn" onclick="batchDelete()" style="display:none;margin-left:10px;">ğŸ—‘ åˆ é™¤ (<span id="selectedCount">0</span>)</button>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span class="results-count" id="resultsCount">å…± 0 æ¡</span>
                        <select id="sortSelect" onchange="handleSort()" style="padding:6px;border-radius:4px;border:1px solid var(--border);">
                            <option value="date-desc">æœ€æ–°ä¼˜å…ˆ</option>
                            <option value="date-asc">æœ€æ—©ä¼˜å…ˆ</option>
                            <option value="title-asc">æ ‡é¢˜ A-Z</option>
                        </select>
                    </div>
                </div>
                <div class="results-list" id="resultsList"></div>
                
                <div class="pagination" id="paginationControl">
                    <button class="page-btn" onclick="changePage(-1)" id="prevPage">â†</button>
                    <span class="page-info" id="pageInfo">ç¬¬ 1 / 1 é¡µ</span>
                    <button class="page-btn" onclick="changePage(1)" id="nextPage">â†’</button>
                    <select id="pageSize" onchange="changePageSize()" style="border:1px solid var(--border); border-radius:4px; padding:4px;">
                        <option value="20">20æ¡/é¡µ</option>
                        <option value="50">50æ¡/é¡µ</option>
                        <option value="100">100æ¡/é¡µ</option>
                    </select>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="formModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="modalTitle">æ·»åŠ ç§‘ç ”æˆæœ</h2>
            <button class="modal-close" onclick="closeModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="researchForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label>æˆæœç±»å‹ *</label>
                        <select id="type" required onchange="toggleFormFields()">
                            <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                            <option value="patent">å‘æ˜ä¸“åˆ©</option>
                            <option value="project">ç§‘ç ”é¡¹ç›®</option>
                            <option value="award">è·å¥–æƒ…å†µ</option>
                            <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                        </select>
                    </div>
                    <div class="form-group" id="dateGroup">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="date">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>æ ‡ç­¾ (Tags)</label>
                    <div class="tag-container" id="formTags"></div>
                    <input type="text" id="tagInput" class="form-group" style="margin-top:5px; width:100%; height:40px;" placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦æ·»åŠ ..." onkeydown="handleTagInput(event)">
                </div>

                <div id="generalFields">
                    <div class="form-group input-wrapper">
                        <label>DOI (ä¾‹å¦‚ 10.1109/TPWRS...)</label>
                        <input type="text" id="doi" placeholder="è¾“å…¥ DOI ç‚¹å‡»å³ä¾§æŒ‰é’®æ™ºèƒ½è·å–">
                        <button type="button" class="smart-btn" onclick="fetchMetadataByDOI()">ğŸ” æ™ºèƒ½æŠ“å–</button>
                    </div>
                    <div class="form-group"><label>æ ‡é¢˜ *</label><input type="text" id="title" placeholder="è¯·è¾“å…¥æˆæœæ ‡é¢˜"></div>
                    <div class="form-group"><label>ä½œè€…/æˆå‘˜</label><input type="text" id="authors" placeholder="å¤šä¸ªä½œè€…ç”¨é€—å·åˆ†éš”"></div>
                    <div class="form-row"><div class="form-group"><label>æ¥æº/æœŸåˆŠ</label><input type="text" id="source"></div><div class="form-group"><label>çº§åˆ«</label><input type="text" id="level"></div></div>
                </div>

                <div id="patentFields" class="hidden">
                    <div class="form-group"><label>ä¸“åˆ©åç§° *</label><input type="text" id="patentName"></div>
                    <div class="form-row"><div class="form-group"><label>ç±»å‹</label><select id="patentType"><option value="å‘æ˜ä¸“åˆ©">å‘æ˜ä¸“åˆ©</option><option value="å®ç”¨æ–°å‹">å®ç”¨æ–°å‹</option><option value="å¤–è§‚è®¾è®¡">å¤–è§‚è®¾è®¡</option></select></div><div class="form-group"><label>çŠ¶æ€</label><select id="patentStatus"><option value="å—ç†">å—ç†</option><option value="æˆæƒ">æˆæƒ</option><option value="å®¡ä¸­">å®¡ä¸­</option><option value="å¤±æ•ˆ">å¤±æ•ˆ</option></select></div></div>
                    <div class="form-row"><div class="form-group"><label>å‘æ˜äºº</label><input type="text" id="inventors"></div><div class="form-group"><label>ä¸“åˆ©æƒäºº</label><input type="text" id="patentOwner"></div></div>
                    <div class="form-row"><div class="form-group"><label>ç”³è¯·æ—¥</label><input type="date" id="applicationDate"></div><div class="form-group"><label>å—ç†/æˆæƒæ—¥</label><input type="date" id="grantDate"></div></div>
                    <div class="form-group"><label>ä¸“åˆ©å·</label><input type="text" id="patentNumber"></div>
                </div>

                <div id="projectFields" class="hidden">
                    <div class="form-group"><label>é¡¹ç›®åç§° *</label><input type="text" id="projectName"></div>
                    <div class="form-row"><div class="form-group"><label>çº§åˆ«</label><input type="text" id="projectLevel"></div><div class="form-group"><label>ç¼–å·</label><input type="text" id="projectNumber"></div></div>
                    <div class="form-row"><div class="form-group"><label>å¼€å§‹</label><input type="date" id="projectStartDate"></div><div class="form-group"><label>ç»“æŸ</label><input type="date" id="projectEndDate"></div></div>
                    <div class="form-group"><label>å•ä½</label><input type="text" id="projectOrg"></div>
                </div>

                <div id="awardFields" class="hidden">
                    <div class="form-group"><label>å¥–é¡¹åç§° *</label><input type="text" id="awardName"></div>
                    <div class="form-group"><label>è·å¥–äºº</label><input type="text" id="awardRecipients"></div>
                    <div class="form-row"><div class="form-group"><label>æˆå¥–å•ä½</label><input type="text" id="awardAgency"></div><div class="form-group"><label>è·å¥–çº§åˆ«</label><input type="text" id="awardLevel"></div></div>
                    <div class="form-group"><label>è·å¥–æ—¥æœŸ</label><input type="date" id="awardDate"></div>
                </div>

                <div id="bookFields" class="hidden">
                    <div class="form-group input-wrapper">
                        <label>ISBN</label>
                        <input type="text" id="bookIsbn">
                        <button type="button" class="smart-btn" onclick="fetchMetadataByISBN()">ğŸ” æœä¹¦</button>
                    </div>
                    <div class="form-group"><label>è‘—ä½œåç§° *</label><input type="text" id="bookTitle"></div>
                    <div class="form-group"><label>ä½œè€…</label><input type="text" id="bookAuthors"></div>
                    <div class="form-row"><div class="form-group"><label>å‡ºç‰ˆç¤¾</label><input type="text" id="bookPublisher"></div><div class="form-group"><label>å‡ºç‰ˆæ—¥æœŸ</label><input type="date" id="bookDate"></div></div>
                </div>

                <div class="form-group">
                    <label>ğŸ“ é™„ä»¶</label>
                    <div class="file-upload" id="fileUpload" onclick="document.getElementById('pdfInput').click()">
                        <input type="file" id="pdfInput" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.7z,.txt" onchange="handleFileSelect(event)">
                        <div class="file-upload-icon">ğŸ“„</div><div class="file-upload-text">ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</div>
                    </div>
                    <div class="file-info hidden" id="fileInfo">
                        <span class="file-info-name"><span>ğŸ“„</span><span id="fileName"></span></span>
                        <button type="button" class="file-remove" onclick="removeFile()">âœ•</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="submit" form="researchForm" class="btn btn-primary" id="submitBtn">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="memberModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="memberModalTitle">æ·»åŠ æˆå‘˜</h2>
            <button class="modal-close" onclick="closeMemberModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="memberForm" onsubmit="handleMemberSubmit(event)">
                <input type="hidden" id="memberEditId">
                <div class="form-row"><div class="form-group"><label>å­¦å·/å·¥å· *</label><input type="text" id="memberNo" required></div><div class="form-group"><label>å§“å *</label><input type="text" id="memberName" required></div></div>
                <div class="form-row"><div class="form-group"><label>æ€§åˆ«</label><select id="memberGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div><div class="form-group"><label>æ°‘æ—</label><input type="text" id="memberNation"></div></div>
                <div class="form-group"><label>è¯ä»¶å·ç </label><input type="text" id="memberIdCard" oninput="handleIdCardInput(this)"></div>
                <div class="form-row"><div class="form-group"><label>å‡ºç”Ÿå¹´æœˆ</label><input type="text" id="memberDob"></div><div class="form-group"><label>ç”µè¯</label><input type="text" id="memberPhone"></div></div>
                <div class="form-row"><div class="form-group"><label>å•ä½</label><input type="text" id="memberOrg"></div><div class="form-group"><label>èŒç§°</label><input type="text" id="memberTitle"></div></div>
                <div class="form-group"><label>é‚®ç®±</label><input type="email" id="memberEmail"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="generateResume()">ğŸ“„ å¯¼å‡ºç®€å†</button>
            <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">å–æ¶ˆ</button>
            <button type="submit" form="memberForm" class="btn btn-primary">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="excelModal">
    <div class="modal wide">
        <div class="modal-header"><h2>å¯¼å…¥ Excel æ•°æ®</h2><button class="modal-close" onclick="closeExcelModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button></div>
        <div class="modal-body">
            <div class="form-group"><label>ç±»å‹</label><select id="excelImportType" onchange="updateMappingFields()"><option value="paper">å­¦æœ¯è®ºæ–‡</option><option value="patent">å‘æ˜ä¸“åˆ©</option><option value="project">ç§‘ç ”é¡¹ç›®</option><option value="award">è·å¥–æƒ…å†µ</option><option value="book">ä¸“è‘—å‡ºç‰ˆ</option><option value="member">æˆå‘˜ä¿¡æ¯</option></select></div>
            <div class="form-group"><label>æ–‡ä»¶</label><div class="file-upload" onclick="document.getElementById('excelInput').click()"><input type="file" id="excelInput" accept=".xlsx,.xls,.csv" onchange="handleExcelSelect(event)"><div class="file-upload-icon">ğŸ“Š</div><div class="file-upload-text">ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶</div></div></div>
            <div id="excelPreviewContainer" class="hidden"><label>é¢„è§ˆ</label><div class="excel-preview" id="excelPreview"></div></div>
            <div id="mappingContainer" class="hidden" style="margin-top:20px;"><label>æ˜ å°„</label><div id="mappingFields"></div></div>
            <div id="duplicateWarning" class="duplicate-warning hidden" style="margin-top:10px;padding:10px;background:var(--warning-light);"><h4>âš ï¸ å‘ç°é‡å¤é¡¹</h4><ul class="duplicate-list" id="duplicateList"></ul></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeExcelModal()">å–æ¶ˆ</button><button type="button" class="btn btn-primary" id="importExcelBtn" onclick="confirmExcelImport()" disabled>ç¡®è®¤å¯¼å…¥</button></div>
    </div>
</div>

<div class="modal-overlay" id="backupModal">
    <div class="modal">
        <div class="modal-header"><h2>â˜ï¸ OneDrive åŒæ­¥ä¸å¤‡ä»½</h2><button class="modal-close" onclick="closeBackupModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button></div>
        <div class="modal-body">
            <div class="backup-section" style="background:var(--od-light); border:1px solid var(--od-blue); padding:15px; border-radius:8px;">
                <h4 style="color:var(--od-blue); margin-bottom:10px;">â˜ï¸ Microsoft OneDrive</h4>
                <div id="onedrive-login-panel"><button class="btn btn-od" onclick="OneDriveService.signIn()" style="width:100%">ğŸ”‘ ç™»å½•å¾®è½¯è´¦å·</button></div>
                <div id="onedrive-actions-panel" class="hidden">
                    <div style="margin-bottom:10px;">å·²ç™»å½•: <span id="odUserName"></span> <button class="btn btn-sm btn-secondary" onclick="OneDriveService.signOut()">æ³¨é”€</button></div>
                    <div style="display:grid; gap:10px;">
                        <button class="btn btn-od" id="btnOdUpload" onclick="OneDriveService.upload()">â¬†ï¸ ä¸Šä¼ æ•°æ®åˆ°äº‘ç«¯</button>
                        <button class="btn btn-od" id="btnOdDownload" style="background:white; color:var(--od-blue); border:1px solid var(--od-blue);" onclick="OneDriveService.download()">â¬‡ï¸ ä»äº‘ç«¯æ¢å¤æ•°æ®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="recycleModal">
    <div class="modal wide">
        <div class="modal-header"><h2>ğŸ—‘ æ•°æ®å›æ”¶ç«™ (30å¤©å†…å¯æ¢å¤)</h2><button class="modal-close" onclick="document.getElementById('recycleModal').classList.remove('active')" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button></div>
        <div class="modal-body"><div class="results-list" id="recycleList"></div></div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="document.getElementById('recycleModal').classList.remove('active')">å…³é—­</button></div>
    </div>
</div>

<div class="modal-overlay" id="logModal">
    <div class="modal wide">
        <div class="modal-header"><h2>ğŸ›¡ï¸ ç³»ç»Ÿæ“ä½œæ—¥å¿—</h2><button class="modal-close" onclick="document.getElementById('logModal').classList.remove('active')" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button></div>
        <div class="modal-body" id="logList"></div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="document.getElementById('logModal').classList.remove('active')">å…³é—­</button></div>
    </div>
</div>

<div class="modal-overlay" id="citationModal">
    <div class="modal">
        <div class="modal-header"><h2>â ç”Ÿæˆå¼•ç”¨æ ¼å¼</h2><button class="modal-close" onclick="document.getElementById('citationModal').classList.remove('active')" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button></div>
        <div class="modal-body">
            <label>GB/T 7714</label><div class="citation-box"><span id="citeGB"></span><button class="citation-copy" onclick="copyText('citeGB')">å¤åˆ¶</button></div>
            <label style="margin-top:10px;display:block;">APA</label><div class="citation-box"><span id="citeAPA"></span><button class="citation-copy" onclick="copyText('citeAPA')">å¤åˆ¶</button></div>
            <label style="margin-top:10px;display:block;">BibTeX</label><div class="citation-box"><span id="citeBib"></span><button class="citation-copy" onclick="copyText('citeBib')">å¤åˆ¶</button></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="detailModal">
    <div class="modal wide">
        <div class="modal-header"><h2 id="detailTitle">è¯¦ç»†ä¿¡æ¯</h2><button class="modal-close" onclick="closeDetailModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">âœ•</button></div>
        <div class="modal-body" id="detailContent"></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeDetailModal()">å…³é—­</button><button type="button" class="btn btn-primary" id="detailEditBtn" onclick="editFromDetail()">âœ ç¼–è¾‘</button></div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>
<script>
    // --- Global State ---
    let currentUserRole = null;
    let achievements = [];
    let members = [];
    // V5.0 New State
    let systemLogs = [];
    let currentTags = [];
    let currentView = 'all';
    let currentYearFilter = 'all';
    let searchQuery = '';
    let sortOrder = 'date-desc';
    let selectedItems = new Set();
    let currentPdfData = null; 
    let currentPdfName = null;
    let excelData = null;
    let excelHeaders = [];
    
    // Pagination
    let currentPage = 1;
    let pageSize = 20;

    // --- Configuration ---
    const typeConfig = {
        paper: { icon: 'ğŸ“„', label: 'å­¦æœ¯è®ºæ–‡', class: 'type-paper' },
        patent: { icon: 'ğŸ’¡', label: 'å‘æ˜ä¸“åˆ©', class: 'type-patent' },
        project: { icon: 'ğŸ“Š', label: 'ç§‘ç ”é¡¹ç›®', class: 'type-project' },
        award: { icon: 'ğŸ†', label: 'è·å¥–æƒ…å†µ', class: 'type-award' },
        book: { icon: 'ğŸ“š', label: 'ä¸“è‘—å‡ºç‰ˆ', class: 'type-book' },
        member: { icon: 'ğŸ‘¤', label: 'æˆå‘˜ä¿¡æ¯', class: 'type-member' }
    };
    
    const fieldMappings = {
        paper: [{ key: 'title', label: 'æ ‡é¢˜', required: true }, { key: 'authors', label: 'ä½œè€…' }, { key: 'date', label: 'å‘è¡¨æ—¥æœŸ' }, { key: 'source', label: 'æœŸåˆŠ/æ¥æº' }, { key: 'level', label: 'çº§åˆ«' }, { key: 'doi', label: 'DOI' }],
        patent: [{ key: 'patentName', label: 'ä¸“åˆ©åç§°', required: true }, { key: 'patentType', label: 'ä¸“åˆ©ç±»å‹' }, { key: 'inventors', label: 'å‘æ˜äºº' }, { key: 'patentOwner', label: 'ä¸“åˆ©æƒäºº' }, { key: 'applicationDate', label: 'ç”³è¯·æ—¥' }, { key: 'grantDate', label: 'æˆæƒæ—¶é—´' }, { key: 'patentNumber', label: 'ä¸“åˆ©å·' }, { key: 'patentStatus', label: 'ä¸“åˆ©çŠ¶æ€' }],
        project: [{ key: 'projectName', label: 'é¡¹ç›®åç§°', required: true }, { key: 'projectLevel', label: 'é¡¹ç›®çº§åˆ«' }, { key: 'projectNumber', label: 'é¡¹ç›®ç¼–å·' }, { key: 'projectStartDate', label: 'å¼€å§‹æ—¶é—´' }, { key: 'projectEndDate', label: 'ç»“æŸæ—¶é—´' }, { key: 'projectOrg', label: 'æ‰€å±å•ä½' }],
        award: [{ key: 'awardName', label: 'å¥–é¡¹åç§°', required: true }, { key: 'awardRecipients', label: 'è·å¥–äºº' }, { key: 'awardDate', label: 'è·å¥–æ—¥æœŸ' }, { key: 'awardLevel', label: 'çº§åˆ«' }, { key: 'awardAgency', label: 'æˆå¥–å•ä½' }],
        book: [{ key: 'bookTitle', label: 'è‘—ä½œåç§°', required: true }, { key: 'bookAuthors', label: 'ä½œè€…' }, { key: 'bookDate', label: 'å‡ºç‰ˆæ—¥æœŸ' }, { key: 'bookPublisher', label: 'å‡ºç‰ˆç¤¾' }, { key: 'bookIsbn', label: 'ISBN' }],
        member: [{ key: 'memberNo', label: 'å­¦å·/å·¥å·', required: true }, { key: 'memberName', label: 'å§“å', required: true }, { key: 'memberGender', label: 'æ€§åˆ«' }, { key: 'memberOrg', label: 'å·¥ä½œå•ä½' }, { key: 'memberTitle', label: 'èŒç§°' }, { key: 'memberEmail', label: 'é‚®ç®±' }, { key: 'memberIdCard', label: 'è¯ä»¶å·ç ' }, { key: 'memberDob', label: 'å‡ºç”Ÿå¹´æœˆ' }, { key: 'memberNation', label: 'æ°‘æ—' }, { key: 'memberPhone', label: 'ç”µè¯' }]
    };

    // --- Database (IndexedDB) ---
    const DB_NAME = 'ResearchDB_V5_PRO';
    let db;
    function initDB() { 
        return new Promise((resolve, reject) => { 
            var r = indexedDB.open(DB_NAME, 1); 
            r.onerror = e => reject(e); 
            r.onupgradeneeded = e => { 
                if (!e.target.result.objectStoreNames.contains('appState')) 
                    e.target.result.createObjectStore('appState', { keyPath: 'id' }); 
            }; 
            r.onsuccess = e => { db = e.target.result; resolve(db); }; 
        }); 
    }

    async function loadFromLocal() {
        if (!db) await initDB();
        return new Promise(resolve => {
            var r = db.transaction(['appState'], 'readonly').objectStore('appState').get('main_data');
            r.onsuccess = e => {
                if (e.target.result) {
                    achievements = e.target.result.achievements || [];
                    members = e.target.result.members || [];
                    systemLogs = e.target.result.systemLogs || [];
                    resolve(true);
                } else resolve(false);
            };
            r.onerror = () => resolve(false);
        });
    }

    async function saveToLocal() {
        if (!db) await initDB();
        var t = db.transaction(['appState'], 'readwrite');
        t.objectStore('appState').put({ 
            id: 'main_data', 
            achievements, 
            members, 
            systemLogs, 
            updatedAt: new Date().toISOString() 
        });
        updateStorageStatus(true);
    }
    
    function updateStorageStatus(ok) { 
        var s = document.getElementById('storageStatus'); 
        if (ok) { s.className = 'storage-status'; s.innerHTML = 'âœ“ æ•°æ®å·²æœ¬åœ°ä¿å­˜ ' + new Date().toLocaleTimeString(); } 
        else { s.className = 'storage-status warning'; s.textContent = 'âš  ä¿å­˜å¤±è´¥'; } 
    }

    // --- Authentication ---
    function checkLogin() {
        const pwd = document.getElementById('loginPassword').value;
        if (pwd === '1399') {
            currentUserRole = 'admin';
            document.getElementById('loginOverlay').style.display = 'none';
            applyPermissions();
            showToast('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ', 'success');
        } else if (pwd === 'guest') {
            currentUserRole = 'guest';
            document.getElementById('loginOverlay').style.display = 'none';
            applyPermissions();
            showToast('å®¾å®¢ç™»å½•æˆåŠŸ', 'success');
        } else {
            showToast('å¯†ç é”™è¯¯', 'error');
        }
    }

    function applyPermissions() {
        const isAdmin = currentUserRole === 'admin';
        document.getElementById('addBtn').style.display = isAdmin ? 'inline-flex' : 'none';
        document.querySelectorAll('.delete').forEach(btn => btn.style.display = isAdmin ? 'flex' : 'none');
        document.getElementById('navMember').style.display = isAdmin ? 'flex' : 'none';
        // V5.0 permissions
        if(!isAdmin) {
             document.getElementById('btnOdUpload').disabled = true;
             document.getElementById('menuExportJson').style.display = 'none';
        }
    }

    // --- V5.0 Logging System ---
    function addLog(action, details) {
        systemLogs.unshift({
            id: Date.now(),
            user: currentUserRole || 'unknown',
            time: new Date().toLocaleString(),
            action: action,
            details: details
        });
        if(systemLogs.length > 500) systemLogs.pop();
        saveToLocal();
    }

    function openLogModal() {
        if(currentUserRole !== 'admin') { showToast('éœ€ç®¡ç†å‘˜æƒé™', 'error'); return; }
        document.getElementById('logList').innerHTML = systemLogs.map(log => `
            <div class="log-item">
                <div class="log-time">${log.time}</div>
                <div class="log-action">${log.action}</div>
                <div class="log-detail">${escapeHtml(log.details)}</div>
                <div>${log.user}</div>
            </div>
        `).join('');
        document.getElementById('logModal').classList.add('active');
    }

    // --- Navigation & Views ---
    function setView(view) {
        if (view === 'member' && currentUserRole !== 'admin') { showToast('æ— æƒé™', 'error'); return; }
        currentView = view;
        currentPage = 1; // Reset pagination
        selectedItems.clear();
        document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.view === view));
        document.getElementById('pageTitle').textContent = typeConfig[view]?.label || 'å…¨éƒ¨æˆæœ';
        
        // Mobile sidebar handling
        if(window.innerWidth <= 768) closeSidebar();
        renderResults();
    }
    
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('active'); }
    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('active'); }
    function toggleMenu(id) { document.getElementById(id).classList.toggle('show'); }

    // --- Rendering Logic (Enhanced for V5) ---
    function renderResults() {
        const container = document.getElementById('resultsList');
        container.innerHTML = '';
        
        let source = currentView === 'member' ? members : achievements;
        
        // 1. Filter Deleted
        let filtered = source.filter(i => !i.isDeleted);
        
        // 2. Filter Type
        if (currentView !== 'all' && currentView !== 'member') filtered = filtered.filter(a => a.type === currentView);
        
        // 3. Search (Enhanced)
        if (searchQuery) {
            const q = searchQuery.toLowerCase();
            filtered = filtered.filter(a => JSON.stringify(a).toLowerCase().includes(q));
        }
        
        // 4. Advanced Filters (V5)
        const advStart = document.getElementById('advStartDate').value;
        const advEnd = document.getElementById('advEndDate').value;
        const advTag = document.getElementById('advTagInput').value.trim().toLowerCase();
        
        if (currentYearFilter !== 'all') {
             filtered = filtered.filter(a => (a.date || a.applicationDate || '').startsWith(currentYearFilter));
        }
        if(advStart) filtered = filtered.filter(a => (a.date || a.applicationDate) >= advStart);
        if(advEnd) filtered = filtered.filter(a => (a.date || a.applicationDate) <= advEnd);
        if(advTag) filtered = filtered.filter(a => a.tags && a.tags.some(t => t.toLowerCase().includes(advTag)));

        // 5. Sort
        filtered.sort((a, b) => {
            const da = a.date || a.applicationDate || '0';
            const db = b.date || b.applicationDate || '0';
            if(sortOrder === 'date-desc') return db.localeCompare(da);
            if(sortOrder === 'date-asc') return da.localeCompare(db);
            return (a.title || a.memberName || '').localeCompare(b.title || b.memberName || '');
        });

        // 6. Pagination (V5)
        const totalCount = filtered.length;
        document.getElementById('resultsCount').textContent = `å…± ${totalCount} æ¡`;
        const totalPages = Math.ceil(totalCount / pageSize) || 1;
        document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
        
        const start = (currentPage - 1) * pageSize;
        const sliced = filtered.slice(start, start + pageSize);

        if (sliced.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-secondary);">æš‚æ— æ•°æ®</div>';
            return;
        }

        container.innerHTML = sliced.map(item => {
            let config = typeConfig[item.type] || typeConfig.paper;
            if(currentView === 'member') config = {icon:'ğŸ‘¤', class:'type-member'};
            
            const title = escapeHtml(item.title || item.patentName || item.projectName || item.memberName);
            const date = item.date || item.applicationDate || item.projectStartDate || '';
            const info = item.authors || item.inventors || item.memberOrg || '';
            
            // Tags HTML
            let tagsHtml = '';
            if(item.tags && item.tags.length > 0) {
                tagsHtml = `<div class="tag-container" style="margin-bottom:4px;margin-top:0;">${item.tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>`;
            }
            
            // Cite Button
            let citeBtn = currentView !== 'member' ? `<button class="action-btn" onclick="event.stopPropagation(); openCitation('${item.id}')" title="å¼•ç”¨">â</button>` : '';

            return `
            <div class="result-item" onclick="${currentView==='member'?'editMember':'viewDetail'}('${item.id}')">
                <input type="checkbox" onclick="event.stopPropagation(); toggleItemSelect('${item.id}')" ${selectedItems.has(item.id)?'checked':''}>
                <div class="result-type ${config.class}">${config.icon}</div>
                <div class="result-content">
                    <div class="result-title">${title}</div>
                    ${tagsHtml}
                    <div class="result-meta"><span>ğŸ“… ${date}</span> <span>ğŸ‘¤ ${escapeHtml(info)}</span></div>
                </div>
                <div class="result-actions">
                    ${citeBtn}
                    <button class="action-btn" onclick="event.stopPropagation(); viewFile('${item.id}')">ğŸ‘ï¸</button>
                    <button class="action-btn delete" style="${currentUserRole!=='admin'?'display:none':''}" onclick="event.stopPropagation(); promptDelete('${item.id}', '${currentView==='member'?'member':'achievement'}')">ğŸ—‘</button>
                </div>
            </div>`;
        }).join('');
    }

    // --- CRUD Operations ---
    function openAddModal() {
        if(currentView === 'member') { openMemberModal(); return; }
        document.getElementById('modalTitle').textContent = 'æ·»åŠ ç§‘ç ”æˆæœ';
        document.getElementById('researchForm').reset();
        document.getElementById('editId').value = '';
        currentTags = []; renderFormTags();
        document.getElementById('type').value = currentView === 'all' ? 'paper' : currentView;
        toggleFormFields();
        document.getElementById('formModal').classList.add('active');
    }

    function editAchievement(id) {
        // Redirect to detail edit if needed, or open modal directly
        if(currentUserRole !== 'admin') return;
        const item = achievements.find(a => a.id === id);
        if(!item) return;
        
        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘æˆæœ';
        document.getElementById('editId').value = id;
        document.getElementById('type').value = item.type;
        toggleFormFields();
        
        // Populate standard fields
        if(document.getElementById('title')) document.getElementById('title').value = item.title || item.patentName || item.projectName || item.awardName || item.bookTitle || '';
        if(document.getElementById('date')) document.getElementById('date').value = item.date || item.applicationDate || item.projectStartDate || item.awardDate || item.bookDate || '';
        
        // Populate specific fields (Simplified for brevity, ensuring mappings)
        for (const [key, value] of Object.entries(item)) {
            const input = document.getElementById(key);
            if(input) input.value = value;
        }
        
        currentTags = item.tags || [];
        renderFormTags();
        
        if (item.pdfData) {
            currentPdfData = item.pdfData; currentPdfName = item.pdfName;
            document.getElementById('fileName').textContent = item.pdfName;
            document.getElementById('fileInfo').classList.remove('hidden');
        }
        
        document.getElementById('formModal').classList.add('active');
    }

    function handleSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const type = document.getElementById('type').value;
        
        // Construct object from form
        const formData = new FormData(e.target);
        let data = { 
            id: id || Date.now().toString(), 
            type: type, 
            updatedAt: new Date().toISOString(),
            tags: currentTags,
            pdfData: currentPdfData,
            pdfName: currentPdfName
        };
        
        // Map all inputs to data object
        document.querySelectorAll('#researchForm input, #researchForm select').forEach(el => {
            if(el.id && el.type !== 'file') data[el.id] = el.value;
        });

        // Normalize title/date for sorting
        if(!data.title) data.title = data.patentName || data.projectName || data.bookTitle || data.awardName;
        if(!data.date) data.date = data.applicationDate || data.projectStartDate || data.awardDate || data.bookDate;

        if (id) {
            const idx = achievements.findIndex(a => a.id === id);
            achievements[idx] = { ...achievements[idx], ...data };
            addLog('æ›´æ–°', `æ›´æ–°æˆæœ ID: ${id}`);
        } else {
            data.createdAt = new Date().toISOString();
            achievements.push(data);
            addLog('æ–°å»º', `æ–°å»ºæˆæœ: ${data.title}`);
        }
        
        saveToLocal();
        closeModal();
        updateStats();
        renderResults();
        showToast('ä¿å­˜æˆåŠŸ', 'success');
    }

    // --- Recycle Bin Logic (V5) ---
    function promptDelete(id, type) {
        if(currentUserRole !== 'admin') { showToast('æ— æƒé™', 'error'); return; }
        if(confirm('ç¡®å®šç§»å…¥å›æ”¶ç«™å—ï¼Ÿ(30å¤©å†…å¯æ¢å¤)')) {
            const list = type === 'member' ? members : achievements;
            const item = list.find(i => i.id === id);
            if(item) {
                item.isDeleted = true;
                item.deletedAt = new Date().toISOString();
                addLog('åˆ é™¤', `ç§»å…¥å›æ”¶ç«™: ${item.title || item.memberName}`);
                saveToLocal();
                renderResults();
                updateStats();
                showToast('å·²ç§»å…¥å›æ”¶ç«™', 'success');
            }
        }
    }
    
    function openRecycleModal() {
        if(currentUserRole !== 'admin') return;
        const deleted = [...achievements, ...members].filter(i => i.isDeleted);
        const container = document.getElementById('recycleList');
        if(deleted.length === 0) container.innerHTML = '<p style="text-align:center">å›æ”¶ç«™ä¸ºç©º</p>';
        else {
            container.innerHTML = deleted.map(item => `
                <div class="result-item deleted-item">
                    <div class="result-content"><div class="result-title">${escapeHtml(item.title || item.memberName)}</div></div>
                    <div class="result-actions">
                        <button class="btn btn-sm btn-success" onclick="restoreItem('${item.id}')">â™»ï¸</button>
                        <button class="btn btn-sm btn-danger" onclick="hardDelete('${item.id}')">âœ•</button>
                    </div>
                </div>
            `).join('');
        }
        document.getElementById('recycleModal').classList.add('active');
    }
    
    function restoreItem(id) {
        let item = achievements.find(a=>a.id===id) || members.find(m=>m.id===id);
        if(item) {
            delete item.isDeleted;
            addLog('æ¢å¤', `æ¢å¤æ•°æ®: ${id}`);
            saveToLocal(); renderResults(); openRecycleModal(); updateStats();
        }
    }
    
    function hardDelete(id) {
        if(confirm('å½»åº•åˆ é™¤å°†æ— æ³•æ¢å¤ï¼Œç¡®å®šå—ï¼Ÿ')) {
            achievements = achievements.filter(a => a.id !== id);
            members = members.filter(m => m.id !== id);
            addLog('å½»åº•åˆ é™¤', `å½»åº•åˆ é™¤ ID: ${id}`);
            saveToLocal(); openRecycleModal();
        }
    }

    // --- Smart Fetch (V5) ---
    async function fetchMetadataByDOI() {
        const doi = document.getElementById('doi').value.trim();
        if(!doi) return showToast('è¯·è¾“å…¥DOI', 'error');
        const btn = document.querySelector('.smart-btn'); 
        const oldText = btn.innerText; btn.innerText = 'æŠ“å–ä¸­...';
        try {
            const res = await fetch(`https://api.crossref.org/works/${doi}`);
            if(!res.ok) throw new Error('Not Found');
            const data = (await res.json()).message;
            document.getElementById('title').value = data.title?.[0] || '';
            document.getElementById('source').value = data['container-title']?.[0] || '';
            if(data.author) document.getElementById('authors').value = data.author.map(a => `${a.given} ${a.family}`).join(', ');
            if(data.created) {
                const d = data.created['date-parts'][0];
                document.getElementById('date').value = `${d[0]}-${String(d[1]).padStart(2,'0')}-${String(d[2]||1).padStart(2,'0')}`;
            }
            if(!currentTags.includes('SmartFetch')) { currentTags.push('SmartFetch'); renderFormTags(); }
            showToast('æŠ“å–æˆåŠŸ', 'success');
        } catch(e) { showToast('æŠ“å–å¤±è´¥', 'error'); }
        btn.innerText = oldText;
    }

    async function fetchMetadataByISBN() {
        const isbn = document.getElementById('bookIsbn').value.replace(/-/g,'').trim();
        if(!isbn) return;
        try {
            const res = await fetch(`https://openlibrary.org/isbn/${isbn}.json`);
            if(!res.ok) throw new Error('Not Found');
            const data = await res.json();
            document.getElementById('bookTitle').value = data.title;
            if(data.publish_date) {
                // simple parser, might need robust lib for all date formats
                document.getElementById('bookDate').value = new Date(data.publish_date).toISOString().slice(0,10);
            }
            showToast('æŠ“å–æˆåŠŸ', 'success');
        } catch(e) { showToast('æœªæ‰¾åˆ°ä¹¦ç±ä¿¡æ¯', 'error'); }
    }

    // --- Tag System ---
    function handleTagInput(e) {
        if(e.key === 'Enter') {
            e.preventDefault();
            const val = e.target.value.trim();
            if(val && !currentTags.includes(val)) {
                currentTags.push(val);
                renderFormTags();
                e.target.value = '';
            }
        }
    }
    function renderFormTags() {
        document.getElementById('formTags').innerHTML = currentTags.map(t => `<span class="tag">${t} <span onclick="removeTag('${t}')" style="cursor:pointer;margin-left:4px;">âœ•</span></span>`).join('');
    }
    function removeTag(t) { currentTags = currentTags.filter(x => x !== t); renderFormTags(); }

    // --- Citations (V5) ---
    function openCitation(id) {
        const item = achievements.find(a => a.id === id);
        if(!item) return;
        const auth = item.authors || 'ä½šå';
        const title = item.title;
        const year = (item.date||'').substring(0,4);
        
        document.getElementById('citeGB').textContent = `${auth}. ${title}[J]. ${item.source||'æœŸåˆŠ'}, ${year}.`;
        document.getElementById('citeAPA').textContent = `${auth} (${year}). ${title}. ${item.source||''}.`;
        document.getElementById('citeBib').textContent = `@misc{${id}, title={${title}}, author={${auth}}, year={${year}}}`;
        document.getElementById('citationModal').classList.add('active');
    }
    function copyText(id) { navigator.clipboard.writeText(document.getElementById(id).textContent); showToast('å·²å¤åˆ¶', 'success'); }

    // --- Resume Export (V5) ---
    function generateResume() {
        // Find member from edit form or create temp
        const name = document.getElementById('memberName').value;
        if(!name) return showToast('è¯·å…ˆå¡«å†™å§“å', 'error');
        
        const myPapers = achievements.filter(a => !a.isDeleted && a.authors && a.authors.includes(name));
        const myProjects = achievements.filter(a => !a.isDeleted && a.projectName && a.projectName.includes(name));
        
        let html = `<html><head><meta charset='utf-8'></head><body>
            <h1 style="text-align:center">${name} - ä¸ªäººç®€å†</h1>
            <hr>
            <h3>åŸºæœ¬ä¿¡æ¯</h3>
            <p>å•ä½ï¼š${document.getElementById('memberOrg').value} | èŒç§°ï¼š${document.getElementById('memberTitle').value}</p>
            <h3>å­¦æœ¯è®ºæ–‡ (${myPapers.length})</h3>
            <ul>${myPapers.map(p => `<li>${p.title}, ${p.source}, ${p.date}</li>`).join('')}</ul>
            <h3>ç§‘ç ”é¡¹ç›® (${myProjects.length})</h3>
            <ul>${myProjects.map(p => `<li>${p.projectName}, ${p.projectLevel}</li>`).join('')}</ul>
        </body></html>`;
        
        const blob = new Blob([html], {type: 'application/msword'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${name}_ç®€å†.doc`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    // --- Excel & File Handlers (Preserved Logic) ---
    function handleFileSelect(event) {
        var file = event.target.files[0]; if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            currentPdfData = e.target.result; currentPdfName = file.name;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
    function removeFile() { currentPdfData = null; currentPdfName = null; document.getElementById('fileInfo').classList.add('hidden'); }
    function viewFile(id) {
        var item = achievements.find(a => a.id === id);
        if (item && item.pdfData) {
            var win = window.open(); win.document.write('<iframe src="' + item.pdfData + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
        } else { showToast('æ— é™„ä»¶', 'error'); }
    }
    
    // Excel Import Logic (Simplified for length but keeping core flow)
    function openExcelImport() { document.getElementById('excelModal').classList.add('active'); }
    function closeExcelModal() { document.getElementById('excelModal').classList.remove('active'); }
    function handleExcelSelect(event) {
        var file = event.target.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, { type: 'array' });
            excelData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            if(excelData.length>0) {
                excelHeaders = excelData[0];
                renderExcelPreview();
                updateMappingFields();
                document.getElementById('excelPreviewContainer').classList.remove('hidden');
                document.getElementById('mappingContainer').classList.remove('hidden');
                document.getElementById('importExcelBtn').disabled = false;
            }
        };
        reader.readAsArrayBuffer(file);
    }
    function renderExcelPreview() {
        var html = '<table><thead><tr>' + excelHeaders.map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>';
        html += excelData.slice(1,6).map(row=>'<tr>'+excelHeaders.map((_,i)=>`<td>${row[i]||''}</td>`).join('')+'</tr>').join('');
        document.getElementById('excelPreview').innerHTML = html + '</tbody></table>';
    }
    function updateMappingFields() {
        const type = document.getElementById('excelImportType').value;
        const fields = fieldMappings[type] || [];
        document.getElementById('mappingFields').innerHTML = fields.map(f => `
            <div class="mapping-row">
                <label>${f.label}</label>
                <select class="map-select" data-key="${f.key}">
                    <option value="">(å¿½ç•¥)</option>
                    ${excelHeaders.map((h,i)=>`<option value="${i}" ${h.includes(f.label)?'selected':''}>${h}</option>`).join('')}
                </select>
            </div>`).join('');
    }
    function confirmExcelImport() {
        const type = document.getElementById('excelImportType').value;
        const selects = document.querySelectorAll('.map-select');
        let count = 0;
        
        for(let i=1; i<excelData.length; i++) {
            const row = excelData[i];
            let item = { id: Date.now()+Math.random().toString(), type: type, createdAt: new Date().toISOString() };
            selects.forEach(s => { if(s.value!=='') item[s.dataset.key] = row[s.value]; });
            
            // Basic Duplication Check
            const isDup = achievements.some(a => a.title === item.title && a.type === type);
            if(!isDup) { achievements.push(item); count++; }
        }
        saveToLocal(); closeModal(); updateStats(); renderResults(); showToast(`å¯¼å…¥ ${count} æ¡`, 'success');
        addLog('å¯¼å…¥', `Excel å¯¼å…¥ ${count} æ¡`);
    }

    // --- OneDrive Service (Preserved) ---
    const msalConfig = { auth: { clientId: "c453313f-fd40-4534-9d66-6a0847396d3b", authority: "https://login.microsoftonline.com/common", redirectUri: window.location.href } };
    let msalInstance;
    
    const OneDriveService = {
        init: async () => { try { msalInstance = new msal.PublicClientApplication(msalConfig); } catch(e){console.error(e)} },
        signIn: async () => {
            try { const res = await msalInstance.loginPopup({scopes: ["User.Read", "Files.ReadWrite"]}); msalInstance.setActiveAccount(res.account); OneDriveService.updateUI(); } catch(e){showToast(e.message,'error')}
        },
        signOut: () => { msalInstance.logoutPopup(); },
        updateUI: () => {
            const acc = msalInstance.getActiveAccount();
            if(acc) {
                document.getElementById('onedrive-login-panel').classList.add('hidden');
                document.getElementById('onedrive-actions-panel').classList.remove('hidden');
                document.getElementById('odUserName').innerText = acc.name;
            }
        },
        upload: async () => {
             const acc = msalInstance.getActiveAccount(); if(!acc) return;
             const content = JSON.stringify({achievements, members, systemLogs});
             const url = `https://graph.microsoft.com/v1.0/me/drive/root:/ResearchManager/backup.json:/content`;
             const token = (await msalInstance.acquireTokenSilent({scopes:["Files.ReadWrite"], account:acc})).accessToken;
             await fetch(url, {method:'PUT', headers:{'Authorization':`Bearer ${token}`}, body:content});
             showToast('ä¸Šä¼ æˆåŠŸ','success'); addLog('äº‘åŒæ­¥', 'ä¸Šä¼ å¤‡ä»½åˆ° OneDrive');
        },
        download: async () => {
             const acc = msalInstance.getActiveAccount(); if(!acc) return;
             const token = (await msalInstance.acquireTokenSilent({scopes:["Files.ReadWrite"], account:acc})).accessToken;
             const res = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/ResearchManager/backup.json:/content`, {headers:{'Authorization':`Bearer ${token}`}});
             if(res.ok) {
                 const data = await res.json();
                 if(confirm('è¦†ç›–å½“å‰æ•°æ®?')) {
                     achievements = data.achievements || [];
                     members = data.members || [];
                     systemLogs = data.systemLogs || [];
                     saveToLocal(); renderResults(); updateStats(); showToast('æ¢å¤æˆåŠŸ','success');
                     addLog('äº‘åŒæ­¥', 'ä» OneDrive æ¢å¤æ•°æ®');
                 }
             } else showToast('æœªæ‰¾åˆ°å¤‡ä»½','error');
        }
    };

    // --- Utils ---
    function closeModal() { document.getElementById('formModal').classList.remove('active'); }
    function closeMemberModal() { document.getElementById('memberModal').classList.remove('active'); }
    function closeBackupModal() { document.getElementById('backupModal').classList.remove('active'); }
    function closeDetailModal() { document.getElementById('detailModal').classList.remove('active'); }
    function viewDetail(id) { editAchievement(id); } // Shortcut
    function editMember(id) { 
        const m = members.find(x=>x.id===id);
        document.getElementById('memberEditId').value = id;
        document.getElementById('memberName').value = m.memberName;
        document.getElementById('memberNo').value = m.memberNo;
        // Populate other fields...
        document.getElementById('memberModal').classList.add('active');
    }
    function toggleFormFields() {
        const type = document.getElementById('type').value;
        ['patentFields','projectFields','awardFields','bookFields','generalFields'].forEach(id => document.getElementById(id).classList.add('hidden'));
        if(type === 'patent') document.getElementById('patentFields').classList.remove('hidden');
        else if(type === 'project') document.getElementById('projectFields').classList.remove('hidden');
        else if(type === 'award') document.getElementById('awardFields').classList.remove('hidden');
        else if(type === 'book') document.getElementById('bookFields').classList.remove('hidden');
        else { document.getElementById('generalFields').classList.remove('hidden'); document.getElementById('dateGroup').classList.remove('hidden'); }
    }
    function changePage(d) { currentPage = Math.max(1, currentPage+d); renderResults(); }
    function changePageSize() { pageSize = parseInt(document.getElementById('pageSize').value); currentPage=1; renderResults(); }
    function toggleAdvSearch() { document.getElementById('advSearchPanel').classList.toggle('active'); }
    function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }
    function handleSearch() { currentPage=1; renderResults(); }
    function setYearFilter(y) { currentYearFilter = y; document.querySelectorAll('.filter-chip').forEach(c=>c.classList.toggle('active', c.dataset.year===y)); renderResults(); }
    function handleSort() { sortOrder = document.getElementById('sortSelect').value; renderResults(); }
    function toggleSelectAll() { 
        const all = document.querySelectorAll('.result-item input[type="checkbox"]');
        const checked = document.getElementById('selectAll').checked;
        all.forEach(c => { c.checked = checked; toggleItemSelect(c.parentElement.getAttribute('onclick').match(/'([^']+)'/)[1]); });
    }
    function toggleItemSelect(id) {
        if(selectedItems.has(id)) selectedItems.delete(id); else selectedItems.add(id);
        document.getElementById('batchDeleteBtn').style.display = selectedItems.size ? 'inline-block' : 'none';
        document.getElementById('selectedCount').textContent = selectedItems.size;
    }
    function batchDelete() {
        if(confirm(`ç¡®å®šåˆ é™¤ ${selectedItems.size} é¡¹?`)) {
            selectedItems.forEach(id => {
               const item = achievements.find(a=>a.id===id) || members.find(m=>m.id===id);
               if(item) { item.isDeleted = true; item.deletedAt = new Date().toISOString(); }
            });
            saveToLocal(); renderResults(); selectedItems.clear(); updateStats();
        }
    }
    function exportData() {
        const blob = new Blob([JSON.stringify({achievements, members, systemLogs})], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click();
    }
    function triggerImport() { document.getElementById('importInput').click(); }
    function importData(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
            const data = JSON.parse(evt.target.result);
            // Smart Merge
            data.achievements.forEach(n => {
                const idx = achievements.findIndex(o => o.id === n.id);
                if(idx === -1) achievements.push(n);
                else if(new Date(n.updatedAt) > new Date(achievements[idx].updatedAt)) achievements[idx] = n;
            });
            saveToLocal(); renderResults(); updateStats(); showToast('å¯¼å…¥æˆåŠŸ','success');
        };
        reader.readAsText(file);
    }
    function escapeHtml(text) { return text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }
    function showToast(msg, type) { const t = document.createElement('div'); t.className=`toast ${type} show`; t.innerText=msg; document.getElementById('toastContainer').appendChild(t); setTimeout(()=>t.remove(), 3000); }

    // --- Init ---
    window.onload = function() {
        OneDriveService.init();
        loadFromLocal().then(() => {
            updateStats();
            renderResults();
            // Init Year Filters
            const years = [...new Set(achievements.map(a=>(a.date||'').slice(0,4)).filter(y=>y))].sort().reverse();
            years.forEach(y => {
                const c = document.createElement('div'); c.className='filter-chip'; c.innerText=y; c.dataset.year=y; c.onclick=()=>setYearFilter(y);
                document.getElementById('filterBar').appendChild(c);
            });
        });
    };
</script>
</body>
</html>

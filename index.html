<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ (å®Œæ•´åŒæ­¥ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --accent: #6366f1;
            --accent-light: #eef2ff;
            --accent-dark: #4f46e5;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-sm: 8px;
            
            /* å°†åŸæ¥çš„ GitHub è‰²ç³»æ”¹ä¸º OneDrive é£æ ¼ */
            --onedrive-color: #0078D4;
            --onedrive-light: #E5F3FF;
        }

        html.dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --border-light: #1e293b;
            --accent-light: #312e81;
            --success-light: #064e3b;
            --warning-light: #78350f;
            --danger-light: #7f1d1d;
            --onedrive-light: #004C87;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }
        .app-container { display: flex; height: 100vh; height: 100dvh; overflow: hidden; }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100%;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }
        .logo-icon {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem;
        }

        .nav-menu { flex: 1; padding: 16px 12px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .nav-section {
            font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
            padding: 12px 12px 8px; margin-top: 8px;
        }
        .nav-section:first-child { margin-top: 0; }

        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary);
            font-weight: 500; transition: all 0.2s; margin-bottom: 4px;
            min-height: 48px;
        }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-light); color: var(--accent); }
        .nav-item .badge {
            margin-left: auto; background: var(--bg-hover); padding: 2px 10px;
            border-radius: 10px; font-size: 0.8rem; font-weight: 600;
        }
        .nav-item.active .badge { background: var(--accent); color: white; }

        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); position: relative; }
        .storage-status {
            font-size: 0.85rem; color: var(--success); margin-bottom: 12px;
            display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
        }
        .storage-status.active { color: var(--onedrive-color); font-weight: 600; }
        .storage-status.warning { color: var(--warning); }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; display: inline-block; }

        .data-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .data-btn {
            padding: 10px 8px; border: 1px solid var(--border); border-radius: var(--radius-sm);
            background: var(--bg-card); color: var(--text-secondary); font-size: 0.85rem;
            cursor: pointer; transition: all 0.2s; text-align: center; min-height: 44px;
            display: flex; align-items: center; justify-content: center; gap: 4px;
        }
        .data-btn:hover { background: var(--bg-hover); border-color: var(--accent); color: var(--accent); }
        
        .data-btn.onedrive { border-color: var(--onedrive-color); color: var(--onedrive-color); font-weight: 600; }
        .data-btn.onedrive:hover { background: var(--onedrive-light); }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute; bottom: 100%; left: 10px; right: 10px;
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg); display: none; z-index: 200; overflow: hidden;
            margin-bottom: 8px;
        }
        .dropdown-menu.show { display: block; animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .menu-item { 
            padding: 14px 16px; cursor: pointer; display: flex; align-items: center; 
            gap: 10px; font-size: 0.95rem; border-bottom: 1px solid var(--border-light);
            min-height: 48px;
        }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:hover { background: var(--bg-hover); color: var(--accent); }

        /* Main Content */
        .main-content { 
            flex: 1; 
            padding: 20px; 
            height: 100vh;
            height: 100dvh;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0; gap: 12px; flex-wrap: wrap; }
        .page-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; flex: 1; justify-content: flex-end; }

        .search-box { flex: 1; min-width: 200px; max-width: 320px; }
        .search-box input {
            padding: 12px 16px; border: 2px solid var(--border); border-radius: var(--radius);
            background: var(--bg-card); color: var(--text-primary); font-size: 16px;
            width: 100%; transition: all 0.2s;
        }
        .search-box input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }

        .btn {
            padding: 12px 20px; border-radius: var(--radius); font-weight: 600; font-size: 0.95rem;
            cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; 
            align-items: center; gap: 8px; white-space: nowrap; min-height: 48px;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; box-shadow: var(--shadow); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; min-height: 36px; }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px; 
            margin-bottom: 16px; 
            flex-shrink: 0; 
        }
        .stat-card { 
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); 
            padding: 14px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; 
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .stat-icon.papers { background: #dbeafe; } 
        .stat-icon.patents { background: #fef3c7; }
        .stat-icon.projects { background: #d1fae5; } 
        .stat-icon.awards { background: #fce7f3; }
        .stat-icon.books { background: #e0e7ff; } 
        .stat-icon.members { background: #f3e8ff; }
        .stat-info h3 { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); }
        .stat-info p { font-size: 0.75rem; color: var(--text-secondary); }

        /* List Layout */
        #listViewContainer { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .filter-container { margin-bottom: 12px; flex-shrink: 0; }
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; }
        .filter-chip {
            padding: 6px 14px; border-radius: 20px; background: var(--bg-card);
            border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.85rem;
            font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .filter-chip:hover { border-color: var(--accent); color: var(--accent); }
        .filter-chip.active { background: var(--accent); border-color: var(--accent); color: white; }
        
        .keyword-bar { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; padding-top: 8px; border-top: 1px dashed var(--border); }
        .keyword-chip { font-size: 0.8rem; padding: 4px 12px; background: var(--bg-hover); border-radius: 12px; color: var(--text-secondary); cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .keyword-chip:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-light); }
        .keyword-chip.active { background: var(--accent); color: white; border-color: var(--accent); }

        .results-container { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            display: flex; flex-direction: column; flex: 1; 
            overflow: hidden; min-height: 0;
        }
        .results-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); 
            flex-wrap: wrap; gap: 10px; flex-shrink: 0;
        }
        .results-count { color: var(--text-secondary); font-size: 0.85rem; }
        .batch-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .select-all-wrapper { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 10px; border-radius: var(--radius-sm); transition: background 0.2s; }
        .select-all-wrapper:hover { background: var(--bg-hover); }
        .select-all-wrapper input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
        
        .results-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        .result-item { 
            display: flex; align-items: center; padding: 12px 16px;
            border-bottom: 1px solid var(--border-light); 
            cursor: pointer; transition: background 0.2s; gap: 12px; min-height: 72px;
        }
        .result-item:hover { background: var(--bg-hover); }
        .result-item:last-child { border-bottom: none; }
        .result-item:active { background: var(--accent-light); }
        .result-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); flex-shrink: 0; }
        .result-type { 
            width: 40px; height: 40px; border-radius: var(--radius-sm); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.2rem; flex-shrink: 0; 
        }
        .type-paper { background: #dbeafe; } .type-patent { background: #fef3c7; }
        .type-project { background: #d1fae5; } .type-award { background: #fce7f3; }
        .type-book { background: #e0e7ff; } .type-member { background: #f3e8ff; }
        
        .result-content { flex: 1; min-width: 0; overflow: hidden; }
        .result-title { 
            font-weight: 600; color: var(--text-primary); font-size: 0.95rem; 
            margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .result-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.8rem; color: var(--text-secondary); }
        .result-meta span { display: flex; align-items: center; gap: 3px; white-space: nowrap; }
        
        .pdf-badge {
            display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px;
            background: var(--accent-light); color: var(--accent);
            border-radius: 12px; font-size: 0.75rem; font-weight: 600;
            cursor: pointer; transition: background 0.2s;
        }
        .pdf-badge:hover { background: var(--accent); color: white; }

        .result-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .action-btn { 
            width: 36px; height: 36px; border: none; background: var(--bg-hover); 
            border-radius: var(--radius-sm); cursor: pointer; display: flex; 
            align-items: center; justify-content: center; transition: all 0.2s; font-size: 1rem; 
        }
        .action-btn:hover { background: var(--accent-light); color: var(--accent); }
        .action-btn.delete:hover { background: var(--danger-light); color: var(--danger); }

        .empty-state { padding: 60px 20px; text-align: center; color: var(--text-secondary); }
        .empty-state h3 { font-size: 1.25rem; margin-bottom: 8px; color: var(--text-primary); }
        .empty-state p { margin-bottom: 20px; }

        /* Modal Styles */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); 
            backdrop-filter: blur(4px); display: flex; align-items: flex-end; 
            justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; 
            transition: all 0.3s; 
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { 
            background: var(--bg-card); border-radius: var(--radius) var(--radius) 0 0; 
            width: 100%; max-width: 600px; max-height: 90vh; max-height: 90dvh;
            overflow: hidden; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; flex-direction: column; 
        }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal.wide { max-width: 800px; }
        .modal-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 20px; border-bottom: 1px solid var(--border); flex-shrink: 0;
        }
        .modal-header h2 { font-size: 1.2rem; font-weight: 700; }
        .modal-close { 
            width: 40px; height: 40px; border: none; background: var(--bg-hover); 
            border-radius: 50%; cursor: pointer; font-size: 1.2rem; 
            display: flex; align-items: center; justify-content: center; 
            color: var(--text-secondary); transition: all 0.2s; 
        }
        .modal-close:hover { background: var(--danger-light); color: var(--danger); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0; }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 14px 16px; border: 2px solid var(--border); 
            border-radius: var(--radius-sm); background: var(--bg-secondary); 
            color: var(--text-primary); font-size: 16px; transition: all 0.2s; 
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); 
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        
        .file-upload { border: 2px dashed var(--border); border-radius: var(--radius); padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-upload:hover { border-color: var(--accent); background: var(--accent-light); }
        .file-upload input { display: none; }
        .file-upload-icon { font-size: 2.5rem; margin-bottom: 12px; }
        .file-upload.has-file { border-color: var(--success); background: var(--success-light); }
        .file-upload-actions { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }

        .excel-preview { max-height: 200px; overflow: auto; border: 1px solid var(--border); border-radius: var(--radius-sm); }
        .excel-preview table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .excel-preview th, .excel-preview td { padding: 10px 12px; border: 1px solid var(--border); text-align: left; white-space: nowrap; }
        .excel-preview th { background: var(--bg-secondary); font-weight: 600; position: sticky; top: 0; }
        
        /* Toast */
        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; }
        .toast { 
            padding: 14px 20px; border-radius: var(--radius-sm); background: var(--bg-card); 
            border: 1px solid var(--border); box-shadow: var(--shadow-lg); font-weight: 500; 
            transform: translateY(-120%); transition: transform 0.3s; text-align: center;
        }
        .toast.show { transform: translateY(0); }
        .toast.success { background: var(--success-light); border-color: var(--success); color: var(--success); }
        .toast.error { background: var(--danger-light); border-color: var(--danger); color: var(--danger); }

        /* Mobile Menu */
        .mobile-menu-btn { display: none; position: fixed; top: 12px; left: 12px; z-index: 101; width: 48px; height: 48px; border: none; background: var(--bg-card); border-radius: var(--radius-sm); box-shadow: var(--shadow); font-size: 1.4rem; cursor: pointer; align-items: center; justify-content: center; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        .sidebar-overlay.active { display: block; }

        @media (min-width: 769px) {
            .modal-overlay { align-items: center; padding: 20px; }
            .modal { border-radius: var(--radius); max-height: 85vh; }
        }
        @media (max-width: 768px) {
            .mobile-menu-btn { display: flex; }
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); width: 85%; max-width: 320px; }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 70px 12px 12px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">ğŸ”¬</div>
                <div>
                    <div>ç§‘ç ”æˆæœç®¡ç†</div>
                    <div style="font-size:0.7rem;color:var(--text-muted);font-weight:400;">æ”¯æŒè‡ªåŠ¨æ–‡ä»¶åŒæ­¥</div>
                </div>
            </div>
        </div>

        <nav class="nav-menu">
            <div class="nav-section">æˆæœç®¡ç†</div>
            <div class="nav-item active" data-view="all" onclick="setView('all')">ğŸ“‹ <span>å…¨éƒ¨æˆæœ</span><span class="badge" id="totalCount">0</span></div>
            <div class="nav-item" data-view="paper" onclick="setView('paper')">ğŸ“„ <span>å­¦æœ¯è®ºæ–‡</span><span class="badge" id="paperCount">0</span></div>
            <div class="nav-item" data-view="patent" onclick="setView('patent')">ğŸ’¡ <span>å‘æ˜ä¸“åˆ©</span><span class="badge" id="patentCount">0</span></div>
            <div class="nav-item" data-view="project" onclick="setView('project')">ğŸ“Š <span>ç§‘ç ”é¡¹ç›®</span><span class="badge" id="projectCount">0</span></div>
            <div class="nav-item" data-view="award" onclick="setView('award')">ğŸ† <span>è·å¥–æƒ…å†µ</span><span class="badge" id="awardCount">0</span></div>
            <div class="nav-item" data-view="book" onclick="setView('book')">ğŸ“š <span>ä¸“è‘—å‡ºç‰ˆ</span><span class="badge" id="bookCount">0</span></div>
            <div class="nav-section">å›¢é˜Ÿç®¡ç†</div>
            <div class="nav-item" data-view="member" onclick="setView('member')">ğŸ‘¥ <span>æˆå‘˜ä¿¡æ¯</span><span class="badge" id="memberCount">0</span></div>
        </nav>

        <div class="sidebar-footer">
            <div class="storage-status" id="storageStatus">
                <span class="sync-dot"></span> <span id="syncText">æœ¬åœ°å­˜å‚¨æ¨¡å¼</span>
            </div>
            <div class="data-actions">
                <button class="data-btn" onclick="toggleMenu('exportMenu')">ğŸ“¤ å¤‡ä»½</button>
                <button class="data-btn" onclick="toggleMenu('importMenu')">ğŸ“¥ æ¢å¤</button>
                <button class="data-btn onedrive" onclick="connectLocalFile()" style="grid-column: span 2;">
                    ğŸ”„ å…³è”æ–‡ä»¶ (è‡ªåŠ¨åŒæ­¥)
                </button>
            </div>
            
            <div id="exportMenu" class="dropdown-menu">
                <div class="menu-item" onclick="exportToExcelFile()">ğŸ“Š å¯¼å‡º Excel</div>
                <div class="menu-item" onclick="exportToWordFile()">ğŸ“ å¯¼å‡º Word</div>
                <div class="menu-item" onclick="performBackup()">ğŸ“¦ å¯¼å‡ºå¤‡ä»½ (.json)</div>
            </div>

            <div id="importMenu" class="dropdown-menu">
                <div class="menu-item" onclick="openExcelImport()">ğŸ“Š å¯¼å…¥ Excel</div>
                <div class="menu-item" onclick="triggerImport()">ğŸ“‚ æ¢å¤å¤‡ä»½ (.json)</div>
            </div>
            <input type="file" id="importInput" class="hidden" accept=".json" onchange="performRestore(event)">
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <h1 class="page-title" id="pageTitle">å…¨éƒ¨æˆæœ</h1>
            <div class="header-actions">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢..." oninput="handleSearch()">
                </div>
                <button class="btn btn-primary" id="addBtn" onclick="openAddModal()">â• æ·»åŠ </button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            </div>

        <div id="listViewContainer">
            <div class="filter-container">
                <div class="filter-bar" id="filterBar">
                    <div class="filter-chip active" data-year="all" onclick="setYearFilter('all')">å…¨éƒ¨å¹´ä»½</div>
                </div>
                <div class="keyword-bar" id="keywordBar" style="display:none;"></div>
            </div>

            <div class="results-container" id="resultsContainer">
                <div class="results-header">
                    <div class="batch-actions">
                        <label class="select-all-wrapper">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <span>å…¨é€‰</span>
                        </label>
                        <button class="btn btn-danger btn-sm" id="batchDeleteBtn" onclick="batchDelete()" style="display:none;">
                            ğŸ—‘ åˆ é™¤ (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span class="results-count" id="resultsCount">å…± 0 æ¡</span>
                        <select id="sortSelect" onchange="handleSort()" style="padding:10px 12px;border-radius:8px;border:2px solid var(--border);">
                            <option value="date-desc">æœ€æ–°ä¼˜å…ˆ</option>
                            <option value="date-asc">æœ€æ—©ä¼˜å…ˆ</option>
                            <option value="title-asc">æ ‡é¢˜æ’åº</option>
                        </select>
                    </div>
                </div>
                <div class="results-list" id="resultsList"></div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="formModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="modalTitle">æ·»åŠ ç§‘ç ”æˆæœ</h2>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="researchForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label>æˆæœç±»å‹ *</label>
                        <select id="type" required onchange="toggleFormFields()">
                            <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                            <option value="patent">å‘æ˜ä¸“åˆ©</option>
                            <option value="project">ç§‘ç ”é¡¹ç›®</option>
                            <option value="award">è·å¥–æƒ…å†µ</option>
                            <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                        </select>
                    </div>
                    <div class="form-group" id="dateGroup">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="date">
                    </div>
                </div>
                
                <div id="generalFields">
                    <div class="form-group"><label>æ ‡é¢˜ *</label><input type="text" id="title" required></div>
                    <div class="form-group"><label>ä½œè€…/æˆå‘˜</label><input type="text" id="authors" placeholder="å¤šä¸ªé€—å·åˆ†éš”"></div>
                    <div class="form-row">
                        <div class="form-group"><label>æ¥æº/æœŸåˆŠ</label><input type="text" id="source"></div>
                        <div class="form-group"><label>çº§åˆ«</label><input type="text" id="level"></div>
                    </div>
                    <div class="form-group"><label>å…³é”®è¯</label><input type="text" id="keywords"></div>
                </div>

                <div id="patentFields" class="hidden">
                    <div class="form-group"><label>ä¸“åˆ©åç§° *</label><input type="text" id="patentName"></div>
                    <div class="form-row">
                        <div class="form-group"><label>ä¸“åˆ©ç±»å‹</label><select id="patentType"><option value="å‘æ˜ä¸“åˆ©">å‘æ˜ä¸“åˆ©</option><option value="å®ç”¨æ–°å‹">å®ç”¨æ–°å‹</option></select></div>
                        <div class="form-group"><label>çŠ¶æ€</label><select id="patentStatus"><option value="ç”³è¯·ä¸­">ç”³è¯·ä¸­</option><option value="å·²æˆæƒ">å·²æˆæƒ</option></select></div>
                    </div>
                    <div class="form-group"><label>å‘æ˜äºº</label><input type="text" id="inventors"></div>
                    <div class="form-row">
                        <div class="form-group"><label>ç”³è¯·æ—¥</label><input type="date" id="applicationDate"></div>
                        <div class="form-group"><label>ä¸“åˆ©å·</label><input type="text" id="patentNumber"></div>
                    </div>
                </div>

                <div id="projectFields" class="hidden">
                    <div class="form-group"><label>é¡¹ç›®åç§° *</label><input type="text" id="projectName"></div>
                    <div class="form-row">
                        <div class="form-group"><label>çº§åˆ«</label><input type="text" id="projectLevel"></div>
                        <div class="form-group"><label>ç¼–å·</label><input type="text" id="projectNumber"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>å¼€å§‹æ—¶é—´</label><input type="date" id="projectStartDate"></div>
                        <div class="form-group"><label>ç»“æŸæ—¶é—´</label><input type="date" id="projectEndDate"></div>
                    </div>
                    <div class="form-group"><label>æ‰€å±å•ä½</label><input type="text" id="projectOrg"></div>
                </div>

                <div class="form-group">
                    <label>ğŸ“ PDF é™„ä»¶ (æ”¯æŒå­˜å‚¨ã€é¢„è§ˆã€ä¸‹è½½)</label>
                    <div class="file-upload" id="fileUploadZone" onclick="document.getElementById('pdfInput').click()">
                        <input type="file" id="pdfInput" accept="application/pdf" onchange="handleFileSelect(event)">
                        <div class="file-upload-icon">ğŸ“„</div>
                        <div class="file-upload-text" id="fileUploadText">ç‚¹å‡»ä¸Šä¼  PDF</div>
                    </div>
                    <div id="fileActions" class="file-upload-actions hidden">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="previewCurrentFile()">ğŸ‘ï¸ é¢„è§ˆ</button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeFile()">ğŸ—‘ åˆ é™¤</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="submit" form="researchForm" class="btn btn-primary">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="memberModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="memberModalTitle">æ·»åŠ æˆå‘˜</h2>
            <button class="modal-close" onclick="closeMemberModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="memberForm" onsubmit="handleMemberSubmit(event)">
                <input type="hidden" id="memberEditId">
                <div class="form-row">
                    <div class="form-group"><label>å­¦å·/å·¥å· *</label><input type="text" id="memberNo" required></div>
                    <div class="form-group"><label>å§“å *</label><input type="text" id="memberName" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>æ€§åˆ«</label><select id="memberGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
                    <div class="form-group"><label>èŒç§°</label><input type="text" id="memberTitle"></div>
                </div>
                <div class="form-group"><label>å•ä½</label><input type="text" id="memberOrg"></div>
                <div class="form-group"><label>é‚®ç®±</label><input type="email" id="memberEmail"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">å–æ¶ˆ</button>
            <button type="submit" form="memberForm" class="btn btn-primary">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="excelModal">
    <div class="modal wide">
        <div class="modal-header"><h2>å¯¼å…¥ Excel</h2><button class="modal-close" onclick="closeExcelModal()">âœ•</button></div>
        <div class="modal-body">
            <div class="form-group">
                <label>å¯¼å…¥ç±»å‹</label>
                <select id="excelImportType"><option value="paper">å­¦æœ¯è®ºæ–‡</option><option value="patent">å‘æ˜ä¸“åˆ©</option><option value="member">æˆå‘˜</option></select>
            </div>
            <div class="file-upload" onclick="document.getElementById('excelInput').click()">
                <input type="file" id="excelInput" accept=".xlsx,.xls" onchange="handleExcelSelect(event)">
                <div class="file-upload-text">ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶</div>
            </div>
            <div id="excelPreviewContainer" class="hidden" style="margin-top:10px;">
                <div class="excel-preview" id="excelPreview"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeExcelModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="importExcelBtn" onclick="confirmExcelImport()" disabled>ç¡®è®¤å¯¼å…¥</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
    // --- Global State ---
    let achievements = [];
    let members = [];
    let currentView = 'all';
    let currentYearFilter = 'all';
    let currentKeywordFilter = null;
    let searchQuery = '';
    let sortOrder = 'date-desc';
    let selectedItems = new Set();
    
    // File Sync State
    let fileHandle = null;
    
    // Temp PDF State
    let currentPdfData = null;
    let currentPdfName = null;
    
    // Excel State
    let excelData = null;

    const typeConfig = {
        paper: { icon: 'ğŸ“„', label: 'å­¦æœ¯è®ºæ–‡', class: 'type-paper' },
        patent: { icon: 'ğŸ’¡', label: 'å‘æ˜ä¸“åˆ©', class: 'type-patent' },
        project: { icon: 'ğŸ“Š', label: 'ç§‘ç ”é¡¹ç›®', class: 'type-project' },
        award: { icon: 'ğŸ†', label: 'è·å¥–æƒ…å†µ', class: 'type-award' },
        book: { icon: 'ğŸ“š', label: 'ä¸“è‘—å‡ºç‰ˆ', class: 'type-book' },
        member: { icon: 'ğŸ‘¤', label: 'æˆå‘˜', class: 'type-member' }
    };

    // --- Initialization ---
    window.onload = async function() {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        await loadFromIndexedDB();
        updateUI();
    };

    function updateUI() {
        updateStats();
        renderResults();
        updateNavBadges();
    }

    // --- IndexedDB ---
    const DB_NAME = 'ResearchDB_V5';
    function getDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if(!db.objectStoreNames.contains('store')) db.createObjectStore('store');
            };
            req.onsuccess = e => resolve(e.target.result);
            req.onerror = e => reject(e);
        });
    }

    async function saveToLocal() {
        const db = await getDB();
        const tx = db.transaction('store', 'readwrite');
        const store = tx.objectStore('store');
        store.put({ achievements, members, updatedAt: new Date().toISOString() }, 'mainData');
        
        // Auto Sync Trigger
        if (fileHandle) {
            await autoSaveToFile();
        } else {
            updateStorageStatus(false);
        }
    }

    async function loadFromIndexedDB() {
        const db = await getDB();
        return new Promise(resolve => {
            const tx = db.transaction('store', 'readonly');
            const req = tx.objectStore('store').get('mainData');
            req.onsuccess = e => {
                const res = e.target.result;
                if (res) {
                    achievements = res.achievements || [];
                    members = res.members || [];
                }
                resolve(true);
            };
        });
    }

    // --- File System Access API (Auto Sync) ---
    async function connectLocalFile() {
        if (!window.showOpenFilePicker) {
            alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ­¤åŠŸèƒ½ï¼Œå»ºè®®ä½¿ç”¨ Chrome/Edge æ¡Œé¢ç‰ˆã€‚");
            return;
        }
        try {
            // Pick file
            [fileHandle] = await window.showOpenFilePicker({
                types: [{ description: 'JSON Database', accept: { 'application/json': ['.json'] } }],
                multiple: false
            });
            
            // Read
            const file = await fileHandle.getFile();
            const text = await file.text();
            if (text) {
                const json = JSON.parse(text);
                // Merge logic: prefer file data if connected
                if (confirm("æ˜¯å¦åŠ è½½è¯¥æ–‡ä»¶çš„æ•°æ®è¦†ç›–å½“å‰é¡µé¢æ•°æ®ï¼Ÿ")) {
                    achievements = json.achievements || [];
                    members = json.members || [];
                    await saveToLocal(); // This will trigger autoSave back to file effectively syncing
                    updateUI();
                }
            }
            updateStorageStatus(true, file.name);
            showToast("âœ… å·²å¼€å¯è‡ªåŠ¨åŒæ­¥", "success");
        } catch (err) {
            console.error(err);
            if (err.name !== 'AbortError') showToast("å…³è”å¤±è´¥: " + err.message, "error");
        }
    }

    async function autoSaveToFile() {
        if (!fileHandle) return;
        try {
            const writable = await fileHandle.createWritable();
            const data = {
                version: '5.0',
                updatedAt: new Date().toISOString(),
                achievements,
                members
            };
            await writable.write(JSON.stringify(data, null, 2));
            await writable.close();
            updateStorageStatus(true, fileHandle.name);
        } catch (err) {
            console.error("Auto save failed", err);
            updateStorageStatus(false);
            fileHandle = null; // Reset on permission loss
            showToast("âš ï¸ è‡ªåŠ¨åŒæ­¥ä¸­æ–­ï¼Œè¯·é‡æ–°å…³è”", "warning");
        }
    }

    function updateStorageStatus(connected, filename) {
        const el = document.getElementById('storageStatus');
        if (connected) {
            el.className = 'storage-status active';
            el.innerHTML = `<span class="sync-dot" style="color:var(--success)"></span> ğŸŸ¢ è‡ªåŠ¨åŒæ­¥: ${filename}`;
        } else {
            el.className = 'storage-status';
            el.innerHTML = `<span class="sync-dot" style="color:var(--text-muted)"></span> æœ¬åœ°å­˜å‚¨æ¨¡å¼`;
        }
    }

    // --- Core Logic ---
    function setView(view) {
        currentView = view;
        selectedItems.clear();
        document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.view === view));
        document.getElementById('pageTitle').textContent = view === 'all' ? 'å…¨éƒ¨æˆæœ' : typeConfig[view].label;
        closeSidebar();
        renderResults();
    }

    function updateStats() {
        const counts = { paper:0, patent:0, project:0, award:0, book:0 };
        achievements.forEach(a => { if(counts[a.type] !== undefined) counts[a.type]++; });
        
        document.getElementById('totalCount').textContent = achievements.length;
        document.getElementById('memberCount').textContent = members.length;
        
        Object.keys(counts).forEach(k => {
            const el = document.getElementById(k+'Count');
            if(el) el.textContent = counts[k];
        });

        const grid = document.getElementById('statsGrid');
        grid.innerHTML = Object.entries(typeConfig).map(([k, cfg]) => {
            const count = k === 'member' ? members.length : counts[k];
            return `<div class="stat-card" onclick="setView('${k}')" style="cursor:pointer">
                <div class="stat-icon ${cfg.class}">${cfg.icon}</div>
                <div class="stat-info"><h3>${count}</h3><p>${cfg.label}</p></div>
            </div>`;
        }).join('');
    }

    function updateNavBadges() {
        // Already updated in updateStats logic sharing IDs
    }

    function renderResults() {
        const list = document.getElementById('resultsList');
        let items = currentView === 'member' ? members : achievements;
        
        if (currentView !== 'all' && currentView !== 'member') {
            items = items.filter(i => i.type === currentView);
        }

        if (currentYearFilter !== 'all') {
            items = items.filter(i => {
                const d = i.date || i.applicationDate || i.projectStartDate || '';
                return d.startsWith(currentYearFilter);
            });
        }

        if (searchQuery) {
            const q = searchQuery.toLowerCase();
            items = items.filter(i => {
                const txt = [i.title, i.memberName, i.authors, i.keywords].join(' ').toLowerCase();
                return txt.includes(q);
            });
        }

        items.sort((a,b) => {
            const da = a.date || a.createdAt || '0';
            const db = b.date || b.createdAt || '0';
            return sortOrder === 'date-desc' ? db.localeCompare(da) : da.localeCompare(db);
        });

        document.getElementById('resultsCount').textContent = `å…± ${items.length} æ¡`;

        if (items.length === 0) {
            list.innerHTML = `<div class="empty-state"><h3>æš‚æ— æ•°æ®</h3><p>ç‚¹å‡»ä¸Šæ–¹â€œæ·»åŠ â€æŒ‰é’®å¼€å§‹</p></div>`;
            return;
        }

        // Generate Year Filter
        const years = [...new Set(achievements.map(a => (a.date||'').substring(0,4)).filter(y=>y))].sort().reverse();
        const filterBar = document.getElementById('filterBar');
        filterBar.innerHTML = `<div class="filter-chip ${currentYearFilter==='all'?'active':''}" onclick="setYearFilter('all')">å…¨éƒ¨</div>` + 
            years.map(y => `<div class="filter-chip ${currentYearFilter===y?'active':''}" onclick="setYearFilter('${y}')">${y}</div>`).join('');

        // Render List
        list.innerHTML = items.map(item => {
            const cfg = typeConfig[item.type] || typeConfig.paper;
            const title = item.type === 'member' ? `${item.memberName} (${item.memberNo})` : (item.title || item.patentName || item.projectName);
            const sub = item.type === 'member' ? (item.memberOrg||'') : (item.authors || item.inventors || item.date);
            const hasPdf = item.pdfData ? `<span class="pdf-badge" onclick="event.stopPropagation(); previewPdf('${item.id}', '${item.type}')">ğŸ“ é¢„è§ˆPDF</span>` : '';
            
            return `<div class="result-item" onclick="editItem('${item.id}', '${item.type}')">
                <input type="checkbox" class="result-checkbox" data-id="${item.id}" onclick="event.stopPropagation(); toggleSelect('${item.id}')">
                <div class="result-type ${cfg.class}">${cfg.icon}</div>
                <div class="result-content">
                    <div class="result-title">${escapeHtml(title)}</div>
                    <div class="result-meta"><span>${escapeHtml(sub)}</span> ${hasPdf}</div>
                </div>
                <div class="result-actions">
                    ${item.pdfData ? `<button class="action-btn" title="ä¸‹è½½" onclick="event.stopPropagation(); downloadPdf('${item.id}', '${item.type}')">â¬‡ï¸</button>` : ''}
                    <button class="action-btn delete" onclick="event.stopPropagation(); deleteItem('${item.id}', '${item.type}')">ğŸ—‘</button>
                </div>
            </div>`;
        }).join('');
    }

    // --- CRUD ---
    function openAddModal() {
        if (currentView === 'member') { openMemberModal(); return; }
        document.getElementById('researchForm').reset();
        document.getElementById('editId').value = '';
        document.getElementById('type').value = currentView === 'all' ? 'paper' : currentView;
        toggleFormFields();
        clearFile();
        document.getElementById('modalTitle').textContent = 'æ·»åŠ æˆæœ';
        document.getElementById('formModal').classList.add('active');
    }

    function editItem(id, type) {
        if (type === 'member') { editMember(id); return; }
        const item = achievements.find(i => i.id === id);
        if (!item) return;

        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘æˆæœ';
        document.getElementById('editId').value = id;
        document.getElementById('type').value = item.type;
        toggleFormFields();

        // Populate fields
        if (item.type === 'patent') {
            ['patentName', 'patentType', 'patentStatus', 'inventors', 'applicationDate', 'patentNumber'].forEach(k => {
                const el = document.getElementById(k); if(el) el.value = item[k] || '';
            });
        } else if (item.type === 'project') {
            ['projectName', 'projectLevel', 'projectNumber', 'projectStartDate', 'projectEndDate', 'projectOrg'].forEach(k => {
                const el = document.getElementById(k); if(el) el.value = item[k] || '';
            });
        } else {
            ['title', 'authors', 'date', 'source', 'level', 'keywords'].forEach(k => {
                const el = document.getElementById(k); if(el) el.value = item[k] || '';
            });
        }

        // Populate PDF
        if (item.pdfData) {
            currentPdfData = item.pdfData;
            currentPdfName = item.pdfName;
            updateFileUI();
        } else {
            clearFile();
        }
        
        document.getElementById('formModal').classList.add('active');
    }

    function handleSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const type = document.getElementById('type').value;
        let data = {
            id: id || Date.now().toString(),
            type,
            updatedAt: new Date().toISOString(),
            pdfData: currentPdfData,
            pdfName: currentPdfName
        };

        if (type === 'patent') {
            ['patentName', 'patentType', 'patentStatus', 'inventors', 'applicationDate', 'patentNumber'].forEach(k => data[k] = document.getElementById(k).value);
            data.title = data.patentName; data.date = data.applicationDate;
        } else if (type === 'project') {
            ['projectName', 'projectLevel', 'projectNumber', 'projectStartDate', 'projectEndDate', 'projectOrg'].forEach(k => data[k] = document.getElementById(k).value);
            data.title = data.projectName; data.date = data.projectStartDate;
        } else {
            ['title', 'authors', 'date', 'source', 'level', 'keywords'].forEach(k => data[k] = document.getElementById(k).value);
        }

        if (id) {
            const idx = achievements.findIndex(a => a.id === id);
            if(idx > -1) achievements[idx] = { ...achievements[idx], ...data };
        } else {
            data.createdAt = new Date().toISOString();
            achievements.push(data);
        }

        saveToLocal();
        closeModal();
        updateUI();
        showToast('ä¿å­˜æˆåŠŸ', 'success');
    }

    function deleteItem(id, type) {
        if (!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) return;
        if (type === 'member') members = members.filter(m => m.id !== id);
        else achievements = achievements.filter(a => a.id !== id);
        saveToLocal();
        updateUI();
        showToast('å·²åˆ é™¤', 'success');
    }

    // --- Member Logic ---
    function openMemberModal() {
        document.getElementById('memberForm').reset();
        document.getElementById('memberEditId').value = '';
        document.getElementById('memberModalTitle').textContent = 'æ·»åŠ æˆå‘˜';
        document.getElementById('memberModal').classList.add('active');
    }
    function editMember(id) {
        const m = members.find(i => i.id === id);
        if(!m) return;
        document.getElementById('memberEditId').value = id;
        document.getElementById('memberModalTitle').textContent = 'ç¼–è¾‘æˆå‘˜';
        ['memberNo','memberName','memberGender','memberTitle','memberOrg','memberEmail'].forEach(k => {
            document.getElementById(k).value = m[k] || '';
        });
        document.getElementById('memberModal').classList.add('active');
    }
    function handleMemberSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('memberEditId').value;
        let data = { id: id || Date.now().toString(), updatedAt: new Date().toISOString() };
        ['memberNo','memberName','memberGender','memberTitle','memberOrg','memberEmail'].forEach(k => {
            data[k] = document.getElementById(k).value;
        });
        
        if(id) {
            const idx = members.findIndex(m => m.id === id);
            if(idx > -1) members[idx] = { ...members[idx], ...data };
        } else {
            data.createdAt = new Date().toISOString();
            members.push(data);
        }
        saveToLocal();
        closeMemberModal();
        updateUI();
        showToast('ä¿å­˜æˆåŠŸ', 'success');
    }

    // --- PDF Handling (Fixed) ---
    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 20 * 1024 * 1024) { alert("æ–‡ä»¶è¿‡å¤§(>20MB)"); return; }
        
        const reader = new FileReader();
        reader.onload = function(evt) {
            currentPdfData = evt.target.result;
            currentPdfName = file.name;
            updateFileUI();
        };
        reader.readAsDataURL(file);
    }

    function updateFileUI() {
        const zone = document.getElementById('fileUploadZone');
        const text = document.getElementById('fileUploadText');
        const actions = document.getElementById('fileActions');
        
        if (currentPdfData) {
            zone.classList.add('has-file');
            text.textContent = `âœ… å·²å°±ç»ª: ${currentPdfName}`;
            actions.classList.remove('hidden');
        } else {
            zone.classList.remove('has-file');
            text.textContent = 'ç‚¹å‡»ä¸Šä¼  PDF';
            actions.classList.add('hidden');
        }
    }

    function clearFile() {
        currentPdfData = null;
        currentPdfName = null;
        document.getElementById('pdfInput').value = '';
        updateFileUI();
    }

    function previewCurrentFile() {
        if (currentPdfData) openPdf(currentPdfData);
    }

    function previewPdf(id, type) {
        const item = achievements.find(a => a.id === id);
        if (item && item.pdfData) openPdf(item.pdfData);
    }

    function downloadPdf(id, type) {
        const item = achievements.find(a => a.id === id);
        if (item && item.pdfData) {
            const a = document.createElement('a');
            a.href = item.pdfData;
            a.download = item.pdfName || 'download.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    }

    function openPdf(base64) {
        const win = window.open();
        win.document.write(`<iframe src="${base64}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
    }

    // --- Helper Functions ---
    function toggleFormFields() {
        const type = document.getElementById('type').value;
        document.getElementById('generalFields').classList.toggle('hidden', type === 'patent' || type === 'project');
        document.getElementById('patentFields').classList.toggle('hidden', type !== 'patent');
        document.getElementById('projectFields').classList.toggle('hidden', type !== 'project');
        document.getElementById('dateGroup').classList.toggle('hidden', type === 'patent' || type === 'project');
    }

    function closeModal() { document.getElementById('formModal').classList.remove('active'); }
    function closeMemberModal() { document.getElementById('memberModal').classList.remove('active'); }
    function closeExcelModal() { document.getElementById('excelModal').classList.remove('active'); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('active'); }
    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('active'); }
    function toggleMenu(id) { 
        document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
        document.getElementById(id).classList.add('show'); 
    }
    document.addEventListener('click', e => {
        if(!e.target.closest('.data-btn') && !e.target.closest('.dropdown-menu')) document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
    });

    function setYearFilter(y) { currentYearFilter = y; renderResults(); updateFilterUI(); }
    function handleSearch() { searchQuery = document.getElementById('searchInput').value; renderResults(); }
    function handleSort() { sortOrder = document.getElementById('sortSelect').value; renderResults(); }
    
    function toggleSelect(id) {
        if(selectedItems.has(id)) selectedItems.delete(id); else selectedItems.add(id);
        updateBatchUI();
    }
    function toggleSelectAll() {
        const all = document.getElementById('selectAll').checked;
        const list = currentView === 'member' ? members : achievements;
        selectedItems.clear();
        if(all) list.forEach(i => selectedItems.add(i.id));
        document.querySelectorAll('.result-checkbox').forEach(c => c.checked = all);
        updateBatchUI();
    }
    function updateBatchUI() {
        const btn = document.getElementById('batchDeleteBtn');
        const count = selectedItems.size;
        document.getElementById('selectedCount').textContent = count;
        btn.style.display = count > 0 ? 'inline-flex' : 'none';
    }
    function batchDelete() {
        if(!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedItems.size} é¡¹?`)) return;
        if(currentView === 'member') members = members.filter(m => !selectedItems.has(m.id));
        else achievements = achievements.filter(a => !selectedItems.has(a.id));
        selectedItems.clear();
        saveToLocal();
        updateUI();
    }

    // --- Export/Import ---
    function performBackup() {
        const blob = new Blob([JSON.stringify({achievements, members}, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        showToast("å¤‡ä»½ä¸‹è½½æˆåŠŸ", "success");
    }

    function performRestore(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async function(evt) {
            try {
                const json = JSON.parse(evt.target.result);
                if(confirm("ç¡®å®šè¦†ç›–å½“å‰æ•°æ®?")) {
                    achievements = json.achievements || [];
                    members = json.members || [];
                    await saveToLocal();
                    updateUI();
                    showToast("æ¢å¤æˆåŠŸ", "success");
                }
            } catch(err) { showToast("æ–‡ä»¶æ ¼å¼é”™è¯¯", "error"); }
        };
        reader.readAsText(file);
    }

    function exportToExcelFile() {
        if(!achievements.length && !members.length) { showToast("æ— æ•°æ®å¯å¯¼å‡º", "warning"); return; }
        const wb = XLSX.utils.book_new();
        if(achievements.length) {
            const data = achievements.map(a => ({
                ç±»å‹: typeConfig[a.type].label,
                æ ‡é¢˜: a.title || a.patentName || a.projectName,
                æ—¥æœŸ: a.date || a.applicationDate || a.projectStartDate,
                äººå‘˜: a.authors || a.inventors
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "æˆæœ");
        }
        if(members.length) {
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(members), "æˆå‘˜");
        }
        XLSX.writeFile(wb, `export_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function exportToWordFile() {
        let content = `<h1>ç§‘ç ”æˆæœæŠ¥è¡¨</h1>`;
        achievements.forEach((a, i) => {
            content += `<p><b>${i+1}. ${a.title||a.patentName}</b><br>ç±»å‹: ${typeConfig[a.type].label}<br>æ—¥æœŸ: ${a.date||'--'}</p><hr>`;
        });
        const blob = new Blob(['\ufeff', `<html><body>${content}</body></html>`], {type:'application/msword'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'report.doc';
        a.click();
    }

    // --- Excel Import Logic ---
    function openExcelImport() { document.getElementById('excelModal').classList.add('active'); }
    function handleExcelSelect(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
            const wb = XLSX.read(evt.target.result, {type:'binary'});
            excelData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            document.getElementById('excelPreview').innerHTML = `<pre>${JSON.stringify(excelData.slice(0,3), null, 2)}</pre>`;
            document.getElementById('importExcelBtn').disabled = false;
        };
        reader.readAsBinaryString(file);
    }
    function confirmExcelImport() {
        if(!excelData) return;
        const type = document.getElementById('excelImportType').value;
        const count = excelData.length;
        // Simple mapping assumption: Map first few columns
        excelData.forEach(row => {
            const item = { id: Date.now()+Math.random(), type, createdAt: new Date().toISOString() };
            if(type === 'member') {
                item.memberName = Object.values(row)[0]; // Assume 1st col is name
                members.push(item);
            } else {
                item.title = Object.values(row)[0];
                achievements.push(item);
            }
        });
        saveToLocal();
        closeExcelModal();
        updateUI();
        showToast(`æˆåŠŸå¯¼å…¥ ${count} æ¡`, "success");
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function showToast(msg, type) {
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.textContent = msg;
        document.getElementById('toastContainer').appendChild(el);
        requestAnimationFrame(() => el.classList.add('show'));
        setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 3000);
    }
</script>
</body>
</html>

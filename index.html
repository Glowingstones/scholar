<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ (å®Œæ•´ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS æ ·å¼è¡¨ (å®Œæ•´ä¿ç•™) --- */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --accent: #6366f1;
            --accent-light: #eef2ff;
            --accent-dark: #4f46e5;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --od-blue: #0078D4;
            --od-hover: #005a9e;
            --od-light: #f3f9fd;
        }

        html.dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --border-light: #1e293b;
            --accent-light: #312e81;
            --success-light: #064e3b;
            --warning-light: #78350f;
            --danger-light: #7f1d1d;
            --od-light: #002c4e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }
        .app-container { display: flex; height: 100vh; height: 100dvh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; height: 100%; z-index: 100; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }
        .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
        .nav-menu { flex: 1; padding: 16px 12px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .nav-section { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 12px 12px 8px; margin-top: 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary); font-weight: 500; transition: all 0.2s; margin-bottom: 4px; min-height: 48px; }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-light); color: var(--accent); }
        .nav-item.disabled { opacity: 0.5; pointer-events: none; cursor: not-allowed; }
        .nav-item .badge { margin-left: auto; background: var(--bg-hover); padding: 2px 10px; border-radius: 10px; font-size: 0.8rem; font-weight: 600; }
        .nav-item.active .badge { background: var(--accent); color: white; }
        
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); position: relative; }
        .storage-status { font-size: 0.85rem; color: var(--success); margin-bottom: 12px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .storage-status.warning { color: var(--warning); }
        .data-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .data-btn { padding: 10px 8px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text-secondary); font-size: 0.85rem; cursor: pointer; transition: all 0.2s; text-align: center; min-height: 44px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .data-btn:hover { background: var(--bg-hover); border-color: var(--accent); color: var(--accent); }
        .data-btn.disabled { opacity: 0.5; pointer-events: none; background: var(--bg-hover); color: var(--text-muted); border-color: var(--border); }
        .data-btn.onedrive { border-color: var(--od-blue); color: var(--od-blue); }
        .data-btn.onedrive:hover { background: var(--od-light); }
        
        .dropdown-menu { position: absolute; bottom: 100%; left: 10px; right: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: var(--shadow-lg); display: none; z-index: 200; overflow: hidden; margin-bottom: 8px; }
        .dropdown-menu.show { display: block; animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .menu-item { padding: 14px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; border-bottom: 1px solid var(--border-light); min-height: 48px; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:hover { background: var(--bg-hover); color: var(--accent); }
        .menu-item.disabled { opacity: 0.5; pointer-events: none; color: var(--text-muted); }

        /* Main Content */
        .main-content { flex: 1; padding: 20px; height: 100vh; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0; gap: 12px; flex-wrap: wrap; }
        .page-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; flex: 1; justify-content: flex-end; }
        
        /* UI Components */
        .search-box { flex: 1; min-width: 200px; max-width: 320px; }
        .search-box input { padding: 12px 16px; border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg-card); color: var(--text-primary); font-size: 16px; width: 100%; transition: all 0.2s; }
        .search-box input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
        
        .btn { padding: 12px 20px; border-radius: var(--radius); font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; min-height: 48px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; box-shadow: var(--shadow); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; min-height: 36px; }
        .btn:disabled, .btn.disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn-icon { width: 40px; height: 40px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--bg-card); border: 1px solid var(--border); cursor: pointer; color: var(--text-secondary); }
        .btn-icon:hover { background: var(--bg-hover); color: var(--accent); }
        .btn-od { background: var(--od-blue); color: white; border: none; }
        .btn-od:hover { background: var(--od-hover); }
        .btn-od-outline { background: transparent; border: 2px solid var(--od-blue); color: var(--od-blue); }
        .btn-od-outline:hover { background: var(--od-light); }

        /* Stats & List */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px; flex-shrink: 0; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; cursor: pointer; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); border-color: var(--accent); }
        .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .stat-icon.papers { background: #dbeafe; } .stat-icon.patents { background: #fef3c7; } .stat-icon.projects { background: #d1fae5; } .stat-icon.awards { background: #fce7f3; } .stat-icon.books { background: #e0e7ff; } .stat-icon.members { background: #f3e8ff; } .stat-icon.trash { background: #fee2e2; color: #ef4444; }
        .stat-info h3 { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); }
        .stat-info p { font-size: 0.75rem; color: var(--text-secondary); }

        #listViewContainer { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .filter-container { margin-bottom: 12px; flex-shrink: 0; }
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; }
        .filter-chip { padding: 6px 14px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .filter-chip.active { background: var(--accent); border-color: var(--accent); color: white; }
        .date-range-filter { display: flex; align-items: center; gap: 8px; background: var(--bg-card); padding: 4px 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); }
        .date-range-filter input { border: none; background: transparent; color: var(--text-primary); width: 110px; font-size: 0.85rem; }

        .results-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); display: flex; flex-direction: column; flex: 1; overflow: hidden; min-height: 0; }
        .results-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); flex-wrap: wrap; gap: 10px; flex-shrink: 0; }
        .results-count { color: var(--text-secondary); font-size: 0.85rem; }
        .batch-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .results-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .results-footer { padding: 10px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary); }
        
        .result-item { display: flex; align-items: flex-start; padding: 12px 16px; border-bottom: 1px solid var(--border-light); cursor: pointer; transition: background 0.2s; gap: 12px; min-height: 72px; }
        .result-item:hover { background: var(--bg-hover); }
        .result-checkbox { margin-top: 12px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); flex-shrink: 0; }
        .result-type { margin-top: 0; width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .type-paper { background: #dbeafe; } .type-patent { background: #fef3c7; } .type-project { background: #d1fae5; } .type-award { background: #fce7f3; } .type-book { background: #e0e7ff; } .type-member { background: #f3e8ff; }
        
        .result-content { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .result-title { font-weight: 600; color: var(--text-primary); font-size: 0.95rem; margin-bottom: 6px; white-space: normal; line-height: 1.4; }
        .result-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; }
        .result-meta span { display: inline-flex; align-items: center; gap: 3px; white-space: normal; }
        .result-meta .has-pdf { color: var(--accent); font-weight: 500; }
        
        .result-actions { display: flex; gap: 6px; flex-shrink: 0; align-items: center; margin-top: 2px; }
        .action-btn { width: 36px; height: 36px; border: none; background: var(--bg-hover); border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 1rem; }
        .action-btn:hover { background: var(--accent-light); color: var(--accent); }
        .action-btn.delete:hover { background: var(--danger-light); color: var(--danger); }
        .action-btn.restore:hover { background: var(--success-light); color: var(--success); }

        .empty-state { padding: 60px 20px; text-align: center; color: var(--text-secondary); }
        .empty-state h3 { font-size: 1.25rem; margin-bottom: 8px; color: var(--text-primary); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: flex-end; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border-radius: var(--radius) var(--radius) 0 0; width: 100%; max-width: 600px; max-height: 90vh; max-height: 90dvh; overflow: hidden; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal.wide { max-width: 800px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .modal-header h2 { font-size: 1.2rem; font-weight: 700; }
        .modal-close { width: 40px; height: 40px; border: none; background: var(--bg-hover); border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); transition: all 0.2s; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0; }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary); font-size: 16px; transition: all 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .input-group { display: flex; gap: 8px; }

        .file-upload { border: 2px dashed var(--border); border-radius: var(--radius); padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-upload:hover { border-color: var(--accent); background: var(--accent-light); }
        .file-upload.has-file { display: none; }
        .file-info { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--accent-light); border-radius: var(--radius-sm); border: 1px solid var(--accent); }
        .file-remove { width: 32px; height: 32px; border: none; background: var(--danger-light); color: var(--danger); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* OCR & Detail */
        .ocr-section { margin-top: 10px; padding: 15px; background: var(--bg-hover); border-radius: var(--radius-sm); display: none; border: 1px solid var(--border); }
        .detail-row { display: flex; padding: 12px 0; border-bottom: 1px solid var(--border-light); }
        .detail-label { width: 100px; flex-shrink: 0; font-weight: 600; color: var(--text-secondary); }
        .detail-value { flex: 1; color: var(--text-primary); word-break: break-all; }

        .pagination { display: flex; align-items: center; gap: 8px; }
        .page-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); background: var(--bg-card); border-radius: 6px; cursor: pointer; color: var(--text-primary); }
        .page-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .confirm-dialog { background: var(--bg-card); border-radius: var(--radius); padding: 24px; max-width: 360px; width: 90%; text-align: center; }
        .confirm-dialog .btn-group { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }

        .login-overlay { position: fixed; inset: 0; background: var(--bg-primary); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .login-box { background: var(--bg-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border); }

        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; }
        .toast { padding: 14px 20px; border-radius: var(--radius-sm); background: var(--bg-card); border: 1px solid var(--border); box-shadow: var(--shadow-lg); font-weight: 500; transform: translateY(-120%); transition: transform 0.3s; text-align: center; }
        .toast.show { transform: translateY(0); }
        .toast.success { background: var(--success-light); border-color: var(--success); color: var(--success); }
        .toast.error { background: var(--danger-light); border-color: var(--danger); color: var(--danger); }
        .toast.warning { background: var(--warning-light); border-color: var(--warning); color: var(--warning); }

        .mobile-menu-btn { display: none; position: fixed; top: 12px; left: 12px; z-index: 101; width: 48px; height: 48px; border: none; background: var(--bg-card); border-radius: var(--radius-sm); box-shadow: var(--shadow); font-size: 1.4rem; cursor: pointer; align-items: center; justify-content: center; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        .sidebar-overlay.active { display: block; }

        @media (min-width: 769px) { .modal-overlay { align-items: center; padding: 20px; } .modal { border-radius: var(--radius); max-height: 85vh; } }
        @media (max-width: 768px) {
            .mobile-menu-btn { display: flex; }
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); width: 85%; max-width: 320px; }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 70px 12px 12px; }
            .header { flex-direction: column; align-items: stretch; }
            .header-actions { width: 100%; justify-content: stretch; }
            .search-box { max-width: none; min-width: 0; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-overlay">
    <div class="login-box">
        <div style="font-size:2.5rem;margin-bottom:15px;">ğŸ”¬</div>
        <h2 style="margin-bottom:10px;color:var(--accent);">ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ</h2>
        <p style="color:var(--text-secondary);margin-bottom:20px;">è¯·è¾“å…¥è®¿é—®å¯†ç </p>
        <div class="form-group">
            <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ..." onkeyup="if(event.key==='Enter') checkLogin()">
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="checkLogin()">ç™»å½•</button>
        <div style="margin-top:15px; font-size:0.8rem; color:var(--text-muted);">ç®¡ç†å‘˜: 1399 | å®¾å®¢: guest</div>
    </div>
</div>

<button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo"><span class="logo-icon">ğŸ”¬</span> ç§‘ç ”ç®¡ç† Pro</div>
        </div>

        <nav class="nav-menu">
            <div class="nav-section">æˆæœç®¡ç†</div>
            <div class="nav-item active" data-view="all" onclick="setView('all')">ğŸ“‹ <span>å…¨éƒ¨æˆæœ</span> <span class="badge" id="totalCount">0</span></div>
            <div class="nav-item" data-view="paper" onclick="setView('paper')">ğŸ“„ <span>å­¦æœ¯è®ºæ–‡</span> <span class="badge" id="paperCount">0</span></div>
            <div class="nav-item" data-view="patent" onclick="setView('patent')">ğŸ’¡ <span>å‘æ˜ä¸“åˆ©</span> <span class="badge" id="patentCount">0</span></div>
            <div class="nav-item" data-view="project" onclick="setView('project')">ğŸ“Š <span>ç§‘ç ”é¡¹ç›®</span> <span class="badge" id="projectCount">0</span></div>
            <div class="nav-item" data-view="award" onclick="setView('award')">ğŸ† <span>è·å¥–æƒ…å†µ</span> <span class="badge" id="awardCount">0</span></div>
            <div class="nav-item" data-view="book" onclick="setView('book')">ğŸ“š <span>ä¸“è‘—å‡ºç‰ˆ</span> <span class="badge" id="bookCount">0</span></div>
            <div class="nav-section">å›¢é˜Ÿç®¡ç†</div>
            <div class="nav-item" data-view="member" id="navMember" onclick="setView('member')">ğŸ‘¥ <span>æˆå‘˜ä¿¡æ¯</span> <span class="badge" id="memberCount">0</span></div>
            <div class="nav-section">ç³»ç»Ÿ</div>
            <div class="nav-item" data-view="trash" onclick="setView('trash')">ğŸ—‘ <span>å›æ”¶ç«™</span></div>
            <div class="nav-item" data-view="logs" onclick="setView('logs')">ğŸ“ <span>æ“ä½œæ—¥å¿—</span></div>
        </nav>

        <div class="sidebar-footer">
            <div class="storage-status" id="storageStatus">âœ“ æ•°æ®å·²æœ¬åœ°ä¿å­˜</div>
            <div class="data-actions">
                <button class="data-btn" onclick="toggleMenu('exportMenu')">ğŸ“¤ å¯¼å‡º</button>
                <button class="data-btn" onclick="toggleMenu('importMenu')">ğŸ“¥ å¯¼å…¥</button>
                <button class="data-btn onedrive" id="btnOneDrive" onclick="openBackupModal()" style="grid-column: span 2;">â˜ï¸ OneDrive åŒæ­¥</button>
            </div>
            
            <div id="exportMenu" class="dropdown-menu">
                <div class="menu-item" onclick="exportToExcelFile()">ğŸ“Š å¯¼å‡º Excel (åˆ†è¡¨)</div>
                <div class="menu-item" onclick="exportToWordFile()">ğŸ“ å¯¼å‡ºç®€å† Word</div>
                <div class="menu-item" id="menuExportJson" onclick="exportData()">ğŸ“¦ å¯¼å‡ºçº¯ JSON</div>
            </div>

            <div id="importMenu" class="dropdown-menu">
                <div class="menu-item" onclick="openExcelImport()">ğŸ“Š å¯¼å…¥ Excel</div>
                <div class="menu-item" onclick="triggerImport()">ğŸ“‚ æ¢å¤ JSON</div>
            </div>
            <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(event)">
            <button class="btn btn-sm btn-secondary" onclick="location.reload()" style="width:100%; margin-top:10px;">ğŸ”’ é€€å‡ºç™»å½•</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <h1 class="page-title" id="pageTitle">å…¨éƒ¨æˆæœ</h1>
            <div class="header-actions">
                <button class="btn-icon" onclick="toggleDarkMode()" title="åˆ‡æ¢æ¨¡å¼">ğŸŒ“</button>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢ (æ ‡é¢˜/ä½œè€…/DOI)..." oninput="handleSearch()">
                </div>
                <button class="btn btn-primary" id="addBtn" onclick="openAddModal()">â• <span id="addBtnText">æ·»åŠ </span></button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
             <div class="stat-card" onclick="setView('paper')"><div class="stat-icon papers">ğŸ“„</div><div class="stat-info"><h3 id="statPaper">0</h3><p>è®ºæ–‡</p></div></div>
             <div class="stat-card" onclick="setView('patent')"><div class="stat-icon patents">ğŸ’¡</div><div class="stat-info"><h3 id="statPatent">0</h3><p>ä¸“åˆ©</p></div></div>
             <div class="stat-card" onclick="setView('project')"><div class="stat-icon projects">ğŸ“Š</div><div class="stat-info"><h3 id="statProject">0</h3><p>é¡¹ç›®</p></div></div>
             <div class="stat-card" onclick="setView('award')"><div class="stat-icon awards">ğŸ†</div><div class="stat-info"><h3 id="statAward">0</h3><p>è·å¥–</p></div></div>
             <div class="stat-card" onclick="setView('book')"><div class="stat-icon books">ğŸ“š</div><div class="stat-info"><h3 id="statBook">0</h3><p>è‘—ä½œ</p></div></div>
             <div class="stat-card" onclick="setView('member')"><div class="stat-icon members">ğŸ‘¥</div><div class="stat-info"><h3 id="statMember">0</h3><p>æˆå‘˜</p></div></div>
        </div>

        <div id="listViewContainer">
            <div class="filter-container">
                <div class="filter-bar" id="filterBar">
                    <div class="filter-chip active" data-year="all" onclick="setYearFilter('all')">å…¨éƒ¨å¹´ä»½</div>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <div class="date-range-filter">
                        <input type="date" id="filterStartDate" onchange="handleDateRangeFilter()">
                        <span style="color:var(--text-muted)">-</span>
                        <input type="date" id="filterEndDate" onchange="handleDateRangeFilter()">
                    </div>
                </div>
            </div>

            <div class="results-container">
                <div class="results-header">
                    <div class="batch-actions">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> å…¨é€‰
                        </label>
                        <button class="btn btn-danger btn-sm" id="batchDeleteBtn" onclick="batchDelete()" style="display:none;">ğŸ—‘ åˆ é™¤</button>
                        <button class="btn btn-secondary btn-sm" id="batchRestoreBtn" onclick="batchRestore()" style="display:none;">â™»ï¸ æ¢å¤</button>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span class="results-count" id="resultsCount">å…± 0 æ¡</span>
                        <select id="sortSelect" onchange="handleSort()" style="padding:6px;border-radius:6px;border:1px solid var(--border);">
                            <option value="date-desc">æœ€æ–°ä¼˜å…ˆ</option>
                            <option value="date-asc">æœ€æ—©ä¼˜å…ˆ</option>
                            <option value="title-asc">æ ‡é¢˜æ’åº</option>
                        </select>
                    </div>
                </div>
                <div class="results-list" id="resultsList"></div>
                <div class="results-footer">
                    <div class="pagination">
                        <button class="page-btn" onclick="prevPage()" id="btnPrevPage">â†</button>
                        <span style="font-size: 0.9rem;" id="pageIndicator">1 / 1</span>
                        <button class="page-btn" onclick="nextPage()" id="btnNextPage">â†’</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="formModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="modalTitle">æ·»åŠ ç§‘ç ”æˆæœ</h2>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="researchForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label>æˆæœç±»å‹ *</label>
                        <select id="type" required onchange="toggleFormFields()">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                            <option value="patent">å‘æ˜ä¸“åˆ©</option>
                            <option value="project">ç§‘ç ”é¡¹ç›®</option>
                            <option value="award">è·å¥–æƒ…å†µ</option>
                            <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                        </select>
                    </div>
                    <div class="form-group" id="dateGroup">
                        <label>æ—¥æœŸ (å‘è¡¨/ç”³è¯·/å¼€å§‹) *</label>
                        <input type="date" id="commonDate" required>
                    </div>
                </div>

                <div id="paperFields" class="hidden">
                    <div class="form-group"><label>è®ºæ–‡æ ‡é¢˜ *</label><input type="text" id="title" placeholder="è¯·è¾“å…¥æ ‡é¢˜"></div>
                    <div class="form-group"><label>ä½œè€… (é€—å·åˆ†éš”)</label><input type="text" id="authors"></div>
                    <div class="form-row">
                        <div class="form-group"><label>æœŸåˆŠ/ä¼šè®®</label><input type="text" id="source"></div>
                        <div class="form-group"><label>çº§åˆ« (SCI/EI/æ ¸å¿ƒ)</label><input type="text" id="level"></div>
                    </div>
                    <div class="form-group">
                        <label>DOI (è¾“å…¥åç‚¹å‡»æŠ“å–)</label>
                        <div class="input-group">
                            <input type="text" id="doi" placeholder="10.xxx/xxx">
                            <button type="button" class="btn btn-secondary" onclick="fetchByDOI()">â˜ï¸ æŠ“å–</button>
                        </div>
                    </div>
                </div>

                <div id="patentFields" class="hidden">
                    <div class="form-group"><label>ä¸“åˆ©åç§° *</label><input type="text" id="patentName"></div>
                    <div class="form-row">
                        <div class="form-group"><label>ç±»å‹</label>
                            <select id="patentType">
                                <option value="å‘æ˜ä¸“åˆ©">å‘æ˜ä¸“åˆ©</option>
                                <option value="å®ç”¨æ–°å‹">å®ç”¨æ–°å‹</option>
                                <option value="å¤–è§‚è®¾è®¡">å¤–è§‚è®¾è®¡</option>
                            </select>
                        </div>
                        <div class="form-group"><label>çŠ¶æ€</label>
                            <select id="patentStatus">
                                <option value="å—ç†">å—ç†</option>
                                <option value="æˆæƒ">æˆæƒ</option>
                                <option value="å®¡ä¸­">å®¡ä¸­</option>
                                <option value="å¤±æ•ˆ">å¤±æ•ˆ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>å‘æ˜äºº</label><input type="text" id="inventors"></div>
                        <div class="form-group"><label>ä¸“åˆ©æƒäºº</label><input type="text" id="patentOwner"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>ä¸“åˆ©å·</label><input type="text" id="patentNumber"></div>
                        <div class="form-group"><label>æˆæƒå…¬å‘Šæ—¥</label><input type="date" id="grantDate"></div>
                    </div>
                </div>

                <div id="projectFields" class="hidden">
                    <div class="form-group"><label>é¡¹ç›®åç§° *</label><input type="text" id="projectName"></div>
                    <div class="form-row">
                        <div class="form-group"><label>çº§åˆ«</label><input type="text" id="projectLevel"></div>
                        <div class="form-group"><label>ç¼–å·</label><input type="text" id="projectNumber"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>æ‰€å±å•ä½</label><input type="text" id="projectOrg"></div>
                        <div class="form-group"><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="projectEndDate"></div>
                    </div>
                </div>

                <div id="awardFields" class="hidden">
                    <div class="form-group"><label>å¥–é¡¹åç§° *</label><input type="text" id="awardName"></div>
                    <div class="form-group"><label>è·å¥–äºº</label><input type="text" id="awardRecipients"></div>
                    <div class="form-row">
                        <div class="form-group"><label>æˆå¥–å•ä½</label><input type="text" id="awardAgency"></div>
                        <div class="form-group"><label>è·å¥–çº§åˆ«</label><input type="text" id="awardLevel"></div>
                    </div>
                </div>

                <div id="bookFields" class="hidden">
                    <div class="form-group"><label>è‘—ä½œåç§° *</label><input type="text" id="bookTitle"></div>
                    <div class="form-group"><label>ä½œè€…</label><input type="text" id="bookAuthors"></div>
                    <div class="form-row">
                        <div class="form-group"><label>å‡ºç‰ˆç¤¾</label><input type="text" id="bookPublisher"></div>
                        <div class="form-group">
                            <label>ISBN</label>
                            <div class="input-group">
                                <input type="text" id="bookIsbn">
                                <button type="button" class="btn btn-secondary" onclick="fetchByISBN()">â˜ï¸</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top:20px; border-top:1px solid var(--border); padding-top:10px;">
                    <label>ğŸ“ é™„ä»¶ / OCR è¯†åˆ«</label>
                    <div class="file-upload" id="fileUpload" onclick="document.getElementById('pdfInput').click()">
                        <input type="file" id="pdfInput" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.7z,.txt,.png,.jpg,.jpeg" onchange="handleFileSelect(event)">
                        <div class="file-upload-icon">ğŸ“„</div>
                        <div class="file-upload-text">ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶æˆ–å›¾ç‰‡</div>
                    </div>
                    
                    <div id="ocrSection" class="ocr-section">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong>ğŸ“· å›¾åƒè¯†åˆ« (OCR)</strong>
                            <button type="button" class="btn btn-sm btn-secondary" id="btnOcr" onclick="triggerOCR()">ğŸ” å¼€å§‹è¯†åˆ«æ–‡å­—</button>
                        </div>
                        <div id="ocrResult" style="padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;max-height:100px;overflow-y:auto;font-size:0.85rem;display:none;"></div>
                        <div id="ocrActions" style="margin-top:8px;display:none;">
                            <button type="button" class="btn btn-sm btn-primary" onclick="fillOcrToTitle()">â¬‡ï¸ å¡«å…¥æ ‡é¢˜</button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="navigator.clipboard.writeText(document.getElementById('ocrResult').textContent);alert('å·²å¤åˆ¶')">ğŸ“‹ å¤åˆ¶</button>
                        </div>
                    </div>

                    <div class="file-info hidden" id="fileInfo">
                        <span class="file-info-name"><span>ğŸ“„</span><span id="fileName"></span></span>
                        <button type="button" class="file-remove" onclick="removeFile()">âœ•</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="submit" form="researchForm" class="btn btn-primary" id="submitBtn">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="detailModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="detailTitle">è¯¦ç»†ä¿¡æ¯</h2>
            <button class="modal-close" onclick="closeDetailModal()">âœ•</button>
        </div>
        <div class="modal-body" id="detailContent"></div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDetailModal()">å…³é—­</button>
            <button type="button" class="btn btn-primary" id="detailEditBtn" onclick="editFromDetail()">âœ ç¼–è¾‘</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="memberModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="memberModalTitle">æ·»åŠ æˆå‘˜</h2>
            <button class="modal-close" onclick="closeMemberModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="memberForm" onsubmit="handleMemberSubmit(event)">
                <input type="hidden" id="memberEditId">
                <div class="form-row">
                    <div class="form-group"><label>å­¦å·/å·¥å· *</label><input type="text" id="memberNo" required></div>
                    <div class="form-group"><label>å§“å *</label><input type="text" id="memberName" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>æ€§åˆ«</label><select id="memberGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
                    <div class="form-group"><label>å•ä½</label><input type="text" id="memberOrg"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>èŒç§°</label><input type="text" id="memberTitle"></div>
                    <div class="form-group"><label>ç”µè¯</label><input type="text" id="memberPhone"></div>
                </div>
                <div class="form-group"><label>é‚®ç®±</label><input type="email" id="memberEmail"></div>
                <div class="form-group"><label>è¯ä»¶å·ç </label><input type="text" id="memberIdCard"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">å–æ¶ˆ</button>
            <button type="submit" form="memberForm" class="btn btn-primary">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="backupModal">
    <div class="modal">
        <div class="modal-header"><h2>â˜ï¸ æ•°æ®å¤‡ä»½</h2><button class="modal-close" onclick="closeBackupModal()">âœ•</button></div>
        <div class="modal-body">
            <div style="background:var(--od-light);padding:15px;border-radius:8px;border:1px solid var(--od-blue);">
                <h4 style="color:var(--od-blue);margin-bottom:10px;">OneDrive åŒæ­¥</h4>
                <div id="onedrive-login-panel">
                     <button class="btn btn-od" onclick="OneDriveService.signIn()" style="width:100%">ğŸ”‘ ç™»å½•å¾®è½¯è´¦å·</button>
                </div>
                <div id="onedrive-actions-panel" class="hidden">
                    <p id="odUserName" style="font-weight:600;margin-bottom:5px;"></p>
                    <div style="display:grid;gap:10px;">
                        <button class="btn btn-od" id="btnOdUpload" onclick="OneDriveService.upload()">â¬†ï¸ ä¸Šä¼ æ•°æ®</button>
                        <button class="btn btn-od-outline" id="btnOdDownload" onclick="OneDriveService.download()">â¬‡ï¸ ä¸‹è½½æ¢å¤</button>
                        <button class="btn btn-sm btn-secondary" onclick="OneDriveService.signOut()">æ³¨é”€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="excelModal">
    <div class="modal wide">
        <div class="modal-header"><h2>å¯¼å…¥ Excel</h2><button class="modal-close" onclick="document.getElementById('excelModal').classList.remove('active')">âœ•</button></div>
        <div class="modal-body">
            <div class="form-group"><label>ç±»å‹</label><select id="excelImportType" onchange="updateMappingFields()"><option value="paper">å­¦æœ¯è®ºæ–‡</option><option value="patent">å‘æ˜ä¸“åˆ©</option><option value="project">ç§‘ç ”é¡¹ç›®</option><option value="member">æˆå‘˜ä¿¡æ¯</option></select></div>
            <div class="file-upload" onclick="document.getElementById('excelInput').click()"><input type="file" id="excelInput" accept=".xlsx,.xls" onchange="handleExcelSelect(event)"><div>ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶</div></div>
            <div id="excelPreviewContainer" class="hidden" style="margin-top:15px;border:1px solid var(--border);padding:10px;max-height:200px;overflow:auto;"></div>
            <div id="mappingContainer" style="margin-top:15px;"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" id="importExcelBtn" onclick="confirmExcelImport()" disabled>ç¡®è®¤å¯¼å…¥</button></div>
    </div>
</div>

<div class="modal-overlay" id="confirmModal">
    <div class="confirm-dialog">
        <p id="confirmMessage">ç¡®å®šåˆ é™¤ï¼Ÿ</p>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="document.getElementById('confirmModal').classList.remove('active')">å–æ¶ˆ</button>
            <button class="btn btn-danger" onclick="confirmDelete()">åˆ é™¤</button>
        </div>
    </div>
</div>
<div class="toast-container" id="toastContainer"></div>

<script>
    // --- å…¨å±€å˜é‡ä¸é…ç½® ---
    let currentUserRole = null;
    let achievements = [];
    let members = [];
    let opLogs = [];
    let currentView = 'all';
    let currentYearFilter = 'all';
    let searchQuery = '';
    let sortOrder = 'date-desc';
    let dateRange = { start: '', end: '' };
    let deleteTargetIds = [];
    let deleteTargetType = 'achievement';
    let currentPdfData = null;
    let currentPdfName = null;
    let selectedItems = new Set();
    let currentDetailId = null;
    let excelData = null, excelHeaders = [];
    let currentPage = 1, itemsPerPage = 50;

    const DB_NAME = 'ResearchDB_V6_Final';
    let db;

    const typeConfig = {
        paper: { icon: 'ğŸ“„', label: 'å­¦æœ¯è®ºæ–‡', class: 'type-paper' },
        patent: { icon: 'ğŸ’¡', label: 'å‘æ˜ä¸“åˆ©', class: 'type-patent' },
        project: { icon: 'ğŸ“Š', label: 'ç§‘ç ”é¡¹ç›®', class: 'type-project' },
        award: { icon: 'ğŸ†', label: 'è·å¥–æƒ…å†µ', class: 'type-award' },
        book: { icon: 'ğŸ“š', label: 'ä¸“è‘—å‡ºç‰ˆ', class: 'type-book' },
        member: { icon: 'ğŸ‘¤', label: 'æˆå‘˜ä¿¡æ¯', class: 'type-member' },
        trash: { icon: 'ğŸ—‘', label: 'å›æ”¶ç«™', class: 'stat-icon trash' }
    };

    // --- åˆå§‹åŒ– ---
    window.onload = function() { 
        OneDriveService.init(); 
        initDB().then(() => loadFromLocal().then(() => { updateStats(); renderResults(); })); 
    };

    // --- æ•°æ®åº“æ“ä½œ ---
    function initDB() { return new Promise((resolve, reject) => { var r = indexedDB.open(DB_NAME, 1); r.onerror = e => reject(e); r.onupgradeneeded = e => { if (!e.target.result.objectStoreNames.contains('appState')) e.target.result.createObjectStore('appState', { keyPath: 'id' }); }; r.onsuccess = e => { db = e.target.result; resolve(db); }; }); }
    async function saveToLocal() { if (!db) await initDB(); var t = db.transaction(['appState'], 'readwrite'); t.objectStore('appState').put({ id: 'main_data', achievements, members, logs: opLogs, updatedAt: new Date().toISOString() }); updateStorageStatus(true); }
    async function loadFromLocal() { if (!db) await initDB(); return new Promise(resolve => { var r = db.transaction(['appState'], 'readonly').objectStore('appState').get('main_data'); r.onsuccess = e => { if (e.target.result) { achievements = e.target.result.achievements || []; members = e.target.result.members || []; opLogs = e.target.result.logs || []; resolve(true); } else resolve(false); }; r.onerror = () => resolve(false); }); }
    function updateStorageStatus(ok) { var s = document.getElementById('storageStatus'); if (ok) { s.style.color = 'var(--success)'; s.innerHTML = 'âœ“ æ•°æ®å·²æœ¬åœ°ä¿å­˜'; } else { s.style.color = 'var(--warning)'; s.textContent = 'âš  ä¿å­˜å¤±è´¥'; } }
    function logOperation(action, detail) { opLogs.unshift({ timestamp: new Date().toISOString(), action, detail, user: currentUserRole || 'unknown' }); if(opLogs.length > 500) opLogs.pop(); }

    // --- ç™»å½•é€»è¾‘ ---
    function checkLogin() {
        const pwd = document.getElementById('loginPassword').value;
        if (pwd === '1399') { currentUserRole = 'admin'; showToast('ç®¡ç†å‘˜ç™»å½•', 'success'); }
        else if (pwd === 'guest') { currentUserRole = 'guest'; showToast('å®¾å®¢ç™»å½•', 'success'); }
        else { showToast('å¯†ç é”™è¯¯', 'error'); return; }
        document.getElementById('loginOverlay').style.display = 'none';
        applyPermissions();
    }
    function applyPermissions() {
        const isAdmin = currentUserRole === 'admin';
        document.getElementById('navMember').style.opacity = isAdmin ? '1' : '0.5';
        document.getElementById('navMember').style.pointerEvents = isAdmin ? 'auto' : 'none';
    }

    // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼šè¡¨å•å¤„ç† ---
    function toggleFormFields() {
        const type = document.getElementById('type').value;
        // éšè—æ‰€æœ‰ç‰¹å®šå­—æ®µåŒº
        ['paperFields', 'patentFields', 'projectFields', 'awardFields', 'bookFields'].forEach(id => document.getElementById(id).classList.add('hidden'));
        
        // æ˜¾ç¤ºå½“å‰é€‰ä¸­
        if(type === 'paper') document.getElementById('paperFields').classList.remove('hidden');
        else if(type === 'patent') document.getElementById('patentFields').classList.remove('hidden');
        else if(type === 'project') document.getElementById('projectFields').classList.remove('hidden');
        else if(type === 'award') document.getElementById('awardFields').classList.remove('hidden');
        else if(type === 'book') document.getElementById('bookFields').classList.remove('hidden');
    }

    function openAddModal() {
        if(currentView === 'trash') return;
        if(currentView === 'member') { openMemberModal(); return; }
        document.getElementById('editId').value = '';
        document.getElementById('researchForm').reset();
        document.getElementById('type').value = (currentView !== 'all') ? currentView : 'paper';
        document.getElementById('commonDate').valueAsDate = new Date();
        document.getElementById('modalTitle').textContent = 'æ·»åŠ ç§‘ç ”æˆæœ';
        removeFile();
        toggleFormFields();
        document.getElementById('formModal').classList.add('active');
    }

    function handleSubmit(event) {
        event.preventDefault();
        const type = document.getElementById('type').value;
        const editId = document.getElementById('editId').value;
        const commonDate = document.getElementById('commonDate').value;
        
        let newItem = {
            id: editId || Date.now().toString() + Math.random().toString(36).substr(2, 5),
            type: type,
            date: commonDate,
            updatedAt: new Date().toISOString(),
            isDeleted: false,
            pdfData: currentPdfData,
            pdfName: currentPdfName
        };

        // å…³é”®ï¼šæ ¹æ®ç±»å‹åˆ†åˆ«è¯»å–ï¼Œé˜²æ­¢IDå†²çªæˆ–è¯»å–ç©ºå€¼
        if (type === 'paper') {
            newItem.title = document.getElementById('title').value;
            newItem.authors = document.getElementById('authors').value;
            newItem.source = document.getElementById('source').value;
            newItem.level = document.getElementById('level').value;
            newItem.doi = document.getElementById('doi').value;
        } else if (type === 'patent') {
            newItem.patentName = document.getElementById('patentName').value;
            newItem.patentType = document.getElementById('patentType').value;
            newItem.patentStatus = document.getElementById('patentStatus').value;
            newItem.patentNumber = document.getElementById('patentNumber').value;
            newItem.inventors = document.getElementById('inventors').value;
            newItem.grantDate = document.getElementById('grantDate').value; // ä¸“åˆ©ç‰¹æœ‰æ—¥æœŸ
            newItem.title = newItem.patentName; // æœç´¢ç”¨
            newItem.date = document.getElementById('applicationDate') ? document.getElementById('applicationDate').value : commonDate;
        } else if (type === 'project') {
            newItem.projectName = document.getElementById('projectName').value;
            newItem.projectNumber = document.getElementById('projectNumber').value;
            newItem.projectLevel = document.getElementById('projectLevel').value;
            newItem.projectOrg = document.getElementById('projectOrg').value;
            newItem.projectEndDate = document.getElementById('projectEndDate').value;
            newItem.title = newItem.projectName;
        } else if (type === 'award') {
            newItem.awardName = document.getElementById('awardName').value;
            newItem.awardRecipients = document.getElementById('awardRecipients').value;
            newItem.awardAgency = document.getElementById('awardAgency').value;
            newItem.awardLevel = document.getElementById('awardLevel').value;
            newItem.title = newItem.awardName;
        } else if (type === 'book') {
            newItem.bookTitle = document.getElementById('bookTitle').value;
            newItem.bookAuthors = document.getElementById('bookAuthors').value;
            newItem.bookPublisher = document.getElementById('bookPublisher').value;
            newItem.bookIsbn = document.getElementById('bookIsbn').value;
            newItem.title = newItem.bookTitle;
        }

        if(editId) {
            const idx = achievements.findIndex(a => a.id === editId);
            if(idx > -1) achievements[idx] = { ...achievements[idx], ...newItem };
        } else {
            newItem.createdAt = new Date().toISOString();
            achievements.push(newItem);
        }

        saveToLocal();
        updateStats();
        renderResults();
        closeModal();
        showToast('ä¿å­˜æˆåŠŸ', 'success');
    }

    function editAchievement(id) {
        if(currentUserRole !== 'admin') { showToast('æ— æƒé™', 'error'); return; }
        const item = achievements.find(a => a.id === id);
        if(!item) return;

        document.getElementById('editId').value = item.id;
        document.getElementById('type').value = item.type;
        document.getElementById('commonDate').value = item.date || '';
        toggleFormFields();

        // å¡«å……æ•°æ® (åˆ†ç±»å¡«å……)
        if(item.type === 'paper') {
            document.getElementById('title').value = item.title || '';
            document.getElementById('authors').value = item.authors || '';
            document.getElementById('source').value = item.source || '';
            document.getElementById('level').value = item.level || '';
            document.getElementById('doi').value = item.doi || '';
        } else if(item.type === 'patent') {
            document.getElementById('patentName').value = item.patentName || '';
            document.getElementById('patentType').value = item.patentType || 'å‘æ˜ä¸“åˆ©';
            document.getElementById('patentStatus').value = item.patentStatus || 'å—ç†';
            document.getElementById('patentNumber').value = item.patentNumber || '';
            document.getElementById('inventors').value = item.inventors || '';
            document.getElementById('grantDate').value = item.grantDate || '';
        } else if(item.type === 'project') {
            document.getElementById('projectName').value = item.projectName || '';
            document.getElementById('projectNumber').value = item.projectNumber || '';
            document.getElementById('projectLevel').value = item.projectLevel || '';
            document.getElementById('projectOrg').value = item.projectOrg || '';
            document.getElementById('projectEndDate').value = item.projectEndDate || '';
        } else if(item.type === 'award') {
            document.getElementById('awardName').value = item.awardName || '';
            document.getElementById('awardRecipients').value = item.awardRecipients || '';
            document.getElementById('awardAgency').value = item.awardAgency || '';
            document.getElementById('awardLevel').value = item.awardLevel || '';
        } else if(item.type === 'book') {
            document.getElementById('bookTitle').value = item.bookTitle || '';
            document.getElementById('bookAuthors').value = item.bookAuthors || '';
            document.getElementById('bookPublisher').value = item.bookPublisher || '';
            document.getElementById('bookIsbn').value = item.bookIsbn || '';
        }

        currentPdfData = item.pdfData;
        currentPdfName = item.pdfName;
        if(currentPdfName) {
             document.getElementById('fileName').textContent = currentPdfName;
             document.getElementById('fileInfo').classList.remove('hidden');
             document.getElementById('fileUpload').classList.add('has-file');
        } else {
             removeFile();
        }

        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘æˆæœ';
        document.getElementById('formModal').classList.add('active');
    }

    // --- æ–‡ä»¶ä¸ OCR ---
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if(!file) return;
        if(file.size > 20*1024*1024) { showToast('æ–‡ä»¶è¿‡å¤§', 'error'); return; }
        
        currentPdfName = file.name;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileInfo').classList.remove('hidden');
        document.getElementById('fileUpload').classList.add('has-file');

        const reader = new FileReader();
        reader.onload = function(e) {
            currentPdfData = e.target.result;
            // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œæ˜¾ç¤ºOCR
            if(file.type.startsWith('image/')) {
                document.getElementById('ocrSection').style.display = 'block';
                document.getElementById('ocrResult').style.display = 'none';
                document.getElementById('ocrActions').style.display = 'none';
            } else {
                document.getElementById('ocrSection').style.display = 'none';
            }
        };
        reader.readAsDataURL(file);
    }

    function removeFile() {
        currentPdfData = null; currentPdfName = null;
        document.getElementById('pdfInput').value = '';
        document.getElementById('fileInfo').classList.add('hidden');
        document.getElementById('fileUpload').classList.remove('hidden');
        document.getElementById('fileUpload').classList.remove('has-file');
        document.getElementById('ocrSection').style.display = 'none';
    }

    function triggerOCR() {
        if(!currentPdfData) return;
        const resDiv = document.getElementById('ocrResult');
        const btn = document.getElementById('btnOcr');
        
        btn.disabled = true;
        btn.innerHTML = 'è¯†åˆ«ä¸­...';
        resDiv.style.display = 'block';
        resDiv.textContent = 'Tesseract æ­£åœ¨åˆå§‹åŒ–å¹¶è¯†åˆ«...';

        Tesseract.recognize(
            currentPdfData,
            'chi_sim+eng',
            { logger: m => console.log(m) }
        ).then(({ data: { text } }) => {
            resDiv.textContent = text;
            document.getElementById('ocrActions').style.display = 'block';
            btn.innerHTML = 'ğŸ” é‡æ–°è¯†åˆ«';
            btn.disabled = false;
        }).catch(err => {
            resDiv.textContent = 'è¯†åˆ«å¤±è´¥: ' + err;
            btn.disabled = false;
        });
    }

    function fillOcrToTitle() {
        const text = document.getElementById('ocrResult').textContent;
        const cleanText = text.replace(/\s+/g, ' ').substring(0, 100);
        const t = document.getElementById('type').value;
        if(t === 'patent') document.getElementById('patentName').value = cleanText;
        else if(t === 'project') document.getElementById('projectName').value = cleanText;
        else if(t === 'award') document.getElementById('awardName').value = cleanText;
        else if(t === 'book') document.getElementById('bookTitle').value = cleanText;
        else document.getElementById('title').value = cleanText;
    }

    // --- æ™ºèƒ½æŠ“å– ---
    async function fetchByDOI() {
        const doi = document.getElementById('doi').value.trim();
        if(!doi) return showToast('è¯·è¾“å…¥DOI', 'warning');
        try {
            const res = await fetch(`https://api.crossref.org/works/${doi}`);
            const data = await res.json();
            const item = data.message;
            
            // å®‰å…¨å¡«å……ï¼šå¦‚æœä¸ä¸ºç©ºåˆ™ä¸è¦†ç›–
            const tInput = document.getElementById('title');
            if(!tInput.value) tInput.value = item.title ? item.title[0] : '';
            
            if(item.author && !document.getElementById('authors').value) {
                document.getElementById('authors').value = item.author.map(a => a.family + ' ' + a.given).join(', ');
            }
            if(item['container-title'] && !document.getElementById('source').value) {
                document.getElementById('source').value = item['container-title'][0];
            }
            showToast('DOIä¿¡æ¯æŠ“å–æˆåŠŸ', 'success');
        } catch(e) { showToast('æŠ“å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–DOI', 'error'); }
    }

    async function fetchByISBN() {
        const isbn = document.getElementById('bookIsbn').value.replace(/-/g,'');
        if(!isbn) return showToast('è¯·è¾“å…¥ISBN', 'warning');
        try {
            const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&jscmd=data&format=json`);
            const data = await res.json();
            const key = `ISBN:${isbn}`;
            if(data[key]) {
                 if(!document.getElementById('bookTitle').value) document.getElementById('bookTitle').value = data[key].title;
                 if(!document.getElementById('bookPublisher').value && data[key].publishers) document.getElementById('bookPublisher').value = data[key].publishers[0].name;
                 showToast('ISBNä¿¡æ¯æŠ“å–æˆåŠŸ', 'success');
            } else { throw new Error('Not found'); }
        } catch(e) { showToast('æœªæ‰¾åˆ°è¯¥ISBNä¿¡æ¯', 'error'); }
    }

    // --- åˆ—è¡¨æ¸²æŸ“ ---
    function renderResults() {
        const container = document.getElementById('resultsList');
        const isTrash = currentView === 'trash';
        const isLog = currentView === 'logs';
        
        if(currentView === 'member') { renderMembers(container); return; }
        if(isLog) { renderLogs(container); return; }

        let filtered = achievements.filter(a => isTrash ? a.isDeleted : !a.isDeleted);

        // è§†å›¾ç­›é€‰
        if(!isTrash && currentView !== 'all') filtered = filtered.filter(a => a.type === currentView);
        // å¹´ä»½ç­›é€‰
        if(currentYearFilter !== 'all') filtered = filtered.filter(a => (a.date||'').startsWith(currentYearFilter));
        // æœç´¢
        if(searchQuery) {
            const q = searchQuery.toLowerCase();
            filtered = filtered.filter(a => 
                (a.title||'').toLowerCase().includes(q) || 
                (a.authors||'').toLowerCase().includes(q) ||
                (a.patentNumber||'').toLowerCase().includes(q)
            );
        }

        // æ’åº
        filtered.sort((a,b) => {
            const da = a.date || '0'; const db = b.date || '0';
            if(sortOrder === 'date-desc') return db.localeCompare(da);
            if(sortOrder === 'date-asc') return da.localeCompare(db);
            return (a.title||'').localeCompare(b.title||'');
        });

        // åˆ†é¡µ
        const total = filtered.length;
        const maxPage = Math.ceil(total / itemsPerPage) || 1;
        if(currentPage > maxPage) currentPage = maxPage;
        document.getElementById('resultsCount').textContent = `å…± ${total} æ¡`;
        document.getElementById('pageIndicator').textContent = `${currentPage} / ${maxPage}`;

        const pageItems = filtered.slice((currentPage-1)*itemsPerPage, currentPage*itemsPerPage);
        
        if(pageItems.length === 0) {
            container.innerHTML = '<div class="empty-state"><h3>æš‚æ— æ•°æ®</h3></div>';
            return;
        }

        container.innerHTML = pageItems.map(item => {
            const cfg = typeConfig[item.type] || typeConfig.paper;
            let meta = '';
            
            if(item.type === 'paper') meta = `<span>ğŸ“„ ${item.source||'-'}</span> <span>â­ ${item.level||'-'}</span>`;
            else if(item.type === 'patent') meta = `<span>ğŸ’¡ ${item.patentType||'-'}</span> <span>ğŸ”¢ ${item.patentNumber||'-'}</span> <span>ğŸ“Œ ${item.patentStatus||'-'}</span>`;
            else if(item.type === 'project') meta = `<span>ğŸ“Š ${item.projectLevel||'-'}</span> <span>ğŸ›ï¸ ${item.projectOrg||'-'}</span>`;
            else if(item.type === 'book') meta = `<span>ğŸ“– ${item.bookPublisher||'-'}</span>`;
            else if(item.type === 'award') meta = `<span>ğŸ† ${item.awardLevel||'-'}</span>`;

            let actions = '';
            if(isTrash) {
                actions = `<button class="action-btn restore" onclick="event.stopPropagation();restoreItem('${item.id}')" title="æ¢å¤">â™»ï¸</button>
                           <button class="action-btn delete" onclick="event.stopPropagation();hardDelete('${item.id}')" title="å½»åº•åˆ é™¤">âŒ</button>`;
            } else {
                actions = `<button class="action-btn" onclick="event.stopPropagation();viewFile('${item.id}')" ${!item.pdfData?'disabled style="opacity:0.3"':''}>ğŸ‘ï¸</button>
                           <button class="action-btn" onclick="event.stopPropagation();downloadFile('${item.id}')" ${!item.pdfData?'disabled style="opacity:0.3"':''}>â¬‡ï¸</button>
                           <button class="action-btn delete" onclick="event.stopPropagation();softDelete('${item.id}')">ğŸ—‘</button>`;
            }

            return `<div class="result-item" onclick="viewDetail('${item.id}')">
                <input type="checkbox" class="result-checkbox" onchange="toggleSelect('${item.id}')" onclick="event.stopPropagation()">
                <div class="result-type ${cfg.class}">${cfg.icon}</div>
                <div class="result-content">
                    <div class="result-title">${item.title||'æ— æ ‡é¢˜'}</div>
                    <div class="result-meta">
                        <span>ğŸ“… ${item.date||'-'}</span>
                        ${meta}
                        ${item.pdfData ? '<span class="has-pdf">ğŸ“</span>' : ''}
                    </div>
                </div>
                <div class="result-actions">${actions}</div>
            </div>`;
        }).join('');
    }

    function renderMembers(container) {
        let filtered = members.filter(m => !searchQuery || m.memberName.includes(searchQuery));
        container.innerHTML = filtered.map(m => `
            <div class="result-item" onclick="editMember('${m.id}')">
                <div class="result-type type-member">ğŸ‘¤</div>
                <div class="result-content">
                    <div class="result-title">${m.memberName} <span style="font-size:0.8rem;color:#666">(${m.memberNo})</span></div>
                    <div class="result-meta"><span>${m.memberOrg||'-'}</span> <span>${m.memberTitle||'-'}</span> <span>${m.memberPhone||'-'}</span></div>
                </div>
                <div class="result-actions"><button class="action-btn delete" onclick="event.stopPropagation();deleteMember('${m.id}')">ğŸ—‘</button></div>
            </div>
        `).join('');
    }

    function renderLogs(container) {
        container.innerHTML = opLogs.map(l => `
            <div class="result-item" style="cursor:default">
                <div class="result-type" style="background:#eee">ğŸ“</div>
                <div class="result-content">
                    <div class="result-title">${l.action}</div>
                    <div class="result-meta"><span>${new Date(l.timestamp).toLocaleString()}</span> <span>ğŸ‘¤ ${l.user}</span></div>
                    <div style="font-size:0.8rem;color:#888">${l.detail}</div>
                </div>
            </div>
        `).join('');
    }

    // --- è¯¦æƒ…ä¸é™„ä»¶ ---
    function viewDetail(id) {
        if(currentView === 'trash') return;
        const item = achievements.find(a => a.id === id);
        if(!item) return;
        currentDetailId = id;
        
        let html = '';
        const addRow = (k, v) => html += `<div class="detail-row"><div class="detail-label">${k}</div><div class="detail-value">${v||'-'}</div></div>`;
        
        if(item.type === 'paper') { addRow('æ ‡é¢˜', item.title); addRow('ä½œè€…', item.authors); addRow('æœŸåˆŠ', item.source); addRow('çº§åˆ«', item.level); addRow('DOI', item.doi); }
        else if(item.type === 'patent') { addRow('ä¸“åˆ©å', item.patentName); addRow('ä¸“åˆ©å·', item.patentNumber); addRow('çŠ¶æ€', item.patentStatus); addRow('å‘æ˜äºº', item.inventors); addRow('æˆæƒæ—¥', item.grantDate); }
        else if(item.type === 'project') { addRow('é¡¹ç›®å', item.projectName); addRow('ç¼–å·', item.projectNumber); addRow('çº§åˆ«', item.projectLevel); addRow('å•ä½', item.projectOrg); }
        
        if(item.pdfData) html += `<div class="detail-row" style="margin-top:10px;"><div class="detail-value"><button class="btn btn-sm btn-secondary" onclick="viewFile('${item.id}')">æŸ¥çœ‹é™„ä»¶</button></div></div>`;

        document.getElementById('detailContent').innerHTML = html;
        document.getElementById('detailEditBtn').style.display = currentUserRole==='admin'?'inline-flex':'none';
        document.getElementById('detailModal').classList.add('active');
    }
    function editFromDetail() { document.getElementById('detailModal').classList.remove('active'); editAchievement(currentDetailId); }
    
    function viewFile(id) {
        const item = achievements.find(a => a.id === id);
        if(item && item.pdfData) {
            const win = window.open();
            win.document.write(`<iframe src="${item.pdfData}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
        }
    }
    function downloadFile(id) {
        const item = achievements.find(a => a.id === id);
        if(item && item.pdfData) {
            const a = document.createElement('a');
            a.href = item.pdfData;
            a.download = item.pdfName || 'download';
            a.click();
        }
    }

    // --- åˆ é™¤ä¸æ¢å¤ ---
    function softDelete(id) { 
        if(currentUserRole !== 'admin') { showToast('æ— æƒé™', 'error'); return; }
        if(confirm('ç§»å…¥å›æ”¶ç«™ï¼Ÿ')) {
            achievements.find(a => a.id === id).isDeleted = true;
            saveToLocal(); renderResults(); logOperation('Delete', `Soft deleted ${id}`);
        }
    }
    function restoreItem(id) {
        achievements.find(a => a.id === id).isDeleted = false;
        saveToLocal(); renderResults(); showToast('å·²æ¢å¤', 'success');
    }
    function hardDelete(id) {
        if(confirm('æ°¸ä¹…åˆ é™¤ä¸å¯æ¢å¤ï¼Œç¡®å®šï¼Ÿ')) {
            achievements = achievements.filter(a => a.id !== id);
            saveToLocal(); renderResults(); logOperation('HardDelete', id);
        }
    }
    function toggleSelect(id) { if(selectedItems.has(id)) selectedItems.delete(id); else selectedItems.add(id); updateBatchBtn(); }
    function toggleSelectAll() {
        const check = document.getElementById('selectAll').checked;
        document.querySelectorAll('.result-checkbox').forEach(cb => { cb.checked = check; check ? selectedItems.add(cb.parentElement.onclick.toString().match(/'(.*?)'/)[1]) : selectedItems.clear(); });
        updateBatchBtn();
    }
    function updateBatchBtn() { 
        document.getElementById('batchDeleteBtn').style.display = selectedItems.size ? 'inline-block' : 'none'; 
        if(currentView === 'trash') document.getElementById('batchRestoreBtn').style.display = selectedItems.size ? 'inline-block' : 'none';
    }
    function batchDelete() {
        if(!confirm('ç¡®å®šæ‰¹é‡åˆ é™¤ï¼Ÿ')) return;
        selectedItems.forEach(id => currentView === 'trash' ? hardDelete(id) : softDelete(id));
        selectedItems.clear(); renderResults();
    }

    // --- æˆå‘˜ç®¡ç† ---
    function openMemberModal() { document.getElementById('memberForm').reset(); document.getElementById('memberEditId').value = ''; document.getElementById('memberModal').classList.add('active'); }
    function closeMemberModal() { document.getElementById('memberModal').classList.remove('active'); }
    function handleMemberSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('memberEditId').value || Date.now().toString();
        const newItem = {
            id,
            memberNo: document.getElementById('memberNo').value,
            memberName: document.getElementById('memberName').value,
            memberGender: document.getElementById('memberGender').value,
            memberOrg: document.getElementById('memberOrg').value,
            memberTitle: document.getElementById('memberTitle').value,
            memberPhone: document.getElementById('memberPhone').value,
            memberEmail: document.getElementById('memberEmail').value,
            memberIdCard: document.getElementById('memberIdCard').value
        };
        const idx = members.findIndex(m => m.id === id);
        if(idx > -1) members[idx] = newItem; else members.push(newItem);
        saveToLocal(); closeMemberModal(); renderResults();
    }
    function editMember(id) {
        const m = members.find(x => x.id === id);
        if(!m) return;
        document.getElementById('memberEditId').value = m.id;
        document.getElementById('memberNo').value = m.memberNo;
        document.getElementById('memberName').value = m.memberName;
        document.getElementById('memberGender').value = m.memberGender;
        document.getElementById('memberOrg').value = m.memberOrg;
        document.getElementById('memberTitle').value = m.memberTitle;
        document.getElementById('memberPhone').value = m.memberPhone;
        document.getElementById('memberEmail').value = m.memberEmail;
        document.getElementById('memberIdCard').value = m.memberIdCard;
        document.getElementById('memberModal').classList.add('active');
    }
    function deleteMember(id) {
        if(confirm('åˆ é™¤æˆå‘˜ï¼Ÿ')) { members = members.filter(m => m.id !== id); saveToLocal(); renderResults(); }
    }

    // --- å¯¼å‡ºåŠŸèƒ½ ---
    function exportToExcelFile() {
        const wb = XLSX.utils.book_new();
        // 1. Papers
        const papers = achievements.filter(a => a.type === 'paper' && !a.isDeleted);
        if(papers.length) {
            const ws = XLSX.utils.json_to_sheet(papers.map(p => ({'æ ‡é¢˜':p.title,'ä½œè€…':p.authors,'æ—¥æœŸ':p.date,'æ¥æº':p.source,'çº§åˆ«':p.level,'DOI':p.doi})));
            XLSX.utils.book_append_sheet(wb, ws, "å­¦æœ¯è®ºæ–‡");
        }
        // 2. Patents
        const patents = achievements.filter(a => a.type === 'patent' && !a.isDeleted);
        if(patents.length) {
            const ws = XLSX.utils.json_to_sheet(patents.map(p => ({'ä¸“åˆ©å':p.patentName,'ä¸“åˆ©å·':p.patentNumber,'ç±»å‹':p.patentType,'çŠ¶æ€':p.patentStatus,'å‘æ˜äºº':p.inventors})));
            XLSX.utils.book_append_sheet(wb, ws, "å‘æ˜ä¸“åˆ©");
        }
        // 3. Projects
        const projects = achievements.filter(a => a.type === 'project' && !a.isDeleted);
        if(projects.length) {
            const ws = XLSX.utils.json_to_sheet(projects.map(p => ({'é¡¹ç›®å':p.projectName,'ç¼–å·':p.projectNumber,'çº§åˆ«':p.projectLevel,'å•ä½':p.projectOrg})));
            XLSX.utils.book_append_sheet(wb, ws, "ç§‘ç ”é¡¹ç›®");
        }
        
        XLSX.writeFile(wb, "ç§‘ç ”æˆæœæ•°æ®.xlsx");
        closeMenu();
    }

    function exportToWordFile() {
        // ç”Ÿæˆ HTML è¡¨æ ¼æ ·å¼çš„ Word
        let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word"><head><meta charset="utf-8"><style>table{border-collapse:collapse;width:100%}td,th{border:1px solid #000;padding:8px}</style></head><body>';
        html += '<h1>ç§‘ç ”æˆæœæ±‡æ€»</h1>';
        
        // åˆ†ç±»ç”Ÿæˆè¡¨æ ¼
        ['paper','patent','project'].forEach(type => {
            const list = achievements.filter(a => a.type === type && !a.isDeleted);
            if(list.length === 0) return;
            html += `<h3>${typeConfig[type].label}</h3><table>`;
            html += `<tr><th>æ—¥æœŸ</th><th>åç§°</th><th>è¯¦æƒ…</th></tr>`;
            list.forEach(item => {
                let detail = '';
                if(type==='paper') detail = `${item.source} (${item.level})`;
                if(type==='patent') detail = `${item.patentNumber} [${item.patentStatus}]`;
                if(type==='project') detail = `${item.projectNumber} ${item.projectOrg}`;
                html += `<tr><td>${item.date}</td><td>${item.title||item.patentName||item.projectName}</td><td>${detail}</td></tr>`;
            });
            html += '</table><br>';
        });
        
        html += '</body></html>';
        const blob = new Blob([html], {type: 'application/msword'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'ç§‘ç ”ç®€å†.doc';
        a.click();
        closeMenu();
    }

    // --- Excel å¯¼å…¥ (å»é‡åˆå¹¶) ---
    function openExcelImport() { document.getElementById('excelModal').classList.add('active'); closeMenu(); }
    function handleExcelSelect(e) {
        const f = e.target.files[0];
        const r = new FileReader();
        r.onload = (evt) => {
            const wb = XLSX.read(evt.target.result, {type:'array'});
            const ws = wb.Sheets[wb.SheetNames[0]];
            excelData = XLSX.utils.sheet_to_json(ws);
            if(excelData.length) {
                // è‡ªåŠ¨æ˜ å°„é¢„è§ˆ
                let html = '<table><tr>';
                Object.keys(excelData[0]).forEach(k => html += `<th>${k}</th>`);
                html += '</tr>';
                excelData.slice(0,5).forEach(row => {
                    html += '<tr>';
                    Object.values(row).forEach(v => html += `<td>${v}</td>`);
                    html += '</tr>';
                });
                html += '</table>';
                document.getElementById('excelPreviewContainer').innerHTML = html;
                document.getElementById('excelPreviewContainer').classList.remove('hidden');
                document.getElementById('importExcelBtn').disabled = false;
            }
        };
        r.readAsArrayBuffer(f);
    }
    
    function confirmExcelImport() {
        const type = document.getElementById('excelImportType').value;
        let count = 0;
        
        excelData.forEach(row => {
            // ç®€å•æ˜ å°„é€»è¾‘ï¼Œå®é™…ä½¿ç”¨å¯æ‰©å±•
            let newItem = { 
                id: Date.now() + Math.random().toString(36), 
                type: type, 
                updatedAt: new Date().toISOString(), 
                isDeleted: false 
            };
            
            // æ™ºèƒ½åŒ¹é…å­—æ®µ
            if(type === 'paper') {
                newItem.title = row['æ ‡é¢˜'] || row['Title'] || row['è®ºæ–‡åç§°'];
                newItem.date = row['æ—¥æœŸ'] || row['Date'] || row['å‘è¡¨æ—¶é—´'];
                newItem.level = row['çº§åˆ«'] || row['Level'];
            } else if(type === 'patent') {
                newItem.patentName = row['ä¸“åˆ©åç§°'] || row['Name'];
                newItem.patentNumber = row['ä¸“åˆ©å·'] || row['Number'];
                newItem.title = newItem.patentName;
            }
            
            if(!newItem.title && !newItem.patentName) return; // è·³è¿‡æ— æ•ˆæ•°æ®

            // æŸ¥é‡ï¼šä¼˜å…ˆåŒ¹é…å”¯ä¸€æ ‡è¯†ï¼Œå…¶æ¬¡åŒ¹é…æ ‡é¢˜
            const exist = achievements.find(a => 
                (a.type === type) && 
                ((newItem.patentNumber && a.patentNumber === newItem.patentNumber) || (a.title === newItem.title))
            );
            
            if(exist) {
                // åˆå¹¶ï¼šä»…å½“å¯¼å…¥æ•°æ®éç©ºæ—¶è¦†ç›–
                Object.keys(newItem).forEach(k => {
                    if(newItem[k]) exist[k] = newItem[k];
                });
            } else {
                achievements.push(newItem);
                count++;
            }
        });
        
        saveToLocal();
        updateStats();
        renderResults();
        document.getElementById('excelModal').classList.remove('active');
        showToast(`å¯¼å…¥å®Œæˆï¼Œæ–°å¢ ${count} æ¡`, 'success');
    }

    // --- OneDrive (Mockup for functionality structure) ---
    const OneDriveService = {
        init: async function() {
            try { this.msal = new msal.PublicClientApplication({ auth: { clientId: "c453313f-fd40-4534-9d66-6a0847396d3b" } }); } catch(e){}
        },
        signIn: async function() {
            // å®é™…é›†æˆéœ€è¦ Azure App é…ç½®ï¼Œæ­¤å¤„ä¸ºé€»è¾‘æ¼”ç¤º
            try {
                const res = await this.msal.loginPopup({ scopes: ["User.Read", "Files.ReadWrite"] });
                document.getElementById('onedrive-login-panel').classList.add('hidden');
                document.getElementById('onedrive-actions-panel').classList.remove('hidden');
                document.getElementById('odUserName').textContent = res.account.name;
            } catch(e) { alert('OneDrive ç™»å½•éœ€è¦é…ç½® Azure App IDï¼Œè¯·æ£€æŸ¥ä»£ç é…ç½®'); }
        },
        signOut: function() {
            this.msal.logoutPopup();
            location.reload();
        },
        upload: function() { showToast('æ­£åœ¨ä¸Šä¼ ...', 'success'); setTimeout(()=>showToast('å¤‡ä»½æˆåŠŸ', 'success'), 1000); },
        download: function() { showToast('æ­£åœ¨ä¸‹è½½...', 'success'); }
    };

    // --- å·¥å…·å‡½æ•° ---
    function showToast(msg, type) {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.textContent = msg;
        document.getElementById('toastContainer').appendChild(t);
        setTimeout(() => t.classList.add('show'), 10);
        setTimeout(() => { t.classList.remove('show'); setTimeout(()=>t.remove(), 300); }, 3000);
    }
    function toggleMenu(id) { document.getElementById(id).classList.toggle('show'); }
    function closeMenu() { document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('show')); }
    function closeModal() { document.querySelector('.modal-overlay.active').classList.remove('active'); }
    function closeBackupModal() { document.getElementById('backupModal').classList.remove('active'); }
    function closeDetailModal() { document.getElementById('detailModal').classList.remove('active'); }
    function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }
    function setView(v) { currentView = v; updateStats(); renderResults(); }
    function setYearFilter(y) { currentYearFilter = y; renderResults(); }
    function handleDateRangeFilter() {
        dateRange.start = document.getElementById('filterStartDate').value;
        dateRange.end = document.getElementById('filterEndDate').value;
        renderResults();
    }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('active'); }
    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('active'); }
    function prevPage() { if(currentPage>1) { currentPage--; renderResults(); } }
    function nextPage() { currentPage++; renderResults(); }
    function handleSort() { sortOrder = document.getElementById('sortSelect').value; renderResults(); }

</script>
</body>
</html>

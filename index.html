<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ (Windowsä¿®å¤æ——èˆ°ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* =================================================================
           1. æ ¸å¿ƒæ ·å¼é‡ç½®ä¸å˜é‡
           ================================================================= */
        :root {
            --sidebar-w: 280px; /* ä¾§è¾¹æ åŠ å®½ï¼Œé€‚åº”Windowsæ˜¾ç¤º */
            --header-h: 70px;
            
            --bg-body: #f1f5f9;
            --bg-sidebar: #1e293b; /* æ·±è‰²ä¾§è¾¹æ ï¼Œæ›´ä¸“ä¸š */
            --bg-card: #ffffff;
            --bg-hover: #f8fafc;
            --bg-active: #eff6ff;

            --text-main: #0f172a;
            --text-sidebar: #cbd5e1; /* ä¾§è¾¹æ æ–‡å­—æµ…ç° */
            --text-sidebar-active: #ffffff;
            --text-sub: #64748b;
            
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;

            --border: #e2e8f0;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            font-family: "Microsoft YaHei", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; /* ç¦ç”¨ Body æ»šåŠ¨ï¼Œä½¿ç”¨å†…éƒ¨æ»šåŠ¨ */
            display: flex;
        }

        /* =================================================================
           2. ä¾§è¾¹æ  (Fixed Sidebar) - Windows é€‚é…ä¿®å¤
           ================================================================= */
        .sidebar {
            width: var(--sidebar-w);
            background-color: var(--bg-sidebar);
            color: var(--text-sidebar);
            display: flex;
            flex-direction: column;
            height: 100%;
            flex-shrink: 0; /* ç¦æ­¢å‹ç¼© */
            z-index: 1000; /* ç¡®ä¿å±‚çº§æœ€é«˜ */
            box-shadow: 4px 0 10px rgba(0,0,0,0.05);
        }

        .sidebar-header {
            height: var(--header-h);
            display: flex;
            align-items: center;
            padding: 0 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background-color: rgba(0,0,0,0.1);
        }

        .logo-box {
            width: 36px; height: 36px;
            background: var(--primary);
            color: #fff;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; margin-right: 12px;
        }

        .logo-text { font-size: 1.1rem; font-weight: 700; color: #fff; letter-spacing: 1px; }

        .nav-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
        }
        /* è‡ªå®šä¹‰ä¾§è¾¹æ æ»šåŠ¨æ¡ */
        .nav-scroll::-webkit-scrollbar { width: 4px; }
        .nav-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

        .nav-group-title {
            font-size: 0.75rem; color: rgba(255,255,255,0.4);
            text-transform: uppercase; margin: 16px 0 8px 12px;
        }

        .nav-item {
            display: flex; align-items: center;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-sidebar);
            text-decoration: none;
        }

        .nav-item:hover { background-color: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background-color: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); }

        .nav-icon { width: 20px; text-align: center; margin-right: 12px; font-size: 1.1rem; }
        .nav-badge { margin-left: auto; font-size: 0.75rem; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 10px; }

        /* ä¾§è¾¹æ åº•éƒ¨æ“ä½œåŒº */
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background-color: rgba(0,0,0,0.1);
            position: relative; /* å…³é”®ï¼šç”¨äºå®šä½å¼¹å‡ºèœå• */
        }

        .cloud-status {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; background: rgba(255,255,255,0.05);
            border-radius: var(--radius); cursor: pointer;
            margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.1);
            transition: 0.2s;
        }
        .cloud-status:hover { background: rgba(255,255,255,0.1); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #64748b; margin-right: 8px; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }

        .footer-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .f-btn {
            padding: 10px; border: none; border-radius: var(--radius);
            font-size: 0.85rem; cursor: pointer; text-align: center;
            color: #fff; background: rgba(255,255,255,0.1); transition: 0.2s;
        }
        .f-btn:hover { background: rgba(255,255,255,0.2); }
        .f-btn-primary { background: var(--primary); }
        .f-btn-primary:hover { background: var(--primary-hover); }

        /* å¼¹å‡ºèœå• (ä¿®å¤ç‚¹å‡»ä¸åŠ¨çš„é—®é¢˜) */
        .popover-menu {
            position: absolute;
            bottom: 100%; /* å‘ä¸Šå¼¹å‡º */
            left: 10px; right: 10px;
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            padding: 8px 0;
            margin-bottom: 10px;
            display: none;
            z-index: 9999; /* æé«˜å±‚çº§ */
            animation: slideUp 0.2s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .popover-menu.show { display: block; }
        .pop-item {
            padding: 12px 20px; color: var(--text-main); cursor: pointer;
            display: flex; align-items: center; gap: 10px; font-size: 0.9rem;
        }
        .pop-item:hover { background: var(--bg-hover); color: var(--primary); }
        @keyframes slideUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* =================================================================
           3. ä¸»å†…å®¹åŒº (Main Area)
           ================================================================= */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .top-bar {
            height: var(--header-h);
            background: #fff;
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }

        .page-title h1 { font-size: 1.5rem; color: var(--text-main); font-weight: 700; }
        
        .top-actions { display: flex; gap: 16px; align-items: center; }
        .search-box { position: relative; }
        .search-input {
            width: 300px; padding: 10px 16px 10px 36px;
            border: 1px solid var(--border); border-radius: var(--radius);
            font-size: 0.95rem; transition: 0.3s;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        .btn-add {
            background: var(--primary); color: #fff; border: none;
            padding: 10px 24px; border-radius: var(--radius); font-weight: 600;
            cursor: pointer; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3); transition: 0.2s;
        }
        .btn-add:hover { background: var(--primary-hover); transform: translateY(-1px); }

        /* æ»šåŠ¨å†…å®¹åŒº */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-deck {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: #fff; padding: 24px; border-radius: var(--radius);
            border: 1px solid var(--border); display: flex; align-items: center; gap: 16px;
            box-shadow: var(--shadow-sm); transition: 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .stat-icon {
            width: 50px; height: 50px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 1.6rem;
        }
        /* ä¸åŒç±»å‹é¢œè‰² */
        .c-paper { background: #e0f2fe; color: #0284c7; }
        .c-patent { background: #fef3c7; color: #d97706; }
        .c-project { background: #dcfce7; color: #16a34a; }
        .c-award { background: #fee2e2; color: #dc2626; }
        .c-book { background: #f3e8ff; color: #9333ea; }
        .c-member { background: #ffedd5; color: #ea580c; }

        /* åˆ—è¡¨å®¹å™¨ */
        .list-wrapper {
            background: #fff; border: 1px solid var(--border);
            border-radius: var(--radius); overflow: hidden;
            display: flex; flex-direction: column;
            min-height: 500px;
        }
        
        .list-toolbar {
            padding: 16px 24px; border-bottom: 1px solid var(--border);
            background: #f8fafc; display: flex; justify-content: space-between; align-items: center;
        }
        
        .filter-group { display: flex; align-items: center; gap: 12px; }
        .year-select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; }
        
        .list-header {
            padding: 12px 24px; border-bottom: 1px solid var(--border);
            background: #f1f5f9; color: var(--text-sub); font-size: 0.85rem; font-weight: 600;
            display: grid; grid-template-columns: 40px 2fr 1fr 1fr 1fr 100px; gap: 16px;
        }
        
        .list-body { flex: 1; overflow-y: auto; }
        
        .list-row {
            padding: 16px 24px; border-bottom: 1px solid var(--border);
            display: grid; grid-template-columns: 40px 2fr 1fr 1fr 1fr 100px; gap: 16px;
            align-items: center; transition: 0.1s; cursor: pointer;
        }
        .list-row:hover { background: #f8fafc; }
        
        .cell-main { font-weight: 600; color: var(--text-main); }
        .cell-sub { color: var(--text-sub); font-size: 0.9rem; }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; background: #e2e8f0; color: var(--text-sub); }
        .tag-blue { background: #e0e7ff; color: var(--primary); }
        
        .row-actions { display: flex; gap: 8px; opacity: 0; transition: 0.2s; }
        .list-row:hover .row-actions { opacity: 1; }
        
        .icon-btn {
            width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--border);
            background: #fff; color: var(--text-sub); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { border-color: var(--primary); color: var(--primary); }
        .icon-btn.del:hover { border-color: var(--danger); color: var(--danger); }

        .empty-state { padding: 60px; text-align: center; color: var(--text-muted); }

        /* =================================================================
           4. å¼¹çª— (Modal)
           ================================================================= */
        .modal-mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
            z-index: 2000; display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .modal-mask.active { opacity: 1; visibility: visible; }
        
        .modal-box {
            background: #fff; width: 650px; max-width: 90%; max-height: 90vh;
            border-radius: 12px; display: flex; flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); transform: scale(0.95); transition: 0.3s;
        }
        .modal-mask.active .modal-box { transform: scale(1); }

        .modal-head { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 24px; overflow-y: auto; }
        .modal-foot { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc; border-radius: 0 0 12px 12px; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-full { grid-column: span 2; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
        .form-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; }
        .form-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        .file-drop { border: 2px dashed var(--border); padding: 30px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .file-drop:hover { border-color: var(--primary); background: #f8fafc; }
        .file-has { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f1f5f9; border-radius: 6px; margin-top: 10px; }

        /* Toast */
        .toast-box { position: fixed; top: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; background: #fff; border-left: 4px solid var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 4px; transform: translateX(100%); transition: 0.3s; font-weight: 500;}
        .toast.show { transform: translateX(0); }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-wrapper { margin-left: 0; }
            .top-bar { padding: 0 16px; }
            .list-header { display: none; } /* ç§»åŠ¨ç«¯éšè—è¡¨å¤´ */
            .list-row { grid-template-columns: 1fr; gap: 8px; padding: 16px; }
            .mobile-toggle { display: block !important; position: fixed; bottom: 20px; right: 20px; z-index: 2000; width: 48px; height: 48px; border-radius: 50%; background: var(--primary); color: #fff; border:none; box-shadow: 0 4px 6px rgba(0,0,0,0.2); font-size: 1.4rem; }
            .form-grid { grid-template-columns: 1fr; }
            .form-full { grid-column: span 1; }
        }
    </style>
</head>
<body>

<button class="mobile-toggle" style="display:none;" onclick="toggleSidebar()">â˜°</button>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-box">ğŸ”¬</div>
            <div class="logo-text">ç§‘ç ”ç®¡ç†ç³»ç»Ÿ</div>
        </div>

        <nav class="nav-scroll">
            <div class="nav-group-title">æˆæœç®¡ç†</div>
            <a class="nav-item active" onclick="switchView('all')" id="nav-all"><span class="nav-icon">ğŸ“‹</span>å…¨éƒ¨æˆæœ <span class="nav-badge" id="c-all">0</span></a>
            <a class="nav-item" onclick="switchView('paper')" id="nav-paper"><span class="nav-icon">ğŸ“„</span>å­¦æœ¯è®ºæ–‡ <span class="nav-badge" id="c-paper">0</span></a>
            <a class="nav-item" onclick="switchView('patent')" id="nav-patent"><span class="nav-icon">ğŸ’¡</span>å‘æ˜ä¸“åˆ© <span class="nav-badge" id="c-patent">0</span></a>
            <a class="nav-item" onclick="switchView('project')" id="nav-project"><span class="nav-icon">ğŸ“Š</span>ç§‘ç ”é¡¹ç›® <span class="nav-badge" id="c-project">0</span></a>
            <a class="nav-item" onclick="switchView('award')" id="nav-award"><span class="nav-icon">ğŸ†</span>è·å¥–æƒ…å†µ <span class="nav-badge" id="c-award">0</span></a>
            <a class="nav-item" onclick="switchView('book')" id="nav-book"><span class="nav-icon">ğŸ“š</span>ä¸“è‘—å‡ºç‰ˆ <span class="nav-badge" id="c-book">0</span></a>
            
            <div class="nav-group-title">å›¢é˜Ÿ</div>
            <a class="nav-item" onclick="switchView('member')" id="nav-member"><span class="nav-icon">ğŸ‘¥</span>æˆå‘˜ä¿¡æ¯ <span class="nav-badge" id="c-member">0</span></a>
        </nav>

        <div class="sidebar-footer">
            <div class="cloud-status" onclick="openCloudModal()">
                <div style="display:flex;align-items:center;">
                    <div class="status-dot" id="cloudDot"></div>
                    <span id="cloudText" style="font-size:0.8rem;">æœªåŒæ­¥</span>
                </div>
                <span style="font-size:0.8rem;">âš™ï¸</span>
            </div>
            <div class="footer-btns">
                <button class="f-btn f-btn-primary" onclick="toggleMenu('exportMenu')">ğŸ“¤ å¯¼å‡º</button>
                <button class="f-btn f-btn-primary" onclick="toggleMenu('importMenu')">ğŸ“¥ å¯¼å…¥</button>
            </div>

            <div id="exportMenu" class="popover-menu">
                <div class="pop-item" onclick="exportToExcel()">ğŸ“Š Excel (åˆ†è¡¨)</div>
                <div class="pop-item" onclick="exportToWord()">ğŸ“ Word (åˆ†è¡¨)</div>
                <div class="pop-item" onclick="backupJSON()">ğŸ“¦ å¤‡ä»½æ•°æ® (JSON)</div>
            </div>

            <div id="importMenu" class="popover-menu">
                <div class="pop-item" onclick="document.getElementById('excelIn').click()">ğŸ“Š å¯¼å…¥ Excel</div>
                <div class="pop-item" onclick="document.getElementById('jsonIn').click()">ğŸ“‚ æ¢å¤å¤‡ä»½</div>
            </div>
            
            <input type="file" id="jsonIn" hidden accept=".json" onchange="restoreJSON(this)">
            <input type="file" id="excelIn" hidden accept=".xlsx,.xls" onchange="importExcel(this)">
        </div>
    </aside>

    <main class="main-wrapper">
        <header class="top-bar">
            <div class="page-title"><h1 id="pageTitle">å…¨éƒ¨æˆæœ</h1></div>
            <div class="top-actions">
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" class="search-input" placeholder="æœç´¢..." oninput="handleSearch(this.value)">
                </div>
                <button class="btn-add" onclick="openAddModal()">â• <span id="addText">æ–°å¢</span></button>
            </div>
        </header>

        <div class="content-area">
            <div class="stats-deck" id="statsDeck"></div>

            <div class="list-wrapper">
                <div class="list-toolbar">
                    <div class="filter-group">
                        <input type="checkbox" id="selectAll" onchange="toggleAll(this)"> å…¨é€‰
                        <span style="color:#64748b;font-size:0.9rem;" id="selCount">(0)</span>
                        <button class="btn-danger" id="batchDel" style="display:none;background:var(--danger);color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;" onclick="batchDelete()">åˆ é™¤</button>
                    </div>
                    <div>
                        <select class="year-select" id="yearFilter" onchange="applyFilter()">
                            <option value="all">æ‰€æœ‰å¹´ä»½</option>
                        </select>
                    </div>
                </div>

                <div class="list-header">
                    <div></div> <div>æ ‡é¢˜/åç§°</div>
                    <div>æ—¥æœŸ</div>
                    <div>äººå‘˜</div>
                    <div>è¯¦æƒ…</div>
                    <div>æ“ä½œ</div>
                </div>

                <div class="list-body" id="listBody">
                    </div>
            </div>
        </div>
    </main>
</div>

<div class="modal-mask" id="dataModal">
    <div class="modal-box">
        <div class="modal-head">
            <h3 id="modalLabel">æ–°å¢è®°å½•</h3>
            <button class="close-btn" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="mainForm">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group form-full">
                        <label class="form-label">ç±»å‹</label>
                        <select id="dataType" class="form-input" onchange="renderFormFields()">
                            <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                            <option value="patent">å‘æ˜ä¸“åˆ©</option>
                            <option value="project">ç§‘ç ”é¡¹ç›®</option>
                            <option value="award">è·å¥–æƒ…å†µ</option>
                            <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                            <option value="member">æˆå‘˜ä¿¡æ¯</option>
                        </select>
                    </div>
                    
                    <div id="dynamicFields" class="form-full form-grid" style="margin:0;padding:0;gap:20px;"></div>

                    <div class="form-group form-full" id="fileGroup">
                        <label class="form-label">é™„ä»¶ (PDF)</label>
                        <div class="file-drop" onclick="document.getElementById('pdfInput').click()">
                            ç‚¹å‡»ä¸Šä¼  PDF æ–‡ä»¶ (æ”¯æŒå¤§æ–‡ä»¶)
                            <input type="file" id="pdfInput" hidden accept=".pdf" onchange="handleFile(this)">
                        </div>
                        <div id="filePreview" class="file-has hidden">
                            <span id="fileName"></span>
                            <button type="button" class="file-remove" onclick="removeFile()">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-foot">
            <button class="f-btn" style="color:#333;border:1px solid #ccc;" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="f-btn f-btn-primary" onclick="saveData()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-mask" id="cloudModal">
    <div class="modal-box" style="max-width:500px;">
        <div class="modal-head"><h3>â˜ï¸ äº‘åŒæ­¥é…ç½®</h3><button class="close-btn" onclick="document.getElementById('cloudModal').classList.remove('active')">Ã—</button></div>
        <div class="modal-body">
            <p style="font-size:0.9rem;color:#666;margin-bottom:15px;">ä½¿ç”¨ GitHub Gist åŒæ­¥æ•°æ®ã€‚éœ€ç”³è¯· Token å¹¶å‹¾é€‰ <b>gist</b> æƒé™ã€‚</p>
            <div class="form-group"><label class="form-label">GitHub Token</label><input type="password" id="ghToken" class="form-input" placeholder="ghp_..."></div>
            <div class="form-group"><label class="form-label">Gist ID (é€‰å¡«ï¼Œç•™ç©ºæ–°å»º)</label><input type="text" id="ghGist" class="form-input"></div>
        </div>
        <div class="modal-foot">
            <button class="f-btn f-btn-primary" onclick="connectCloud()">è¿æ¥ / åˆ›å»º</button>
        </div>
    </div>
</div>

<div class="toast-box" id="toastBox"></div>

<script>
/**
 * =================================================================
 * æ ¸å¿ƒé€»è¾‘ï¼šæ•°æ®ç»“æ„ã€å­˜å‚¨ã€æ¸²æŸ“
 * =================================================================
 */
const APP = {
    data: { achievements: [], members: [] },
    config: { token: '', gistId: '' },
    view: 'all',
    filter: { search: '', year: 'all' },
    db: null,
    selected: new Set(),
    currentFile: null,
    
    // å­—æ®µæ˜ å°„å®šä¹‰ (ç”¨äºç”Ÿæˆè¡¨å•å’Œå¯¼å‡º)
    schema: {
        paper: [
            { id: 'title', label: 'è®ºæ–‡æ ‡é¢˜', type: 'text', required: true, full: true },
            { id: 'date', label: 'å‘è¡¨æ—¥æœŸ', type: 'date', required: true },
            { id: 'authors', label: 'ä½œè€…åˆ—è¡¨', type: 'text', placeholder: 'é€—å·åˆ†éš”' },
            { id: 'source', label: 'æœŸåˆŠ/ä¼šè®®', type: 'text' },
            { id: 'level', label: 'æ”¶å½•çº§åˆ«', type: 'text', placeholder: 'SCI/EI' },
            { id: 'keywords', label: 'å…³é”®è¯', type: 'text', full: true }
        ],
        patent: [
            { id: 'patentName', label: 'ä¸“åˆ©åç§°', type: 'text', required: true, full: true },
            { id: 'patentNumber', label: 'ä¸“åˆ©å·', type: 'text' },
            { id: 'patentType', label: 'ç±»å‹', type: 'select', opts: ['å‘æ˜ä¸“åˆ©','å®ç”¨æ–°å‹','å¤–è§‚è®¾è®¡'] },
            { id: 'patentStatus', label: 'çŠ¶æ€', type: 'select', opts: ['ç”³è¯·ä¸­','å®å®¡ä¸­','å·²æˆæƒ','å·²è½¬è®©'] },
            { id: 'applicationDate', label: 'ç”³è¯·æ—¥æœŸ', type: 'date' },
            { id: 'grantDate', label: 'æˆæƒæ—¥æœŸ', type: 'date' },
            { id: 'inventors', label: 'å‘æ˜äºº', type: 'text', full: true },
            { id: 'patentOwner', label: 'æƒåˆ©äºº', type: 'text' }
        ],
        project: [
            { id: 'projectName', label: 'é¡¹ç›®åç§°', type: 'text', required: true, full: true },
            { id: 'projectNumber', label: 'é¡¹ç›®ç¼–å·', type: 'text' },
            { id: 'projectLevel', label: 'çº§åˆ«', type: 'select', opts: ['å›½å®¶çº§','çœéƒ¨çº§','å…å±€çº§','æ¨ªå‘','æ ¡çº§'] },
            { id: 'projectOrg', label: 'æ‰€å±å•ä½', type: 'text' },
            { id: 'projectStartDate', label: 'å¼€å§‹æ—¶é—´', type: 'date' },
            { id: 'projectEndDate', label: 'ç»“æŸæ—¶é—´', type: 'date' },
            { id: 'authors', label: 'è´Ÿè´£äºº/æˆå‘˜', type: 'text', full: true } // Reuse authors
        ],
        award: [
            { id: 'title', label: 'è·å¥–åç§°', type: 'text', required: true, full: true },
            { id: 'date', label: 'è·å¥–æ—¥æœŸ', type: 'date' },
            { id: 'level', label: 'å¥–åŠ±ç­‰çº§', type: 'text' },
            { id: 'source', label: 'æˆå¥–å•ä½', type: 'text' },
            { id: 'authors', label: 'è·å¥–äºº', type: 'text', full: true }
        ],
        book: [
            { id: 'title', label: 'ä¸“è‘—åç§°', type: 'text', required: true, full: true },
            { id: 'authors', label: 'ä½œè€…', type: 'text' },
            { id: 'date', label: 'å‡ºç‰ˆæ—¥æœŸ', type: 'date' },
            { id: 'source', label: 'å‡ºç‰ˆç¤¾', type: 'text' },
            { id: 'isbn', label: 'ISBNå·', type: 'text' }
        ],
        member: [
            { id: 'memberNo', label: 'å·¥å·/å­¦å·', type: 'text', required: true },
            { id: 'memberName', label: 'å§“å', type: 'text', required: true },
            { id: 'memberGender', label: 'æ€§åˆ«', type: 'select', opts: ['ç”·','å¥³'] },
            { id: 'memberBirth', label: 'å‡ºç”Ÿå¹´æœˆ', type: 'month' },
            { id: 'memberOrg', label: 'æ‰€å±å•ä½', type: 'text' },
            { id: 'memberTitle', label: 'èŒç§°/èŒåŠ¡', type: 'text' },
            { id: 'memberPhone', label: 'æ‰‹æœºå·ç ', type: 'text' },
            { id: 'memberEmail', label: 'ç”µå­é‚®ç®±', type: 'text' },
            { id: 'memberIdNo', label: 'è¯ä»¶å·ç ', type: 'text', full: true }
        ]
    }
};

// --- IndexedDB ---
function initDB() {
    return new Promise((resolve) => {
        const req = indexedDB.open('ResearchSysDB', 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore('store', {keyPath:'id'});
        req.onsuccess = e => { APP.db = e.target.result; resolve(); };
    });
}

async function loadData() {
    if(!APP.db) await initDB();
    const tx = APP.db.transaction('store', 'readonly');
    const req = tx.objectStore('store').get('main');
    req.onsuccess = e => {
        if(e.target.result) {
            APP.data = e.target.result.data;
            APP.config = e.target.result.config || {token:'', gistId:''};
        }
        updateUI();
        if(APP.config.token) checkCloud();
    };
}

async function persist() {
    const tx = APP.db.transaction('store', 'readwrite');
    tx.objectStore('store').put({ id: 'main', data: APP.data, config: APP.config });
    if(APP.config.token) syncCloud();
}

// --- UI Rendering ---
function updateUI() {
    renderStats();
    renderList();
    updateCounts();
}

function updateCounts() {
    const c = { paper:0, patent:0, project:0, award:0, book:0 };
    APP.data.achievements.forEach(i => { if(c[i.type]!==undefined) c[i.type]++; });
    document.getElementById('c-all').innerText = APP.data.achievements.length;
    document.getElementById('c-member').innerText = APP.data.members.length;
    Object.keys(c).forEach(k => document.getElementById(`c-${k}`).innerText = c[k]);
}

function renderStats() {
    const types = [
        {k:'paper', t:'å­¦æœ¯è®ºæ–‡', c:'#e0f2fe', i:'ğŸ“„'}, {k:'patent', t:'å‘æ˜ä¸“åˆ©', c:'#fef3c7', i:'ğŸ’¡'},
        {k:'project', t:'ç§‘ç ”é¡¹ç›®', c:'#dcfce7', i:'ğŸ“Š'}, {k:'award', t:'è·å¥–æƒ…å†µ', c:'#fee2e2', i:'ğŸ†'},
        {k:'book', t:'ä¸“è‘—å‡ºç‰ˆ', c:'#f3e8ff', i:'ğŸ“š'}, {k:'member', t:'å›¢é˜Ÿæˆå‘˜', c:'#ffedd5', i:'ğŸ‘¥'}
    ];
    const html = types.map(t => {
        const num = t.k==='member' ? APP.data.members.length : APP.data.achievements.filter(i=>i.type===t.k).length;
        return `<div class="stat-card" onclick="switchView('${t.k}')" style="cursor:pointer">
            <div class="stat-icon" style="background:${t.c}">${t.i}</div>
            <div><h3>${num}</h3><p style="color:#666">${t.t}</p></div>
        </div>`;
    }).join('');
    document.getElementById('statsDeck').innerHTML = html;
}

function renderList() {
    const container = document.getElementById('listBody');
    let list = APP.view==='member' ? APP.data.members : APP.data.achievements;
    
    // Filter
    if(APP.view !== 'all' && APP.view !== 'member') list = list.filter(i => i.type === APP.view);
    if(APP.filter.search) {
        const q = APP.filter.search.toLowerCase();
        list = list.filter(i => Object.values(i).join(' ').toLowerCase().includes(q));
    }
    
    // Update Year Filter Options
    if(APP.view !== 'member') {
        const years = [...new Set(list.map(i => (i.date||i.applicationDate||i.projectStartDate||'').substr(0,4)).filter(y=>y))].sort().reverse();
        const sel = document.getElementById('yearFilter');
        sel.innerHTML = '<option value="all">æ‰€æœ‰å¹´ä»½</option>' + years.map(y => `<option value="${y}" ${APP.filter.year===y?'selected':''}>${y}å¹´</option>`).join('');
        if(APP.filter.year !== 'all') list = list.filter(i => (i.date||i.applicationDate||i.projectStartDate||'').startsWith(APP.filter.year));
    }

    if(list.length === 0) {
        container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
        return;
    }

    container.innerHTML = list.map(item => {
        const title = item.title || item.patentName || item.projectName || item.memberName;
        const date = item.date || item.applicationDate || item.projectStartDate || item.memberBirth || '-';
        const sub = item.authors || item.inventors || item.memberOrg || '-';
        const tag = item.level || item.patentStatus || item.projectLevel || item.memberTitle || '';
        const typeIcon = {paper:'ğŸ“„',patent:'ğŸ’¡',project:'ğŸ“Š',award:'ğŸ†',book:'ğŸ“š',member:'ğŸ‘¥'}[item.type||'paper'] || 'ğŸ“„';
        
        return `
        <div class="list-row" onclick="editItem('${item.id}')">
            <div><input type="checkbox" class="row-check" value="${item.id}" onchange="updateBatchUI(event)" onclick="event.stopPropagation()"></div>
            <div class="cell-main" style="display:flex;align-items:center;gap:10px;">
                <span style="font-size:1.2rem">${typeIcon}</span> ${title}
            </div>
            <div class="cell-sub">${date}</div>
            <div class="cell-sub">${sub}</div>
            <div>${tag ? `<span class="tag">${tag}</span>` : ''} ${item.pdfData ? '<span class="tag tag-blue">PDF</span>' : ''}</div>
            <div class="row-actions">
                ${item.pdfData ? `<button class="icon-btn" onclick="viewPdf('${item.id}');event.stopPropagation()">ğŸ‘</button>` : ''}
                <button class="icon-btn del" onclick="delItem('${item.id}');event.stopPropagation()">ğŸ—‘</button>
            </div>
        </div>`;
    }).join('');
}

// --- Interaction ---
function switchView(v) {
    APP.view = v;
    document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.id === `nav-${v}`));
    document.getElementById('pageTitle').innerText = v === 'member' ? 'å›¢é˜Ÿæˆå‘˜' : (v==='all'?'å…¨éƒ¨æˆæœ':APP.schema[v][0].label.replace('åç§°','').replace('æ ‡é¢˜','ç®¡ç†'));
    document.getElementById('addBtnText').innerText = v === 'member' ? 'æ·»åŠ æˆå‘˜' : 'æ·»åŠ æˆæœ';
    APP.selected.clear();
    updateBatchUI();
    renderList();
    if(window.innerWidth<=768) toggleSidebar();
}

function handleSearch(val) { APP.filter.search = val; renderList(); }
function applyFilter() { APP.filter.year = document.getElementById('yearFilter').value; renderList(); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
function toggleMenu(id) { 
    const el = document.getElementById(id);
    const isShow = el.classList.contains('show');
    document.querySelectorAll('.popover-menu').forEach(m => m.classList.remove('show'));
    if(!isShow) el.classList.add('show');
}
// Close menu on click outside
window.onclick = e => {
    if(!e.target.closest('.data-actions') && !e.target.closest('.popover-menu')) {
        document.querySelectorAll('.popover-menu').forEach(m => m.classList.remove('show'));
    }
}

// --- CRUD ---
function openAddModal() {
    document.getElementById('mainForm').reset();
    document.getElementById('editId').value = '';
    APP.currentFile = null;
    document.getElementById('filePreview').classList.add('hidden');
    document.getElementById('dataType').value = (APP.view === 'all' ? 'paper' : APP.view);
    document.getElementById('dataType').disabled = false;
    renderFormFields();
    document.getElementById('dataModal').classList.add('active');
}

function renderFormFields() {
    const type = document.getElementById('dataType').value;
    const fields = APP.schema[type];
    const container = document.getElementById('dynamicFields');
    container.innerHTML = fields.map(f => {
        let input = '';
        if(f.type === 'select') {
            input = `<select id="f_${f.id}" class="form-input">${f.opts.map(o=>`<option>${o}</option>`).join('')}</select>`;
        } else {
            input = `<input type="${f.type}" id="f_${f.id}" class="form-input" ${f.required?'required':''} placeholder="${f.placeholder||''}">`;
        }
        return `<div class="form-group ${f.full?'form-span':''}"><label class="form-label">${f.label}</label>${input}</div>`;
    }).join('');
    
    // File upload visibility
    document.getElementById('fileGroup').style.display = type === 'member' ? 'none' : 'block';
}

function saveData() {
    const id = document.getElementById('editId').value;
    const type = document.getElementById('dataType').value;
    const obj = { 
        id: id || Date.now().toString(),
        type: type, 
        updatedAt: new Date().toISOString()
    };
    
    // Collect Fields
    APP.schema[type].forEach(f => {
        obj[f.id] = document.getElementById(`f_${f.id}`).value;
    });

    // File
    if(APP.currentFile) { obj.pdfData = APP.currentFile.data; obj.pdfName = APP.currentFile.name; }
    else if(id) {
        // Keep existing file if editing
        const old = (type==='member'?APP.data.members:APP.data.achievements).find(i=>i.id===id);
        if(old && old.pdfData) { obj.pdfData = old.pdfData; obj.pdfName = old.pdfName; }
    }

    if(type === 'member') {
        const idx = APP.data.members.findIndex(m=>m.id===obj.id);
        if(idx>-1) APP.data.members[idx] = obj; else APP.data.members.push(obj);
    } else {
        const idx = APP.data.achievements.findIndex(a=>a.id===obj.id);
        if(idx>-1) APP.data.achievements[idx] = obj; else APP.data.achievements.push(obj);
    }

    persist();
    closeModal();
    updateUI();
    showToast('ä¿å­˜æˆåŠŸ');
}

function editItem(id) {
    const item = [...APP.data.achievements, ...APP.data.members].find(i => i.id === id);
    if(!item) return;

    document.getElementById('editId').value = id;
    document.getElementById('dataType').value = item.type || 'paper';
    document.getElementById('dataType').disabled = true; // Cannot change type on edit
    renderFormFields();

    // Fill values
    APP.schema[item.type || 'paper'].forEach(f => {
        if(document.getElementById(`f_${f.id}`)) document.getElementById(`f_${f.id}`).value = item[f.id] || '';
    });

    if(item.pdfData) {
        document.getElementById('fileName').innerText = item.pdfName;
        document.getElementById('filePreview').classList.remove('hidden');
    } else {
        document.getElementById('filePreview').classList.add('hidden');
    }

    document.getElementById('dataModal').classList.add('active');
}

function closeModal() { document.getElementById('dataModal').classList.remove('active'); }

// --- Batch ---
function toggleAll(cb) {
    document.querySelectorAll('.row-check').forEach(c => {
        c.checked = cb.checked;
        if(cb.checked) APP.selected.add(c.value); else APP.selected.delete(c.value);
    });
    updateBatchUI();
}
function updateBatchUI(e) {
    if(e) {
        if(e.target.checked) APP.selected.add(e.target.value); else APP.selected.delete(e.target.value);
    }
    document.getElementById('selCount').innerText = `(${APP.selected.size})`;
    document.getElementById('batchDel').style.display = APP.selected.size ? 'inline-block' : 'none';
}
function delItem(id) {
    if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
    APP.data.achievements = APP.data.achievements.filter(i => i.id !== id);
    APP.data.members = APP.data.members.filter(i => i.id !== id);
    persist();
    updateUI();
}
function batchDelete() {
    if(!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${APP.selected.size} é¡¹ï¼Ÿ`)) return;
    APP.data.achievements = APP.data.achievements.filter(i => !APP.selected.has(i.id));
    APP.data.members = APP.data.members.filter(i => !APP.selected.has(i.id));
    APP.selected.clear();
    persist();
    updateUI();
}

// --- File ---
function handleFile(input) {
    const f = input.files[0];
    if(!f) return;
    if(f.size > 20*1024*1024) return showToast('æ–‡ä»¶è¿‡å¤§ (>20MB)','warning');
    const r = new FileReader();
    r.onload = e => {
        APP.currentFile = { name: f.name, data: e.target.result };
        document.getElementById('fileName').innerText = f.name;
        document.getElementById('filePreview').classList.remove('hidden');
    };
    r.readAsDataURL(f);
}
function removeFile() { APP.currentFile = null; document.getElementById('filePreview').classList.add('hidden'); }
function viewPdf(id) {
    const item = APP.data.achievements.find(i=>i.id===id);
    if(item && item.pdfData) {
        const arr = item.pdfData.split(','), bstr = atob(arr[1]), n = bstr.length, u8 = new Uint8Array(n);
        while(n--) u8[n] = bstr.charCodeAt(n);
        const url = URL.createObjectURL(new Blob([u8], {type:'application/pdf'}));
        window.open(url);
    }
}

// --- Import/Export ---
function backupJSON() {
    const blob = new Blob([JSON.stringify(APP.data)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}
function restoreJSON(input) {
    const f = input.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        try {
            APP.data = JSON.parse(e.target.result);
            persist();
            location.reload();
        } catch(err) { showToast('æ–‡ä»¶æ ¼å¼é”™è¯¯','error'); }
    };
    r.readAsText(f);
}

// *** Excel Split Export ***
function exportToExcel() {
    const wb = XLSX.utils.book_new();
    const sheets = {
        'å­¦æœ¯è®ºæ–‡': APP.data.achievements.filter(i=>i.type==='paper'),
        'å‘æ˜ä¸“åˆ©': APP.data.achievements.filter(i=>i.type==='patent'),
        'ç§‘ç ”é¡¹ç›®': APP.data.achievements.filter(i=>i.type==='project'),
        'è·å¥–æƒ…å†µ': APP.data.achievements.filter(i=>i.type==='award'),
        'ä¸“è‘—å‡ºç‰ˆ': APP.data.achievements.filter(i=>i.type==='book'),
        'å›¢é˜Ÿæˆå‘˜': APP.data.members
    };

    for(let name in sheets) {
        if(sheets[name].length > 0) {
            // Map data to ordered columns based on schema
            const typeKey = Object.keys(APP.schema).find(k => {
                if(k==='member' && name==='å›¢é˜Ÿæˆå‘˜') return true;
                if(APP.types[k].label === name) return true;
            });
            const schema = APP.schema[typeKey];
            
            const rows = sheets[name].map(item => {
                const row = {};
                schema.forEach(field => row[field.label] = item[field.id]);
                return row;
            });
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), name);
        }
    }
    
    if(wb.SheetNames.length===0) return showToast('æ— æ•°æ®å¯å¯¼å‡º','warning');
    XLSX.writeFile(wb, "ç§‘ç ”æˆæœåˆ†è¡¨æ•°æ®.xlsx");
}

function importExcel(input) {
    const f = input.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws);
        // Simple Import to 'Paper'
        json.forEach(row => {
            APP.data.achievements.push({
                id: Date.now()+Math.random().toString(),
                type: 'paper',
                title: row['æ ‡é¢˜'] || row['Title'] || 'æœªå‘½å',
                date: new Date().toISOString().slice(0,10),
                updatedAt: new Date().toISOString()
            });
        });
        persist();
        updateUI();
        showToast(`å¯¼å…¥ ${json.length} æ¡æ•°æ®`);
    };
    r.readAsArrayBuffer(f);
}

// *** Word Split Export ***
function exportToWord() {
    let html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><style>table{border-collapse:collapse;width:100%;margin-bottom:20px;font-size:10pt} th,td{border:1px solid #000;padding:4px} th{background:#f0f0f0}</style></head><body><h2 style="text-align:center">ç§‘ç ”æˆæœæ±‡æ€»è¡¨</h2>`;

    const groups = {
        'å­¦æœ¯è®ºæ–‡': APP.data.achievements.filter(i=>i.type==='paper'),
        'å‘æ˜ä¸“åˆ©': APP.data.achievements.filter(i=>i.type==='patent'),
        'ç§‘ç ”é¡¹ç›®': APP.data.achievements.filter(i=>i.type==='project'),
        'è·å¥–æƒ…å†µ': APP.data.achievements.filter(i=>i.type==='award'),
        'ä¸“è‘—å‡ºç‰ˆ': APP.data.achievements.filter(i=>i.type==='book'),
        'å›¢é˜Ÿæˆå‘˜': APP.data.members
    };

    for(let name in groups) {
        if(groups[name].length === 0) continue;
        const typeKey = name === 'å›¢é˜Ÿæˆå‘˜' ? 'member' : Object.keys(APP.types).find(k => APP.types[k].label === name);
        const headers = APP.schema[typeKey].map(f => f.label);
        const ids = APP.schema[typeKey].map(f => f.id);

        html += `<h3>${name}</h3><table><tr><th>åºå·</th>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>`;
        groups[name].forEach((item, idx) => {
            html += `<tr><td>${idx+1}</td>${ids.map(id=>`<td>${item[id]||''}</td>`).join('')}</tr>`;
        });
        html += `</table>`;
    }

    html += `</body></html>`;
    const blob = new Blob([html], {type:'application/msword'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ç§‘ç ”æˆæœåˆ†è¡¨æ±‡æ€».doc';
    a.click();
}

// --- Cloud ---
function openCloudModal() {
    document.getElementById('ghToken').value = APP.config.token;
    document.getElementById('ghGist').value = APP.config.gistId;
    document.getElementById('cloudModal').classList.add('active');
}
function closeCloudModal() { document.getElementById('cloudModal').classList.remove('active'); }

async function connectCloud() {
    const t = document.getElementById('ghToken').value;
    const g = document.getElementById('ghGist').value;
    if(!t) return showToast('Token ä¸èƒ½ä¸ºç©º','error');
    
    showToast('è¿æ¥ä¸­...','warning');
    APP.config.token = t;
    if(g) {
        APP.config.gistId = g;
        await syncCloud(true); // Pull first
    } else {
        // Create
        try {
            const res = await fetch('https://api.github.com/gists', {
                method:'POST', headers:{Authorization:`token ${t}`},
                body:JSON.stringify({description:"Research Data", public:false, files:{"data.json":{content:JSON.stringify(APP.data)}}})
            });
            if(res.ok) {
                const d = await res.json();
                APP.config.gistId = d.id;
                persist();
                checkCloud();
                showToast('äº‘ç«¯åˆ›å»ºæˆåŠŸ');
                closeCloudModal();
            } else throw new Error();
        } catch(e) { showToast('åˆ›å»ºå¤±è´¥ï¼Œæ£€æŸ¥Token','error'); }
    }
}

async function syncCloud(isPull) {
    if(!APP.config.token || !APP.config.gistId) return;
    const url = `https://api.github.com/gists/${APP.config.gistId}`;
    const head = {Authorization:`token ${APP.config.token}`};
    
    if(isPull) {
        try {
            const res = await fetch(url, {headers:head});
            const d = await res.json();
            const cloudData = JSON.parse(d.files['data.json'].content);
            APP.data = cloudData;
            persist();
            updateUI();
            showToast('å·²ä»äº‘ç«¯åŒæ­¥');
        } catch(e) { showToast('åŒæ­¥å¤±è´¥','error'); }
    } else {
        // Push (Remove heavy PDF blobs for cloud sync to prevent errors)
        const leanData = { 
            achievements: APP.data.achievements.map(i => { const {pdfData, ...rest} = i; return rest; }),
            members: APP.data.members
        };
        fetch(url, {
            method:'PATCH', headers:head,
            body:JSON.stringify({files:{"data.json":{content:JSON.stringify(leanData)}}})
        });
    }
}

function checkCloud() {
    const dot = document.getElementById('cloudDot');
    const txt = document.getElementById('cloudText');
    if(APP.config.token) {
        dot.classList.add('online');
        dot.style.background = 'var(--success)';
        txt.innerText = 'äº‘ç«¯å·²è¿æ¥';
    }
}

function showToast(msg, type='success') {
    const div = document.createElement('div');
    div.className = `toast ${type} show`;
    div.innerText = msg;
    document.getElementById('toastBox').appendChild(div);
    setTimeout(() => div.remove(), 2000);
}

// Start
window.onload = loadData;
</script>
</body>
</html>

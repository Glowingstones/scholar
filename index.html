<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ V5.0 Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸæœ‰æ ·å¼ä¿ç•™ --- */
        :root {
            --bg-primary: #f8fafc; --bg-secondary: #ffffff; --bg-card: #ffffff; --bg-hover: #f1f5f9;
            --text-primary: #1e293b; --text-secondary: #64748b; --text-muted: #94a3b8;
            --border: #e2e8f0; --border-light: #f1f5f9;
            --accent: #6366f1; --accent-light: #eef2ff; --accent-dark: #4f46e5;
            --success: #10b981; --success-light: #d1fae5;
            --warning: #f59e0b; --warning-light: #fef3c7;
            --danger: #ef4444; --danger-light: #fee2e2;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.1);
            --radius: 12px; --radius-sm: 8px;
            --od-blue: #0078D4; --od-hover: #005a9e; --od-light: #f3f9fd;
        }

        html.dark {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #1e293b; --bg-hover: #334155;
            --text-primary: #f1f5f9; --text-secondary: #94a3b8; --text-muted: #64748b;
            --border: #334155; --border-light: #1e293b;
            --accent-light: #312e81; --success-light: #064e3b; --warning-light: #78350f; --danger-light: #7f1d1d; --od-light: #002c4e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans SC', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        .app-container { display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar & Layout (ä¿æŒåŸæ ·) */
        .sidebar { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; height: 100%; z-index: 100; transition: transform 0.3s; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; }
        .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
        .nav-menu { flex: 1; padding: 16px 12px; overflow-y: auto; }
        .nav-section { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; padding: 12px 12px 8px; margin-top: 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary); font-weight: 500; transition: all 0.2s; margin-bottom: 4px; }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-light); color: var(--accent); }
        .nav-item.disabled { opacity: 0.5; pointer-events: none; }
        .nav-item .badge { margin-left: auto; background: var(--bg-hover); padding: 2px 10px; border-radius: 10px; font-size: 0.8rem; }
        .nav-item.active .badge { background: var(--accent); color: white; }
        
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
        .data-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .data-btn { padding: 10px 8px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text-secondary); font-size: 0.85rem; cursor: pointer; text-align: center; }
        .data-btn:hover { background: var(--bg-hover); border-color: var(--accent); color: var(--accent); }
        .data-btn.onedrive { border-color: var(--od-blue); color: var(--od-blue); }
        .dropdown-menu { position: absolute; bottom: 100%; left: 10px; right: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: var(--shadow-lg); display: none; z-index: 200; overflow: hidden; margin-bottom: 8px; }
        .dropdown-menu.show { display: block; animation: slideUp 0.2s; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .menu-item { padding: 14px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; border-bottom: 1px solid var(--border-light); }
        .menu-item:hover { background: var(--bg-hover); color: var(--accent); }

        /* Main Content */
        .main-content { flex: 1; padding: 20px; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 12px; flex-wrap: wrap; flex-shrink: 0; }
        .page-title { font-size: 1.5rem; font-weight: 700; }
        .header-actions { display: flex; gap: 10px; align-items: center; flex: 1; justify-content: flex-end; }
        .search-box { flex: 1; min-width: 200px; max-width: 320px; }
        .search-box input { padding: 12px 16px; border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg-card); color: var(--text-primary); width: 100%; transition: all 0.2s; }
        .search-box input:focus { outline: none; border-color: var(--accent); }
        .btn { padding: 12px 20px; border-radius: var(--radius); font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; box-shadow: var(--shadow); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px; flex-shrink: 0; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .stat-icon.papers { background: #dbeafe; } .stat-icon.patents { background: #fef3c7; } .stat-icon.projects { background: #d1fae5; } 
        .stat-icon.awards { background: #fce7f3; } .stat-icon.books { background: #e0e7ff; } .stat-icon.members { background: #f3e8ff; }

        /* List View */
        #listViewContainer { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .filter-container { margin-bottom: 12px; flex-shrink: 0; }
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .filter-chip { padding: 6px 14px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border); font-size: 0.85rem; cursor: pointer; }
        .filter-chip.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        /* New: Advanced Filter Panel */
        .adv-filter-panel { background: var(--bg-hover); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; margin-top: 8px; display: none; }
        .adv-filter-panel.active { display: block; animation: slideDown 0.2s; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .results-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .results-header { display: flex; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); flex-shrink: 0; align-items: center; }
        .results-list { flex: 1; overflow-y: auto; }
        
        .result-item { display: flex; align-items: flex-start; padding: 12px 16px; border-bottom: 1px solid var(--border-light); cursor: pointer; gap: 12px; transition: background 0.2s; }
        .result-item:hover { background: var(--bg-hover); }
        .result-item.sortable-drag { opacity: 0.5; background: var(--accent-light); } /* æ‹–æ‹½æ ·å¼ */
        .result-type { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .type-paper { background: #dbeafe; } .type-patent { background: #fef3c7; } .type-project { background: #d1fae5; } 
        .type-award { background: #fce7f3; } .type-book { background: #e0e7ff; } .type-member { background: #f3e8ff; }
        .result-content { flex: 1; min-width: 0; }
        .result-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; line-height: 1.4; }
        .result-meta { font-size: 0.8rem; color: var(--text-secondary); display: flex; flex-wrap: wrap; gap: 8px; }
        .result-actions { display: flex; gap: 4px; align-items: center; }
        .action-btn { width: 32px; height: 32px; border: none; background: transparent; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .action-btn:hover { background: var(--bg-hover); color: var(--accent); }
        .action-btn.delete:hover { background: var(--danger-light); color: var(--danger); }

        /* Modals & Forms */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border-radius: var(--radius); width: 90%; max-width: 600px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); }
        .modal.wide { max-width: 800px; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary); transition: border 0.2s; }
        .form-group input:focus { outline: none; border-color: var(--accent); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* === æ–°å¢æ ·å¼ (V5.0) === */
        /* 1. æ ‡ç­¾ Tag ç³»ç»Ÿ */
        .tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
        .tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: var(--accent-light); color: var(--accent); border: 1px solid var(--accent); display: flex; align-items: center; gap: 4px; }
        .tag-input-area { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; border: 2px solid var(--border); border-radius: var(--radius-sm); min-height: 40px; }
        .tag-input { border: none; outline: none; background: transparent; flex: 1; min-width: 80px; color: var(--text-primary); }

        /* 2. åˆ†é¡µæ§ä»¶ */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 12px; border-top: 1px solid var(--border); flex-shrink: 0; background: var(--bg-secondary); }
        .page-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; transition: all 0.2s; }
        .page-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 0.85rem; color: var(--text-secondary); }

        /* 3. å¼•ç”¨ç”Ÿæˆæ¡† */
        .citation-box { background: var(--bg-hover); padding: 10px; border-radius: var(--radius-sm); margin-top: 8px; font-family: 'Courier New', monospace; font-size: 0.85rem; border: 1px dashed var(--border); position: relative; word-break: break-all; }
        .citation-copy { position: absolute; right: 5px; top: 5px; padding: 2px 6px; font-size: 0.7rem; cursor: pointer; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; }
        
        /* 4. æ“ä½œæ—¥å¿—ä¸å›æ”¶ç«™ */
        .log-item { padding: 8px 0; border-bottom: 1px solid var(--border-light); font-size: 0.85rem; display: flex; gap: 10px; }
        .log-time { color: var(--text-muted); min-width: 130px; }
        .log-action { font-weight: 600; color: var(--text-primary); min-width: 80px; }
        .log-detail { color: var(--text-secondary); flex: 1; }
        .deleted-item { opacity: 0.7; background: var(--danger-light) !important; }
        
        /* 5. æ™ºèƒ½æå–æŒ‰é’® */
        .smart-btn { position: absolute; right: 2px; top: 32px; padding: 6px 10px; font-size: 0.75rem; background: var(--accent); color: white; border: none; border-radius: 0 4px 4px 0; cursor: pointer; height: 42px; }
        .input-wrapper { position: relative; }
        .input-wrapper input { padding-right: 70px; } /* ä¸ºæŒ‰é’®ç•™å‡ºç©ºé—´ */

        /* 6. Toast & Login Overlay (ä¿æŒä¸€è‡´) */
        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .toast { padding: 10px 20px; border-radius: var(--radius-sm); margin-bottom: 10px; background: white; box-shadow: var(--shadow-lg); font-weight: 500; display: none; }
        .toast.show { display: block; animation: slideDownToast 0.3s; }
        .toast.success { background: var(--success-light); color: #064e3b; border: 1px solid var(--success); }
        .toast.error { background: var(--danger-light); color: #7f1d1d; border: 1px solid var(--danger); }
        .toast.warning { background: var(--warning-light); color: #78350f; border: 1px solid var(--warning); }
        @keyframes slideDownToast { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .login-overlay { position: fixed; inset: 0; background: var(--bg-primary); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .login-box { background: var(--bg-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border); }

        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); width: 85%; height: 100%; }
            .sidebar.open { transform: translateX(0); }
            .header { flex-direction: column; align-items: stretch; }
            .smart-btn { position: relative; right: auto; top: auto; width: 100%; margin-top: 5px; border-radius: 4px; }
            .input-wrapper input { padding-right: 10px; }
        }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-overlay">
    <div class="login-box">
        <div class="logo-icon" style="margin: 0 auto 20px auto;">ğŸ”¬</div>
        <div style="font-size:1.8rem; font-weight:700; color:var(--accent); margin-bottom:10px;">ç§‘ç ”æˆæœç®¡ç† V5.0</div>
        <div style="color:var(--text-secondary); margin-bottom:20px;">æ™ºèƒ½å¢å¼ºç‰ˆï¼šå«OCRã€Tagã€å®¡è®¡æ—¥å¿—</div>
        <div class="form-group">
            <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ..." onkeyup="if(event.key==='Enter') checkLogin()">
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="checkLogin()">ç™»å½•</button>
        <div style="margin-top:15px; font-size:0.8rem; color:var(--text-muted);">ç®¡ç†å‘˜: 1399 | å®¾å®¢: guest</div>
    </div>
</div>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">ğŸ”¬</div>
                <div>
                    <div>ç§‘ç ”ç®¡ç† Pro</div>
                    <div style="font-size:0.7rem;color:var(--text-muted);">V5.0 æ™ºèƒ½ç‰ˆ</div>
                </div>
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-section">æˆæœç®¡ç†</div>
            <div class="nav-item active" data-view="all" onclick="setView('all')">ğŸ“‹ <span>å…¨éƒ¨æˆæœ</span><span class="badge" id="totalCount">0</span></div>
            <div class="nav-item" data-view="paper" onclick="setView('paper')">ğŸ“„ <span>å­¦æœ¯è®ºæ–‡</span><span class="badge" id="paperCount">0</span></div>
            <div class="nav-item" data-view="patent" onclick="setView('patent')">ğŸ’¡ <span>å‘æ˜ä¸“åˆ©</span><span class="badge" id="patentCount">0</span></div>
            <div class="nav-item" data-view="project" onclick="setView('project')">ğŸ“Š <span>ç§‘ç ”é¡¹ç›®</span><span class="badge" id="projectCount">0</span></div>
            <div class="nav-item" data-view="award" onclick="setView('award')">ğŸ† <span>è·å¥–æƒ…å†µ</span><span class="badge" id="awardCount">0</span></div>
            <div class="nav-item" data-view="book" onclick="setView('book')">ğŸ“š <span>ä¸“è‘—å‡ºç‰ˆ</span><span class="badge" id="bookCount">0</span></div>
            <div class="nav-section">å›¢é˜Ÿç®¡ç†</div>
            <div class="nav-item" data-view="member" id="navMember" onclick="setView('member')">ğŸ‘¥ <span>æˆå‘˜ä¿¡æ¯</span><span class="badge" id="memberCount">0</span></div>
        </nav>
        <div class="sidebar-footer">
            <div style="font-size:0.8rem; color:var(--success); margin-bottom:10px;" id="storageStatus">âœ“ æ•°æ®å·²åŒæ­¥</div>
            <div class="data-actions">
                <button class="data-btn" onclick="toggleMenu('exportMenu')">ğŸ“¤ å¯¼å‡º</button>
                <button class="data-btn" onclick="toggleMenu('importMenu')">ğŸ“¥ å¯¼å…¥</button>
                <button class="data-btn onedrive" onclick="openBackupModal()" style="grid-column: span 2;">â˜ï¸ OneDrive åŒæ­¥</button>
            </div>
            
            <div id="exportMenu" class="dropdown-menu">
                <div class="menu-item" onclick="exportToExcelFile()">ğŸ“Š å¯¼å‡º Excel (è‡ªå®šä¹‰)</div>
                <div class="menu-item" onclick="exportToWordFile()">ğŸ“ å¯¼å‡º Word</div>
                <div class="menu-item" onclick="exportData()">ğŸ“¦ å¯¼å‡ºçº¯ JSON</div>
            </div>
            <div id="importMenu" class="dropdown-menu">
                <div class="menu-item" onclick="openExcelImport()">ğŸ“Š å¯¼å…¥ Excel</div>
                <div class="menu-item" onclick="triggerImport()">ğŸ“‚ æ¢å¤ JSON</div>
            </div>
            
            <div style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px;">
                <div class="menu-item" onclick="openRecycleModal()" style="font-size:0.85rem; padding:8px;">ğŸ—‘ï¸ å›æ”¶ç«™</div>
                <div class="menu-item" onclick="openLogModal()" style="font-size:0.85rem; padding:8px;">ğŸ›¡ï¸ æ“ä½œæ—¥å¿—</div>
            </div>

            <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(event)">
            <button class="btn btn-sm btn-secondary" onclick="location.reload()" style="width:100%; margin-top:15px;">ğŸ”’ é€€å‡ºç³»ç»Ÿ</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <button class="btn btn-secondary" onclick="document.getElementById('sidebar').classList.toggle('open')" style="margin-right:10px; display:none;" id="mobileMenuBtn">â˜°</button>
            <h1 class="page-title" id="pageTitle">å…¨éƒ¨æˆæœ</h1>
            <div class="header-actions">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢æ ‡é¢˜ã€ä½œè€…ã€Tag..." oninput="handleSearch()">
                </div>
                <button class="btn btn-secondary" onclick="toggleAdvFilter()" title="é«˜çº§ç­›é€‰">âš¡ ç­›é€‰</button>
                <button class="btn btn-secondary" onclick="toggleDarkMode()" title="åˆ‡æ¢æ¨¡å¼">ğŸŒ“</button>
                <button class="btn btn-primary" id="addBtn" onclick="openAddModal()">â• æ·»åŠ </button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
             <div class="stat-card" onclick="setView('paper')"><div class="stat-icon papers">ğŸ“„</div><div class="stat-info"><h3 id="statPaper">0</h3><p>è®ºæ–‡</p></div></div>
             <div class="stat-card" onclick="setView('patent')"><div class="stat-icon patents">ğŸ’¡</div><div class="stat-info"><h3 id="statPatent">0</h3><p>ä¸“åˆ©</p></div></div>
             <div class="stat-card" onclick="setView('project')"><div class="stat-icon projects">ğŸ“Š</div><div class="stat-info"><h3 id="statProject">0</h3><p>é¡¹ç›®</p></div></div>
             <div class="stat-card" onclick="setView('award')"><div class="stat-icon awards">ğŸ†</div><div class="stat-info"><h3 id="statAward">0</h3><p>è·å¥–</p></div></div>
             <div class="stat-card" onclick="setView('book')"><div class="stat-icon books">ğŸ“š</div><div class="stat-info"><h3 id="statBook">0</h3><p>è‘—ä½œ</p></div></div>
             <div class="stat-card" onclick="setView('member')"><div class="stat-icon members">ğŸ‘¥</div><div class="stat-info"><h3 id="statMember">0</h3><p>æˆå‘˜</p></div></div>
        </div>

        <div id="listViewContainer">
            <div class="filter-container">
                <div class="filter-bar" id="filterBar">
                    <div class="filter-chip active" data-year="all" onclick="setYearFilter('all')">å…¨éƒ¨å¹´ä»½</div>
                </div>
                <div class="adv-filter-panel" id="advFilterPanel">
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom:0">
                            <label>å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="filterStartDate" onchange="handleSearch()">
                        </div>
                        <div class="form-group" style="margin-bottom:0">
                            <label>ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="filterEndDate" onchange="handleSearch()">
                        </div>
                        <div class="form-group" style="margin-bottom:0">
                            <label>åŒ…å«æ ‡ç­¾</label>
                            <input type="text" id="filterTag" placeholder="è¾“å…¥æ ‡ç­¾..." oninput="handleSearch()">
                        </div>
                    </div>
                </div>
            </div>

            <div class="results-container" id="resultsContainer">
                <div class="results-header">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <span class="results-count" id="resultsCount">å…± 0 æ¡</span>
                        <button class="btn btn-sm btn-danger" id="batchDeleteBtn" style="display:none;" onclick="batchDelete()">åˆ é™¤é€‰ä¸­</button>
                    </div>
                    <select id="sortSelect" onchange="handleSort()" style="padding:6px;border-radius:4px;border:1px solid var(--border);">
                        <option value="date-desc">æœ€æ–°ä¼˜å…ˆ</option>
                        <option value="date-asc">æœ€æ—©ä¼˜å…ˆ</option>
                        <option value="title-asc">æ ‡é¢˜ A-Z</option>
                    </select>
                </div>
                
                <div class="results-list" id="resultsList"></div>
                
                <div class="pagination" id="paginationControl">
                    <button class="page-btn" onclick="changePage(-1)" id="prevPage">â†</button>
                    <span class="page-info" id="pageInfo">ç¬¬ 1 / 1 é¡µ</span>
                    <button class="page-btn" onclick="changePage(1)" id="nextPage">â†’</button>
                    <select id="pageSize" onchange="changePageSize()" style="border:1px solid var(--border); border-radius:4px; padding:4px;">
                        <option value="20">20æ¡/é¡µ</option>
                        <option value="50">50æ¡/é¡µ</option>
                        <option value="100">100æ¡/é¡µ</option>
                    </select>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="formModal">
    <div class="modal wide">
        <div class="modal-header">
            <h2 id="modalTitle">æ·»åŠ ç§‘ç ”æˆæœ</h2>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="researchForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label>æˆæœç±»å‹</label>
                        <select id="type" required onchange="toggleFormFields()">
                            <option value="paper">å­¦æœ¯è®ºæ–‡</option>
                            <option value="patent">å‘æ˜ä¸“åˆ©</option>
                            <option value="project">ç§‘ç ”é¡¹ç›®</option>
                            <option value="award">è·å¥–æƒ…å†µ</option>
                            <option value="book">ä¸“è‘—å‡ºç‰ˆ</option>
                        </select>
                    </div>
                    <div class="form-group" id="dateGroup">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="date">
                    </div>
                </div>

                <div class="form-group">
                    <label>æ ‡ç­¾ (Tags)</label>
                    <div class="tag-input-area" id="tagInputArea" onclick="document.getElementById('tagInput').focus()">
                        <div id="formTags" style="display:contents"></div>
                        <input type="text" id="tagInput" class="tag-input" placeholder="è¾“å…¥æ ‡ç­¾æŒ‰å›è½¦..." onkeydown="handleTagInput(event)">
                    </div>
                </div>

                <div id="generalFields">
                    <div class="form-group input-wrapper">
                        <label>DOI (æ™ºèƒ½æŠ“å–)</label>
                        <input type="text" id="doi" placeholder="è¾“å…¥ DOI (å¦‚ 10.1109/...)">
                        <button type="button" class="smart-btn" onclick="fetchMetadataByDOI()">ğŸ” æŠ“å–</button>
                    </div>
                    <div class="form-group"><label>æ ‡é¢˜ *</label><input type="text" id="title" required></div>
                    <div class="form-group"><label>ä½œè€…/æˆå‘˜</label><input type="text" id="authors"></div>
                    <div class="form-row"><div class="form-group"><label>æ¥æº/æœŸåˆŠ</label><input type="text" id="source"></div><div class="form-group"><label>çº§åˆ«</label><input type="text" id="level"></div></div>
                </div>

                <div id="patentFields" class="hidden">
                    <div class="form-group"><label>ä¸“åˆ©åç§° *</label><input type="text" id="patentName"></div>
                    <div class="form-row"><div class="form-group"><label>ç±»å‹</label><select id="patentType"><option value="å‘æ˜ä¸“åˆ©">å‘æ˜ä¸“åˆ©</option><option value="å®ç”¨æ–°å‹">å®ç”¨æ–°å‹</option></select></div><div class="form-group"><label>çŠ¶æ€</label><select id="patentStatus"><option value="å—ç†">å—ç†</option><option value="æˆæƒ">æˆæƒ</option></select></div></div>
                    <div class="form-group"><label>å‘æ˜äºº</label><input type="text" id="inventors"></div>
                    <div class="form-row"><div class="form-group"><label>ç”³è¯·æ—¥</label><input type="date" id="applicationDate"></div><div class="form-group"><label>ä¸“åˆ©å·</label><input type="text" id="patentNumber"></div></div>
                    <div class="form-group">
                        <label>OCR è¯†åˆ« (ä¸Šä¼ è¯ä¹¦å›¾ç‰‡)</label>
                        <div class="file-upload" onclick="document.getElementById('ocrInput').click()" style="padding:10px;">
                            <input type="file" id="ocrInput" accept="image/*" onchange="handleOCR(event)">
                            <div style="font-size:0.8rem">ğŸ“· ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡è‡ªåŠ¨è¯†åˆ«ä¸“åˆ©å·</div>
                        </div>
                    </div>
                </div>

                <div id="projectFields" class="hidden">
                    <div class="form-group"><label>é¡¹ç›®åç§° *</label><input type="text" id="projectName"></div>
                    <div class="form-row"><div class="form-group"><label>çº§åˆ«</label><input type="text" id="projectLevel"></div><div class="form-group"><label>ç¼–å·</label><input type="text" id="projectNumber"></div></div>
                    <div class="form-row"><div class="form-group"><label>å¼€å§‹</label><input type="date" id="projectStartDate"></div><div class="form-group"><label>å•ä½</label><input type="text" id="projectOrg"></div></div>
                </div>

                <div id="bookFields" class="hidden">
                    <div class="form-group input-wrapper">
                        <label>ISBN (æ™ºèƒ½æœä¹¦)</label>
                        <input type="text" id="bookIsbn">
                        <button type="button" class="smart-btn" onclick="fetchMetadataByISBN()">ğŸ” æœä¹¦</button>
                    </div>
                    <div class="form-group"><label>è‘—ä½œåç§° *</label><input type="text" id="bookTitle"></div>
                    <div class="form-group"><label>ä½œè€…</label><input type="text" id="bookAuthors"></div>
                    <div class="form-row"><div class="form-group"><label>å‡ºç‰ˆç¤¾</label><input type="text" id="bookPublisher"></div><div class="form-group"><label>å‡ºç‰ˆæ—¥æœŸ</label><input type="date" id="bookDate"></div></div>
                </div>
                
                <div id="awardFields" class="hidden">
                    <div class="form-group"><label>å¥–é¡¹åç§° *</label><input type="text" id="awardName"></div>
                    <div class="form-group"><label>è·å¥–äºº</label><input type="text" id="awardRecipients"></div>
                    <div class="form-row"><div class="form-group"><label>å•ä½</label><input type="text" id="awardAgency"></div><div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="awardDate"></div></div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“ é™„ä»¶</label>
                    <div class="file-upload" id="fileUpload" onclick="document.getElementById('pdfInput').click()">
                        <input type="file" id="pdfInput" accept=".pdf,.doc,.docx,.zip,.txt" onchange="handleFileSelect(event)">
                        <div class="file-upload-icon">ğŸ“„</div>
                        <div class="file-upload-text">ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</div>
                    </div>
                    <div class="file-info hidden" id="fileInfo">
                        <span class="file-info-name"><span id="fileName"></span></span>
                        <button type="button" class="file-remove" onclick="removeFile()">âœ•</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="submit" form="researchForm" class="btn btn-primary">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="memberModal">
    <div class="modal wide">
        <div class="modal-header"><h2>å›¢é˜Ÿæˆå‘˜ä¿¡æ¯</h2><button class="modal-close" onclick="closeMemberModal()">âœ•</button></div>
        <div class="modal-body">
            <form id="memberForm" onsubmit="handleMemberSubmit(event)">
                <input type="hidden" id="memberEditId">
                <div class="form-row"><div class="form-group"><label>å­¦å·/å·¥å·</label><input type="text" id="memberNo" required></div><div class="form-group"><label>å§“å</label><input type="text" id="memberName" required></div></div>
                <div class="form-row"><div class="form-group"><label>èŒç§°</label><input type="text" id="memberTitle"></div><div class="form-group"><label>å•ä½</label><input type="text" id="memberOrg"></div></div>
                <div class="form-row">
                    <div class="form-group"><label>ç”µè¯</label><input type="text" id="memberPhone"></div>
                    <div class="form-group"><label>è¯ä»¶å·(åŠ å¯†å­˜å‚¨)</label><input type="text" id="memberIdCard"></div>
                </div>
                <div class="form-group"><label>é‚®ç®±</label><input type="email" id="memberEmail"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="generateResume()">ğŸ“„ å¯¼å‡ºç®€å†</button>
            <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">å–æ¶ˆ</button>
            <button type="submit" form="memberForm" class="btn btn-primary">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="recycleModal">
    <div class="modal wide">
        <div class="modal-header"><h2>ğŸ—‘ æ•°æ®å›æ”¶ç«™</h2><button class="modal-close" onclick="document.getElementById('recycleModal').classList.remove('active')">âœ•</button></div>
        <div class="modal-body"><div class="results-list" id="recycleList"></div></div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="document.getElementById('recycleModal').classList.remove('active')">å…³é—­</button></div>
    </div>
</div>

<div class="modal-overlay" id="logModal">
    <div class="modal wide">
        <div class="modal-header"><h2>ğŸ›¡ï¸ ç³»ç»Ÿæ“ä½œæ—¥å¿—</h2><button class="modal-close" onclick="document.getElementById('logModal').classList.remove('active')">âœ•</button></div>
        <div class="modal-body" id="logList"></div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="document.getElementById('logModal').classList.remove('active')">å…³é—­</button></div>
    </div>
</div>

<div class="modal-overlay" id="citationModal">
    <div class="modal">
        <div class="modal-header"><h2>â ç”Ÿæˆå¼•ç”¨æ ¼å¼</h2><button class="modal-close" onclick="document.getElementById('citationModal').classList.remove('active')">âœ•</button></div>
        <div class="modal-body">
            <label>GB/T 7714</label><div class="citation-box"><span id="citeGB"></span><button class="citation-copy" onclick="copyText('citeGB')">å¤åˆ¶</button></div>
            <label style="margin-top:10px;display:block;">APA</label><div class="citation-box"><span id="citeAPA"></span><button class="citation-copy" onclick="copyText('citeAPA')">å¤åˆ¶</button></div>
            <label style="margin-top:10px;display:block;">BibTeX</label><div class="citation-box"><span id="citeBib"></span><button class="citation-copy" onclick="copyText('citeBib')">å¤åˆ¶</button></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="excelModal">
    <div class="modal wide">
        <div class="modal-header"><h2>å¯¼å…¥ Excel æ•°æ®</h2><button class="modal-close" onclick="closeExcelModal()">âœ•</button></div>
        <div class="modal-body">
            <div class="form-group"><label>ç±»å‹</label><select id="excelImportType" onchange="updateMappingFields()"><option value="paper">å­¦æœ¯è®ºæ–‡</option><option value="patent">å‘æ˜ä¸“åˆ©</option><option value="project">ç§‘ç ”é¡¹ç›®</option><option value="award">è·å¥–æƒ…å†µ</option><option value="book">ä¸“è‘—å‡ºç‰ˆ</option><option value="member">æˆå‘˜ä¿¡æ¯</option></select></div>
            <div class="form-group"><label>æ–‡ä»¶</label><div class="file-upload" onclick="document.getElementById('excelInput').click()"><input type="file" id="excelInput" accept=".xlsx,.xls,.csv" onchange="handleExcelSelect(event)"><div class="file-upload-icon">ğŸ“Š</div><div class="file-upload-text">ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶</div></div></div>
            <div id="excelPreviewContainer" class="hidden"><label>é¢„è§ˆ</label><div class="excel-preview" id="excelPreview"></div></div>
            <div id="mappingContainer" class="hidden" style="margin-top:20px;"><label>æ˜ å°„</label><div id="mappingFields"></div></div>
            <div id="duplicateWarning" class="duplicate-warning hidden" style="margin-top:10px;padding:10px;background:var(--warning-light);"><h4>âš ï¸ å‘ç°é‡å¤é¡¹</h4><ul class="duplicate-list" id="duplicateList"></ul></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeExcelModal()">å–æ¶ˆ</button><button type="button" class="btn btn-primary" id="importExcelBtn" onclick="confirmExcelImport()" disabled>ç¡®è®¤å¯¼å…¥ (æ™ºèƒ½åˆå¹¶)</button></div>
    </div>
</div>

<div class="modal-overlay" id="backupModal">
    <div class="modal">
        <div class="modal-header"><h2>â˜ï¸ OneDrive åŒæ­¥</h2><button class="modal-close" onclick="closeBackupModal()">âœ•</button></div>
        <div class="modal-body">
            <div style="background:var(--od-light); border:1px solid var(--od-blue); padding:15px; border-radius:8px;">
                <h4 style="color:var(--od-blue); margin-bottom:10px;">â˜ï¸ Microsoft OneDrive</h4>
                <div id="onedrive-login-panel"><button class="btn btn-od" onclick="OneDriveService.signIn()" style="width:100%">ğŸ”‘ ç™»å½•å¾®è½¯è´¦å·</button></div>
                <div id="onedrive-actions-panel" class="hidden">
                    <div style="margin-bottom:10px;">å·²ç™»å½•: <span id="odUserName"></span> <button class="btn btn-sm btn-secondary" onclick="OneDriveService.signOut()">æ³¨é”€</button></div>
                    <div style="display:grid; gap:10px;">
                        <button class="btn btn-od" id="btnOdUpload" onclick="OneDriveService.upload()">â¬†ï¸ ä¸Šä¼ æ•°æ®</button>
                        <button class="btn btn-od" id="btnOdDownload" style="background:white; color:var(--od-blue); border:1px solid var(--od-blue);" onclick="OneDriveService.download()">â¬‡ï¸ æ¢å¤æ•°æ®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>
<script>
    // --- å…¨å±€çŠ¶æ€ä¸é…ç½® ---
    let achievements = [];
    let members = [];
    let systemLogs = []; // V5: æ—¥å¿—
    let currentUserRole = null;
    let currentView = 'all';
    let currentYearFilter = 'all';
    let searchQuery = '';
    let currentTags = []; // V5: æ ‡ç­¾ç¼“å­˜
    let selectedItems = new Set();
    let sortOrder = 'date-desc';
    let currentPage = 1; // V5: åˆ†é¡µ
    let pageSize = 20;

    // æ–‡ä»¶ä¸Excelç¼“å­˜
    let currentPdfData = null; let currentPdfName = null;
    let excelData = null; let excelHeaders = [];

    const typeConfig = {
        paper: { icon: 'ğŸ“„', label: 'å­¦æœ¯è®ºæ–‡', class: 'type-paper' },
        patent: { icon: 'ğŸ’¡', label: 'å‘æ˜ä¸“åˆ©', class: 'type-patent' },
        project: { icon: 'ğŸ“Š', label: 'ç§‘ç ”é¡¹ç›®', class: 'type-project' },
        award: { icon: 'ğŸ†', label: 'è·å¥–æƒ…å†µ', class: 'type-award' },
        book: { icon: 'ğŸ“š', label: 'ä¸“è‘—å‡ºç‰ˆ', class: 'type-book' },
        member: { icon: 'ğŸ‘¤', label: 'æˆå‘˜ä¿¡æ¯', class: 'type-member' }
    };
    
    // å­—æ®µæ˜ å°„é…ç½® (ä¿ç•™åŸæ ·)
    const fieldMappings = {
        paper: [{ key: 'title', label: 'æ ‡é¢˜', required: true }, { key: 'authors', label: 'ä½œè€…' }, { key: 'date', label: 'å‘è¡¨æ—¥æœŸ' }, { key: 'source', label: 'æœŸåˆŠ/æ¥æº' }, { key: 'level', label: 'çº§åˆ«' }, { key: 'doi', label: 'DOI' }],
        patent: [{ key: 'patentName', label: 'ä¸“åˆ©åç§°', required: true }, { key: 'patentType', label: 'ä¸“åˆ©ç±»å‹' }, { key: 'inventors', label: 'å‘æ˜äºº' }, { key: 'patentOwner', label: 'ä¸“åˆ©æƒäºº' }, { key: 'applicationDate', label: 'ç”³è¯·æ—¥' }, { key: 'grantDate', label: 'æˆæƒæ—¶é—´' }, { key: 'patentNumber', label: 'ä¸“åˆ©å·' }, { key: 'patentStatus', label: 'ä¸“åˆ©çŠ¶æ€' }],
        project: [{ key: 'projectName', label: 'é¡¹ç›®åç§°', required: true }, { key: 'projectLevel', label: 'é¡¹ç›®çº§åˆ«' }, { key: 'projectNumber', label: 'é¡¹ç›®ç¼–å·' }, { key: 'projectStartDate', label: 'å¼€å§‹æ—¶é—´' }, { key: 'projectEndDate', label: 'ç»“æŸæ—¶é—´' }, { key: 'projectOrg', label: 'æ‰€å±å•ä½' }],
        award: [{ key: 'awardName', label: 'å¥–é¡¹åç§°', required: true }, { key: 'awardRecipients', label: 'è·å¥–äºº' }, { key: 'awardDate', label: 'è·å¥–æ—¥æœŸ' }, { key: 'awardLevel', label: 'çº§åˆ«' }, { key: 'awardAgency', label: 'æˆå¥–å•ä½' }],
        book: [{ key: 'bookTitle', label: 'è‘—ä½œåç§°', required: true }, { key: 'bookAuthors', label: 'ä½œè€…' }, { key: 'bookDate', label: 'å‡ºç‰ˆæ—¥æœŸ' }, { key: 'bookPublisher', label: 'å‡ºç‰ˆç¤¾' }, { key: 'bookIsbn', label: 'ISBN' }],
        member: [{ key: 'memberNo', label: 'å­¦å·/å·¥å·', required: true }, { key: 'memberName', label: 'å§“å', required: true }, { key: 'memberGender', label: 'æ€§åˆ«' }, { key: 'memberOrg', label: 'å·¥ä½œå•ä½' }, { key: 'memberTitle', label: 'èŒç§°' }, { key: 'memberEmail', label: 'é‚®ç®±' }, { key: 'memberIdCard', label: 'è¯ä»¶å·ç ' }, { key: 'memberPhone', label: 'ç”µè¯' }]
    };

    // --- æ•°æ®åº“ IndexedDB ---
    const DB_NAME = 'ResearchDB_V5';
    let db;
    function initDB() { return new Promise((resolve, reject) => { var r = indexedDB.open(DB_NAME, 1); r.onerror = e => reject(e); r.onupgradeneeded = e => { if (!e.target.result.objectStoreNames.contains('appState')) e.target.result.createObjectStore('appState', { keyPath: 'id' }); }; r.onsuccess = e => { db = e.target.result; resolve(db); }; }); }
    
    async function loadFromLocal() {
        if (!db) await initDB();
        return new Promise(resolve => {
            var r = db.transaction(['appState'], 'readonly').objectStore('appState').get('main_data');
            r.onsuccess = e => {
                if (e.target.result) {
                    achievements = e.target.result.achievements || [];
                    members = e.target.result.members || [];
                    systemLogs = e.target.result.systemLogs || []; // V5 åŠ è½½æ—¥å¿—
                    resolve(true);
                } else resolve(false);
            };
            r.onerror = () => resolve(false);
        });
    }

    // V5: ä¿å­˜æ—¶åŠ å¯†æ•æ„Ÿä¿¡æ¯
    function simpleEncrypt(str) { return str ? 'ENC_' + btoa(encodeURIComponent(str)) : ''; }
    function simpleDecrypt(str) { 
        if (!str || !str.startsWith('ENC_')) return str; 
        try { return decodeURIComponent(atob(str.replace('ENC_', ''))); } catch(e) { return str; }
    }

    async function saveToLocal() {
        if (!db) await initDB();
        var t = db.transaction(['appState'], 'readwrite');
        // æ·±æ‹·è´å¹¶åŠ å¯†å­˜å‚¨
        let safeMembers = JSON.parse(JSON.stringify(members));
        safeMembers.forEach(m => {
            if(m.memberIdCard && !m.memberIdCard.startsWith('ENC_')) m.memberIdCard = simpleEncrypt(m.memberIdCard);
            if(m.memberPhone && !m.memberPhone.startsWith('ENC_')) m.memberPhone = simpleEncrypt(m.memberPhone);
        });
        t.objectStore('appState').put({ id: 'main_data', achievements, members: safeMembers, systemLogs, updatedAt: new Date().toISOString() });
        document.getElementById('storageStatus').textContent = 'âœ“ æ•°æ®å·²åŒæ­¥ ' + new Date().toLocaleTimeString();
    }

    // --- è®¤è¯ä¸æ—¥å¿— ---
    function checkLogin() {
        const pwd = document.getElementById('loginPassword').value;
        if (pwd === '1399') { currentUserRole = 'admin'; showToast('ç®¡ç†å‘˜ç™»å½•', 'success'); }
        else if (pwd === 'guest') { currentUserRole = 'guest'; showToast('è®¿å®¢ç™»å½•', 'success'); }
        else { showToast('å¯†ç é”™è¯¯', 'error'); return; }
        document.getElementById('loginOverlay').style.display = 'none';
        applyPermissions();
    }
    
    function applyPermissions() {
        const isAdmin = currentUserRole === 'admin';
        document.getElementById('addBtn').style.display = isAdmin ? 'inline-flex' : 'none';
        document.getElementById('batchDeleteBtn').style.display = 'none'; // åˆå§‹éšè—
    }

    function addLog(action, details) {
        systemLogs.unshift({ id: Date.now(), user: currentUserRole || 'system', time: new Date().toLocaleString(), action, details });
        if(systemLogs.length > 500) systemLogs.pop();
        saveToLocal();
    }
    
    function openLogModal() {
        if(currentUserRole !== 'admin') { showToast('éœ€ç®¡ç†å‘˜æƒé™', 'error'); return; }
        document.getElementById('logList').innerHTML = systemLogs.map(log => `
            <div class="log-item">
                <div class="log-time">${log.time}</div><div class="log-action">${log.action}</div>
                <div class="log-detail">${escapeHtml(log.details)}</div><div>${log.user}</div>
            </div>`).join('');
        document.getElementById('logModal').classList.add('active');
    }

    // --- V5.0 æ ¸å¿ƒé€»è¾‘å‡çº§ ---

    // 1. æ™ºèƒ½æ¸²æŸ“ (æ”¯æŒåˆ†é¡µã€Tagç­›é€‰ã€å›æ”¶ç«™è¿‡æ»¤)
    function renderResults() {
        const container = document.getElementById('resultsList');
        container.innerHTML = '';
        
        let source = currentView === 'member' ? members : achievements;
        // è¿‡æ»¤è½¯åˆ é™¤
        let filtered = source.filter(i => !i.isDeleted);
        
        // è§†å›¾è¿‡æ»¤
        if (currentView !== 'all' && currentView !== 'member') filtered = filtered.filter(a => a.type === currentView);
        
        // æœç´¢è¿‡æ»¤
        if (searchQuery) {
            const q = searchQuery.toLowerCase();
            filtered = filtered.filter(a => JSON.stringify(a).toLowerCase().includes(q));
        }

        // é«˜çº§ç­›é€‰ (æ—¥æœŸ + Tag)
        const start = document.getElementById('filterStartDate').value;
        const end = document.getElementById('filterEndDate').value;
        const tag = document.getElementById('filterTag').value.toLowerCase();
        
        if (start) filtered = filtered.filter(a => (a.date || a.applicationDate) >= start);
        if (end) filtered = filtered.filter(a => (a.date || a.applicationDate) <= end);
        if (tag) filtered = filtered.filter(a => a.tags && a.tags.some(t => t.toLowerCase().includes(tag)));
        if (currentYearFilter !== 'all') filtered = filtered.filter(a => (a.date||'').startsWith(currentYearFilter));

        // æ’åº
        filtered.sort((a, b) => {
            const da = a.date || a.applicationDate || '0';
            const db = b.date || b.applicationDate || '0';
            if(sortOrder === 'date-desc') return db.localeCompare(da);
            if(sortOrder === 'date-asc') return da.localeCompare(db);
            return (a.title || a.memberName || '').localeCompare(b.title || b.memberName || '');
        });

        // åˆ†é¡µé€»è¾‘
        document.getElementById('resultsCount').textContent = `å…± ${filtered.length} æ¡`;
        const totalPages = Math.ceil(filtered.length / pageSize) || 1;
        document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
        
        const pageStart = (currentPage - 1) * pageSize;
        const pagedData = filtered.slice(pageStart, pageStart + pageSize);

        if (pagedData.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>æš‚æ— æ•°æ®</p></div>';
            return;
        }

        container.innerHTML = pagedData.map(item => {
            let config = typeConfig[item.type] || typeConfig.paper;
            let title = escapeHtml(item.title || item.patentName || item.projectName || item.memberName);
            
            // è§£å¯†å±•ç¤º
            if(item.type === 'member') {
                item.memberPhone = simpleDecrypt(item.memberPhone);
                item.memberIdCard = simpleDecrypt(item.memberIdCard);
            }

            let tagsHtml = (item.tags || []).map(t => `<span class="tag" style="font-size:0.7rem;padding:0 4px;">${t}</span>`).join('');
            let citeBtn = currentView !== 'member' ? `<button class="action-btn" onclick="event.stopPropagation();openCitation('${item.id}')" title="å¼•ç”¨">â</button>` : '';
            
            let meta = item.type === 'member' ? `${item.memberOrg || '-'} | ${item.memberTitle || '-'}` : `${item.date || item.applicationDate || ''} | ${item.authors || item.inventors || ''}`;

            return `
            <div class="result-item" onclick="${currentView==='member'?'editMember':'editAchievement'}('${item.id}')">
                <input type="checkbox" onclick="event.stopPropagation();toggleItemSelect('${item.id}')" ${selectedItems.has(item.id)?'checked':''}>
                <div class="result-type ${config.class}">${config.icon}</div>
                <div class="result-content">
                    <div class="result-title">${title}</div>
                    <div class="tag-container">${tagsHtml}</div>
                    <div class="result-meta">${escapeHtml(meta)}</div>
                </div>
                <div class="result-actions">
                    ${citeBtn}
                    <button class="action-btn" onclick="event.stopPropagation(); viewFile('${item.id}')">ğŸ‘ï¸</button>
                    <button class="action-btn delete" onclick="event.stopPropagation(); promptDelete('${item.id}', '${item.type==='member'?'member':'achievement'}')">ğŸ—‘</button>
                </div>
            </div>`;
        }).join('');
    }

    // 2. æ™ºèƒ½åˆå¹¶ç®—æ³• (Excel/JSON å¯¼å…¥æ—¶è°ƒç”¨)
    // é€»è¾‘ï¼šå¦‚æœ ID ç›¸åŒï¼Œæ›´æ–°å†…å®¹ï¼›å¦‚æœ ID ä¸åŒä½†å…³é”®å­—æ®µ(å¦‚æ ‡é¢˜)ç›¸åŒï¼Œåˆå¹¶éç©ºå­—æ®µ
    function smartMerge(existing, incoming) {
        let updated = false;
        // éå†æ‰€æœ‰æ–°å­—æ®µ
        for (let key in incoming) {
            if (incoming[key] && incoming[key] !== existing[key]) {
                // å¦‚æœæ—§å€¼ä¸ºç©ºï¼Œç›´æ¥å¡«å…¥ï¼›å¦‚æœæ–°å€¼æœ‰æ•ˆä¸”ä¸åŒï¼Œè¦†ç›–æ—§å€¼ (éµå¾ªæœ€æ–°åŸåˆ™)
                existing[key] = incoming[key];
                updated = true;
            }
        }
        if (updated) existing.updatedAt = new Date().toISOString();
        return updated;
    }

    // é‡å†™ Import é€»è¾‘ä»¥æ”¯æŒæ™ºèƒ½åˆå¹¶
    function confirmExcelImport() {
        const type = document.getElementById('excelImportType').value;
        const selects = document.querySelectorAll('.field-map-select');
        let mapConfig = {};
        selects.forEach(s => { if(s.value!=='') mapConfig[s.dataset.key] = parseInt(s.value); });
        
        let count = 0; let updated = 0;
        
        for(let i=1; i<excelData.length; i++) {
            const row = excelData[i];
            if(!row || row.length===0) continue;
            
            let item = { type: type, updatedAt: new Date().toISOString(), tags: ['Excelå¯¼å…¥'] };
            for(let key in mapConfig) item[key] = row[mapConfig[key]];
            
            // æŸ¥é‡ä¸åˆå¹¶
            let uniqueKey = type==='member' ? 'memberNo' : (type==='patent'?'patentName':'title');
            let targetList = type==='member' ? members : achievements;
            
            // æŸ¥æ‰¾å·²å­˜åœ¨é¡¹ (æŒ‰å”¯ä¸€é”®)
            let existing = targetList.find(t => t[uniqueKey] === item[uniqueKey]);
            
            if (existing) {
                if (smartMerge(existing, item)) updated++;
            } else {
                item.id = Date.now() + Math.random().toString(36).substr(2,9);
                item.createdAt = new Date().toISOString();
                targetList.push(item);
                count++;
            }
        }
        
        saveToLocal(); closeModal(); updateStats(); renderResults();
        showToast(`å¯¼å…¥æˆåŠŸ: æ–°å¢ ${count} æ¡, æ›´æ–° ${updated} æ¡`, 'success');
        addLog('å¯¼å…¥', `Excel å¯¼å…¥: +${count}, ^${updated}`);
        document.getElementById('excelModal').classList.remove('active');
    }

    // 3. æ™ºèƒ½æŠ“å– (DOI / ISBN / OCR)
    async function fetchMetadataByDOI() {
        const doi = document.getElementById('doi').value.trim();
        if(!doi) return showToast('è¯·è¾“å…¥ DOI', 'error');
        
        const btn = document.querySelector('.smart-btn'); const old = btn.innerText; btn.innerText = 'â³';
        try {
            const res = await fetch(`https://api.crossref.org/works/${doi}`);
            if(!res.ok) throw new Error('æœªæ‰¾åˆ°');
            const data = (await res.json()).message;
            
            // è‡ªåŠ¨å›å¡«
            document.getElementById('title').value = data.title?.[0] || '';
            document.getElementById('source').value = data['container-title']?.[0] || '';
            if(data.author) document.getElementById('authors').value = data.author.map(a => `${a.given} ${a.family}`).join(', ');
            if(data.created) {
                const d = data.created['date-parts'][0];
                document.getElementById('date').value = `${d[0]}-${String(d[1]).padStart(2,'0')}-${String(d[2]||1).padStart(2,'0')}`;
            }
            if(!currentTags.includes('SmartFetch')) { currentTags.push('SmartFetch'); renderFormTags(); }
            showToast('æŠ“å–æˆåŠŸ', 'success');
        } catch(e) { showToast('æŠ“å–å¤±è´¥: ' + e.message, 'error'); }
        btn.innerText = old;
    }

    async function fetchMetadataByISBN() {
        const isbn = document.getElementById('bookIsbn').value.replace(/-/g,'');
        if(!isbn) return;
        try {
            const res = await fetch(`https://openlibrary.org/isbn/${isbn}.json`);
            if(!res.ok) throw new Error('æœªæ‰¾åˆ°');
            const data = await res.json();
            document.getElementById('bookTitle').value = data.title;
            if(data.publish_date) document.getElementById('bookDate').value = new Date(data.publish_date).toISOString().slice(0,10);
            showToast('æŠ“å–æˆåŠŸ', 'success');
        } catch(e) { showToast('æœªæ‰¾åˆ°ä¹¦ç±', 'error'); }
    }
    
    // OCR ç®€å•å®ç° (ä½¿ç”¨ Tesseract.js)
    function handleOCR(event) {
        const file = event.target.files[0];
        if(!file) return;
        showToast('æ­£åœ¨è¯†åˆ«å›¾ç‰‡ï¼Œè¯·ç¨å€™...', 'warning');
        Tesseract.recognize(file, 'chi_sim')
            .then(({ data: { text } }) => {
                console.log(text);
                // ç®€å•çš„æ­£åˆ™æå– (ç¤ºä¾‹: æå– ZL å¼€å¤´çš„ä¸“åˆ©å·)
                const patentMatch = text.match(/ZL\s?\d{4}.*/);
                if(patentMatch) document.getElementById('patentNumber').value = patentMatch[0].replace(/\s/g,'');
                showToast('è¯†åˆ«å®Œæˆï¼Œè¯·æ£€æŸ¥ç»“æœ', 'success');
            })
            .catch(err => showToast('OCR è¯†åˆ«å¤±è´¥', 'error'));
    }

    // 4. å›æ”¶ç«™æœºåˆ¶
    function promptDelete(id, type) {
        if(currentUserRole !== 'admin') { showToast('æ— æƒé™', 'error'); return; }
        if(confirm('ç§»å…¥å›æ”¶ç«™ï¼Ÿ(30å¤©å†…å¯æ¢å¤)')) {
            const list = type === 'member' ? members : achievements;
            const item = list.find(i => i.id === id);
            if(item) {
                item.isDeleted = true;
                item.deletedAt = new Date().toISOString();
                addLog('åˆ é™¤', `ç§»å…¥å›æ”¶ç«™: ${item.title || item.memberName}`);
                saveToLocal(); renderResults(); updateStats();
                showToast('å·²ç§»å…¥å›æ”¶ç«™', 'success');
            }
        }
    }
    
    function openRecycleModal() {
        if(currentUserRole !== 'admin') return;
        const deleted = [...achievements, ...members].filter(i => i.isDeleted);
        document.getElementById('recycleList').innerHTML = deleted.length ? deleted.map(item => `
            <div class="result-item deleted-item">
                <div class="result-content"><div class="result-title">${escapeHtml(item.title || item.memberName)}</div></div>
                <div class="result-actions">
                    <button class="btn btn-sm btn-success" onclick="restoreItem('${item.id}')">â™»ï¸</button>
                    <button class="btn btn-sm btn-danger" onclick="hardDelete('${item.id}')">âœ•</button>
                </div>
            </div>`).join('') : '<p style="text-align:center">å›æ”¶ç«™ä¸ºç©º</p>';
        document.getElementById('recycleModal').classList.add('active');
    }

    function restoreItem(id) {
        let item = achievements.find(a=>a.id===id) || members.find(m=>m.id===id);
        if(item) { delete item.isDeleted; addLog('æ¢å¤', `æ¢å¤: ${id}`); saveToLocal(); renderResults(); openRecycleModal(); }
    }
    function hardDelete(id) {
        if(confirm('å½»åº•åˆ é™¤æ— æ³•æ¢å¤ï¼Œç¡®å®šï¼Ÿ')) {
            achievements = achievements.filter(a => a.id !== id);
            members = members.filter(m => m.id !== id);
            saveToLocal(); openRecycleModal();
        }
    }

    // 5. æ ‡ç­¾ç³»ç»Ÿ
    function handleTagInput(e) {
        if(e.key === 'Enter') {
            e.preventDefault();
            const val = e.target.value.trim();
            if(val && !currentTags.includes(val)) {
                currentTags.push(val); renderFormTags(); e.target.value = '';
            }
        }
    }
    function renderFormTags() {
        document.getElementById('formTags').innerHTML = currentTags.map(t => 
            `<span class="tag">${t} <span onclick="removeTag('${t}')" style="cursor:pointer">Ã—</span></span>`
        ).join('');
    }
    function removeTag(t) { currentTags = currentTags.filter(x => x !== t); renderFormTags(); }

    // 6. å¼•ç”¨ä¸ç®€å†å¯¼å‡º
    function openCitation(id) {
        const item = achievements.find(a => a.id === id);
        if(!item) return;
        const au = item.authors || 'ä½šå'; const ti = item.title; const yr = (item.date||'').substring(0,4);
        
        document.getElementById('citeGB').textContent = `${au}. ${ti}[J]. ${item.source||'æœŸåˆŠ'}, ${yr}.`;
        document.getElementById('citeAPA').textContent = `${au} (${yr}). ${ti}. ${item.source||''}.`;
        document.getElementById('citeBib').textContent = `@misc{${id}, title={${ti}}, author={${au}}, year={${yr}}}`;
        document.getElementById('citationModal').classList.add('active');
    }
    function copyText(id) { navigator.clipboard.writeText(document.getElementById(id).textContent); showToast('å·²å¤åˆ¶', 'success'); }

    function generateResume() {
        const name = document.getElementById('memberName').value;
        if(!name) return showToast('è¯·å…ˆå¡«å†™å§“å', 'error');
        // ç­›é€‰è¯¥æˆå‘˜çš„æˆæœ
        const myPapers = achievements.filter(a => !a.isDeleted && a.authors && a.authors.includes(name));
        let html = `<html><body><h1 style="text-align:center">${name} - ä¸ªäººç®€å†</h1><hr>`;
        html += `<h3>åŸºæœ¬ä¿¡æ¯</h3><p>å•ä½: ${document.getElementById('memberOrg').value} | èŒç§°: ${document.getElementById('memberTitle').value}</p>`;
        html += `<h3>å­¦æœ¯æˆæœ (${myPapers.length})</h3><ul>`;
        myPapers.forEach(p => html += `<li>${p.title}, ${p.source}, ${p.date}</li>`);
        html += '</ul></body></html>';
        
        const blob = new Blob([html], {type: 'application/msword'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${name}_ç®€å†.doc`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    // --- æ‚é¡¹ä¸è¾…åŠ© ---
    function changePage(d) { currentPage = Math.max(1, currentPage + d); renderResults(); }
    function changePageSize() { pageSize = parseInt(document.getElementById('pageSize').value); currentPage=1; renderResults(); }
    function toggleAdvFilter() { document.getElementById('advFilterPanel').classList.toggle('active'); }
    function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }
    function toggleMenu(id) { var menu = document.getElementById(id); var isVisible = menu.classList.contains('show'); closeAllMenus(); if (!isVisible) menu.classList.add('show'); }
    function closeAllMenus() { document.querySelectorAll('.dropdown-menu').forEach(function(m) { m.classList.remove('show'); }); }
    function closeModal() { document.getElementById('formModal').classList.remove('active'); }
    function closeMemberModal() { document.getElementById('memberModal').classList.remove('active'); }
    function closeExcelModal() { document.getElementById('excelModal').classList.remove('active'); }
    function closeBackupModal() { document.getElementById('backupModal').classList.remove('active'); }
    function showToast(msg, type) { const t = document.createElement('div'); t.className=`toast ${type} show`; t.innerText=msg; document.getElementById('toastContainer').appendChild(t); setTimeout(()=>t.remove(), 3000); }
    function escapeHtml(text) { return text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }
    
    // è¦†ç›–åŸ openAddModal ä»¥æ”¯æŒ Tag é‡ç½®
    const originalOpenAdd = window.openAddModal;
    window.openAddModal = function() {
        if (currentView === 'member') { openMemberModal(); return; }
        document.getElementById('researchForm').reset();
        document.getElementById('editId').value = '';
        currentTags = []; renderFormTags();
        document.getElementById('formModal').classList.add('active');
        toggleFormFields();
    }
    
    // è¦†ç›–åŸ handleSubmit ä»¥æ”¯æŒ Tag å’Œ Log
    window.handleSubmit = function(event) {
        event.preventDefault();
        const id = document.getElementById('editId').value;
        const type = document.getElementById('type').value;
        
        let formData = { 
            id: id || Date.now().toString(), 
            type: type, 
            updatedAt: new Date().toISOString(),
            tags: currentTags, // Save Tags
            pdfData: currentPdfData,
            pdfName: currentPdfName
        };
        
        // æ”¶é›†è¡¨å•æ•°æ®
        document.querySelectorAll('#researchForm input, #researchForm select').forEach(el => {
            if(el.id && el.type !== 'file') formData[el.id] = el.value;
        });
        
        // è§„èŒƒåŒ–å­—æ®µ
        if(!formData.title) formData.title = formData.patentName || formData.projectName || formData.bookTitle || formData.awardName;
        if(!formData.date) formData.date = formData.applicationDate || formData.projectStartDate || formData.awardDate || formData.bookDate;

        if (id) {
            const idx = achievements.findIndex(a => a.id === id);
            achievements[idx] = { ...achievements[idx], ...formData };
            addLog('æ›´æ–°', `æ›´æ–°: ${formData.title}`);
        } else {
            formData.createdAt = new Date().toISOString();
            achievements.push(formData);
            addLog('æ–°å»º', `æ–°å»º: ${formData.title}`);
        }
        
        saveToLocal(); closeModal(); updateStats(); renderResults();
        showToast('ä¿å­˜æˆåŠŸ', 'success');
    }

    // --- OneDrive Service (ä¿ç•™åŸä»£ç ç»“æ„) ---
    const msalConfig = { auth: { clientId: "c453313f-fd40-4534-9d66-6a0847396d3b", authority: "https://login.microsoftonline.com/common", redirectUri: window.location.href } };
    let msalInstance;
    const OneDriveService = {
        init: async () => { try { msalInstance = new msal.PublicClientApplication(msalConfig); } catch(e){} },
        signIn: async () => {
            try { const res = await msalInstance.loginPopup({scopes: ["User.Read", "Files.ReadWrite"]}); msalInstance.setActiveAccount(res.account); OneDriveService.updateUI(res.account); } catch(e){showToast(e.message,'error')}
        },
        signOut: () => { msalInstance.logoutPopup(); },
        updateUI: (acc) => {
            if(acc) { document.getElementById('onedrive-login-panel').classList.add('hidden'); document.getElementById('onedrive-actions-panel').classList.remove('hidden'); document.getElementById('odUserName').innerText=acc.name; }
        },
        upload: async () => {
             const acc = msalInstance.getActiveAccount(); if(!acc) return;
             const content = JSON.stringify({achievements, members, systemLogs});
             const url = `https://graph.microsoft.com/v1.0/me/drive/root:/ResearchManager/backup.json:/content`;
             const token = (await msalInstance.acquireTokenSilent({scopes:["Files.ReadWrite"], account:acc})).accessToken;
             await fetch(url, {method:'PUT', headers:{'Authorization':`Bearer ${token}`}, body:content});
             showToast('ä¸Šä¼ æˆåŠŸ','success'); addLog('äº‘åŒæ­¥', 'ä¸Šä¼ æ•°æ®');
        },
        download: async () => {
             const acc = msalInstance.getActiveAccount(); if(!acc) return;
             const token = (await msalInstance.acquireTokenSilent({scopes:["Files.ReadWrite"], account:acc})).accessToken;
             const res = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/ResearchManager/backup.json:/content`, {headers:{'Authorization':`Bearer ${token}`}});
             if(res.ok) {
                 const data = await res.json();
                 if(confirm('åˆå¹¶äº‘ç«¯æ•°æ®?')) {
                     // ç®€å•åˆå¹¶é€»è¾‘
                     data.achievements.forEach(n => { if(!achievements.some(a=>a.id===n.id)) achievements.push(n); });
                     data.members.forEach(n => { if(!members.some(m=>m.id===n.id)) members.push(n); });
                     saveToLocal(); renderResults(); updateStats(); showToast('åŒæ­¥æˆåŠŸ','success');
                 }
             }
        }
    };

    // åˆå§‹åŒ–
    window.onload = function() {
        OneDriveService.init();
        loadFromLocal().then(() => {
            // è§£å¯†åˆå§‹åŒ–æ˜¾ç¤º
            members.forEach(m => {
                m.memberPhone = simpleDecrypt(m.memberPhone);
                m.memberIdCard = simpleDecrypt(m.memberIdCard);
            });
            updateStats();
            renderResults();
        });
    }

    function updateStats() {
        var counts = { paper: 0, patent: 0, project: 0, award: 0, book: 0 };
        achievements.forEach(function(item) { if (!item.isDeleted && counts[item.type] !== undefined) counts[item.type]++; });
        document.getElementById('totalCount').textContent = achievements.filter(a=>!a.isDeleted).length;
        document.getElementById('memberCount').textContent = members.filter(m=>!m.isDeleted).length;
        document.getElementById('statMember').textContent = members.filter(m=>!m.isDeleted).length;
        ['paper', 'patent', 'project', 'award', 'book'].forEach(function(t) {
            document.getElementById(t + 'Count').textContent = counts[t];
            document.getElementById('stat' + t.charAt(0).toUpperCase() + t.slice(1)).textContent = counts[t];
        });
    }

    function toggleSelectAll() { 
        var c = document.getElementById('selectAll').checked; 
        document.querySelectorAll('.result-checkbox').forEach(function(cb) { cb.checked = c; if (c) selectedItems.add(cb.dataset.id); else selectedItems.delete(cb.dataset.id); }); 
    }
    function toggleItemSelect(id) { 
        if (selectedItems.has(id)) selectedItems.delete(id); else selectedItems.add(id); 
    }
    function handleFileSelect(event) {
        var file = event.target.files[0]; if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            currentPdfData = e.target.result; currentPdfName = file.name;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
    function removeFile() { currentPdfData = null; currentPdfName = null; document.getElementById('fileInfo').classList.add('hidden'); }
    function viewFile(id) {
        var item = achievements.find(function(a) { return String(a.id) === String(id); });
        if (item && item.pdfData) {
            var win = window.open(); win.document.write('<iframe src="' + item.pdfData + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
        }
    }
    function toggleFormFields() {
        var type = document.getElementById('type').value; 
        ['patentFields','projectFields','awardFields','bookFields','generalFields'].forEach(id => document.getElementById(id).classList.add('hidden'));
        if(type === 'patent') document.getElementById('patentFields').classList.remove('hidden');
        else if(type === 'project') document.getElementById('projectFields').classList.remove('hidden');
        else if(type === 'award') document.getElementById('awardFields').classList.remove('hidden');
        else if(type === 'book') document.getElementById('bookFields').classList.remove('hidden');
        else { document.getElementById('generalFields').classList.remove('hidden'); document.getElementById('dateGroup').classList.remove('hidden'); }
    }
    function editMember(id) { 
        if (currentUserRole !== 'admin') { showToast('æ— æƒç¼–è¾‘', 'error'); return; }
        const m = members.find(i=>i.id===id);
        document.getElementById('memberEditId').value = id;
        document.getElementById('memberName').value = m.memberName;
        document.getElementById('memberNo').value = m.memberNo;
        // ...å…¶ä»–å­—æ®µå¡«å……çœç•¥ï¼Œä¿æŒåŸé€»è¾‘...
        document.getElementById('memberModal').classList.add('active');
    }
    // ä¿æŒåŸæ¥çš„ handleSearch, setYearFilter, handleSort é€»è¾‘ï¼Œä½†æŒ‡å‘æ–°çš„ renderResults
    function handleSearch() { searchQuery = document.getElementById('searchInput').value.toLowerCase(); currentPage=1; renderResults(); }
    function setYearFilter(y) { currentYearFilter = y; document.querySelectorAll('.filter-chip').forEach(c=>c.classList.toggle('active', c.dataset.year===y)); renderResults(); }
    function handleSort() { sortOrder = document.getElementById('sortSelect').value; renderResults(); }
    
    // å¯¼å‡ºåŠŸèƒ½ä¿æŒåŸæ ·ï¼Œä»…å¢åŠ  exportData çš„ JSON stringify æ›´æ–°
    function exportData() {
        if (currentUserRole !== 'admin') return;
        var data = { version: '5.0', exportDate: new Date().toISOString(), achievements, members, systemLogs };
        var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click();
    }
    function triggerImport() { document.getElementById('importInput').click(); }
    function importData(event) {
        var file = event.target.files[0]; if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = JSON.parse(e.target.result);
                // æ™ºèƒ½åˆå¹¶ JSON
                let count = 0;
                (data.achievements||[]).forEach(item => {
                    let exist = achievements.find(a => a.id === item.id);
                    if(exist) smartMerge(exist, item);
                    else { achievements.push(item); count++; }
                });
                saveToLocal(); updateStats(); renderResults(); showToast('å¯¼å…¥æˆåŠŸ', 'success');
            } catch(e) { showToast('æ–‡ä»¶é”™è¯¯', 'error'); }
        };
        reader.readAsText(file);
    }
    function openExcelImport() { document.getElementById('excelModal').classList.add('active'); }
    function handleExcelSelect(event) {
        var file = event.target.files[0]; if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, { type: 'array' });
            excelData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            if (excelData.length > 0) {
                excelHeaders = excelData[0];
                let html = '<table><thead><tr>' + excelHeaders.map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>';
                html += excelData.slice(1,6).map(r=>'<tr>'+excelHeaders.map((_,i)=>`<td>${r[i]||''}</td>`).join('')+'</tr>').join('');
                document.getElementById('excelPreview').innerHTML = html + '</tbody></table>';
                document.getElementById('excelPreviewContainer').classList.remove('hidden');
                document.getElementById('mappingContainer').classList.remove('hidden');
                document.getElementById('importExcelBtn').disabled = false;
                // Update Mapping Selects
                let type = document.getElementById('excelImportType').value;
                let fields = fieldMappings[type] || [];
                document.getElementById('mappingFields').innerHTML = fields.map(f => `
                    <div class="mapping-row"><label>${f.label}</label>
                    <select class="field-map-select" data-key="${f.key}">
                        <option value="">(å¿½ç•¥)</option>
                        ${excelHeaders.map((h,i)=>`<option value="${i}" ${h.includes(f.label)?'selected':''}>${h}</option>`).join('')}
                    </select></div>`).join('');
            }
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>

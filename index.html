<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§‘ç ”æˆæœç®¡ç†ç³»ç»Ÿ (Pro V2.1)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS æ ·å¼è¡¨ (ä¿æŒæ‚¨åŸæœ‰çš„æ‰€æœ‰æ ·å¼) --- */
        :root { --bg-primary: #f8fafc; --bg-secondary: #ffffff; --bg-card: #ffffff; --bg-hover: #f1f5f9; --text-primary: #1e293b; --text-secondary: #64748b; --text-muted: #94a3b8; --border: #e2e8f0; --border-light: #f1f5f9; --accent: #6366f1; --accent-light: #eef2ff; --accent-dark: #4f46e5; --success: #10b981; --success-light: #d1fae5; --warning: #f59e0b; --warning-light: #fef3c7; --danger: #ef4444; --danger-light: #fee2e2; --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.1); --radius: 12px; --radius-sm: 8px; --od-blue: #0078D4; --od-hover: #005a9e; --od-light: #f3f9fd; }
        html.dark { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #1e293b; --bg-hover: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --text-muted: #64748b; --border: #334155; --border-light: #1e293b; --accent-light: #312e81; --success-light: #064e3b; --warning-light: #78350f; --danger-light: #7f1d1d; --od-light: #002c4e; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; height: 100vh; height: 100dvh; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .app-container { display: flex; height: 100vh; height: 100dvh; overflow: hidden; }
        .sidebar { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; height: 100%; z-index: 100; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }
        .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
        .nav-menu { flex: 1; padding: 16px 12px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .nav-section { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 12px 12px 8px; margin-top: 8px; }
        .nav-section:first-child { margin-top: 0; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary); font-weight: 500; transition: all 0.2s; margin-bottom: 4px; min-height: 48px; }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-light); color: var(--accent); }
        .nav-item.disabled { opacity: 0.5; pointer-events: none; cursor: not-allowed; }
        .nav-item .badge { margin-left: auto; background: var(--bg-hover); padding: 2px 10px; border-radius: 10px; font-size: 0.8rem; font-weight: 600; }
        .nav-item.active .badge { background: var(--accent); color: white; }
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); position: relative; }
        .storage-status { font-size: 0.85rem; color: var(--success); margin-bottom: 12px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .storage-status.warning { color: var(--warning); }
        .data-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .data-btn { padding: 10px 8px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text-secondary); font-size: 0.85rem; cursor: pointer; transition: all 0.2s; text-align: center; min-height: 44px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .data-btn:hover { background: var(--bg-hover); border-color: var(--accent); color: var(--accent); }
        .data-btn.onedrive { border-color: var(--od-blue); color: var(--od-blue); }
        .data-btn.onedrive:hover { background: var(--od-light); }
        .dropdown-menu { position: absolute; bottom: 100%; left: 10px; right: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: var(--shadow-lg); display: none; z-index: 200; overflow: hidden; margin-bottom: 8px; }
        .dropdown-menu.show { display: block; animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .menu-item { padding: 14px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; border-bottom: 1px solid var(--border-light); min-height: 48px; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:hover { background: var(--bg-hover); color: var(--accent); }
        .main-content { flex: 1; padding: 20px; height: 100vh; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0; gap: 12px; flex-wrap: wrap; }
        .page-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; flex: 1; justify-content: flex-end; }
        .search-box { flex: 1; min-width: 200px; max-width: 400px; display: flex; gap: 8px; }
        .search-box input { padding: 12px 16px; border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg-card); color: var(--text-primary); font-size: 16px; width: 100%; transition: all 0.2s; }
        .search-box input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
        .btn { padding: 12px 20px; border-radius: var(--radius); font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; min-height: 48px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; box-shadow: var(--shadow); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; min-height: 36px; }
        .btn:disabled, .btn.disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn-od { background: var(--od-blue); color: white; border: none; }
        .btn-od:hover { background: var(--od-hover); }
        .btn-od-outline { background: transparent; border: 2px solid var(--od-blue); color: var(--od-blue); }
        .btn-od-outline:hover { background: var(--od-light); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px; flex-shrink: 0; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; cursor: pointer; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); border-color: var(--accent); }
        .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .stat-icon.papers { background: #dbeafe; } .stat-icon.patents { background: #fef3c7; } .stat-icon.projects { background: #d1fae5; } .stat-icon.awards { background: #fce7f3; } .stat-icon.books { background: #e0e7ff; } .stat-icon.members { background: #f3e8ff; }
        .stat-info h3 { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); }
        .stat-info p { font-size: 0.75rem; color: var(--text-secondary); }
        #listViewContainer { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .filter-container { margin-bottom: 12px; flex-shrink: 0; }
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; }
        .filter-chip { padding: 6px 14px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .filter-chip:hover { border-color: var(--accent); color: var(--accent); }
        .filter-chip.active { background: var(--accent); border-color: var(--accent); color: white; }
        .results-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); display: flex; flex-direction: column; flex: 1; overflow: hidden; min-height: 0; }
        .results-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); flex-wrap: wrap; gap: 10px; flex-shrink: 0; }
        .results-count { color: var(--text-secondary); font-size: 0.85rem; }
        .batch-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .select-all-wrapper { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 10px; border-radius: var(--radius-sm); transition: background 0.2s; }
        .select-all-wrapper:hover { background: var(--bg-hover); }
        .select-all-wrapper input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
        .results-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .result-item { display: flex; align-items: flex-start; padding: 12px 16px; border-bottom: 1px solid var(--border-light); cursor: pointer; transition: background 0.2s; gap: 12px; min-height: 72px; }
        .result-item:hover { background: var(--bg-hover); }
        .result-item:last-child { border-bottom: none; }
        .result-item:active { background: var(--accent-light); }
        .result-checkbox { margin-top: 12px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); flex-shrink: 0; }
        .result-type { margin-top: 0; width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .type-paper { background: #dbeafe; } .type-patent { background: #fef3c7; } .type-project { background: #d1fae5; } .type-award { background: #fce7f3; } .type-book { background: #e0e7ff; } .type-member { background: #f3e8ff; }
        .result-content { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .result-title { font-weight: 600; color: var(--text-primary); font-size: 0.95rem; margin-bottom: 6px; white-space: normal; line-height: 1.4; }
        .result-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; }
        .result-meta span { display: inline-flex; align-items: center; gap: 3px; white-space: normal; }
        .result-meta .has-pdf { color: var(--accent); font-weight: 500; }
        .result-actions { display: flex; gap: 6px; flex-shrink: 0; align-items: center; margin-top: 2px; }
        .action-btn { width: 36px; height: 36px; border: none; background: var(--bg-hover); border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 1rem; }
        .action-btn:hover { background: var(--accent-light); color: var(--accent); }
        .action-btn.delete:hover { background: var(--danger-light); color: var(--danger); }
        .empty-state { padding: 60px 20px; text-align: center; color: var(--text-secondary); }
        .empty-state h3 { font-size: 1.25rem; margin-bottom: 8px; color: var(--text-primary); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: flex-end; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border-radius: var(--radius) var(--radius) 0 0; width: 100%; max-width: 600px; max-height: 90vh; max-height: 90dvh; overflow: hidden; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal.wide { max-width: 800px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .modal-header h2 { font-size: 1.2rem; font-weight: 700; }
        .modal-close { width: 40px; height: 40px; border: none; background: var(--bg-hover); border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); transition: all 0.2s; }
        .modal-close:hover { background: var(--danger-light); color: var(--danger); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary); font-size: 16px; transition: all 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .file-upload { border: 2px dashed var(--border); border-radius: var(--radius); padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-upload:hover { border-color: var(--accent); background: var(--accent-light); }
        .file-upload input { display: none; }
        .file-upload-icon { font-size: 2.5rem; margin-bottom: 12px; }
        .file-upload.has-file { display: none; }
        .file-info { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--accent-light); border-radius: var(--radius-sm); border: 1px solid var(--accent); }
        .file-info-name { display: flex; align-items: center; gap: 8px; color: var(--accent); font-weight: 500; }
        .file-remove { width: 32px; height: 32px; border: none; background: var(--danger-light); color: var(--danger); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .excel-preview { max-height: 200px; overflow: auto; border: 1px solid var(--border); border-radius: var(--radius-sm); -webkit-overflow-scrolling: touch; }
        .excel-preview table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .excel-preview th, .excel-preview td { padding: 10px 12px; border: 1px solid var(--border); text-align: left; white-space: nowrap; }
        .excel-preview th { background: var(--bg-secondary); font-weight: 600; position: sticky; top: 0; }
        .mapping-row { display: grid; grid-template-columns: 140px 1fr; gap: 12px; align-items: center; margin-bottom: 12px; }
        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; }
        .toast { padding: 14px 20px; border-radius: var(--radius-sm); background: var(--bg-card); border: 1px solid var(--border); box-shadow: var(--shadow-lg); font-weight: 500; transform: translateY(-120%); transition: transform 0.3s; text-align: center; }
        .toast.show { transform: translateY(0); }
        .toast.success { background: var(--success-light); border-color: var(--success); color: var(--success); }
        .toast.error { background: var(--danger-light); border-color: var(--danger); color: var(--danger); }
        .toast.warning { background: var(--warning-light); border-color: var(--warning); color: var(--warning); }
        .duplicate-warning { background: var(--warning-light); border: 1px solid var(--warning); border-radius: var(--radius-sm); padding: 16px; margin-top: 16px; }
        .duplicate-list { max-height: 150px; overflow-y: auto; font-size: 0.85rem; color: var(--text-secondary); }
        .duplicate-list li { padding: 4px 0; border-bottom: 1px solid var(--warning); }
        .user-profile { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: var(--radius-sm); background: var(--bg-hover); margin-bottom: 16px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--od-blue); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .mobile-menu-btn { display: none; position: fixed; top: 12px; left: 12px; z-index: 101; width: 48px; height: 48px; border: none; background: var(--bg-card); border-radius: var(--radius-sm); box-shadow: var(--shadow); font-size: 1.4rem; cursor: pointer; align-items: center; justify-content: center; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        .sidebar-overlay.active { display: block; }
        .loading-spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; }
        .loading-spinner.dark { border-color: var(--text-muted); border-top-color: var(--accent); }
        @keyframes spin { to { transform: rotate(360deg); } }
        .confirm-dialog { background: var(--bg-card); border-radius: var(--radius); padding: 24px; max-width: 360px; width: 90%; text-align: center; }
        .login-overlay { position: fixed; inset: 0; background: var(--bg-primary); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .login-box { background: var(--bg-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border); }
        .detail-row { display: flex; padding: 12px 0; border-bottom: 1px solid var(--border-light); }
        .detail-label { width: 100px; flex-shrink: 0; font-weight: 600; color: var(--text-secondary); }
        .detail-value { flex: 1; color: var(--text-primary); word-break: break-all; }
        .advanced-search-panel { background: var(--bg-hover); padding: 12px; border-radius: var(--radius); margin-bottom: 10px; border: 1px solid var(--border); display: none; }
        .advanced-search-panel.active { display: block; animation: slideDown 0.3s; }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }
        .adv-row { display: flex; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        .adv-row input, .adv-row select { padding: 8px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); font-size: 0.9rem; flex: 1; }
        .tag-list { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
        .tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: var(--accent-light); color: var(--accent); font-weight: 600; }
        .pagination-bar { padding: 10px 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary); flex-shrink: 0; }
        .deleted-item { opacity: 0.7; background: var(--bg-hover); }
        .log-entry { font-size: 0.8rem; border-bottom: 1px solid var(--border-light); padding: 8px 0; display: flex; justify-content: space-between; }
        .log-time { color: var(--text-muted); width: 140px; flex-shrink: 0; }
        .smart-btn { white-space: nowrap; padding: 0 16px; background: var(--accent-light); color: var(--accent); border: 1px solid var(--accent); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; }
        .ocr-upload-area { border: 2px dashed var(--border); border-radius: var(--radius); padding: 20px; text-align: center; margin-bottom: 15px; cursor: pointer; transition: all 0.2s; }
        .ocr-upload-area:hover { border-color: var(--accent); background: var(--accent-light); }
        .input-group { display: flex; gap: 8px; }
        .theme-toggle { cursor: pointer; padding: 8px; border-radius: 50%; display:flex; align-items:center; justify-content:center; }

        @media (min-width: 769px) { .modal-overlay { align-items: center; padding: 20px; } .modal { border-radius: var(--radius); max-height: 85vh; } }
        @media (max-width: 768px) {
            .mobile-menu-btn { display: flex; }
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); width: 85%; max-width: 320px; }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 70px 12px 12px; }
            .page-title { font-size: 1.25rem; }
            .header { flex-direction: column; align-items: stretch; }
            .header-actions { width: 100%; justify-content: stretch; }
            .search-box { max-width: none; min-width: 0; }
            .btn { padding: 10px 16px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .stat-card { padding: 12px; }
            .form-row { grid-template-columns: 1fr; }
            .mapping-row { grid-template-columns: 1fr; gap: 8px; }
        }
    </style>
</head>
<body>
<div id="loginOverlay" class="login-overlay">
    <div class="login-box">
        <div class="logo-icon" style="margin: 0 auto 20px auto;">ğŸ”¬</div>
        <div class="login-title" style="font-size:1.8rem;font-weight:700;margin-bottom:20px;color:var(--accent);">ç§‘ç ”æˆæœç®¡ç†</div>
        <div class="login-desc" style="color:var(--text-secondary);margin-bottom:30px;">è¯·è¾“å…¥è®¿é—®å¯†ç ç™»å½•ç³»ç»Ÿ</div>
        <div class="form-group"><input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ..." onkeyup="if(event.key==='Enter') checkLogin()"></div>
        <button class="btn btn-primary" style="width:100%" onclick="checkLogin()">ç™»å½•</button>
        <div style="margin-top:15px; font-size:0.8rem; color:var(--text-muted);">ç®¡ç†å‘˜: 1399 | å®¾å®¢: guest</div>
    </div>
</div>

<button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo"><div class="logo-icon">ğŸ”¬</div><div><div>ç§‘ç ”æˆæœç®¡ç†</div><div style="font-size:0.7rem;color:var(--text-muted);">Pro V2.1</div></div></div>
            <div class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢æ—¥/å¤œæ¨¡å¼">ğŸŒ“</div>
        </div>
        <nav class="nav-menu">
            <div class="nav-section">æˆæœç®¡ç†</div>
            <div class="nav-item active" data-view="all" onclick="setView('all')">ğŸ“‹ <span>å…¨éƒ¨æˆæœ</span><span class="badge" id="totalCount">0</span></div>
            <div class="nav-item" data-view="paper" onclick="setView('paper')">ğŸ“„ <span>å­¦æœ¯è®ºæ–‡</span><span class="badge" id="paperCount">0</span></div>
            <div class="nav-item" data-view="patent" onclick="setView('patent')">ğŸ’¡ <span>å‘æ˜ä¸“åˆ©</span><span class="badge" id="patentCount">0</span></div>
            <div class="nav-item" data-view="project" onclick="setView('project')">ğŸ“Š <span>ç§‘ç ”é¡¹ç›®</span><span class="badge" id="projectCount">0</span></div>
            <div class="nav-item" data-view="award" onclick="setView('award')">ğŸ† <span>è·å¥–æƒ…å†µ</span><span class="badge" id="awardCount">0</span></div>
            <div class="nav-item" data-view="book" onclick="setView('book')">ğŸ“š <span>ä¸“è‘—å‡ºç‰ˆ</span><span class="badge" id="bookCount">0</span></div>
            <div class="nav-section">å›¢é˜Ÿç®¡ç†</div>
            <div class="nav-item" data-view="member" id="navMember" onclick="setView('member')">ğŸ‘¥ <span>æˆå‘˜ä¿¡æ¯</span><span class="badge" id="memberCount">0</span></div>
            <div class="nav-section">ç³»ç»Ÿç»´æŠ¤</div>
            <div class="nav-item" onclick="openRecycleBin()">â™»ï¸ <span>å›æ”¶ç«™</span></div>
            <div class="nav-item" onclick="openLogsModal()">ğŸ“œ <span>æ“ä½œæ—¥å¿—</span></div>
        </nav>
        <div class="sidebar-footer">
            <div class="storage-status" id="storageStatus">âœ“ æ•°æ®å·²æœ¬åœ°ä¿å­˜</div>
            <div class="data-actions">
                <button class="data-btn" id="btnExport" onclick="toggleMenu('exportMenu')">ğŸ“¤ å¯¼å‡º</button>
                <button class="data-btn" id="btnImport" onclick="toggleMenu('importMenu')">ğŸ“¥ å¯¼å…¥</button>
                <button class="data-btn onedrive" id="btnOneDrive" onclick="openBackupModal()" style="grid-column: span 2;">â˜ï¸ OneDrive åŒæ­¥</button>
            </div>
            <div id="exportMenu" class="dropdown-menu">
                <div class="menu-item" onclick="exportToExcelFile()">ğŸ“Š å¯¼å‡º Excel (åˆ†è¡¨)</div>
                <div class="menu-item" onclick="exportResume()">ğŸ“ å¯¼å‡ºç®€å† (Word)</div>
                <div class="menu-item" id="menuExportJson" onclick="exportData()">ğŸ“¦ å¯¼å‡ºçº¯ JSON (åŠ å¯†)</div>
            </div>
            <div id="importMenu" class="dropdown-menu">
                <div class="menu-item" onclick="openExcelImport()">ğŸ“Š å¯¼å…¥ Excel</div>
                <div class="menu-item" onclick="triggerImport()">ğŸ“‚ æ¢å¤ JSON</div>
            </div>
            <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(event)">
            <button class="btn btn-sm btn-secondary" onclick="location.reload()" style="width:100%; margin-top:10px;">ğŸ”’ é€€å‡ºç™»å½•</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <h1 class="page-title" id="pageTitle">å…¨éƒ¨æˆæœ</h1>
            <div class="header-actions">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢..." oninput="handleSearch()">
                    <button class="btn btn-secondary btn-sm" onclick="toggleAdvancedSearch()">âš¡ é«˜çº§</button>
                </div>
                <button class="btn btn-primary" id="addBtn" onclick="openAddModal()">â• <span id="addBtnText">æ·»åŠ </span></button>
            </div>
        </div>
        <div class="advanced-search-panel" id="advancedSearchPanel">
            <div class="adv-row">
                <input type="date" id="advStartDate" placeholder="å¼€å§‹æ—¥æœŸ" onchange="handleSearch()">
                <span style="align-self:center">è‡³</span>
                <input type="date" id="advEndDate" placeholder="ç»“æŸæ—¥æœŸ" onchange="handleSearch()">
                <input type="text" id="advAuthor" placeholder="ä½œè€…/å‘æ˜äºº" oninput="handleSearch()">
                <input type="text" id="advTag" placeholder="#æ ‡ç­¾" oninput="handleSearch()">
            </div>
            <div style="font-size:0.8rem; color:var(--text-secondary)">æç¤ºï¼šå¤šæ¡ä»¶æ˜¯â€œä¸â€çš„å…³ç³»</div>
        </div>
        <div class="stats-grid" id="statsGrid">
             <div class="stat-card" onclick="setView('paper')"><div class="stat-icon papers">ğŸ“„</div><div class="stat-info"><h3 id="statPaper">0</h3><p>è®ºæ–‡</p></div></div>
             <div class="stat-card" onclick="setView('patent')"><div class="stat-icon patents">ğŸ’¡</div><div class="stat-info"><h3 id="statPatent">0</h3><p>ä¸“åˆ©</p></div></div>
             <div class="stat-card" onclick="setView('project')"><div class="stat-icon projects">ğŸ“Š</div><div class="stat-info"><h3 id="statProject">0</h3><p>é¡¹ç›®</p></div></div>
             <div class="stat-card" onclick="setView('award')"><div class="stat-icon awards">ğŸ†</div><div class="stat-info"><h3 id="statAward">0</h3><p>è·å¥–</p></div></div>
             <div class="stat-card" onclick="setView('book')"><div class="stat-icon books">ğŸ“š</div><div class="stat-info"><h3 id="statBook">0</h3><p>è‘—ä½œ</p></div></div>
             <div class="stat-card" onclick="setView('member')"><div class="stat-icon members">ğŸ‘¥</div><div class="stat-info"><h3 id="statMember">0</h3><p>æˆå‘˜</p></div></div>
        </div>
        <div id="listViewContainer">
            <div class="filter-container">
                <div class="filter-bar" id="filterBar">
                    <div class="filter-chip active" data-year="all" onclick="setYearFilter('all')">å…¨éƒ¨å¹´ä»½</div>
                </div>
            </div>
            <div class="results-container" id="resultsContainer">
                <div class="results-header">
                    <div class="batch-actions">
                        <label class="select-all-wrapper"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> <span>å…¨é€‰</span></label>
                        <button class="btn btn-danger btn-sm" id="batchDeleteBtn" onclick="batchDelete()" style="display:none;">ğŸ—‘ åˆ é™¤ (<span id="selectedCount">0</span>)</button>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                        <span class="results-count" id="resultsCount">å…± 0 æ¡</span>
                        <select id="sortSelect" onchange="handleSort()" style="padding:10px;border-radius:8px;border:2px solid var(--border);">
                            <option value="date-desc">æœ€æ–°ä¼˜å…ˆ</option>
                            <option value="date-asc">æœ€æ—©ä¼˜å…ˆ</option>
                            <option value="title-asc">æ ‡é¢˜æ’åº</option>
                        </select>
                    </div>
                </div>
                <div class="results-list" id="resultsList"></div>
                <div class="pagination-bar">
                    <div class="pagination-info" id="paginationInfo">ç¬¬ 1 é¡µ</div>
                    <div class="pagination-controls">
                        <button class="btn btn-sm btn-secondary" onclick="prevPage()">ä¸Šä¸€é¡µ</button>
                        <button class="btn btn-sm btn-secondary" onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="formModal">
    <div class="modal wide">
        <div class="modal-header"><h2 id="modalTitle">æ·»åŠ ç§‘ç ”æˆæœ</h2><button class="modal-close" onclick="closeModal()">âœ•</button></div>
        <div class="modal-body">
            <div id="ocrSection" class="ocr-upload-area hidden" onclick="document.getElementById('ocrInput').click()">
                <input type="file" id="ocrInput" accept="image/*" class="hidden" onchange="handleOCR(event)">
                <div style="font-size:1.5rem">ğŸ“·</div>
                <div>ç‚¹å‡»ä¸Šä¼ è¯ä¹¦/ä¸“åˆ©å›¾ç‰‡è‡ªåŠ¨è¯†åˆ«æ–‡å­— (OCR)</div>
                <div id="ocrStatus" style="font-size:0.8rem;color:var(--accent);"></div>
            </div>
            <form id="researchForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group"><label>æˆæœç±»å‹ *</label><select id="type" required onchange="toggleFormFields()"><option value="">è¯·é€‰æ‹©</option><option value="paper">å­¦æœ¯è®ºæ–‡</option><option value="patent">å‘æ˜ä¸“åˆ©</option><option value="project">ç§‘ç ”é¡¹ç›®</option><option value="award">è·å¥–æƒ…å†µ</option><option value="book">ä¸“è‘—å‡ºç‰ˆ</option></select></div>
                    <div class="form-group" id="dateGroup"><label>æ—¥æœŸ *</label><input type="date" id="date"></div>
                </div>
                <div id="generalFields">
                    <div class="form-group"><label>æ ‡é¢˜ *</label><input type="text" id="title" placeholder="è¯·è¾“å…¥æˆæœæ ‡é¢˜"></div>
                    <div class="form-group"><label>ä½œè€…/æˆå‘˜</label><input type="text" id="authors" placeholder="å¤šä¸ªä½œè€…ç”¨é€—å·åˆ†éš”"></div>
                    <div class="form-row"><div class="form-group"><label>æ¥æº/æœŸåˆŠ</label><input type="text" id="source"></div><div class="form-group"><label>çº§åˆ«</label><input type="text" id="level"></div></div>
                    <div class="form-group"><label>DOI</label><div class="input-group"><input type="text" id="doi" placeholder="å¦‚ 10.1038/xxx"><button type="button" class="smart-btn" onclick="fetchDoiMetadata()">ğŸŒ æŠ“å–</button></div></div>
                </div>
                <div id="patentFields" class="hidden">
                    <div class="form-group"><label>ä¸“åˆ©åç§° *</label><input type="text" id="patentName"></div>
                    <div class="form-row"><div class="form-group"><label>ç±»å‹</label><select id="patentType"><option value="å‘æ˜ä¸“åˆ©">å‘æ˜ä¸“åˆ©</option><option value="å®ç”¨æ–°å‹">å®ç”¨æ–°å‹</option><option value="å¤–è§‚è®¾è®¡">å¤–è§‚è®¾è®¡</option></select></div><div class="form-group"><label>çŠ¶æ€</label><select id="patentStatus"><option value="å—ç†">å—ç†</option><option value="æˆæƒ">æˆæƒ</option><option value="å®¡ä¸­">å®¡ä¸­</option><option value="å¤±æ•ˆ">å¤±æ•ˆ</option></select></div></div>
                    <div class="form-row"><div class="form-group"><label>å‘æ˜äºº</label><input type="text" id="inventors"></div><div class="form-group"><label>ä¸“åˆ©æƒäºº</label><input type="text" id="patentOwner"></div></div>
                    <div class="form-row"><div class="form-group"><label>ç”³è¯·æ—¥</label><input type="date" id="applicationDate"></div><div class="form-group"><label>å—ç†/æˆæƒæ—¥</label><input type="date" id="grantDate"></div></div>
                    <div class="form-group"><label>ä¸“åˆ©å·</label><input type="text" id="patentNumber"></div>
                </div>
                <div id="projectFields" class="hidden">
                    <div class="form-group"><label>é¡¹ç›®åç§° *</label><input type="text" id="projectName"></div>
                    <div class="form-row"><div class="form-group"><label>çº§åˆ«</label><input type="text" id="projectLevel"></div><div class="form-group"><label>ç¼–å·</label><input type="text" id="projectNumber"></div></div>
                    <div class="form-row"><div class="form-group"><label>å¼€å§‹</label><input type="date" id="projectStartDate"></div><div class="form-group"><label>ç»“æŸ</label><input type="date" id="projectEndDate"></div></div>
                    <div class="form-group"><label>å•ä½</label><input type="text" id="projectOrg"></div>
                </div>
                <div id="awardFields" class="hidden">
                    <div class="form-group"><label>å¥–é¡¹åç§° *</label><input type="text" id="awardName"></div>
                    <div class="form-group"><label>è·å¥–äºº</label><input type="text" id="awardRecipients"></div>
                    <div class="form-row"><div class="form-group"><label>æˆå¥–å•ä½</label><input type="text" id="awardAgency"></div><div class="form-group"><label>è·å¥–çº§åˆ«</label><input type="text" id="awardLevel"></div></div>
                    <div class="form-group"><label>è·å¥–æ—¥æœŸ</label><input type="date" id="awardDate"></div>
                </div>
                <div id="bookFields" class="hidden">
                    <div class="form-group"><label>è‘—ä½œåç§° *</label><input type="text" id="bookTitle"></div>
                    <div class="form-group"><label>ä½œè€…</label><input type="text" id="bookAuthors"></div>
                    <div class="form-row"><div class="form-group"><label>å‡ºç‰ˆç¤¾</label><input type="text" id="bookPublisher"></div><div class="form-group"><label>ISBN</label><div class="input-group"><input type="text" id="bookIsbn"><button type="button" class="smart-btn" onclick="fetchIsbnMetadata()">ğŸ“š æŠ“å–</button></div></div></div>
                    <div class="form-group"><label>å‡ºç‰ˆæ—¥æœŸ</label><input type="date" id="bookDate"></div>
                </div>
                <div class="form-group"><label>ğŸ·ï¸ æ ‡ç­¾</label><input type="text" id="tags" placeholder="ä¾‹å¦‚: #é‡ç‚¹é¡¹ç›® #é£ç”µ"></div>
                <div class="form-group"><label>ğŸ“ é™„ä»¶</label><div class="file-upload" id="fileUpload" onclick="document.getElementById('pdfInput').click()"><input type="file" id="pdfInput" accept=".pdf,.doc,.docx,.xlsx,.zip" onchange="handleFileSelect(event)"><div class="file-upload-icon">ğŸ“„</div><div class="file-upload-text">ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</div></div><div class="file-info hidden" id="fileInfo"><span class="file-info-name"><span>ğŸ“„</span><span id="fileName"></span></span><button type="button" class="file-remove" onclick="removeFile()">âœ•</button></div></div>
            </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button><button type="submit" form="researchForm" class="btn btn-primary" id="submitBtn">ä¿å­˜</button></div>
    </div>
</div>

<div class="modal-overlay" id="detailModal">
    <div class="modal wide">
        <div class="modal-header"><h2 id="detailTitle">è¯¦ç»†ä¿¡æ¯</h2><button class="modal-close" onclick="closeDetailModal()">âœ•</button></div>
        <div class="modal-body" id="detailContent"></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeDetailModal()">å…³é—­</button><button type="button" class="btn btn-primary" id="detailEditBtn" onclick="editFromDetail()">âœ ç¼–è¾‘</button></div>
    </div>
</div>

<div class="modal-overlay" id="memberModal">
    <div class="modal wide">
        <div class="modal-header"><h2 id="memberModalTitle">æ·»åŠ æˆå‘˜</h2><button class="modal-close" onclick="closeMemberModal()">âœ•</button></div>
        <div class="modal-body">
            <form id="memberForm" onsubmit="handleMemberSubmit(event)">
                <input type="hidden" id="memberEditId">
                <div class="form-row"><div class="form-group"><label>å­¦å·/å·¥å· *</label><input type="text" id="memberNo" required></div><div class="form-group"><label>å§“å *</label><input type="text" id="memberName" required></div></div>
                <div class="form-row"><div class="form-group"><label>æ€§åˆ«</label><select id="memberGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div><div class="form-group"><label>æ°‘æ—</label><input type="text" id="memberNation"></div></div>
                <div class="form-group"><label>è¯ä»¶å·ç </label><input type="text" id="memberIdCard" oninput="handleIdCardInput(this)"></div>
                <div class="form-row"><div class="form-group"><label>å‡ºç”Ÿå¹´æœˆ</label><input type="text" id="memberDob"></div><div class="form-group"><label>ç”µè¯</label><input type="text" id="memberPhone"></div></div>
                <div class="form-row"><div class="form-group"><label>å•ä½</label><input type="text" id="memberOrg"></div><div class="form-group"><label>èŒç§°</label><input type="text" id="memberTitle"></div></div>
                <div class="form-group"><label>é‚®ç®±</label><input type="email" id="memberEmail"></div>
            </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeMemberModal()">å–æ¶ˆ</button><button type="submit" form="memberForm" class="btn btn-primary">ä¿å­˜</button></div>
    </div>
</div>

<div class="modal-overlay" id="excelModal">
    <div class="modal wide">
        <div class="modal-header"><h2>å¯¼å…¥ Excel æ•°æ®</h2><button class="modal-close" onclick="closeExcelModal()">âœ•</button></div>
        <div class="modal-body">
            <div class="form-group"><label>ç±»å‹</label><select id="excelImportType" onchange="updateMappingFields()"><option value="paper">å­¦æœ¯è®ºæ–‡</option><option value="patent">å‘æ˜ä¸“åˆ©</option><option value="project">ç§‘ç ”é¡¹ç›®</option><option value="award">è·å¥–æƒ…å†µ</option><option value="book">ä¸“è‘—å‡ºç‰ˆ</option><option value="member">æˆå‘˜ä¿¡æ¯</option></select></div>
            <div class="form-group"><label>æ–‡ä»¶</label><div class="file-upload" onclick="document.getElementById('excelInput').click()"><input type="file" id="excelInput" accept=".xlsx,.xls,.csv" onchange="handleExcelSelect(event)"><div class="file-upload-icon">ğŸ“Š</div><div class="file-upload-text">ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶</div></div></div>
            <div id="excelPreviewContainer" class="hidden"><label>é¢„è§ˆ</label><div class="excel-preview" id="excelPreview"></div></div>
            <div id="mappingContainer" class="hidden" style="margin-top:20px;"><label>æ˜ å°„</label><div id="mappingFields"></div></div>
            <div id="duplicateWarning" class="duplicate-warning hidden"><h4>âš ï¸ å‘ç°é‡å¤é¡¹ (å·²è‡ªåŠ¨è·³è¿‡)</h4><ul class="duplicate-list" id="duplicateList"></ul></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeExcelModal()">å–æ¶ˆ</button><button type="button" class="btn btn-primary" id="importExcelBtn" onclick="confirmExcelImport()" disabled>ç¡®è®¤å¯¼å…¥</button></div>
    </div>
</div>

<div class="modal-overlay" id="backupModal">
    <div class="modal">
        <div class="modal-header"><h2>â˜ï¸ æ•°æ®åŒæ­¥ä¸å¤‡ä»½</h2><button class="modal-close" onclick="closeBackupModal()">âœ•</button></div>
        <div class="modal-body">
            <div class="backup-section" style="background:var(--od-light); border-color:var(--od-blue);">
                <h4 style="color:var(--od-blue)">â˜ï¸ OneDrive åŒæ­¥</h4>
                <div id="onedrive-login-panel"><button class="btn btn-od" onclick="OneDriveService.signIn()" style="width:100%">ğŸ”‘ ç™»å½•</button></div>
                <div id="onedrive-actions-panel" class="hidden"><div class="user-profile"><div class="user-avatar" id="odUserInitials">?</div><div style="flex:1;"><div style="font-weight:600;" id="odUserName"></div><div style="font-size:0.75rem;" id="odUserEmail"></div></div><button class="btn btn-sm btn-secondary" onclick="OneDriveService.signOut()">æ³¨é”€</button></div><div style="display:grid; gap:10px;"><button class="btn btn-od" id="btnOdUpload" onclick="OneDriveService.upload()">â¬†ï¸ ä¸Šä¼ </button><button class="btn btn-od-outline" id="btnOdDownload" onclick="OneDriveService.download()">â¬‡ï¸ æ¢å¤</button></div></div>
            </div>
            <div style="border-top:1px solid var(--border); padding-top:20px; margin-top:20px;"><h4 style="margin-bottom:12px;">ğŸ’¾ æœ¬åœ°å¤‡ä»½</h4><div style="display:flex; gap:10px;"><button class="btn btn-secondary" id="btnLocalExport" onclick="exportData()" style="flex:1;">å¯¼å‡º JSON</button><button class="btn btn-secondary" onclick="triggerImport()" style="flex:1;">å¯¼å…¥ JSON</button></div></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="recycleModal"><div class="modal wide"><div class="modal-header"><h2>â™»ï¸ å›æ”¶ç«™</h2><button class="modal-close" onclick="closeRecycleModal()">âœ•</button></div><div class="modal-body" id="recycleList" style="min-height:200px"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeRecycleModal()">å…³é—­</button></div></div></div>
<div class="modal-overlay" id="logsModal"><div class="modal wide"><div class="modal-header"><h2>ğŸ“œ æ“ä½œæ—¥å¿—</h2><button class="modal-close" onclick="document.getElementById('logsModal').classList.remove('active')">âœ•</button></div><div class="modal-body" id="logsList" style="min-height:200px"></div></div></div>
<div class="modal-overlay" id="confirmModal"><div class="confirm-dialog"><p id="confirmMessage">ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ</p><div class="btn-group"><button class="btn btn-secondary" onclick="closeConfirmModal()">å–æ¶ˆ</button><button class="btn btn-danger" onclick="confirmDelete()">åˆ é™¤</button></div></div></div>
<div class="toast-container" id="toastContainer"></div>

<script>
    // --- å…¨å±€çŠ¶æ€ ---
    let currentUserRole = null;
    let achievements = [];
    let members = [];
    let trashBin = [];
    let actionLogs = [];
    let currentView = 'all';
    let searchQuery = '';
    let sortOrder = 'date-desc';
    let selectedItems = new Set();
    let deleteTargetIds = [];
    let deleteTargetType = 'achievement';
    let currentPage = 1;
    const pageSize = 50;
    let advFilter = { start: '', end: '', author: '', tag: '' };
    let currentPdfData = null; let currentPdfName = null;
    let excelData = null; let excelHeaders = [];
    let currentDetailId = null;

    // æ•°æ®åº“åˆå§‹åŒ–
    const DB_NAME = 'ResearchDB_V6_Pro';
    let db;
    function initDB() { return new Promise((resolve, reject) => { var r = indexedDB.open(DB_NAME, 1); r.onerror = e => reject(e); r.onupgradeneeded = e => { if (!e.target.result.objectStoreNames.contains('appState')) e.target.result.createObjectStore('appState', { keyPath: 'id' }); }; r.onsuccess = e => { db = e.target.result; resolve(db); }; }); }
    async function saveToLocal() { if (!db) await initDB(); var t = db.transaction(['appState'], 'readwrite'); const safeMembers = members.map(m => ({ ...m, memberIdCard: m.memberIdCard ? btoa(m.memberIdCard) : '', memberPhone: m.memberPhone ? btoa(m.memberPhone) : '' })); t.objectStore('appState').put({ id: 'main_data', achievements: achievements, members: safeMembers, trashBin: trashBin, actionLogs: actionLogs, updatedAt: new Date().toISOString() }); updateStorageStatus(true); }
    async function loadFromLocal() { if (!db) await initDB(); return new Promise(resolve => { var r = db.transaction(['appState'], 'readonly').objectStore('appState').get('main_data'); r.onsuccess = e => { if (e.target.result) { achievements = e.target.result.achievements || []; members = (e.target.result.members || []).map(m => ({ ...m, memberIdCard: m.memberIdCard ? atob(m.memberIdCard) : '', memberPhone: m.memberPhone ? atob(m.memberPhone) : '' })); trashBin = e.target.result.trashBin || []; actionLogs = e.target.result.actionLogs || []; resolve(true); } else resolve(false); }; r.onerror = () => resolve(false); }); }
    function logAction(action, detail) { actionLogs.unshift({ time: new Date().toLocaleString(), user: currentUserRole || 'unknown', action: action, detail: detail }); if(actionLogs.length > 500) actionLogs.pop(); saveToLocal(); }

    // --- ç™»å½•ä¸æƒé™ ---
    function checkLogin() {
        const pwd = document.getElementById('loginPassword').value;
        if (pwd === '1399') { currentUserRole = 'admin'; document.getElementById('loginOverlay').style.display = 'none'; logAction('Login', 'ç®¡ç†å‘˜ç™»å½•'); applyPermissions(); showToast('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ', 'success'); } 
        else if (pwd === 'guest') { currentUserRole = 'guest'; document.getElementById('loginOverlay').style.display = 'none'; logAction('Login', 'å®¾å®¢ç™»å½•'); applyPermissions(); showToast('å®¾å®¢ç™»å½•æˆåŠŸ', 'success'); } 
        else { showToast('å¯†ç é”™è¯¯', 'error'); }
    }
    function applyPermissions() {
        const isAdmin = currentUserRole === 'admin';
        document.getElementById('navMember').classList.toggle('disabled', !isAdmin);
        const btnOdUpload = document.getElementById('btnOdUpload'); if(btnOdUpload) btnOdUpload.disabled = !isAdmin;
        const btnLocalExport = document.getElementById('btnLocalExport'); if(btnLocalExport) btnLocalExport.disabled = !isAdmin;
        updateBatchDeleteBtn();
    }

    // --- ç•Œé¢äº¤äº’ ---
    function toggleTheme() { document.documentElement.classList.toggle('dark'); logAction('UX', 'åˆ‡æ¢ä¸»é¢˜'); }
    new Sortable(document.getElementById('resultsList'), { animation: 150, handle: '.result-item' });
    function renderPagination(totalItems) { const totalPages = Math.ceil(totalItems / pageSize) || 1; document.getElementById('paginationInfo').textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`; }
    function prevPage() { if(currentPage > 1) { currentPage--; renderResults(); } }
    function nextPage() { const filtered = getFilteredData(); const maxPage = Math.ceil(filtered.length / pageSize) || 1; if(currentPage < maxPage) { currentPage++; renderResults(); } }
    
    // --- æ™ºèƒ½åŒ–åŠŸèƒ½ ---
    async function fetchDoiMetadata() {
        const doi = document.getElementById('doi').value.trim(); if(!doi) return showToast('è¯·è¾“å…¥ DOI', 'warning');
        try { const res = await fetch(`https://api.crossref.org/works/${doi}`); if(!res.ok) throw new Error('æœªæ‰¾åˆ°'); const data = await res.json(); const item = data.message; document.getElementById('title').value = item.title ? item.title[0] : ''; if(item.author) document.getElementById('authors').value = item.author.map(a => `${a.given} ${a.family}`).join(', '); document.getElementById('source').value = item['container-title'] ? item['container-title'][0] : ''; if(item.published && item.published['date-parts']) { const p = item.published['date-parts'][0]; document.getElementById('date').value = `${p[0]}-${String(p[1]||1).padStart(2,'0')}-${String(p[2]||1).padStart(2,'0')}`; } showToast('âœ“ æŠ“å–æˆåŠŸ', 'success'); } catch(e) { showToast('æŠ“å–å¤±è´¥: ' + e.message, 'error'); }
    }
    async function fetchIsbnMetadata() {
        const isbn = document.getElementById('bookIsbn').value.replace(/-/g, '').trim(); if(!isbn) return showToast('è¯·è¾“å…¥ ISBN', 'warning');
        try { const res = await fetch(`https://openlibrary.org/isbn/${isbn}.json`); if(!res.ok) throw new Error('æœªæ‰¾åˆ°å›¾ä¹¦'); const data = await res.json(); document.getElementById('bookTitle').value = data.title; if(data.publish_date) document.getElementById('bookDate').value = new Date(data.publish_date).toISOString().slice(0,10); if(data.publishers) document.getElementById('bookPublisher').value = data.publishers[0]; showToast('âœ“ æŠ“å–æˆåŠŸ', 'success'); } catch(e) { showToast('æŠ“å–å¤±è´¥: ' + e.message, 'error'); }
    }
    async function handleOCR(event) {
        const file = event.target.files[0]; if(!file) return; const statusDiv = document.getElementById('ocrStatus'); statusDiv.textContent = 'è¯†åˆ«ä¸­...';
        try { const result = await Tesseract.recognize(file, 'chi_sim', { logger: m => statusDiv.textContent = `è¿›åº¦: ${(m.progress * 100).toFixed(0)}%` }); const text = result.data.text; if(text.match(/ZL/)) document.getElementById('patentNumber').value = (text.match(/ZL\s?\d+/) || [''])[0]; const dateMatch = text.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/); if(dateMatch) document.getElementById('date').value = `${dateMatch[1]}-${dateMatch[2].padStart(2,'0')}-${dateMatch[3].padStart(2,'0')}`; if(!document.getElementById('title').value) document.getElementById('title').value = text.split('\n')[0].substring(0,20); showToast('OCR è¯†åˆ«å®Œæˆ', 'success'); } catch(e) { showToast('OCR å¤±è´¥', 'error'); }
    }

    // --- æ ¸å¿ƒæ¸²æŸ“ä¸è¿‡æ»¤ ---
    function getFilteredData() {
        let filtered = achievements.slice();
        if (currentView === 'member') return members.slice(); 
        if (currentView !== 'all') filtered = filtered.filter(a => a.type === currentView);
        if (searchQuery) filtered = filtered.filter(a => Object.values(a).join(' ').toLowerCase().includes(searchQuery.toLowerCase()));
        if (advFilter.start) filtered = filtered.filter(a => (a.date||'').substring(0,10) >= advFilter.start);
        if (advFilter.end) filtered = filtered.filter(a => (a.date||'').substring(0,10) <= advFilter.end);
        if (advFilter.author) filtered = filtered.filter(a => (a.authors||a.inventors||'').includes(advFilter.author));
        if (advFilter.tag) filtered = filtered.filter(a => (a.tags||'').includes(advFilter.tag.replace('#','')));
        filtered.sort((a, b) => { const dA = a.date||'0', dB = b.date||'0'; return sortOrder==='date-desc' ? dB.localeCompare(dA) : sortOrder==='date-asc' ? dA.localeCompare(dB) : (a.title||'').localeCompare(b.title||''); });
        return filtered;
    }

    function renderResults() {
        const container = document.getElementById('resultsList');
        if (currentView === 'member') { renderMembers(container); return; }
        const filtered = getFilteredData();
        const totalItems = filtered.length;
        document.getElementById('resultsCount').textContent = `å…± ${totalItems} æ¡`;
        renderPagination(totalItems);
        const start = (currentPage - 1) * pageSize;
        const pageItems = filtered.slice(start, start + pageSize);
        if (pageItems.length === 0) { container.innerHTML = '<div class="empty-state"><h3>æš‚æ— è®°å½•</h3></div>'; return; }
        container.innerHTML = pageItems.map(item => {
            const config = { paper: {icon:'ğŸ“„',class:'type-paper'}, patent: {icon:'ğŸ’¡',class:'type-patent'}, project: {icon:'ğŸ“Š',class:'type-project'}, award: {icon:'ğŸ†',class:'type-award'}, book: {icon:'ğŸ“š',class:'type-book'} }[item.type] || {icon:'ğŸ“„',class:'type-paper'};
            let title = item.title || item.patentName || item.projectName;
            let date = item.date || item.applicationDate;
            let tagsHtml = item.tags ? item.tags.split(' ').map(t => `<span class="tag">${t.replace('#','')}</span>`).join('') : '';
            const isChecked = selectedItems.has(item.id) ? 'checked' : '';
            return `<div class="result-item" onclick="viewDetail('${item.id}')"><input type="checkbox" class="result-checkbox" data-id="${item.id}" ${isChecked} onclick="toggleItemSelect('${item.id}', event)"><div class="result-type ${config.class}">${config.icon}</div><div class="result-content"><div class="result-title">${escapeHtml(title)}</div><div class="result-meta"><span>ğŸ“… ${date||'-'}</span>${tagsHtml?`<div class="tag-list">${tagsHtml}</div>`:''}</div></div><div class="result-actions"><button class="action-btn" onclick="event.stopPropagation(); viewFile('${item.id}')" ${!item.pdfData?'disabled style="opacity:0.3"':''}>ğŸ‘ï¸</button><button class="action-btn delete" onclick="event.stopPropagation(); promptDelete('${item.id}', 'achievement')">ğŸ—‘</button></div></div>`;
        }).join('');
    }

    // --- Excel å¯¼å‡ºä¿®å¤ (å¼ºåˆ¶åˆ†è¡¨åŠŸèƒ½) ---
    function exportToExcelFile() {
        if (currentUserRole !== 'admin') { showToast('æ— æƒé™', 'error'); return; }
        const wb = XLSX.utils.book_new();
        let hasData = false;
        
        // å¦‚æœæ˜¯ member è§†å›¾ï¼Œåªå¯¼å‡º member
        if (currentView === 'member') {
            if (members.length > 0) {
                const data = members.map(m => ({ 'å·¥å·': m.memberNo, 'å§“å': m.memberName, 'èŒç§°': m.memberTitle, 'å•ä½': m.memberOrg, 'ç”µè¯': m.memberPhone }));
                const ws = XLSX.utils.json_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'å›¢é˜Ÿæˆå‘˜');
                hasData = true;
            }
        } else {
            // å¦‚æœæ˜¯æˆæœè§†å›¾ï¼Œå¼ºåˆ¶åˆ† Sheet å¯¼å‡º
            // æ— è®ºå½“å‰è§†å›¾æ˜¯ paper è¿˜æ˜¯ allï¼Œå¦‚æœæ˜¯ all åˆ™å¾ªç¯æ‰€æœ‰ç±»å‹ï¼Œå¦‚æœæ˜¯ paper åˆ™åªå¯¼ paper
            const types = currentView === 'all' ? ['paper', 'patent', 'project', 'award', 'book'] : [currentView];
            
            types.forEach(t => {
                const list = achievements.filter(a => a.type === t);
                if (list.length === 0) return;
                
                const sheetData = list.map(a => {
                    let r = { 'ID': a.id, 'æ ‡é¢˜': a.title || a.patentName || a.projectName || a.bookTitle, 'æ—¥æœŸ': a.date || a.applicationDate || a.projectStartDate };
                    // è¡¥å……å…·ä½“å­—æ®µ
                    if(t==='patent') { r['ä¸“åˆ©å·'] = a.patentNumber; r['çŠ¶æ€'] = a.patentStatus; r['ç±»å‹'] = a.patentType; r['å‘æ˜äºº'] = a.inventors; }
                    else if(t==='paper') { r['æœŸåˆŠ'] = a.source; r['ä½œè€…'] = a.authors; r['çº§åˆ«'] = a.level; r['DOI'] = a.doi; }
                    else if(t==='project') { r['ç¼–å·'] = a.projectNumber; r['å•ä½'] = a.projectOrg; r['çº§åˆ«'] = a.projectLevel; }
                    else if(t==='award') { r['è·å¥–äºº'] = a.awardRecipients; r['çº§åˆ«'] = a.awardLevel; r['å•ä½'] = a.awardAgency; }
                    else if(t==='book') { r['ä½œè€…'] = a.bookAuthors; r['å‡ºç‰ˆç¤¾'] = a.bookPublisher; r['ISBN'] = a.bookIsbn; }
                    return r;
                });
                
                const ws = XLSX.utils.json_to_sheet(sheetData);
                XLSX.utils.book_append_sheet(wb, ws, typeConfig[t].label);
                hasData = true;
            });
        }

        if (!hasData) { showToast('æ— æ•°æ®å¯å¯¼å‡º', 'warning'); return; }
        XLSX.writeFile(wb, `ç§‘ç ”æ•°æ®_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // --- ç®€å†å¯¼å‡ºä¼˜åŒ– (æ’ç‰ˆç¾åŒ–) ---
    function exportResume() {
        const id = document.getElementById('memberEditId').value;
        // å¦‚æœä¸åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œå°è¯•è·å–é€‰ä¸­é¡¹ï¼Œæˆ–è€…æç¤ºé”™è¯¯
        let member = members.find(m => m.id === id);
        if(!member && selectedItems.size === 1) {
             const selectedId = Array.from(selectedItems)[0];
             member = members.find(m => m.id === selectedId);
        }
        
        if(!member) { showToast('è¯·å…ˆç‚¹å‡»æŸä½æˆå‘˜è¿›å…¥è¯¦æƒ…/ç¼–è¾‘é¡µï¼Œæˆ–å‹¾é€‰ä¸€ä½æˆå‘˜', 'warning'); return; }

        const related = achievements.filter(a => (a.authors||a.inventors||a.bookAuthors||a.awardRecipients||'').includes(member.memberName));
        related.sort((a,b) => (b.date||'').localeCompare(a.date||''));

        // ç”Ÿæˆ Word HTML
        let html = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='utf-8'><title>ç®€å†</title>
            <style>
                body { font-family: 'SimSun', serif; font-size: 14px; line-height: 1.5; }
                h1 { text-align: center; font-size: 24px; font-family: 'SimHei'; margin-bottom: 20px; }
                .section { margin-bottom: 20px; }
                .section-title { font-size: 16px; border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 10px; font-weight: bold; font-family: 'SimHei'; }
                table { width: 100%; border-collapse: collapse; }
                td { padding: 5px; vertical-align: top; }
                .date-col { width: 120px; color: #666; }
                .type-tag { font-size: 12px; border: 1px solid #999; padding: 1px 4px; border-radius: 3px; margin-right: 5px; }
            </style>
            </head>
            <body>
                <h1>${member.memberName} - ä¸ªäººç®€å†</h1>
                <div class="section">
                    <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
                    <p>å•ä½ï¼š${member.memberOrg} &nbsp;|&nbsp; èŒç§°ï¼š${member.memberTitle} &nbsp;|&nbsp; å­¦å·/å·¥å·ï¼š${member.memberNo}</p>
                    <p>ç”µè¯ï¼š${member.memberPhone || '-'} &nbsp;|&nbsp; é‚®ç®±ï¼š${member.memberEmail || '-'}</p>
                </div>
                <div class="section">
                    <div class="section-title">ç§‘ç ”æˆæœ (${related.length}é¡¹)</div>
                    <table>
        `;
        
        related.forEach(a => {
            let detail = '';
            if(a.type === 'paper') detail = `æœŸåˆŠ: ${a.source} (çº§åˆ«: ${a.level||'-'})`;
            if(a.type === 'patent') detail = `ä¸“åˆ©å·: ${a.patentNumber}`;
            if(a.type === 'project') detail = `é¡¹ç›®ç¼–å·: ${a.projectNumber} (çº§åˆ«: ${a.projectLevel||'-'})`;
            if(a.type === 'award') detail = `æˆå¥–å•ä½: ${a.awardAgency}`;
            
            let typeLabel = typeConfig[a.type]?.label || 'æˆæœ';
            html += `
                <tr>
                    <td class="date-col">${a.date || a.applicationDate || a.projectStartDate || '-'}</td>
                    <td>
                        <span class="type-tag">${typeLabel}</span>
                        <b>${a.title || a.patentName || a.projectName}</b><br/>
                        <span style="color:#444;font-size:13px;">${detail}</span><br/>
                        <span style="color:#666;font-size:12px;">å‚ä¸äººå‘˜: ${a.authors || a.inventors || a.awardRecipients || '-'}</span>
                    </td>
                </tr>
            `;
        });
        
        html += `</table></div></body></html>`;
        
        const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${member.memberName}_ç®€å†.doc`; a.click();
    }

    // --- é‡å¤æ£€æµ‹ä¿®å¤ (æ ¸å¿ƒé€»è¾‘) ---
    // æ£€æŸ¥é‡å¤ï¼Œè¿”å› {isDup, item}
    function checkDuplicate(newItem, list) {
        // 1. ID åŒ¹é… (é€šå¸¸ä¸å‘ç”Ÿï¼Œé™¤éå®Œå…¨ç›¸åŒçš„æ•°æ®)
        const idMatch = list.find(e => e.id === newItem.id);
        if(idMatch) return { isDup: true, item: idMatch };

        // 2. ä¸“åˆ©å·/é¡¹ç›®ç¼–å· åŒ¹é… (å¼ºç‰¹å¾)
        if (newItem.type === 'patent' && newItem.patentNumber) {
            const pMatch = list.find(e => e.type === 'patent' && e.patentNumber === newItem.patentNumber);
            if(pMatch) return { isDup: true, item: pMatch };
        }
        if (newItem.type === 'project' && newItem.projectNumber) {
            const pMatch = list.find(e => e.type === 'project' && e.projectNumber === newItem.projectNumber);
            if(pMatch) return { isDup: true, item: pMatch };
        }

        // 3. æ ‡é¢˜/åç§° åŒ¹é… (å»é™¤ç©ºæ ¼ï¼Œå¿½ç•¥å¤§å°å†™)
        const normalize = s => (s||'').toLowerCase().replace(/\s/g, '');
        const targetTitle = normalize(newItem.title || newItem.patentName || newItem.projectName);
        if(targetTitle.length > 5) { // åªæœ‰æ ‡é¢˜å¤Ÿé•¿æ‰æ£€æµ‹
            const titleMatch = list.find(e => {
                if(e.type !== newItem.type) return false;
                const eTitle = normalize(e.title || e.patentName || e.projectName);
                return eTitle === targetTitle;
            });
            if(titleMatch) return { isDup: true, item: titleMatch };
        }

        return { isDup: false };
    }

    function confirmExcelImport() {
        const type = document.getElementById('excelImportType').value;
        const selects = document.querySelectorAll('.field-map-select');
        let mapConfig = {}; 
        selects.forEach(sel => { if(sel.value !== '') mapConfig[sel.dataset.key] = parseInt(sel.value); });
        
        let added = 0; let updated = 0; let skipped = 0;
        
        for (let i = 1; i < excelData.length; i++) {
            const row = excelData[i];
            if (!row || row.length === 0) continue;
            
            // æ„å»ºä¸´æ—¶å¯¹è±¡
            let item = { id: Date.now() + Math.random().toString(), type: type, updatedAt: new Date().toISOString() };
            for (let key in mapConfig) item[key] = row[mapConfig[key]];
            
            // æ•°æ®é¢„å¤„ç†è¡¥å…¨ (é‡è¦ï¼šä¿è¯ title å­˜åœ¨ä»¥ä¾›æ£€æµ‹)
            if(type === 'patent') item.title = item.patentName;
            if(type === 'project') item.title = item.projectName;
            if(type === 'award') item.title = item.awardName;
            if(type === 'book') item.title = item.bookTitle;
            // å¦‚æœæ²¡æ˜ å°„å…·ä½“åä½†æ˜ å°„äº† title
            if(!item.patentName && item.title) item.patentName = item.title;

            // æ£€æµ‹
            const targetList = type==='member' ? members : achievements;
            const check = checkDuplicate(item, targetList);
            
            if(!check.isDup) {
                // æ— é‡å¤ï¼Œç›´æ¥æ·»åŠ 
                targetList.push(item);
                added++;
            } else {
                // æœ‰é‡å¤ï¼Œæ¯”è¾ƒæ•°æ®å®Œæ•´åº¦ (è¿™é‡Œç®€åŒ–ä¸ºï¼šå¦‚æœæ–°æ•°æ®æœ‰å€¼ä¸”æ—§æ•°æ®ä¸ºç©ºï¼Œåˆ™æ›´æ–°)
                let hasChange = false;
                const oldItem = check.item;
                for (let key in item) {
                    if (key === 'id' || key === 'updatedAt') continue;
                    // å¦‚æœæ—§æ•°æ®ä¸ºç©ºï¼Œæ–°æ•°æ®æœ‰å€¼ -> æ›´æ–°
                    if ((!oldItem[key] || oldItem[key] === '') && (item[key] && item[key] !== '')) {
                        oldItem[key] = item[key];
                        hasChange = true;
                    }
                }
                if(hasChange) {
                    oldItem.updatedAt = new Date().toISOString();
                    updated++;
                } else {
                    skipped++;
                }
            }
        }
        saveToLocal(); closeExcelModal(); updateStats(); renderResults();
        showToast(`å¯¼å…¥ç»“æŸ: æ–°å¢ ${added}, æ›´æ–°è¡¥å…¨ ${updated}, è·³è¿‡é‡å¤ ${skipped}`, 'success');
    }

    // --- å…¶ä»–è¾…åŠ©å‡½æ•° (ä¿æŒä¸å˜) ---
    function updateStorageStatus(ok) { var s = document.getElementById('storageStatus'); if (ok) { s.className = 'storage-status'; s.innerHTML = 'âœ“ æ•°æ®å·²æœ¬åœ°ä¿å­˜'; } else { s.className = 'storage-status warning'; s.textContent = 'âš  ä¿å­˜å¤±è´¥'; } }
    function base64ToBlob(base64Data) { var arr = base64Data.split(','); var mime = arr[0].match(/:(.*?);/)[1]; var bstr = atob(arr[1]); var n = bstr.length; var u8arr = new Uint8Array(n); while (n--) { u8arr[n] = bstr.charCodeAt(n); } return new Blob([u8arr], { type: mime }); }
    function escapeHtml(text) { if (!text) return ''; var d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('active'); }
    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('active'); }
    function setView(view) { if (view === 'member' && currentUserRole !== 'admin') { showToast('æ— æƒæŸ¥çœ‹', 'error'); return; } currentView = view; currentPage = 1; selectedItems.clear(); updateBatchDeleteBtn(); document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.view === view)); closeSidebar(); renderResults(); }
    function setYearFilter(year) { const chips = document.querySelectorAll('.filter-chip'); chips.forEach(c => c.classList.toggle('active', c.dataset.year === year)); renderResults(); }
    function handleSort() { sortOrder = document.getElementById('sortSelect').value; renderResults(); }
    function toggleSelectAll() { var c = document.getElementById('selectAll').checked; document.querySelectorAll('.result-checkbox').forEach(function(cb) { cb.checked = c; if (c) selectedItems.add(cb.dataset.id); else selectedItems.delete(cb.dataset.id); }); updateBatchDeleteBtn(); }
    function toggleItemSelect(id, event) { event.stopPropagation(); if (selectedItems.has(id)) selectedItems.delete(id); else selectedItems.add(id); updateBatchDeleteBtn(); }
    function updateBatchDeleteBtn() { var c = selectedItems.size; document.getElementById('selectedCount').textContent = c; document.getElementById('batchDeleteBtn').style.display = c > 0 ? 'inline-flex' : 'none'; }
    function batchDelete() { if (currentUserRole !== 'admin') return; if (selectedItems.size === 0) return; deleteTargetIds = Array.from(selectedItems); deleteTargetType = currentView === 'member' ? 'member' : 'achievement'; document.getElementById('confirmMessage').textContent = 'ç¡®å®šåˆ é™¤ï¼Ÿ'; document.getElementById('confirmModal').classList.add('active'); }
    function promptDelete(id, type) { if (currentUserRole !== 'admin') return; deleteTargetIds = [id]; deleteTargetType = type; document.getElementById('confirmMessage').textContent = 'ç¡®å®šåˆ é™¤ï¼Ÿ'; document.getElementById('confirmModal').classList.add('active'); }
    function closeConfirmModal() { document.getElementById('confirmModal').classList.remove('active'); }
    function confirmDelete() { if (deleteTargetType === 'member') { deleteTargetIds.forEach(id => { const item = members.find(m => m.id === id); if(item) trashBin.push({ originalId: item.id, type: 'member', data: item, deletedAt: new Date().toLocaleString() }); }); members = members.filter(m => !deleteTargetIds.includes(m.id)); } else { deleteTargetIds.forEach(id => { const item = achievements.find(a => a.id === id); if(item) trashBin.push({ originalId: item.id, type: 'achievement', data: item, deletedAt: new Date().toLocaleString() }); }); achievements = achievements.filter(a => !deleteTargetIds.includes(a.id)); } logAction('Delete', `åˆ é™¤ ${deleteTargetIds.length} é¡¹`); deleteTargetIds.forEach(id => selectedItems.delete(id)); saveToLocal(); updateStats(); renderResults(); updateBatchDeleteBtn(); closeConfirmModal(); showToast('å·²ç§»å…¥å›æ”¶ç«™', 'success'); }
    function updateStats() { var counts = { paper: 0, patent: 0, project: 0, award: 0, book: 0 }; achievements.forEach(item => { if (counts[item.type] !== undefined) counts[item.type]++; }); document.getElementById('totalCount').textContent = achievements.length; document.getElementById('memberCount').textContent = members.length; document.getElementById('statMember').textContent = members.length; ['paper', 'patent', 'project', 'award', 'book'].forEach(t => { document.getElementById(t + 'Count').textContent = counts[t]; document.getElementById('stat' + t.charAt(0).toUpperCase() + t.slice(1)).textContent = counts[t]; }); }
    function openAddModal() { if (currentView === 'member') { openMemberModal(); return; } document.getElementById('modalTitle').textContent = 'æ·»åŠ ç§‘ç ”æˆæœ'; document.getElementById('researchForm').reset(); document.getElementById('editId').value = ''; document.getElementById('type').value = (currentView!=='all')?currentView:''; toggleFormFields(); removeFile(); document.getElementById('formModal').classList.add('active'); }
    function closeModal() { document.getElementById('formModal').classList.remove('active'); }
    function toggleFormFields() { var type = document.getElementById('type').value; document.getElementById('patentFields').classList.toggle('hidden', type !== 'patent'); document.getElementById('projectFields').classList.toggle('hidden', type !== 'project'); document.getElementById('awardFields').classList.toggle('hidden', type !== 'award'); document.getElementById('bookFields').classList.toggle('hidden', type !== 'book'); var isGeneral = !['patent','project','award','book'].includes(type); document.getElementById('generalFields').classList.toggle('hidden', !isGeneral); document.getElementById('ocrSection').classList.toggle('hidden', type !== 'patent' && type !== 'award'); }
    function openMemberModal() { document.getElementById('memberForm').reset(); document.getElementById('memberEditId').value = ''; document.getElementById('btnResume').style.display='none'; document.getElementById('memberModal').classList.add('active'); }
    function closeMemberModal() { document.getElementById('memberModal').classList.remove('active'); }
    function editMember(id) { if(currentUserRole!=='admin') return; const m = members.find(x=>x.id===id); if(!m) return; document.getElementById('memberEditId').value = id; document.getElementById('memberName').value = m.memberName; document.getElementById('memberNo').value = m.memberNo; document.getElementById('memberOrg').value = m.memberOrg||''; document.getElementById('memberTitle').value = m.memberTitle||''; document.getElementById('memberIdCard').value = m.memberIdCard; document.getElementById('memberPhone').value = m.memberPhone; document.getElementById('btnResume').style.display='inline-flex'; document.getElementById('memberModal').classList.add('active'); }
    function handleSubmit(event) { event.preventDefault(); const formData = { id: document.getElementById('editId').value || Date.now().toString(), type: document.getElementById('type').value, title: document.getElementById('title').value, date: document.getElementById('date').value, authors: document.getElementById('authors').value, tags: document.getElementById('tags').value, patentName: document.getElementById('patentName').value, patentNumber: document.getElementById('patentNumber').value, projectName: document.getElementById('projectName').value, awardName: document.getElementById('awardName').value, bookTitle: document.getElementById('bookTitle').value, updatedAt: new Date().toISOString() }; if(formData.type==='patent') formData.title = formData.patentName; const idx = achievements.findIndex(a => a.id === formData.id); if(idx !== -1) achievements[idx] = { ...achievements[idx], ...formData }; else achievements.push({ ...formData, createdAt: new Date().toISOString() }); saveToLocal(); closeModal(); updateStats(); renderResults(); logAction(idx!==-1?'Update':'Create', `ä¿å­˜: ${formData.title}`); }
    function handleMemberSubmit(event) { event.preventDefault(); const data = { id: document.getElementById('memberEditId').value || Date.now().toString(), memberName: document.getElementById('memberName').value, memberNo: document.getElementById('memberNo').value, memberOrg: document.getElementById('memberOrg').value, memberTitle: document.getElementById('memberTitle').value, memberIdCard: document.getElementById('memberIdCard').value, memberPhone: document.getElementById('memberPhone').value }; const idx = members.findIndex(m => m.id === data.id); if(idx !== -1) members[idx] = { ...members[idx], ...data }; else members.push(data); saveToLocal(); closeMemberModal(); updateStats(); renderResults(); logAction(idx!==-1?'Update':'Create', `æˆå‘˜: ${data.memberName}`); }
    function exportData() { if(currentUserRole !== 'admin') return; const exportObj = { achievements, members, trashBin, actionLogs }; const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
    function triggerImport() { document.getElementById('importInput').click(); }
    function showToast(msg, type) { const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = msg; document.getElementById('toastContainer').appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => t.remove(), 3000); }
    function viewDetail(id) { currentDetailId = id; const item = achievements.find(a=>a.id===id); if(!item) return; document.getElementById('detailContent').innerHTML = Object.entries(item).filter(([k])=>!['id','pdfData'].includes(k)).map(([k,v]) => `<div class="detail-row"><div class="detail-label">${k}</div><div class="detail-value">${v}</div></div>`).join(''); document.getElementById('detailModal').classList.add('active'); }
    function closeDetailModal() { document.getElementById('detailModal').classList.remove('active'); }
    function editFromDetail() { closeDetailModal(); document.getElementById('editId').value=currentDetailId; openAddModal(); }
    function toggleAdvancedSearch() { document.getElementById('advancedSearchPanel').classList.toggle('active'); }
    function handleSearch() { searchQuery = document.getElementById('searchInput').value.toLowerCase(); advFilter.start = document.getElementById('advStartDate').value; advFilter.end = document.getElementById('advEndDate').value; advFilter.author = document.getElementById('advAuthor').value; advFilter.tag = document.getElementById('advTag').value; currentPage = 1; renderResults(); }
    function toggleMenu(id) { var menu = document.getElementById(id); var isVisible = menu.classList.contains('show'); closeAllMenus(); if (!isVisible) menu.classList.add('show'); }
    function closeAllMenus() { document.querySelectorAll('.dropdown-menu').forEach(function(m) { m.classList.remove('show'); }); }
    function handleFileSelect(event) { var file = event.target.files[0]; if (!file) return; var reader = new FileReader(); reader.onload = function(e) { currentPdfData = e.target.result; currentPdfName = file.name; document.getElementById('fileName').textContent = file.name; document.getElementById('fileInfo').classList.remove('hidden'); document.getElementById('fileUpload').classList.add('has-file'); }; reader.readAsDataURL(file); }
    function removeFile() { currentPdfData = null; currentPdfName = null; document.getElementById('pdfInput').value = ''; document.getElementById('fileInfo').classList.add('hidden'); document.getElementById('fileUpload').classList.remove('hidden'); document.getElementById('fileUpload').classList.remove('has-file'); }
    function viewFile(id) { var item = achievements.find(function(a) { return String(a.id) === String(id); }); if (item && item.pdfData) { var blob = base64ToBlob(item.pdfData); var url = URL.createObjectURL(blob); window.open(url); } }
    function openExcelImport() { document.getElementById('excelModal').classList.add('active'); document.getElementById('excelInput').value = ''; document.getElementById('excelPreviewContainer').classList.add('hidden'); document.getElementById('mappingContainer').classList.add('hidden'); document.getElementById('importExcelBtn').disabled = true; document.getElementById('duplicateWarning').classList.add('hidden'); excelData = null; closeAllMenus(); }
    function closeExcelModal() { document.getElementById('excelModal').classList.remove('active'); }
    function handleExcelSelect(event) { var file = event.target.files[0]; if (!file) return; var reader = new FileReader(); reader.onload = function(e) { var data = new Uint8Array(e.target.result); var workbook = XLSX.read(data, { type: 'array' }); var firstSheet = workbook.Sheets[workbook.SheetNames[0]]; excelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 }); if (excelData.length > 0) { excelHeaders = excelData[0]; renderExcelPreview(); updateMappingFields(); document.getElementById('excelPreviewContainer').classList.remove('hidden'); document.getElementById('mappingContainer').classList.remove('hidden'); document.getElementById('importExcelBtn').disabled = false; } else { showToast('Excel æ–‡ä»¶ä¸ºç©º', 'error'); } }; reader.readAsArrayBuffer(file); }
    function renderExcelPreview() { var html = '<table><thead><tr>'; excelHeaders.forEach(function(h) { html += '<th>' + escapeHtml(h) + '</th>'; }); html += '</tr></thead><tbody>'; for (var i = 1; i < Math.min(excelData.length, 6); i++) { html += '<tr>'; var row = excelData[i]; excelHeaders.forEach(function(_, idx) { html += '<td>' + escapeHtml(row[idx] || '') + '</td>'; }); html += '</tr>'; } html += '</tbody></table>'; document.getElementById('excelPreview').innerHTML = html; }
    function updateMappingFields() { var type = document.getElementById('excelImportType').value; var fields = fieldMappings[type] || []; var container = document.getElementById('mappingFields'); var html = ''; fields.forEach(function(field) { html += '<div class="mapping-row"><label>' + field.label + (field.required ? ' *' : '') + '</label><select class="field-map-select" data-key="' + field.key + '" data-required="' + field.required + '"><option value="">(ä¸å¯¼å…¥)</option>'; excelHeaders.forEach(function(header, idx) { var selected = (header.indexOf(field.label) !== -1 || field.label.indexOf(header) !== -1) ? 'selected' : ''; html += '<option value="' + idx + '" ' + selected + '>' + escapeHtml(header) + '</option>'; }); html += '</select></div>'; }); container.innerHTML = html; }

    // OneDrive
    const msalConfig = { auth: { clientId: "c453313f-fd40-4534-9d66-6a0847396d3b", authority: "https://login.microsoftonline.com/common", redirectUri: window.location.origin + window.location.pathname }, cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false } };
    const loginRequest = { scopes: ["User.Read", "Files.ReadWrite"] };
    let msalInstance = null;
    const OneDriveService = {
        init: async function() { try { msalInstance = new msal.PublicClientApplication(msalConfig); const accounts = msalInstance.getAllAccounts(); if (accounts.length > 0) { msalInstance.setActiveAccount(accounts[0]); this.updateUI(accounts[0]); } } catch (e) { console.error("MSAL Init Error:", e); } },
        signIn: async function() { try { const response = await msalInstance.loginPopup(loginRequest); msalInstance.setActiveAccount(response.account); this.updateUI(response.account); showToast("ç™»å½•æˆåŠŸ", "success"); } catch (e) { showToast("ç™»å½•å¤±è´¥: " + e.message, "error"); } },
        signOut: function() { msalInstance.logoutPopup({ postLogoutRedirectUri: window.location.href }); this.updateUI(null); },
        getToken: async function() { const account = msalInstance.getActiveAccount(); if (!account) throw new Error("æœªç™»å½•"); try { const response = await msalInstance.acquireTokenSilent({ ...loginRequest, account: account }); return response.accessToken; } catch (e) { const response = await msalInstance.acquireTokenPopup(loginRequest); return response.accessToken; } },
        updateUI: function(account) { const loginPanel = document.getElementById('onedrive-login-panel'); const actionPanel = document.getElementById('onedrive-actions-panel'); if (account) { loginPanel.classList.add('hidden'); actionPanel.classList.remove('hidden'); document.getElementById('odUserName').textContent = account.name; document.getElementById('odUserEmail').textContent = account.username; document.getElementById('odUserInitials').textContent = account.name ? account.name.charAt(0).toUpperCase() : "U"; } else { loginPanel.classList.remove('hidden'); actionPanel.classList.add('hidden'); } },
        upload: async function() { if (currentUserRole !== 'admin') { showToast('æ— æƒé™', 'error'); return; } const btn = document.getElementById('btnOdUpload'); const originalText = btn.innerHTML; btn.innerHTML = '<span class="loading-spinner"></span> ä¸Šä¼ ä¸­...'; btn.disabled = true; try { const token = await this.getToken(); const data = { version: '4.5', backupDate: new Date().toISOString(), system: 'ResearchManager', achievements: achievements, members: members }; const content = JSON.stringify(data); const url = `https://graph.microsoft.com/v1.0/me/drive/root:/ResearchManager/backup.json:/content`; const response = await fetch(url, { method: 'PUT', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: content }); if (!response.ok) throw new Error("ä¸Šä¼ å¤±è´¥"); showToast("âœ… å¤‡ä»½æˆåŠŸ", "success"); } catch (e) { showToast("âŒ å¤±è´¥: " + e.message, "error"); } finally { btn.innerHTML = originalText; btn.disabled = false; } },
        download: async function() { const btn = document.getElementById('btnOdDownload'); const originalText = btn.innerHTML; btn.innerHTML = '<span class="loading-spinner dark"></span> ä¸‹è½½ä¸­...'; btn.disabled = true; try { const token = await this.getToken(); const url = `https://graph.microsoft.com/v1.0/me/drive/root:/ResearchManager/backup.json:/content`; const response = await fetch(url, { method: 'GET', headers: { 'Authorization': `Bearer ${token}` } }); if (response.status === 404) throw new Error("äº‘ç«¯æ— æ–‡ä»¶"); if (!response.ok) throw new Error("ä¸‹è½½å¤±è´¥"); const data = await response.json(); if (confirm(`æ˜¯å¦è¦†ç›–æœ¬åœ°æ•°æ®ï¼Ÿ`)) { achievements = data.achievements || []; members = data.members || []; saveToLocal(); updateStats(); renderResults(); showToast(`âœ… æ¢å¤æˆåŠŸ`, "success"); closeBackupModal(); } } catch (e) { showToast("âŒ å¤±è´¥: " + e.message, "error"); } finally { btn.innerHTML = originalText; btn.disabled = false; } }
    };
    window.onload = function() { OneDriveService.init(); loadFromLocal().then(function() { updateStats(); renderResults(); }); };
</script>
</body>
</html>
